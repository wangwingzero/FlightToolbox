<view class="container page-content">
  <!-- 分类菜单 -->
  <view class="category-tabs-container">
    <scroll-view class="category-tabs-scroll" scroll-x scroll-with-animation enhanced>
      <view class="category-tabs-wrapper">
        <view
          wx:for="{{ quickFilters }}"
          wx:key="value"
          class="category-tab-item {{ currentQuickFilter === item.value ? 'active' : '' }}"
          bind:tap="onQuickFilterTap"
          data-filter="{{ item }}"
        >
          <view class="category-badge">{{ item.count }}</view>
          <view class="category-title">{{ item.label }}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 优雅搜索区域 -->
  <view class="elegant-search-container">
    <!-- 背景装饰 -->
    <view class="search-bg-decoration">
      <view class="decoration-circle circle-1"></view>
      <view class="decoration-circle circle-2"></view>
      <view class="decoration-circle circle-3"></view>
    </view>

    <!-- 主搜索框 -->
    <view class="main-search-wrapper">
      <view class="premium-search-box {{ searchFocused ? 'focused' : '' }}">
        <view class="search-icon-wrapper">
          <van-icon name="search" size="18px" color="#8E8E93" />
        </view>
        
        <input 
          class="premium-search-input"
          value="{{ searchKeyword }}"
          placeholder="输入机场代码、名称或城市名称"
          placeholder-class="premium-search-placeholder"
          bindinput="onSearchInput"
          bindfocus="onSearchFocus"
          bindblur="onSearchBlur"
          confirm-type="search"
          bindconfirm="onSearchConfirm"
        />
        
        <view wx:if="{{ searchKeyword }}" class="search-clear-btn" bind:tap="onClearSearch">
          <van-icon name="clear" size="18px" color="#9ca3af" />
        </view>
        
        <view wx:if="{{ searchLoading }}" class="search-loading-indicator">
          <van-loading type="spinner" size="16px" color="#007AFF" />
        </view>
      </view>
      
      <!-- 搜索状态提示 -->
      <view wx:if="{{ isSearchMode }}" class="search-status-elegant">
        <view class="status-indicator">
          <view class="pulse-dot"></view>
        </view>
        <text class="status-text-elegant">正在为您搜索全球机场数据...</text>
      </view>
    </view>
    
    <!-- 搜索建议卡片 -->
    <view wx:if="{{ showSuggestions }}" class="suggestions-card">
      <view class="suggestions-header-elegant">
        <view class="suggestions-title-elegant">
          <van-icon name="fire" size="16px" color="#f59e0b" />
          <text>热门搜索</text>
        </view>
        <view class="suggestions-close-elegant" bind:tap="onCloseSuggestions">
          <van-icon name="cross" size="16px" color="#9ca3af" />
        </view>
      </view>
      
      <view class="suggestions-content-elegant">
        <view 
          wx:for="{{ searchSuggestions }}" 
          wx:key="keyword"
          class="suggestion-item-elegant"
          bind:tap="onSuggestionTap"
          data-suggestion="{{ item }}"
        >
          <view class="suggestion-icon-elegant">
            <van-icon name="location-o" size="16px" color="#007AFF" />
          </view>
          <view class="suggestion-content-wrapper">
            <text class="suggestion-code-elegant">{{ item.keyword }}</text>
            <text class="suggestion-name-elegant">{{ item.display }}</text>
          </view>
          <view class="suggestion-arrow-elegant">
            <van-icon name="arrow" size="14px" color="#d1d5db" />
          </view>
        </view>
      </view>
    </view>
    
    <!-- 实时搜索结果预览卡片 -->
    <view wx:if="{{ realtimeResults.length > 0 && searchKeyword && !showSuggestions }}" class="results-preview-card">
      <view class="preview-header-elegant">
        <text class="preview-title-elegant">找到 {{ realtimeResults.length }} 个匹配结果</text>
        <view class="preview-close-elegant" bind:tap="onClosePreview">
          <van-icon name="arrow-up" size="16px" color="#9ca3af" />
        </view>
      </view>
      
      <view class="preview-content-elegant">
        <view 
          wx:for="{{ realtimeResults.slice(0, 3) }}" 
          wx:key="ICAOCode"
          class="preview-item-elegant"
          bind:tap="onAirportTap"
          data-airport="{{ item }}"
        >
          <view class="preview-codes-elegant">
            <text class="preview-icao-elegant">{{ item.ICAOCode }}</text>
            <text wx:if="{{ item.IATACode }}" class="preview-iata-elegant">{{ item.IATACode }}</text>
          </view>
          <view class="preview-info-elegant">
            <text class="preview-name-elegant">{{ item.ShortName }}</text>
            <text class="preview-country-elegant">{{ item.CountryName }}</text>
            <text wx:if="{{ item.Elevation }}" class="preview-elevation-elegant">⛰️ {{ item.Elevation }}ft</text>
          </view>
          <view class="preview-arrow-elegant">
            <van-icon name="arrow" size="14px" color="#d1d5db" />
          </view>
        </view>
        
        <view wx:if="{{ realtimeResults.length > 3 }}" class="preview-more-elegant" bind:tap="onViewAllResults">
          <text class="more-text">查看全部 {{ realtimeResults.length }} 个结果</text>
          <van-icon name="arrow" size="14px" color="#007AFF" />
        </view>
      </view>
    </view>
  </view>


  <!-- 搜索结果统计 -->
  <view wx:if="{{ isSearchMode }}" class="search-stats-elegant">
    <view class="stats-content">
      <van-icon name="success" size="14px" color="#34C759" />
      <text class="stats-text">找到 {{ filteredAirports.length || displayedAirports.length }}{{ hasMoreData ? '+' : '' }} 个结果</text>
    </view>
  </view>

  <!-- 机场列表 -->
  <view class="airport-list">
    <view wx:if="{{ searchLoading }}" class="loading-container">
      <view class="loading-content">
        <van-loading type="spinner" size="24px" color="#007AFF" />
        <text class="loading-text">{{ searchConfig.searchingText || '搜索中...' }}</text>
      </view>
    </view>

    <view wx:elif="{{ displayedAirports.length === 0 && !loading }}" class="empty-container">
      <view class="empty-icon">🔍</view>
      <view class="empty-text">{{ isSearchMode ? '未找到匹配的机场' : '暂无机场数据' }}</view>
      <view class="empty-tips">尝试使用不同的关键词搜索</view>
    </view>

    <view wx:else>
      <block wx:for="{{ displayedAirports }}" wx:key="ICAOCode" wx:for-index="idx">
        <view class="airport-item">
          <view class="airport-main" bind:tap="onAirportTap" data-airport="{{ item }}">
            <view class="airport-codes">
              <view class="icao-code">{{ item.ICAOCode }}</view>
              <view wx:if="{{ item.IATACode }}" class="iata-code">{{ item.IATACode }}</view>
            </view>

            <view class="airport-info">
              <view class="airport-name">
                <text class="name-chinese">{{ item.ShortName }}</text>
                <text wx:if="{{ item.EnglishName }}" class="name-english">{{ item.EnglishName }}</text>
              </view>

              <view class="airport-location">
                <view class="country">📍 {{ item.CountryName }}</view>
                <view wx:if="{{ item.Latitude && item.Longitude }}" class="coordinates">
                  {{ item.LatitudeDisplay }}°, {{ item.LongitudeDisplay }}°
                </view>
                <view wx:if="{{ item.Elevation }}" class="elevation">
                  ⛰️ 标高: {{ item.Elevation }}ft
                </view>
              </view>
            </view>
          </view>

          <!-- 地图按钮 -->
          <view wx:if="{{ item.Latitude && item.Longitude }}" class="map-btn-container">
            <view class="map-btn" bind:tap="onShowAirportInMap" data-airport="{{ item }}">
              <text class="map-btn-icon">🗺️</text>
              <text class="map-btn-text">地图</text>
            </view>
          </view>

          <!-- 搜索匹配标识 -->
          <view wx:if="{{ item.matchScore }}" class="match-indicator">
            <van-tag type="primary" size="mini">匹配度: {{ item.matchScore }}</van-tag>
          </view>
        </view>

        <!-- 第一个结果后插入横幅广告 - 仅在原生广告开关开启时显示 -->
        <view wx:if="{{ idx === 0 && !isAdFree && nativeAdEnabled }}" class="ad-banner-container">
          <ad unit-id="adunit-d7a3b71f5ce0afca" ad-type="banner" ad-intervals="30"
              bindload="onAdLoad" binderror="onAdError"></ad>
        </view>
      </block>
    </view>
  </view>

  <!-- 加载更多 -->
  <view wx:if="{{ hasMoreData && displayedAirports.length > 0 }}" class="load-more-container">
    <van-button
      type="default"
      size="small"
      loading="{{ loading }}"
      bind:click="onLoadMore"
      block
    >
      {{ loading ? '加载中...' : '加载更多' }}
    </van-button>
  </view>

  <!-- 页面底部横幅广告 -->
  <view wx:if="{{ !isAdFree && nativeAdEnabled }}" class="ad-banner-container">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"
        bindload="onAdLoad" binderror="onAdError"></ad>
  </view>
</view>

<van-toast id="van-toast" />
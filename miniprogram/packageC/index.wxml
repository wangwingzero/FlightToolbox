<view class="container page-content">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-title">âœˆï¸ æœºåœºæ•°æ®</view>
    <view class="header-subtitle">å…¨çƒæœºåœºä¿¡æ¯æŸ¥è¯¢</view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-container">
    <!-- ä¸»æœç´¢åŒºåŸŸ -->
    <view class="search-main">
      <view class="search-box">
        <view class="search-icon">
          <van-icon name="search" size="18px" color="#969799" />
        </view>
        <input 
          class="search-input"
          value="{{ searchKeyword }}"
          placeholder="æœç´¢æœºåœºä»£ç ã€åç§°æˆ–åœ°åŒº"
          placeholder-class="search-placeholder"
          bindinput="onSearchInput"
          bindfocus="onSearchFocus"
          bindblur="onSearchBlur"
          confirm-type="search"
          bindconfirm="onSearchConfirm"
        />
        <view wx:if="{{ searchKeyword }}" class="search-clear" bind:tap="onClearSearch">
          <van-icon name="clear" size="16px" color="#c8c9cc" />
        </view>
        <view wx:if="{{ searchLoading }}" class="search-loading">
          <van-loading type="spinner" size="16px" color="#1989fa" />
        </view>
      </view>
      
      <!-- æœç´¢çŠ¶æ€æŒ‡ç¤º -->
      <view wx:if="{{ isSearchMode }}" class="search-status">
        <view class="status-icon">
          <van-icon name="success" size="12px" color="#07c160" />
        </view>
        <text class="status-text">å®æ—¶æœç´¢ä¸­...</text>
      </view>
    </view>
    
    <!-- å¿«é€Ÿç­›é€‰æ ‡ç­¾ -->
    <view class="quick-filters">
      <scroll-view class="filter-scroll" scroll-x="true" enhanced="true" show-scrollbar="false">
        <view class="filter-tags">
          <view 
            wx:for="{{ quickFilters }}" 
            wx:key="value"
            class="filter-tag {{ currentQuickFilter === item.value ? 'active' : '' }}"
            bind:tap="onQuickFilterTap"
            data-filter="{{ item }}"
          >
            <text class="tag-text">{{ item.label }}</text>
            <text wx:if="{{ item.count }}" class="tag-count">{{ item.count }}</text>
          </view>
        </view>
      </scroll-view>
    </view>
    
    <!-- æœç´¢å»ºè®® -->
    <view wx:if="{{ showSuggestions }}" class="search-suggestions">
      <view class="suggestions-header">
        <view class="suggestions-title">
          <van-icon name="fire" size="14px" color="#ff6034" />
          <text>çƒ­é—¨æœºåœº</text>
        </view>
        <view class="suggestions-close" bind:tap="onCloseSuggestions">
          <van-icon name="cross" size="14px" color="#969799" />
        </view>
      </view>
      
      <view class="suggestions-content">
        <view 
          wx:for="{{ searchSuggestions }}" 
          wx:key="keyword"
          class="suggestion-item"
          bind:tap="onSuggestionTap"
          data-suggestion="{{ item }}"
        >
          <view class="suggestion-icon">
            <van-icon name="location" size="14px" color="#1989fa" />
          </view>
          <view class="suggestion-content">
            <text class="suggestion-code">{{ item.keyword }}</text>
            <text class="suggestion-name">{{ item.display }}</text>
          </view>
          <view class="suggestion-arrow">
            <van-icon name="arrow" size="12px" color="#c8c9cc" />
          </view>
        </view>
      </view>
    </view>
    
    <!-- å®æ—¶æœç´¢ç»“æœé¢„è§ˆ -->
    <view wx:if="{{ realtimeResults.length > 0 && searchKeyword && !showSuggestions }}" class="realtime-preview">
      <view class="preview-header">
        <text class="preview-title">æ‰¾åˆ° {{ realtimeResults.length }} ä¸ªç»“æœ</text>
        <view class="preview-close" bind:tap="onClosePreview">
          <van-icon name="arrow-up" size="14px" color="#969799" />
        </view>
      </view>
      
      <view class="preview-content">
        <view 
          wx:for="{{ realtimeResults.slice(0, 3) }}" 
          wx:key="ICAOCode"
          class="preview-item"
          bind:tap="onAirportTap"
          data-airport="{{ item }}"
        >
          <view class="preview-codes">
            <text class="preview-icao">{{ item.ICAOCode }}</text>
            <text wx:if="{{ item.IATACode }}" class="preview-iata">{{ item.IATACode }}</text>
          </view>
          <view class="preview-info">
            <text class="preview-name">{{ item.ShortName }}</text>
            <text class="preview-country">{{ item.CountryName }}</text>
          </view>
        </view>
        
        <view wx:if="{{ realtimeResults.length > 3 }}" class="preview-more" bind:tap="onViewAllResults">
          <text>æŸ¥çœ‹å…¨éƒ¨ {{ realtimeResults.length }} ä¸ªç»“æœ</text>
          <van-icon name="arrow" size="12px" color="#1989fa" />
        </view>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰æ  -->
  <view class="filter-container">
    <view class="filter-main">
      <view class="filter-item">
        <van-dropdown-menu>
          <van-dropdown-item 
            value="{{ currentCountry }}" 
            options="{{ countryList }}"
            bind:change="onCountryChange"
          />
        </van-dropdown-menu>
      </view>
      
      <!-- æ’åºé€‰æ‹© -->
      <view class="sort-selector">
        <van-button 
          type="default" 
          size="small" 
          icon="sort" 
          bind:click="onShowSortPopup"
        >
          {{ sortOptions[sortType] || 'é»˜è®¤æ’åº' }}
        </van-button>
      </view>
    </view>
    
    <!-- æœç´¢ç»Ÿè®¡å’Œç»“æœä¿¡æ¯ -->
    <view class="search-stats-enhanced">
      <view class="stats-main">
        <text wx:if="{{ !isSearchMode }}">å…± {{ totalCount }} ä¸ªæœºåœº</text>
        <text wx:else class="search-result-text">
          <van-icon name="success" size="12px" color="#07c160" />
          æ‰¾åˆ° {{ filteredAirports.length || displayedAirports.length }}{{ hasMoreData ? '+' : '' }} ä¸ªç»“æœ
        </text>
      </view>
      
      <view wx:if="{{ isSearchMode && searchKeyword }}" class="search-keyword">
        <text class="keyword-label">æœç´¢:</text>
        <text class="keyword-value">{{ searchKeyword }}</text>
        <view class="keyword-clear" bind:tap="onClearSearch">
          <van-icon name="cross" size="10px" color="#969799" />
        </view>
      </view>
    </view>
  </view>

  <!-- æœºåœºåˆ—è¡¨ -->
  <view class="airport-list">
    <view wx:if="{{ searchLoading }}" class="loading-container">
      <view class="loading-content">
        <van-loading type="spinner" size="24px" color="#1989fa" />
        <text class="loading-text">{{ searchConfig.searchingText || 'æœç´¢ä¸­...' }}</text>
      </view>
    </view>
    
    <view wx:elif="{{ displayedAirports.length === 0 && !loading }}" class="empty-container">
      <view class="empty-icon">ğŸ”</view>
      <view class="empty-text">{{ isSearchMode ? 'æœªæ‰¾åˆ°åŒ¹é…çš„æœºåœº' : 'æš‚æ— æœºåœºæ•°æ®' }}</view>
      <view class="empty-tips">å°è¯•ä½¿ç”¨ä¸åŒçš„å…³é”®è¯æœç´¢</view>
    </view>
    
    <view wx:else>
      <view 
        wx:for="{{ displayedAirports }}" 
        wx:key="ICAOCode"
        class="airport-item"
        bind:tap="onAirportTap"
        data-airport="{{ item }}"
      >
        <view class="airport-main">
          <view class="airport-codes">
            <view class="icao-code">{{ item.ICAOCode }}</view>
            <view wx:if="{{ item.IATACode }}" class="iata-code">{{ item.IATACode }}</view>
          </view>
          
          <view class="airport-info">
            <view class="airport-name">
              <text class="name-chinese">{{ item.ShortName }}</text>
              <text wx:if="{{ item.EnglishName }}" class="name-english">{{ item.EnglishName }}</text>
            </view>
            
            <view class="airport-location">
              <view class="country">ğŸ“ {{ item.CountryName }}</view>
              <view wx:if="{{ item.Latitude && item.Longitude }}" class="coordinates">
                {{ item.Latitude.toFixed(3) }}Â°, {{ item.Longitude.toFixed(3) }}Â°
              </view>
            </view>
          </view>
        </view>
        
        <!-- æœç´¢åŒ¹é…æ ‡è¯† -->
        <view wx:if="{{ item.matchScore }}" class="match-indicator">
          <van-tag type="primary" size="mini">åŒ¹é…åº¦: {{ item.matchScore }}</van-tag>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view wx:if="{{ hasMoreData && displayedAirports.length > 0 }}" class="load-more-container">
    <van-button 
      type="default" 
      size="small" 
      loading="{{ loading }}"
      bind:click="onLoadMore"
      block
    >
      {{ loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š' }}
    </van-button>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{ !isSearchMode && statistics }}" class="statistics-section">
    <view class="stats-title">ğŸ“Š æ•°æ®ç»Ÿè®¡</view>
    <view class="stats-grid">
      <view class="stat-item">
        <view class="stat-number">{{ statistics.total }}</view>
        <view class="stat-label">æ€»æœºåœºæ•°</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{ statistics.countries }}</view>
        <view class="stat-label">è¦†ç›–å›½å®¶</view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{ statistics.withIATA }}</view>
        <view class="stat-label">æœ‰IATAä»£ç </view>
      </view>
      <view class="stat-item">
        <view class="stat-number">{{ statistics.withCoordinates }}</view>
        <view class="stat-label">æœ‰åæ ‡ä¿¡æ¯</view>
      </view>
    </view>
  </view>

  <!-- ä½¿ç”¨è¯´æ˜ -->
  <view class="tips-section">
    <view class="tips-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</view>
    <view class="tips-content">
      <view class="tip-item">â€¢ æ”¯æŒICAOä»£ç æœç´¢ï¼ˆå¦‚ï¼šZBAAã€ZSPDï¼‰</view>
      <view class="tip-item">â€¢ æ”¯æŒIATAä»£ç æœç´¢ï¼ˆå¦‚ï¼šPEKã€PVGï¼‰</view>
      <view class="tip-item">â€¢ æ”¯æŒæœºåœºä¸­è‹±æ–‡åç§°æœç´¢</view>
      <view class="tip-item">â€¢ æ”¯æŒå›½å®¶/åœ°åŒºåç§°æœç´¢</view>
      <view class="tip-item">â€¢ ç‚¹å‡»æœºåœºå¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</view>
      <view class="tip-item">â€¢ æ”¯æŒç¦»çº¿ä½¿ç”¨ï¼Œæ— éœ€ç½‘ç»œè¿æ¥</view>
    </view>
  </view>
</view>

<!-- æ’åºå¼¹çª— -->
<van-popup 
  show="{{ showSortPopup }}" 
  position="bottom" 
  round 
  bind:close="onCloseSortPopup"
>
  <view class="sort-popup">
    <view class="popup-header">
      <text class="popup-title">é€‰æ‹©æ’åºæ–¹å¼</text>
      <view class="popup-close" bind:tap="onCloseSortPopup">
        <van-icon name="cross" size="16px" color="#969799" />
      </view>
    </view>
    
    <view class="sort-options">
      <view 
        wx:for="{{ sortOptionsList }}" 
        wx:key="value"
        class="sort-option {{ sortType === item.value ? 'active' : '' }}"
        bind:tap="onSortOptionTap"
        data-sort="{{ item }}"
      >
        <view class="option-content">
          <van-icon name="{{ item.icon }}" size="16px" color="{{ sortType === item.value ? '#1989fa' : '#969799' }}" />
          <text class="option-text">{{ item.label }}</text>
          <text class="option-desc">{{ item.desc }}</text>
        </view>
        <view wx:if="{{ sortType === item.value }}" class="option-check">
          <van-icon name="success" size="16px" color="#1989fa" />
        </view>
      </view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />
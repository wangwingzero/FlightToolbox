<view class="qar-page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="qar-header">
    <view class="header-content">
      <view class="title">QARçº¢è‰²äº‹ä»¶ç›‘æ§é¡¹</view>
      <view class="subtitle">é£è¡Œå“è´¨ç›‘æ§é¡¹ç›®ä¸æ ‡å‡†é€ŸæŸ¥</view>
    </view>
  </view>

  <!-- æœºå‹åˆ†ç±»æ ‡ç­¾é¡µ -->
  <view class="qar-tabs">
    <view class="qar-tab {{ activeCategory === 'airbus' ? 'active' : '' }}" data-tab="airbus" bind:tap="onCategoryChange">
      <text class="tab-label">ğŸ›©ï¸ ç©ºå®¢</text>
      <text class="tab-count" wx:if="{{ categoryTabs[0].count > 0 }}">{{ categoryTabs[0].count }}</text>
    </view>
    <view class="qar-tab {{ activeCategory === 'boeing' ? 'active' : '' }}" data-tab="boeing" bind:tap="onCategoryChange">
      <text class="tab-label">âœˆï¸ æ³¢éŸ³</text>
      <text class="tab-count" wx:if="{{ categoryTabs[1].count > 0 }}">{{ categoryTabs[1].count }}</text>
    </view>
    <view class="qar-tab {{ activeCategory === 'other' ? 'active' : '' }}" data-tab="other" bind:tap="onCategoryChange">
      <text class="tab-label">ğŸ›« å…¶ä»–</text>
      <text class="tab-count" wx:if="{{ categoryTabs[2].count > 0 }}">{{ categoryTabs[2].count }}</text>
    </view>
  </view>

  <!-- å­æœºå‹é€‰æ‹© -->
  <view class="aircraft-type-filter">
    <scroll-view class="type-filter-scroll" scroll-x="true" show-scrollbar="false">
      <view class="type-filter-inner">
        <view
          wx:for="{{ aircraftTypes }}"
          wx:key="id"
          class="type-pill {{ activeAircraftType === item.id ? 'active' : '' }}"
          bind:tap="onAircraftTypeChange"
          data-type="{{ item.id }}"
        >
          <text class="type-pill-label">{{ item.name }}</text>
          <text class="type-pill-count">{{ item.count }}é¡¹</text>
        </view>
        <!-- æŸ¥çœ‹é™åˆ¶å€¼æŒ‰é’® -->
        <view class="type-pill limits-pill" bind:tap="onViewLimits">
          <text class="type-pill-label">ğŸ“‹ é™„ä»¶2é™åˆ¶å€¼</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢åŒºåŸŸ -->
  <view class="search-wrapper">
    <van-search
      value="{{ searchValue }}"
      placeholder="æœç´¢ç›‘æ§é¡¹ç›®ã€å‚æ•°ã€é˜¶æ®µ..."
      bind:change="onSearchInput"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>

  <!-- ç»“æœåˆ—è¡¨ -->
  <scroll-view class="result-scroll" scroll-y="true">
    <view wx:if="{{ displayedItems.length === 0 }}" class="no-results">
      <view class="no-results-icon">ğŸ”</view>
      <view class="no-results-text">æœªæ‰¾åˆ°ç›¸å…³ç›‘æ§é¡¹ç›®</view>
      <view class="no-results-tip">è¯•è¯•æ›´çŸ­çš„å…³é”®è¯ï¼Œæˆ–åˆ‡æ¢ä¸Šæ–¹æœºå‹</view>
    </view>

    <view wx:else class="result-list">
      <block wx:for="{{ displayedItems }}" wx:key="id" wx:for-index="idx">
        <view class="result-card" bind:tap="onItemTap" data-item="{{ item }}">
          <view class="card-content">
            <!-- ç®€æ´çš„å¤´éƒ¨ï¼šåºå· + æ ‡é¢˜ -->
            <view class="card-top">
              <view class="item-number">{{ item.id }}</view>
              <view class="item-info">
                <view class="result-title">{{ item.item }}</view>
                <view class="result-meta">
                  <text class="meta-tag">{{ activeAircraftType }}</text>
                  <text wx:if="{{ item.duration }}" class="meta-duration">â± {{ item.duration }}</text>
                </view>
              </view>
            </view>
            
            <!-- æ ¸å¿ƒä¿¡æ¯ -->
            <view class="card-body">
              <view class="info-row">
                <text class="info-label">å‚æ•°</text>
                <text class="info-value">{{ item.parameter }}</text>
              </view>
              <view class="info-row standard-row">
                <text class="info-label">æ ‡å‡†</text>
                <text class="info-value highlight">{{ item.standard }}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- ç¬¬2ä¸ªç»“æœåæ’å…¥å¹¿å‘Š -->
        <view wx:if="{{ idx === 1 && displayedItems.length > 2 && !isAdFree && nativeAdEnabled }}" class="ad-banner-container">
          <ad unit-id="adunit-d7a3b71f5ce0afca" ad-type="banner" ad-intervals="30"></ad>
        </view>
      </block>

      <view wx:if="{{ hasMore }}" class="load-more" bind:tap="onLoadMore">
        <view class="load-more-button">
          <text class="load-more-text">åŠ è½½æ›´å¤š</text>
          <text class="load-more-icon">â†“</text>
        </view>
      </view>

      <view wx:if="{{ !hasMore }}" class="no-more">
        <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨ {{ filteredCount }} æ¡ç›‘æ§é¡¹ç›®</text>
      </view>
    </view>
  </scroll-view>
</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<van-popup
  show="{{ showModal }}"
  position="bottom"
  round
  bind:close="onModalClose"
  custom-style="height: 80%; max-height: 80vh;"
>
  <view wx:if="{{ selectedItem }}" class="detail-popup">
    <!-- ç®€æ´å¤´éƒ¨ -->
    <view class="popup-header">
      <view class="popup-handle"></view>
      <view class="popup-title-row">
        <view class="popup-badges">
          <view class="popup-badge number">{{ selectedItem.id }}</view>
          <view class="popup-badge type">{{ activeAircraftType }}</view>
        </view>
        <view class="popup-close" bind:tap="onModalClose">âœ•</view>
      </view>
      <view class="popup-title">{{ selectedItem.item }}</view>
    </view>

    <scroll-view class="popup-body" scroll-y="true">
      <!-- æ ¸å¿ƒç›‘æ§ä¿¡æ¯ -->
      <view class="info-card">
        <view class="info-item">
          <text class="info-icon">ğŸ“ˆ</text>
          <view class="info-text">
            <text class="info-title">ç›‘æ§å‚æ•°</text>
            <text class="info-desc">{{ selectedItem.parameter }}</text>
          </view>
        </view>
        
        <view class="info-item">
          <text class="info-icon">â±</text>
          <view class="info-text">
            <text class="info-title">ç›‘æ§é˜¶æ®µ</text>
            <text class="info-desc">{{ selectedItem.phase }}</text>
          </view>
        </view>
        
        <view class="info-item highlight-item">
          <text class="info-icon">âš ï¸</text>
          <view class="info-text">
            <text class="info-title">ç›‘æ§æ ‡å‡†</text>
            <text class="info-desc danger">{{ selectedItem.standard }}</text>
          </view>
        </view>
        
        <view wx:if="{{ selectedItem.duration }}" class="info-item">
          <text class="info-icon">â³</text>
          <view class="info-text">
            <text class="info-title">æŒç»­æ—¶é—´</text>
            <text class="info-desc">{{ selectedItem.duration }}</text>
          </view>
        </view>
      </view>

      <!-- å¤‡æ³¨è¯´æ˜ -->
      <view wx:if="{{ selectedItem.remark }}" class="remark-card">
        <text class="remark-label">ğŸ“ å¤‡æ³¨è¯´æ˜</text>
        <text class="remark-content">{{ selectedItem.remark }}</text>
      </view>

      <!-- æŸ¥çœ‹é™åˆ¶å€¼ - åªåœ¨å¤‡æ³¨åŒ…å«"è§é™„ä»¶2"æ—¶æ˜¾ç¤º -->
      <view wx:if="{{ selectedItem.remark && selectedItem.remark.indexOf('é™„ä»¶2') !== -1 }}" class="action-card" bind:tap="onViewLimits">
        <text class="action-icon">ğŸ“‹</text>
        <text class="action-text">æŸ¥çœ‹ {{ activeAircraftType }} é™åˆ¶å€¼</text>
        <text class="action-arrow">â†’</text>
      </view>

      <!-- æ¥æº -->
      <view class="source-card">
        <text class="source-label">æ¥æºï¼š{{ docInfo.title }}</text>
        <text class="source-number">{{ docInfo.documentNumber }}</text>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="popup-footer">
      <view class="close-btn" bind:tap="onModalClose">å…³é—­</view>
    </view>
  </view>
</van-popup>

<!-- é™åˆ¶å€¼å¼¹çª— -->
<van-popup
  show="{{ showLimitsModal }}"
  position="bottom"
  round
  bind:close="onLimitsModalClose"
  custom-style="height: 85%; max-height: 85vh;"
>
  <view class="detail-popup">
    <!-- ç®€æ´å¤´éƒ¨ -->
    <view class="popup-header">
      <view class="popup-handle"></view>
      <view class="popup-title-row">
        <view class="popup-badges">
          <view class="popup-badge limits">ğŸ“‹ é™„ä»¶2</view>
        </view>
        <view class="popup-close" bind:tap="onLimitsModalClose">âœ•</view>
      </view>
      <view class="popup-title">{{ activeAircraftType }} é™åˆ¶å€¼</view>
    </view>

    <scroll-view class="popup-body" scroll-y="true">
      <view wx:if="{{ currentLimits }}" class="info-card">
        <view wx:if="{{ currentLimits.tailStrikeAngle }}" class="info-item">
          <text class="info-icon">âœˆï¸</text>
          <view class="info-text">
            <text class="info-title">æ“¦å°¾è§’åº¦</text>
            <text class="info-desc">{{ currentLimits.tailStrikeAngle }}</text>
          </view>
        </view>

        <view wx:if="{{ currentLimits.flapSpeed }}" class="info-item">
          <text class="info-icon">ğŸ›©ï¸</text>
          <view class="info-text">
            <text class="info-title">è¥Ÿç¿¼é™åˆ¶é€Ÿåº¦ (VFE)</text>
            <text class="info-desc">{{ currentLimits.flapSpeed }}</text>
          </view>
        </view>

        <view wx:if="{{ currentLimits.engineSpeed }}" class="info-item">
          <text class="info-icon">âš™ï¸</text>
          <view class="info-text">
            <text class="info-title">å‘åŠ¨æœºè½¬é€Ÿé™åˆ¶</text>
            <text class="info-desc">{{ currentLimits.engineSpeed }}</text>
          </view>
        </view>

        <view wx:if="{{ currentLimits.vibration }}" class="info-item">
          <text class="info-icon">ğŸ“³</text>
          <view class="info-text">
            <text class="info-title">æŒ¯åŠ¨å€¼é™åˆ¶</text>
            <text class="info-desc">{{ currentLimits.vibration }}</text>
          </view>
        </view>

        <view wx:if="{{ currentLimits.minFuel }}" class="info-item">
          <text class="info-icon">â›½</text>
          <view class="info-text">
            <text class="info-title">æœ€ä½æ²¹é‡</text>
            <text class="info-desc">{{ currentLimits.minFuel }}</text>
          </view>
        </view>

        <view wx:if="{{ currentLimits.takeoffEGT }}" class="info-item">
          <text class="info-icon">ğŸŒ¡ï¸</text>
          <view class="info-text">
            <text class="info-title">èµ·é£EGTé™åˆ¶</text>
            <text class="info-desc">{{ currentLimits.takeoffEGT }}</text>
          </view>
        </view>
      </view>

      <view wx:else class="no-results">
        <view class="no-results-icon">ğŸ“‹</view>
        <view class="no-results-text">æš‚æ— é™åˆ¶å€¼æ•°æ®</view>
      </view>

      <!-- æ¥æº -->
      <view class="source-card">
        <text class="source-label">æ¥æºï¼š{{ docInfo.title }} - é™„ä»¶2</text>
        <text class="source-number">{{ docInfo.documentNumber }}</text>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <view class="popup-footer">
      <view class="close-btn" bind:tap="onLimitsModalClose">å…³é—­</view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />

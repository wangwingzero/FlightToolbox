<view class="container page-content">
  <!-- åˆ†ç±»ç­›é€‰æ ‡ç­¾ - ç½®é¡¶ -->
  <view class="category-filter-container">
    <scroll-view scroll-x class="category-scroll" enable-flex show-scrollbar="{{ false }}">
      <view class="category-tags">
        <view
          wx:for="{{ categoryList }}"
          wx:key="id"
          class="category-tag {{ selectedCategory === item.id ? 'active' : '' }}"
          bind:tap="onCategoryTap"
          data-category="{{ item.id }}"
        >
          <view class="category-badge">{{ item.count }}</view>
          <view class="category-title">{{ item.name }}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢åŒºåŸŸ -->
  <view class="search-section">
    <van-search
      value="{{ searchValue }}"
      placeholder="æœç´¢æœ¯è¯­åç§°ã€å®šä¹‰å†…å®¹æˆ–æ¥æº"
      bind:change="onSearchInput"
      bind:clear="onSearchClear"
      bind:focus="onSearchFocus"
      bind:blur="onSearchBlur"
      shape="round"
    />

    <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
    <view wx:if="{{ filteredCount !== totalCount }}" class="search-stats">
      <view class="stats-content">
        <text class="stats-icon">âœ…</text>
        <text class="stats-text">æ‰¾åˆ° {{ filteredCount }} æ¡ç»“æœ</text>
      </view>
    </view>
  </view>

  <!-- å®šä¹‰åˆ—è¡¨ -->
  <view class="definitions-container">
    <!-- ç©ºçŠ¶æ€ -->
    <van-empty 
      wx:if="{{ displayedDefinitions.length === 0 }}"
      image="search"
      description="æœªæ‰¾åˆ°ç›¸å…³å®šä¹‰"
    />
    
    <!-- å®šä¹‰åˆ—è¡¨ -->
    <view wx:else class="definitions-list">
      <block wx:for="{{ displayedDefinitions }}" wx:key="id" wx:for-index="idx">
        <view 
          class="definition-card" 
          bind:tap="onDefinitionTap"
          data-definition="{{ item }}"
        >
          <!-- å¡ç‰‡å¤´éƒ¨ -->
          <view class="card-header">
            <view class="card-title">{{ item.chinese_name }}</view>
            <view class="source-tag">{{ item.source }}</view>
          </view>
          
          <!-- è‹±æ–‡åç§° -->
          <view class="english-name">{{ item.english_name }}</view>
          
          <!-- å®šä¹‰å†…å®¹åŒºåŸŸ -->
          <view class="definition-box">
            <view class="definition-text">{{ item.definition }}</view>
          </view>
          
          <!-- æ“ä½œæç¤º -->
          <view class="action-hint">
            <view class="hint-icon">ğŸ‘†</view>
            <view class="hint-text">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹</view>
          </view>
        </view>
      </block>
      
      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{ hasMore }}" class="load-more-container">
        <view class="load-more-btn" bind:tap="onLoadMore">
          <van-loading type="spinner" size="16px" />
          <text class="load-more-text">åŠ è½½æ›´å¤š</text>
        </view>
      </view>
      
      <!-- å·²åŠ è½½å…¨éƒ¨ -->
      <view wx:else class="load-complete">
        <view class="load-complete-text">å·²æ˜¾ç¤ºå…¨éƒ¨ {{ filteredCount }} æ¡å®šä¹‰</view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½è¯´æ˜ -->
  <view class="tips-section">
    <view class="tips-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</view>
    <view class="tips-content">
      <view class="tip-item">â€¢ æä¾›èˆªç©ºä¸“ä¸šæœ¯è¯­çš„æƒå¨å®šä¹‰æŸ¥è¯¢</view>
      <view class="tip-item">â€¢ æ”¯æŒä¸­è‹±æ–‡æœ¯è¯­åç§°å’Œå®šä¹‰å†…å®¹æœç´¢</view>
      <view class="tip-item">â€¢ ç‚¹å‡»ä»»æ„å®šä¹‰å¯å¤åˆ¶å®Œæ•´å†…å®¹åˆ°å‰ªè´´æ¿</view>
      <view class="tip-item">â€¢ æ”¯æŒç¦»çº¿ä½¿ç”¨ï¼Œæ— éœ€ç½‘ç»œè¿æ¥</view>
      <view class="tip-item">â€¢ æ‰€æœ‰å®šä¹‰å‡æ¥è‡ªå®˜æ–¹æƒå¨æ–‡ä»¶</view>
    </view>
  </view>

</view>

<!-- è¯¦æƒ…å¼¹çª— - å‚è€ƒIOSAè®¾è®¡ -->
<van-popup
  show="{{ showModal }}"
  bind:close="onModalClose"
  position="bottom"
  round="{{ true }}"
  close-on-click-overlay="{{ true }}"
  custom-style="height: 85vh; overflow: hidden;"
>
  <view class="detail-popup-container">
    <!-- å¼¹çª—æ ‡é¢˜æ  -->
    <view class="detail-header">
      <view class="header-left">
        <view wx:if="{{ canGoBack }}" class="back-btn" catchtap="goBackInHistory">
          <van-icon name="arrow-left" class="back-icon" />
        </view>
      </view>
      <view class="detail-title">{{ selectedDefinition.chinese_name }}</view>
      <view class="header-right">
        <view class="close-btn" catchtap="onModalClose">
          <van-icon name="cross" class="close-icon" />
        </view>
      </view>
    </view>

    <!-- æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
    <scroll-view scroll-y class="detail-content" enable-flex enhanced show-scrollbar="{{ false }}">
      <!-- æœ¯è¯­å®šä¹‰è¯¦æƒ… -->
      <view class="definition-detail">
        <van-cell-group title="æœ¯è¯­ä¿¡æ¯" class="detail-section">
          <van-cell title="ä¸­æ–‡åç§°" value="{{ selectedDefinition.chinese_name }}" />
          <van-cell wx:if="{{ selectedDefinition.english_name }}" title="è‹±æ–‡åç§°" value="{{ selectedDefinition.english_name }}" />
        </van-cell-group>

        <van-cell-group title="å®šä¹‰å†…å®¹" class="detail-section">
          <view class="description-content definition-content-box" bind:tap="onCopyDefinitionContent">
            <!-- ä½¿ç”¨è§£æåçš„definitionPartsæ¸²æŸ“å¸¦æœ¯è¯­é“¾æ¥çš„å†…å®¹ -->
            <view class="description-text">
              <block wx:if="{{ selectedDefinition.definitionParts && selectedDefinition.definitionParts.length > 0 }}">
                <block wx:for="{{ selectedDefinition.definitionParts }}" wx:key="index">
                  <text wx:if="{{ item.type === 'text' }}">{{ item.text }}</text>
                  <text wx:elif="{{ item.type === 'term' }}"
                        class="term-highlight clickable-term"
                        catchtap="onTermClick"
                        data-term="{{ item.termName }}">{{ item.text }}</text>
                </block>
              </block>
              <text wx:else>{{ selectedDefinition.definition }}</text>
            </view>
          </view>
        </van-cell-group>

        <van-cell-group title="æ¥æº" class="detail-section">
          <view class="description-content">
            <view class="source-text">{{ selectedDefinition.source }}</view>
          </view>
        </van-cell-group>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="detail-footer">
      <view wx:if="{{ canGoBack }}" class="footer-buttons">
        <view class="back-button" bind:tap="goBackInHistory">
          <van-icon name="arrow-left" class="button-icon" />
          <text>è¿”å›</text>
        </view>
        <view class="close-button" bind:tap="onModalClose">
          <van-icon name="cross" class="button-icon" />
          <text>å…³é—­</text>
        </view>
      </view>
      <view wx:else class="close-button-single" bind:tap="onModalClose">
        <van-icon name="cross" class="button-icon" />
        <text>å…³é—­</text>
      </view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />
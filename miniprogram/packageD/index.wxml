<view class="container page-content">
  <!-- 分类筛选标签 - 置顶 -->
  <view class="category-filter-container">
    <scroll-view scroll-x class="category-scroll" enable-flex show-scrollbar="{{ false }}">
      <view class="category-tags">
        <view
          wx:for="{{ categoryList }}"
          wx:key="id"
          class="category-tag tag-{{ item.id }} {{ selectedCategory === item.id ? 'active' : '' }}"
          bind:tap="onCategoryTap"
          data-category="{{ item.id }}"
        >
          <view class="category-badge">{{ item.count }}</view>
          <view class="category-title">{{ item.name }}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 搜索区域 -->
  <view class="search-section">
    <view class="premium-search-box {{ searchFocused ? 'focused' : '' }}">
      <view class="search-icon-wrapper">
        <van-icon name="search" size="20px" color="#6366f1" />
      </view>

      <input
        class="premium-search-input"
        value="{{ searchValue }}"
        placeholder="搜索术语名称、定义内容或来源"
        placeholder-class="premium-search-placeholder"
        bindinput="onSearchInput"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
        bindconfirm="onSearchConfirm"
        confirm-type="search"
      />

      <view wx:if="{{ searchValue }}" class="search-clear-btn" bind:tap="onSearchClear">
        <van-icon name="clear" size="18px" color="#9ca3af" />
      </view>
    </view>

    <!-- 搜索结果统计 -->
    <view wx:if="{{ filteredCount !== totalCount }}" class="search-stats">
      <view class="stats-content">
        <text class="stats-icon">✅</text>
        <text class="stats-text">找到 {{ filteredCount }} 条结果</text>
      </view>
    </view>
  </view>

  <!-- 定义列表 -->
  <view class="definitions-container">
    <!-- 空状态 -->
    <van-empty 
      wx:if="{{ displayedDefinitions.length === 0 }}"
      image="search"
      description="未找到相关定义"
    />
    
    <!-- 定义列表 -->
    <view wx:else class="definitions-list">
      <block wx:for="{{ displayedDefinitions }}" wx:key="id" wx:for-index="idx">
        <view
          class="definition-card card-{{ item.category }}"
          bind:tap="onDefinitionTap"
          data-definition="{{ item }}"
        >
          <!-- 卡片头部 -->
          <view class="card-header">
            <view class="card-title">{{ item.chinese_name }}</view>
            <view class="source-tag">{{ item.source }}</view>
          </view>

          <!-- 英文名称 -->
          <view class="english-name">{{ item.english_name }}</view>

          <!-- 定义内容区域 -->
          <view class="definition-box">
            <view class="definition-text">{{ item.definition }}</view>
          </view>

          <!-- 操作提示 -->
          <view class="action-hint">
            <view class="hint-icon">👆</view>
            <view class="hint-text">点击查看详细内容</view>
          </view>
        </view>

      </block>
      
      <!-- 加载更多 -->
      <view wx:if="{{ hasMore }}" class="load-more-container">
        <view class="load-more-btn" bind:tap="onLoadMore">
          <van-loading type="spinner" size="16px" />
          <text class="load-more-text">加载更多</text>
        </view>
      </view>
      
      <!-- 已加载全部 -->
      <view wx:else class="load-complete">
        <view class="load-complete-text">已显示全部 {{ filteredCount }} 条定义</view>
      </view>
    </view>
  </view>

  <!-- 使用说明上方横幅广告 -->
  <view wx:if="{{ !isAdFree }}" class="ad-banner-container">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"
        bindload="onAdLoad" binderror="onAdError"></ad>
  </view>

  <!-- 功能说明 -->
  <view class="tips-section">
    <view class="tips-title">💡 使用说明</view>
    <view class="tips-content">
      <view class="tip-item">• 提供航空专业术语的权威定义查询</view>
      <view class="tip-item">• 支持中英文术语名称和定义内容搜索</view>
      <view class="tip-item">• 点击任意定义可复制完整内容到剪贴板</view>
      <view class="tip-item">• 支持离线使用，无需网络连接</view>
      <view class="tip-item">• 所有定义均来自官方权威文件</view>
    </view>
  </view>

</view>

<!-- 详情弹窗 - 参考IOSA设计 -->
<van-popup
  show="{{ showModal }}"
  bind:close="onModalClose"
  position="bottom"
  round="{{ true }}"
  close-on-click-overlay="{{ true }}"
  custom-style="height: 85vh; overflow: hidden;"
>
  <view class="detail-popup-container">
    <!-- 弹窗标题栏 -->
    <view class="detail-header">
      <view class="header-left">
        <view wx:if="{{ canGoBack }}" class="back-btn" catchtap="goBackInHistory">
          <van-icon name="arrow-left" class="back-icon" />
        </view>
      </view>
      <view class="detail-title">{{ selectedDefinition.chinese_name }}</view>
      <view class="header-right">
        <view class="close-btn" catchtap="onModalClose">
          <van-icon name="cross" class="close-icon" />
        </view>
      </view>
    </view>

    <!-- 滚动内容区域 -->
    <scroll-view scroll-y class="detail-content" enable-flex enhanced show-scrollbar="{{ false }}">
      <!-- 术语定义详情 -->
      <view class="definition-detail">
        <van-cell-group title="术语信息" class="detail-section">
          <van-cell title="中文名称" value="{{ selectedDefinition.chinese_name }}" />
          <van-cell wx:if="{{ selectedDefinition.english_name }}" title="英文名称" value="{{ selectedDefinition.english_name }}" />
        </van-cell-group>

        <van-cell-group title="定义内容" class="detail-section">
          <view class="description-content definition-content-box" bind:tap="onCopyDefinitionContent">
            <!-- 使用解析后的definitionParts渲染带术语链接的内容 -->
            <view class="description-text">
              <block wx:if="{{ selectedDefinition.definitionParts && selectedDefinition.definitionParts.length > 0 }}">
                <block wx:for="{{ selectedDefinition.definitionParts }}" wx:key="index">
                  <text wx:if="{{ item.type === 'text' }}">{{ item.text }}</text>
                  <text wx:elif="{{ item.type === 'term' }}"
                        class="term-highlight clickable-term"
                        catchtap="onTermClick"
                        data-term="{{ item.termName }}">{{ item.text }}</text>
                </block>
              </block>
              <text wx:else>{{ selectedDefinition.definition }}</text>
            </view>
          </view>
        </van-cell-group>

        <van-cell-group title="来源" class="detail-section">
          <view class="description-content">
            <view class="source-text">{{ selectedDefinition.source }}</view>
          </view>
        </van-cell-group>
      </view>
    </scroll-view>

    <!-- 底部操作栏 -->
    <view class="detail-footer">
      <view wx:if="{{ canGoBack }}" class="footer-buttons">
        <view class="back-button" bind:tap="goBackInHistory">
          <van-icon name="arrow-left" class="button-icon" />
          <text>返回</text>
        </view>
        <view class="close-button" bind:tap="onModalClose">
          <van-icon name="cross" class="button-icon" />
          <text>关闭</text>
        </view>
      </view>
      <view wx:else class="close-button-single" bind:tap="onModalClose">
        <van-icon name="cross" class="button-icon" />
        <text>关闭</text>
      </view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-title">ğŸŒ {{ isEnglish ? 'International Communication Failure Procedures' : 'å›½é™…é€šä¿¡å¤±æ•ˆç¨‹åº' }}</view>
    <view class="header-subtitle">{{ isEnglish ? (procedureData.document && procedureData.document.en) || 'ICAO Doc 4444 - PANS-ATM' : (procedureData.document && procedureData.document.cn) || 'Doc 4444 - ç©ºä¸­èˆªè¡ŒæœåŠ¡ç¨‹åº' }}</view>
  </view>

  <!-- æ¨ªå¹…å¹¿å‘Š -->
  <view wx:if="{{ !isAdFree }}" class="ad-container">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-intervals="30" bindload="adLoad" binderror="adError" bindclose="adClose"></ad>
  </view>

  <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
  <view class="section-card">
    <view class="language-switcher">
      <view class="lang-btn {{ !isEnglish ? 'active' : '' }}" bind:tap="selectChinese">ä¸­æ–‡</view>
      <view class="lang-btn {{ isEnglish ? 'active' : '' }}" bind:tap="selectEnglish">English</view>
    </view>
  </view>

  <!-- ä¸€èˆ¬ç¨‹åº -->
  <view class="section-card">
    <view class="section-title">
      <text class="section-icon">ğŸ“¡</text>
      <text class="section-text">{{ isEnglish ? 'General Procedures' : 'ä¸€èˆ¬ç¨‹åº' }}</text>
    </view>
    <view class="content-box">
      <view class="procedure-step">
        <view class="step-number">ğŸ“¡</view>
        <view class="step-content">
          <view class="step-title">{{ isEnglish ? 'Transponder Code' : 'åº”ç­”æœºç¼–ç ' }}</view>
          <view class="step-description">{{ isEnglish ? (procedureData.general_procedures && procedureData.general_procedures.transponder_code && procedureData.general_procedures.transponder_code.en) : (procedureData.general_procedures && procedureData.general_procedures.transponder_code && procedureData.general_procedures.transponder_code.cn) }}</view>
        </view>
      </view>
      <view class="procedure-step">
        <view class="step-number">ğŸ“¶</view>
        <view class="step-content">
          <view class="step-title">ADS-B/ADS-C</view>
          <view class="step-description">{{ isEnglish ? (procedureData.general_procedures && procedureData.general_procedures.ads_b_ads_c && procedureData.general_procedures.ads_b_ads_c.en) : (procedureData.general_procedures && procedureData.general_procedures.ads_b_ads_c && procedureData.general_procedures.ads_b_ads_c.cn) }}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç®¡åˆ¶éƒ¨é—¨è¡ŒåŠ¨ -->
  <view class="section-card">
    <view class="section-title">
      <text class="section-icon">ğŸ¢</text>
      <text class="section-text">{{ isEnglish ? 'Action by ATC' : 'ç®¡åˆ¶éƒ¨é—¨è¡ŒåŠ¨' }}</text>
    </view>
    <view class="content-box">
      <view class="atc-action-item" wx:if="{{ procedureData.action_by_atc }}">
        <view class="action-number">1</view>
        <view class="action-content">{{ isEnglish ? (procedureData.action_by_atc.immediate_action && procedureData.action_by_atc.immediate_action.en) : (procedureData.action_by_atc.immediate_action && procedureData.action_by_atc.immediate_action.cn) }}</view>
      </view>
      <view class="atc-action-item" wx:if="{{ procedureData.action_by_atc }}">
        <view class="action-number">2</view>
        <view class="action-content">{{ isEnglish ? (procedureData.action_by_atc.separation && procedureData.action_by_atc.separation.en) : (procedureData.action_by_atc.separation && procedureData.action_by_atc.separation.cn) }}</view>
      </view>
      <view class="atc-action-item" wx:if="{{ procedureData.action_by_atc }}">
        <view class="action-number">3</view>
        <view class="action-content">{{ isEnglish ? (procedureData.action_by_atc.blind_transmission && procedureData.action_by_atc.blind_transmission.en) : (procedureData.action_by_atc.blind_transmission && procedureData.action_by_atc.blind_transmission.cn) }}</view>
      </view>
      <view class="atc-action-item" wx:if="{{ procedureData.action_by_atc }}">
        <view class="action-number">4</view>
        <view class="action-content">{{ isEnglish ? (procedureData.action_by_atc.nearby_aircraft && procedureData.action_by_atc.nearby_aircraft.en) : (procedureData.action_by_atc.nearby_aircraft && procedureData.action_by_atc.nearby_aircraft.cn) }}</view>
      </view>
      <view class="atc-action-item" wx:if="{{ procedureData.action_by_atc }}">
        <view class="action-number">5</view>
        <view class="action-content">{{ isEnglish ? (procedureData.action_by_atc.coordination && procedureData.action_by_atc.coordination.en) : (procedureData.action_by_atc.coordination && procedureData.action_by_atc.coordination.cn) }}</view>
      </view>
      <view class="atc-action-item" wx:if="{{ procedureData.action_by_atc }}">
        <view class="action-number">6</view>
        <view class="action-content">{{ isEnglish ? (procedureData.action_by_atc.restoration && procedureData.action_by_atc.restoration.en) : (procedureData.action_by_atc.restoration && procedureData.action_by_atc.restoration.cn) }}</view>
      </view>
      <view class="atc-action-item" wx:if="{{ procedureData.action_by_atc }}">
        <view class="action-number">7</view>
        <view class="action-content">{{ isEnglish ? (procedureData.action_by_atc.time_limit && procedureData.action_by_atc.time_limit.en) : (procedureData.action_by_atc.time_limit && procedureData.action_by_atc.time_limit.cn) }}</view>
      </view>
    </view>
  </view>

  <!-- èˆªç©ºå™¨è¡ŒåŠ¨ -->
  <view class="section-card">
    <view class="section-title">
      <text class="section-icon">âœˆï¸</text>
      <text class="section-text">{{ isEnglish ? 'Action by Aircraft' : 'èˆªç©ºå™¨è¡ŒåŠ¨' }}</text>
    </view>
    <view class="content-box">
      <!-- æ°”è±¡æ¡ä»¶é€‰æ‹© -->
      <view class="weather-tabs">
        <view class="tab-item {{ selectedWeather === 'vmc' ? 'active' : '' }}" 
              bind:tap="selectWeather" data-type="vmc">
          <text class="tab-text">{{ isEnglish ? 'VMC Conditions' : 'VMCæ¡ä»¶' }}</text>
        </view>
        <view class="tab-item {{ selectedWeather === 'imc' ? 'active' : '' }}" 
              bind:tap="selectWeather" data-type="imc">
          <text class="tab-text">{{ isEnglish ? 'IMC Conditions' : 'IMCæ¡ä»¶' }}</text>
        </view>
      </view>

      <!-- VMCæ¡ä»¶ç¨‹åº -->
      <view wx:if="{{ selectedWeather === 'vmc' }}" class="weather-content">
        <view class="weather-title">{{ isEnglish ? (procedureData.action_by_aircraft && procedureData.action_by_aircraft.vfr_conditions && procedureData.action_by_aircraft.vfr_conditions.description && procedureData.action_by_aircraft.vfr_conditions.description.en) : (procedureData.action_by_aircraft && procedureData.action_by_aircraft.vfr_conditions && procedureData.action_by_aircraft.vfr_conditions.description && procedureData.action_by_aircraft.vfr_conditions.description.cn) }}</view>
        <view class="steps-list">
          <view wx:for="{{ procedureData.action_by_aircraft.vfr_conditions.steps }}" 
                wx:key="index" class="step-item">
            <view class="step-bullet">{{ index + 1 }}</view>
            <view class="step-text">{{ isEnglish ? item.en : item.cn }}</view>
          </view>
        </view>
      </view>

      <!-- IMCæ¡ä»¶ç¨‹åº -->
      <view wx:if="{{ selectedWeather === 'imc' }}" class="weather-content">
        <view class="weather-title">{{ isEnglish ? (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.description && procedureData.action_by_aircraft.imc_conditions.description.en) : (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.description && procedureData.action_by_aircraft.imc_conditions.description.cn) }}</view>
        
        <!-- é€Ÿåº¦å’Œé«˜åº¦å±‚ -->
        <view class="imc-section">
          <view class="imc-subtitle">{{ isEnglish ? 'Speed and Level' : 'é€Ÿåº¦å’Œé«˜åº¦å±‚' }}</view>
          <view class="separation-tabs">
            <view class="separation-tab {{ selectedSeparation === 'procedural' ? 'active' : '' }}" 
                  bind:tap="selectSeparation" data-type="procedural">
              <text class="tab-text">{{ isEnglish ? 'Procedural Separation' : 'ç¨‹åºé—´éš”' }}</text>
            </view>
            <view class="separation-tab {{ selectedSeparation === 'surveillance' ? 'active' : '' }}" 
                  bind:tap="selectSeparation" data-type="surveillance">
              <text class="tab-text">{{ isEnglish ? 'ATS Surveillance' : 'ATSç›‘è§†' }}</text>
            </view>
          </view>
          
          <view wx:if="{{ selectedSeparation === 'procedural' }}" class="separation-content">
            <view class="separation-description">
              {{ isEnglish ? (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.procedural_separation && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.procedural_separation.en) : (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.procedural_separation && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.procedural_separation.cn) }}
            </view>
          </view>
          
          <view wx:if="{{ selectedSeparation === 'surveillance' }}" class="separation-content">
            <view class="separation-description">
              {{ isEnglish ? (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.ats_surveillance && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.ats_surveillance.en) : (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.ats_surveillance && procedureData.action_by_aircraft.imc_conditions.steps.speed_and_level.ats_surveillance.cn) }}
            </view>
          </view>
        </view>

        <!-- èˆªè·¯ -->
        <view class="imc-section">
          <view class="imc-subtitle">{{ isEnglish ? 'Route' : 'èˆªè·¯' }}</view>
          <view class="imc-description">
            {{ isEnglish ? (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.route && procedureData.action_by_aircraft.imc_conditions.steps.route.en) : (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.route && procedureData.action_by_aircraft.imc_conditions.steps.route.cn) }}
          </view>
        </view>

        <!-- ä¸‹é™å’Œè¿›è¿‘ -->
        <view class="imc-section">
          <view class="imc-subtitle">{{ isEnglish ? 'Descent and Approach' : 'ä¸‹é™å’Œè¿›è¿‘' }}</view>
          <view class="imc-description">
            {{ isEnglish ? (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.descent_and_approach && procedureData.action_by_aircraft.imc_conditions.steps.descent_and_approach.en) : (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.descent_and_approach && procedureData.action_by_aircraft.imc_conditions.steps.descent_and_approach.cn) }}
          </view>
        </view>

        <!-- ç€é™† -->
        <view class="imc-section">
          <view class="imc-subtitle">{{ isEnglish ? 'Landing' : 'ç€é™†' }}</view>
          <view class="imc-description">
            {{ isEnglish ? (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.landing && procedureData.action_by_aircraft.imc_conditions.steps.landing.en) : (procedureData.action_by_aircraft && procedureData.action_by_aircraft.imc_conditions && procedureData.action_by_aircraft.imc_conditions.steps && procedureData.action_by_aircraft.imc_conditions.steps.landing && procedureData.action_by_aircraft.imc_conditions.steps.landing.cn) }}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åœ°åŒºå·®å¼‚ç¨‹åº -->
  <view class="section-card">
    <view class="section-title" bind:tap="toggleRegionDifferences">
      <text class="section-icon">ğŸŒ</text>
      <text class="section-text">{{ isEnglish ? 'Regional Differences Procedures' : 'åœ°åŒºå·®å¼‚ç¨‹åº' }}</text>
      <text class="toggle-icon">{{ showRegionDifferences ? 'â–¼' : 'â–¶' }}</text>
    </view>
    
    <view wx:if="{{ showRegionDifferences }}" class="content-box">
      <!-- åœ°åŒºé€‰æ‹© -->
      <view class="region-tabs">
        <scroll-view scroll-x="true" class="region-scroll">
          <view class="region-list">
            <view wx:for="{{ regionDifferences }}" 
                  wx:key="index" 
                  wx:for-item="regionInfo"
                  wx:for-index="regionKey"
                  class="region-tab {{ selectedRegion === regionKey ? 'active' : '' }}"
                  bind:tap="selectRegion" 
                  data-region="{{ regionKey }}">
              <text class="region-icon">{{ regionInfo.icon }}</text>
              <text class="region-name">{{ regionInfo.name }}</text>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- å›½å®¶/åœ°åŒºåˆ—è¡¨ -->
      <view wx:if="{{ selectedRegion }}" class="countries-section">
        <view class="countries-title">{{ isEnglish ? 'Select Country/Region:' : 'é€‰æ‹©å›½å®¶/åœ°åŒºï¼š' }}</view>
        <view class="countries-grid">
          <view wx:for="{{ regionDifferences[selectedRegion].data }}" 
                wx:key="index"
                wx:for-item="countryInfo"
                wx:for-index="countryKey"
                class="country-card {{ selectedCountry === countryKey ? 'active' : '' }}"
                bind:tap="selectCountry"
                data-country="{{ countryKey }}">
            <view class="country-name">{{ isEnglish ? countryInfo.region_name_en : countryInfo.region_name_cn }}</view>
            <view class="country-name-en">{{ isEnglish ? countryInfo.region_name_cn : countryInfo.region_name_en }}</view>
          </view>
        </view>
      </view>

      <!-- å…·ä½“å·®å¼‚ç¨‹åº -->
      <view wx:if="{{ selectedCountry && regionDifferences[selectedRegion].data[selectedCountry] }}" class="country-details">
        <view class="country-header">
          <view class="country-title">
            {{ isEnglish ? regionDifferences[selectedRegion].data[selectedCountry].region_name_en : regionDifferences[selectedRegion].data[selectedCountry].region_name_cn }}
          </view>
          <view class="copy-btn" bind:tap="copyRegionProcedure" data-country="{{ selectedCountry }}">
            <text class="copy-icon">ğŸ“‹</text>
            <text class="copy-text">{{ isEnglish ? 'Copy' : 'å¤åˆ¶' }}</text>
          </view>
        </view>

        <!-- ICAOå·®å¼‚ -->
        <view class="difference-section">
          <view class="difference-title">ğŸ”„ {{ isEnglish ? 'ICAO Standard Differences' : 'ä¸ICAOæ ‡å‡†å·®å¼‚' }}</view>
          <view class="difference-content">
            {{ isEnglish ? regionDifferences[selectedRegion].data[selectedCountry].icao_differences.en : regionDifferences[selectedRegion].data[selectedCountry].icao_differences.cn }}
          </view>
        </view>

        <!-- å…·ä½“ç¨‹åº -->
        <view class="procedures-section">
          <view class="procedures-title">ğŸ“ {{ isEnglish ? 'Specific Procedures' : 'å…·ä½“ç¨‹åº' }}</view>
          <view class="procedures-list">
            <view wx:for="{{ regionDifferences[selectedRegion].data[selectedCountry].procedures }}" 
                  wx:key="index" 
                  class="procedure-item">
              <view class="procedure-number">{{ index + 1 }}</view>
              <view class="procedure-content">
                <view class="procedure-text">{{ isEnglish ? item.en : item.cn }}</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æç¤ºä¿¡æ¯ -->
      <view wx:if="{{ !selectedRegion }}" class="no-selection">
        <text class="no-selection-icon">ğŸ‘†</text>
        <text class="no-selection-text">{{ isEnglish ? 'Please select a region to view difference procedures' : 'è¯·é€‰æ‹©åœ°åŒºæŸ¥çœ‹å·®å¼‚ç¨‹åº' }}</text>
      </view>
      
      <view wx:if="{{ selectedRegion && !selectedCountry }}" class="no-selection">
        <text class="no-selection-icon">ğŸ‘†</text>
        <text class="no-selection-text">{{ isEnglish ? 'Please select a country/region to view specific procedures' : 'è¯·é€‰æ‹©å›½å®¶/åœ°åŒºæŸ¥çœ‹å…·ä½“ç¨‹åº' }}</text>
      </view>
    </view>
  </view>

  <!-- å…³é”®æé†’ -->
  <view class="key-reminders">
    <view class="reminder-title">ğŸ”” {{ isEnglish ? 'Key Reminders' : 'å…³é”®æé†’' }}</view>
    <view class="reminder-list">
      <view class="reminder-item">
        <text class="reminder-icon">âš ï¸</text>
        <text class="reminder-text">{{ isEnglish ? 'Immediately set transponder to Mode A Code 7600' : 'ç«‹å³è®¾ç½®åº”ç­”æœºç¼–ç  Aæ¨¡å¼ 7600' }}</text>
      </view>
      <view class="reminder-item">
        <text class="reminder-icon">ğŸ“¡</text>
        <text class="reminder-text">{{ isEnglish ? 'Attempt to restore communication through data link and other means' : 'å°è¯•é€šè¿‡æ•°æ®é“¾ç­‰æ‰‹æ®µæ¢å¤é€šä¿¡' }}</text>
      </view>
      <view class="reminder-item">
        <text class="reminder-icon">ğŸ•</text>
        <text class="reminder-text">{{ isEnglish ? 'Pay attention to time requirements under IMC conditions (7 minutes or 20 minutes)' : 'IMCæ¡ä»¶ä¸‹æ³¨æ„æ—¶é—´è¦æ±‚ï¼ˆ7åˆ†é’Ÿæˆ–20åˆ†é’Ÿï¼‰' }}</text>
      </view>
      <view class="reminder-item">
        <text class="reminder-icon">ğŸ›¬</text>
        <text class="reminder-text">{{ isEnglish ? 'Land within 30 minutes after estimated time of arrival' : 'åœ¨é¢„è®¡åˆ°è¾¾æ—¶é—´30åˆ†é’Ÿå†…ç€é™†' }}</text>
      </view>
      <view class="reminder-item">
        <text class="reminder-icon">ğŸŒ</text>
        <text class="reminder-text">{{ isEnglish ? 'Check regional difference procedures for destination' : 'æ³¨æ„æŸ¥çœ‹ç›®çš„åœ°çš„åœ°åŒºå·®å¼‚ç¨‹åº' }}</text>
      </view>
    </view>
  </view>

</view>
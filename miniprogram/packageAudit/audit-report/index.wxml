<!-- å®¡è®¡æŠ¥å‘Šè¾“å‡ºé¡µé¢ - å¼€å‘ç¯å¢ƒä¸“ç”¨ -->
<view class="container">
  <!-- å¼€å‘ç¯å¢ƒè­¦å‘Š -->
  <view class="dev-warning" wx:if="{{isDev}}">
    <text class="warning-icon">ğŸ”§</text>
    <text class="warning-text">å¼€å‘ç¯å¢ƒä¸“ç”¨é¡µé¢</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view class="error-container" wx:if="{{hasError}}">
    <van-empty
      image="error"
      description="{{errorMessage}}"
    />
    <view class="error-hint">
      <text>æ­¤é¡µé¢ä»…åœ¨å¼€å‘ç¯å¢ƒä¸‹å¯ç”¨</text>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="main-content" wx:if="{{!hasError}}">
    <!-- æ“ä½œæŒ‰é’®åŒº -->
    <view class="action-section">
      <view class="action-header">
        <text class="section-title">ğŸ“Š å®¡è®¡å·¥å…·</text>
        <text class="section-subtitle">è¿è¡Œå®¡è®¡åˆ†æé¡¹ç›®ä»£ç è´¨é‡</text>
      </view>
      <view class="action-buttons">
        <van-button
          type="primary"
          size="large"
          loading="{{isLoading}}"
          loading-text="å®¡è®¡ä¸­..."
          bind:click="runAudit"
          custom-class="run-audit-btn"
        >
          ğŸ” è¿è¡Œå®¡è®¡
        </van-button>
      </view>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{isLoading}}">
      <van-loading size="48rpx" type="spinner" vertical>
        æ­£åœ¨åˆ†æé¡¹ç›®ä»£ç ...
      </van-loading>
    </view>

    <!-- æ— æŠ¥å‘ŠçŠ¶æ€ -->
    <view class="empty-container" wx:if="{{!hasReport && !isLoading}}">
      <van-empty
        image="search"
        description="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿è¡Œå®¡è®¡"
      />
    </view>

    <!-- æŠ¥å‘Šå†…å®¹ -->
    <view class="report-content" wx:if="{{hasReport && !isLoading}}">
      <!-- ä¸€ç¥¨å¦å†³è­¦å‘Š -->
      <view class="veto-warnings" wx:if="{{vetoFlags.length > 0}}">
        <view class="veto-header">
          <text class="veto-icon">âš ï¸</text>
          <text class="veto-title">å…³é”®è­¦å‘Š</text>
        </view>
        <view class="veto-list">
          <view class="veto-item" wx:for="{{vetoFlags}}" wx:key="index">
            <text class="veto-desc">{{item.description}}</text>
            <text class="veto-limit">è¯„åˆ†ä¸Šé™: {{item.maxScore}}</text>
          </view>
        </view>
      </view>

      <!-- è¯„åˆ†æ¦‚è§ˆ -->
      <view class="scores-section">
        <view class="section-header">
          <text class="section-title">ğŸ“ˆ è¯„åˆ†æ¦‚è§ˆ</text>
        </view>

        <!-- ç»¼åˆè¯„åˆ† -->
        <view class="overall-score">
          <view class="score-circle {{scores.overall >= 90 ? 'excellent' : scores.overall >= 80 ? 'good' : scores.overall >= 70 ? 'average' : scores.overall >= 60 ? 'poor' : 'critical'}}">
            <text class="score-value">{{scores.overall}}</text>
            <text class="score-label">ç»¼åˆè¯„åˆ†</text>
          </view>
          <view class="score-status">
            <text class="status-text">{{scores.overall >= 90 ? 'ä¼˜ç§€' : scores.overall >= 80 ? 'è‰¯å¥½' : scores.overall >= 70 ? 'ä¸€èˆ¬' : scores.overall >= 60 ? 'è¾ƒå·®' : 'éœ€æ”¹è¿›'}}</text>
          </view>
        </view>

        <!-- åˆ†é¡¹è¯„åˆ† -->
        <view class="sub-scores">
          <view class="sub-score-item">
            <view class="sub-score-header">
              <text class="sub-score-icon">âš¡</text>
              <text class="sub-score-label">æ€§èƒ½è¯„åˆ†</text>
              <text class="sub-score-value">{{scores.performance}}</text>
            </view>
            <van-progress
              percentage="{{scores.performance}}"
              stroke-width="8"
              color="{{scores.performance >= 80 ? '#07c160' : scores.performance >= 60 ? '#ff976a' : '#ee0a24'}}"
              track-color="#f2f3f5"
            />
          </view>

          <view class="sub-score-item">
            <view class="sub-score-header">
              <text class="sub-score-icon">ğŸ¨</text>
              <text class="sub-score-label">UIè¯„åˆ†</text>
              <text class="sub-score-value">{{scores.ui}}</text>
            </view>
            <van-progress
              percentage="{{scores.ui}}"
              stroke-width="8"
              color="{{scores.ui >= 80 ? '#07c160' : scores.ui >= 60 ? '#ff976a' : '#ee0a24'}}"
              track-color="#f2f3f5"
            />
          </view>

          <view class="sub-score-item">
            <view class="sub-score-header">
              <text class="sub-score-icon">ğŸ›¡ï¸</text>
              <text class="sub-score-label">ç¨³å®šæ€§è¯„åˆ†</text>
              <text class="sub-score-value">{{scores.stability}}</text>
            </view>
            <van-progress
              percentage="{{scores.stability}}"
              stroke-width="8"
              color="{{scores.stability >= 80 ? '#07c160' : scores.stability >= 60 ? '#ff976a' : '#ee0a24'}}"
              track-color="#f2f3f5"
            />
          </view>
        </view>
      </view>

      <!-- é—®é¢˜ç»Ÿè®¡ -->
      <view class="summary-section">
        <view class="section-header">
          <text class="section-title">ğŸ“‹ é—®é¢˜ç»Ÿè®¡</text>
          <text class="total-count">å…± {{summary.totalIssues}} ä¸ªé—®é¢˜</text>
        </view>

        <view class="summary-cards">
          <view class="summary-card critical" bind:tap="onFilterChange" data-filter="critical">
            <text class="card-icon">ğŸ”´</text>
            <text class="card-count">{{summary.criticalCount}}</text>
            <text class="card-label">ä¸¥é‡</text>
          </view>
          <view class="summary-card major" bind:tap="onFilterChange" data-filter="major">
            <text class="card-icon">ğŸŸ </text>
            <text class="card-count">{{summary.majorCount}}</text>
            <text class="card-label">ä¸»è¦</text>
          </view>
          <view class="summary-card minor" bind:tap="onFilterChange" data-filter="minor">
            <text class="card-icon">ğŸŸ¡</text>
            <text class="card-count">{{summary.minorCount}}</text>
            <text class="card-label">æ¬¡è¦</text>
          </view>
          <view class="summary-card info" bind:tap="onFilterChange" data-filter="info">
            <text class="card-icon">ğŸ”µ</text>
            <text class="card-count">{{summary.infoCount}}</text>
            <text class="card-label">æç¤º</text>
          </view>
        </view>
      </view>

      <!-- ç­›é€‰å™¨ -->
      <view class="filter-section">
        <view class="filter-tabs">
          <view
            class="filter-tab {{currentFilter === item.value ? 'active' : ''}}"
            wx:for="{{filterOptions}}"
            wx:key="value"
            data-filter="{{item.value}}"
            bind:tap="onFilterChange"
          >
            <text class="filter-icon">{{item.icon}}</text>
            <text class="filter-label">{{item.label}}</text>
          </view>
        </view>
      </view>

      <!-- é—®é¢˜åˆ—è¡¨ -->
      <view class="issues-section">
        <view class="section-header">
          <text class="section-title">ğŸ” é—®é¢˜è¯¦æƒ…</text>
        </view>

        <!-- æ— é—®é¢˜çŠ¶æ€ -->
        <view class="no-issues" wx:if="{{groupedIssues.length === 0}}">
          <van-empty
            image="search"
            description="å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— é—®é¢˜"
          />
        </view>

        <!-- åˆ†ç»„é—®é¢˜åˆ—è¡¨ -->
        <view class="issue-groups" wx:if="{{groupedIssues.length > 0}}">
          <view class="issue-group" wx:for="{{groupedIssues}}" wx:key="category">
            <!-- åˆ†ç»„æ ‡é¢˜ -->
            <view
              class="group-header {{expandedGroups[item.category] ? 'expanded' : ''}}"
              data-category="{{item.category}}"
              bind:tap="toggleGroup"
            >
              <view class="group-title">
                <text class="group-icon">{{item.icon}}</text>
                <text class="group-label">{{item.label}}</text>
                <text class="group-count">({{item.issues.length}})</text>
              </view>
              <view class="group-badges">
                <van-tag type="danger" wx:if="{{item.criticalCount > 0}}">{{item.criticalCount}}</van-tag>
                <van-tag type="warning" wx:if="{{item.majorCount > 0}}">{{item.majorCount}}</van-tag>
                <van-tag type="primary" wx:if="{{item.minorCount > 0}}">{{item.minorCount}}</van-tag>
              </view>
              <van-icon name="{{expandedGroups[item.category] ? 'arrow-up' : 'arrow-down'}}" />
            </view>

            <!-- é—®é¢˜åˆ—è¡¨ -->
            <view class="group-issues" wx:if="{{expandedGroups[item.category]}}">
              <view
                class="issue-item {{issue.severity}}"
                wx:for="{{item.issues}}"
                wx:for-item="issue"
                wx:key="id"
              >
                <view class="issue-header">
                  <view class="issue-severity">
                    <text class="severity-icon">{{issue.severity === 'critical' ? 'ğŸ”´' : issue.severity === 'major' ? 'ğŸŸ ' : issue.severity === 'minor' ? 'ğŸŸ¡' : 'ğŸ”µ'}}</text>
                    <text class="severity-label">{{issue.severity === 'critical' ? 'ä¸¥é‡' : issue.severity === 'major' ? 'ä¸»è¦' : issue.severity === 'minor' ? 'æ¬¡è¦' : 'æç¤º'}}</text>
                  </view>
                  <text class="issue-file">{{issue.file}}{{issue.line ? ':' + issue.line : ''}}</text>
                </view>
                <view class="issue-body">
                  <text class="issue-desc">{{issue.description}}</text>
                  <view class="issue-suggestion" wx:if="{{issue.suggestion}}">
                    <text class="suggestion-icon">ğŸ’¡</text>
                    <text class="suggestion-text">{{issue.suggestion}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ä¼˜åŒ–å»ºè®® -->
      <view class="recommendations-section" wx:if="{{recommendations.length > 0}}">
        <view class="section-header">
          <text class="section-title">ğŸ¯ ä¼˜åŒ–å»ºè®®</text>
          <text class="section-subtitle">æŒ‰ä¼˜å…ˆçº§æ’åº</text>
        </view>

        <view class="recommendation-list">
          <view
            class="recommendation-item {{item.priority}}"
            wx:for="{{recommendations}}"
            wx:key="id"
          >
            <view class="rec-header">
              <view class="rec-priority">
                <text class="priority-icon">{{item.priority === 'high' ? 'ğŸ”´' : item.priority === 'medium' ? 'ğŸŸ ' : 'ğŸŸ¡'}}</text>
                <text class="priority-label">{{item.priority === 'high' ? 'é«˜ä¼˜å…ˆçº§' : item.priority === 'medium' ? 'ä¸­ä¼˜å…ˆçº§' : 'ä½ä¼˜å…ˆçº§'}}</text>
              </view>
              <text class="rec-count">{{item.issueCount}}å¤„</text>
            </view>
            <text class="rec-title">{{item.title}}</text>
            <text class="rec-desc">{{item.description}}</text>
            <view class="rec-meta">
              <text class="meta-item">å½±å“: {{item.estimatedImpact}}%</text>
              <text class="meta-item">éš¾åº¦: {{item.effort === 'quick' ? 'å¿«é€Ÿä¿®å¤' : item.effort === 'medium' ? 'ä¸­ç­‰éš¾åº¦' : 'å¤æ‚ä¿®å¤'}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å¯¼å‡ºæŒ‰é’® -->
      <view class="export-section">
        <view class="section-header">
          <text class="section-title">ğŸ“¤ å¯¼å‡ºæŠ¥å‘Š</text>
        </view>
        <view class="export-buttons">
          <van-button
            type="info"
            size="normal"
            loading="{{isExporting}}"
            bind:click="exportJSON"
            custom-class="export-btn"
          >
            ğŸ“‹ å¤åˆ¶JSON
          </van-button>
          <van-button
            type="default"
            size="normal"
            loading="{{isExporting}}"
            bind:click="exportMarkdown"
            custom-class="export-btn"
          >
            ğŸ“ å¤åˆ¶Markdown
          </van-button>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
  <view class="bottom-safe-area"></view>
</view>

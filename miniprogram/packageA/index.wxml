<view class="container page-content">
  <!-- è‡ªå®šä¹‰æ ‡ç­¾é¡µ -->
  <view class="modern-tabs-container">
    <scroll-view class="tabs-scroll" scroll-x enhanced>
      <view class="tabs-wrapper">
        <view 
          wx:for="{{ tabList }}" 
          wx:key="name"
          class="modern-tab {{ activeTab === item.name ? 'active' : '' }}"
          bind:tap="onCustomTabChange"
          data-tab="{{ item.name }}"
        >
          <view class="tab-content">
            <view class="tab-icon">{{ item.icon }}</view>
            <view class="tab-title">{{ item.title }}</view>
            <view class="tab-count" wx:if="{{ item.count > 0 }}">{{ item.count }}</view>
          </view>
          <view class="tab-indicator" wx:if="{{ activeTab === item.name }}"></view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-section communication-search">
    <van-search
      value="{{ searchValue }}"
      placeholder="{{ searchPlaceholder }}"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>

  <!-- ç« èŠ‚è¯¦æƒ…è§†å›¾çš„è¿”å›æŒ‰é’® -->
  <view wx:if="{{ viewMode === 'chapterDetail' }}" class="chapter-nav-bar">
    <view class="back-button" bind:tap="backToChapterList">
      <view class="back-icon">â†</view>
      <view class="back-text">è¿”å›ç« èŠ‚åˆ—è¡¨</view>
    </view>
    <view class="chapter-title">{{ icaoChapters[selectedChapter] ? icaoChapters[selectedChapter].name : 'ç« èŠ‚è¯¦æƒ…' }}</view>
  </view>

  <!-- åº”æ€¥ç‰¹æƒ…åˆ†ç±»è¯¦æƒ…è§†å›¾çš„è¿”å›æŒ‰é’® -->
  <view wx:if="{{ viewMode === 'categoryDetail' }}" class="chapter-nav-bar">
    <view class="back-button" bind:tap="backToCategoryList">
      <view class="back-icon">â†</view>
      <view class="back-text">è¿”å›åˆ†ç±»åˆ—è¡¨</view>
    </view>
    <view class="chapter-title">{{ emergencyCategories[selectedCategory] ? emergencyCategories[selectedCategory].name : 'åˆ†ç±»è¯¦æƒ…' }}</view>
  </view>

  <!-- é€šä¿¡ç¿»è¯‘åˆ—è¡¨ -->
  <view class="communication-section">
    <!-- ç« èŠ‚åˆ—è¡¨è§†å›¾ -->
    <view wx:if="{{ viewMode === 'chapterList' && displayData.length > 0 }}" class="chapter-list modern-list">
      <view 
        wx:for="{{ displayData }}"
        wx:key="id"
        wx:for-index="idx"
        class="modern-chapter-card"
        bind:tap="selectChapter"
        data-index="{{ idx }}"
      >
        <view class="chapter-card-content">
          <view class="chapter-icon">ğŸ“–</view>
          <view class="chapter-info">
            <view class="chapter-name">{{ item.name }}</view>
            <view class="chapter-count">{{ item.sentenceCount }} å¥</view>
          </view>
          <view class="chapter-arrow">â†’</view>
        </view>
      </view>
    </view>
    
    <!-- åº”æ€¥ç‰¹æƒ…åˆ†ç±»åˆ—è¡¨è§†å›¾ -->
    <view wx:elif="{{ viewMode === 'categoryList' && displayData.length > 0 }}" class="chapter-list modern-list">
      <view 
        wx:for="{{ displayData }}"
        wx:key="id"
        wx:for-index="idx"
        class="modern-chapter-card emergency-category-card"
        bind:tap="selectCategory"
        data-index="{{ idx }}"
      >
        <view class="chapter-card-content">
          <view class="chapter-icon emergency-icon">ğŸš¨</view>
          <view class="chapter-info">
            <view class="chapter-name emergency-category-name">{{ item.name }}</view>
            <view class="chapter-count emergency-count">{{ item.termsCount }} ä¸ªè¯æ±‡</view>
          </view>
          <view class="chapter-arrow emergency-arrow">â†’</view>
        </view>
      </view>
    </view>
    
    <!-- å¥å­åˆ—è¡¨è§†å›¾ï¼ˆæœç´¢ç»“æœã€ç« èŠ‚è¯¦æƒ…ã€åˆ†ç±»è¯¦æƒ…ï¼‰ -->
    <view wx:elif="{{ displayData.length > 0 }}" class="communication-list modern-list">
      <view 
        wx:for="{{ displayData }}"
        wx:key="id"
        wx:for-index="idx"
        class="modern-communication-card"
        bind:tap="showItemDetail"
        bind:longpress="showQuickActions"
        data-index="{{ idx }}"
      >
        <!-- å¡ç‰‡å¤´éƒ¨ -->
        <view class="card-header">
          <view class="primary-info">
            <view class="type-indicator {{ item.type }}">
              <text class="type-icon">{{ item.type === 'emergency' ? 'ğŸš¨' : 'ğŸ“»' }}</text>
            </view>
          </view>
          <view class="header-tags">
            <view wx:if="{{ item.type !== 'emergency' }}" class="type-tag icao">ICAO</view>
            <view wx:if="{{ item.isEmergency }}" class="priority-tag emergency">ç‰¹æƒ…</view>
          </view>
        </view>
        
        <!-- ä¸»è¦å†…å®¹ -->
        <view class="card-content">
          <view class="chinese-primary">{{ item.chinese }}</view>
          <view class="english-secondary">{{ item.english }}</view>
        </view>
        
        <!-- å¡ç‰‡åº•éƒ¨ -->
        <view class="card-footer">
          <view class="category-info">
            <view class="category-badge-extended {{ item.type }}">
              <text class="category-icon">{{ item.type === 'emergency' ? 'ğŸ†˜' : 'ğŸ—£ï¸' }}</text>
              <text class="category-name-extended">{{ item.category }}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
      <view wx:if="{{ hasMore && !isLoading }}" class="load-more-section">
        <view class="load-more-btn" bind:tap="loadMore">
          <text class="load-more-text">åŠ è½½æ›´å¤š</text>
          <view class="load-more-icon">ğŸ“±</view>
        </view>
        <view class="load-more-tip">è¿˜æœ‰ {{ filteredAllData.length - displayData.length }} æ¡æ•°æ®</view>
      </view>
      
      <!-- åŠ è½½ä¸­çŠ¶æ€ -->
      <view wx:if="{{ isLoading }}" class="loading-section">
        <view class="loading-spinner"></view>
        <text class="loading-text">åŠ è½½ä¸­...</text>
      </view>
      
      <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
      <view wx:if="{{ !hasMore && displayData.length > 0 }}" class="no-more-section">
        <view class="no-more-icon">âœ…</view>
        <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨ {{ displayData.length }} æ¡æ•°æ®</text>
      </view>
    </view>
    
    <!-- æ— æœç´¢ç»“æœ -->
    <view wx:else class="no-results">
      <view class="no-results-icon">ğŸ”</view>
      <view class="no-results-text">æœªæ‰¾åˆ°ç›¸å…³é€šä¿¡å†…å®¹</view>
      <view class="no-results-tip">è¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–åˆ‡æ¢åˆ†ç±»</view>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{ activeTab === 'all' && !searchValue }}" class="stats-section">
    <view class="stats-item">
      <text class="stats-number">{{ totalCount }}</text>
      <text class="stats-label">æ¡å†…å®¹</text>
    </view>
    <view class="stats-item">
      <text class="stats-number">2</text>
      <text class="stats-label">ä¸ªåˆ†ç±»</text>
    </view>
  </view>
</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<van-popup
  show="{{ showDetailPopup }}"
  position="bottom"
  round
  closeable
  close-icon="close"
  bind:close="closeDetailPopup"
  custom-style="height: 70%; max-height: 70vh;"
>
  <view class="detail-popup" wx:if="{{ selectedItem && selectedItem.chinese }}">
    <view class="popup-header">
      <view class="popup-header-content">
        <view class="popup-title">{{ selectedItem.type === 'emergency' ? 'åº”æ€¥ç‰¹æƒ…' : 'ICAOæ ‡å‡†å¥' }}</view>
        <view class="popup-subtitle">{{ selectedItem.category || '' }}</view>
      </view>
      <view class="popup-close-btn" bind:tap="closeDetailPopup">
        <van-icon name="cross" size="20px" color="white" />
      </view>
    </view>
    
    <scroll-view class="popup-content" scroll-y enhanced>
      <view class="detail-section">
        <view class="detail-label">ä¸­æ–‡</view>
        <view class="detail-content chinese-content">{{ selectedItem.chinese || 'æš‚æ— ä¸­æ–‡' }}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">è‹±æ–‡</view>
        <view class="detail-content english-content">{{ selectedItem.english || 'æš‚æ— è‹±æ–‡' }}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">åˆ†ç±»</view>
        <view class="detail-content category-content">{{ selectedItem.category || 'æš‚æ— åˆ†ç±»ä¿¡æ¯' }}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">æ¥æº</view>
        <view class="detail-content source-content">{{ selectedItem.source || 'æš‚æ— æ¥æºä¿¡æ¯' }}</view>
      </view>
    </scroll-view>
  </view>
  
  <view wx:else class="detail-popup">
    <view class="popup-header">
      <view class="popup-title">åŠ è½½ä¸­...</view>
    </view>
    <view class="popup-content">
      <view class="detail-section">
        <view class="detail-content">æ­£åœ¨åŠ è½½è¯¦æƒ…...</view>
      </view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />
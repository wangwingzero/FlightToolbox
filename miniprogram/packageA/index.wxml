<view class="container page-content">
  <!-- 自定义标签页 -->
  <view class="modern-tabs-container">
    <view class="tabs-wrapper-grid">
      <view
        wx:for="{{ tabList }}"
        wx:key="name"
        class="modern-tab-grid {{ activeTab === item.name ? 'active' : '' }}"
        bind:tap="onCustomTabChange"
        data-tab="{{ item.name }}"
      >
        <view class="tab-content">
          <view class="tab-icon">{{ item.icon }}</view>
          <view class="tab-title">{{ item.title }}</view>
          <view class="tab-count" wx:if="{{ item.count > 0 }}">{{ item.count }}</view>
        </view>
        <view class="tab-indicator" wx:if="{{ activeTab === item.name }}"></view>
      </view>
    </view>
  </view>

  <!-- 搜索框 -->
  <view class="search-section communication-search">
    <van-search
      value="{{ searchValue }}"
      placeholder="{{ searchPlaceholder }}"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>


  <!-- 章节详情视图的返回按钮 -->
  <view wx:if="{{ viewMode === 'chapterDetail' }}" class="chapter-nav-bar">
    <view class="back-button" bind:tap="backToChapterList">
      <view class="back-icon">←</view>
      <view class="back-text">返回章节列表</view>
    </view>
    <view class="chapter-title">{{ icaoChapters[selectedChapter] ? icaoChapters[selectedChapter].name : '章节详情' }}</view>
  </view>

  <!-- 应急特情分类详情视图的返回按钮 -->
  <view wx:if="{{ viewMode === 'categoryDetail' }}" class="chapter-nav-bar">
    <view class="back-button" bind:tap="backToCategoryList">
      <view class="back-icon">←</view>
      <view class="back-text">返回分类列表</view>
    </view>
    <view class="chapter-title">
      {{ activeTab === 'emergency' ? (emergencyCategories[selectedCategory] ? emergencyCategories[selectedCategory].name : '分类详情') : (routineCategories[selectedCategory] ? routineCategories[selectedCategory].name : '分类详情') }}
    </view>
  </view>

  <!-- 通信翻译列表 -->
  <view class="communication-section">
    <!-- 章节列表视图 -->
    <view wx:if="{{ viewMode === 'chapterList' && displayData.length > 0 }}" class="chapter-list modern-list">
      <block wx:for="{{ displayData }}" wx:key="id" wx:for-index="idx">
        <view
          class="modern-chapter-card"
          bind:tap="selectChapter"
          data-index="{{ idx }}"
        >
          <view class="chapter-card-content">
            <view class="chapter-icon">📖</view>
            <view class="chapter-info">
              <view class="chapter-name">{{ item.name }}</view>
              <view class="chapter-count">{{ item.sentenceCount }} 句</view>
            </view>
            <view class="chapter-arrow">→</view>
          </view>
        </view>

        <!-- 第一章后插入横幅广告 -->
        <view wx:if="{{ idx === 0 && !isAdFree }}" class="ad-banner-container">
          <ad unit-id="adunit-d6c8a55bd3cb4fd1" ad-type="banner" ad-intervals="30"
              bindload="onAdLoad" binderror="onAdError"></ad>
        </view>
      </block>
    </view>
    
    <!-- 应急特情分类列表视图 -->
    <view wx:elif="{{ viewMode === 'categoryList' && displayData.length > 0 }}" class="chapter-list modern-list">
      <view
        wx:for="{{ displayData }}"
        wx:key="id"
        wx:for-index="idx"
        class="modern-chapter-card {{ activeTab === 'routine' ? 'routine-category-card' : 'emergency-category-card' }}"
        bind:tap="selectCategory"
        data-index="{{ idx }}"
      >
        <view class="chapter-card-content">
          <view class="chapter-icon {{ activeTab === 'routine' ? 'routine-icon' : 'emergency-icon' }}">{{ activeTab === 'routine' ? '✈️' : '🚨' }}</view>
          <view class="chapter-info">
            <view class="chapter-name {{ activeTab === 'routine' ? 'routine-category-name' : 'emergency-category-name' }}">{{ item.name }}</view>
            <view class="chapter-count {{ activeTab === 'routine' ? 'routine-count' : 'emergency-count' }}">{{ item.termsCount }} 个词汇</view>
          </view>
          <view class="chapter-arrow {{ activeTab === 'routine' ? 'routine-arrow' : 'emergency-arrow' }}">→</view>
        </view>
      </view>
    </view>
    
    <!-- 句子列表视图（搜索结果、章节详情、分类详情） -->
    <view wx:elif="{{ displayData.length > 0 }}" class="communication-list modern-list">
      <block wx:for="{{ displayData }}" wx:key="id" wx:for-index="idx">
        <view 
          class="modern-communication-card"
          bind:tap="showItemDetail"
          bind:longpress="showQuickActions"
          data-index="{{ idx }}"
        >
          <!-- 卡片头部 -->
          <view class="card-header">
            <view class="primary-info">
              <view class="type-indicator {{ item.type }}">
                <text class="type-icon">{{ item.type === 'emergency' ? '🚨' : (item.type === 'routine' ? '✈️' : '📻') }}</text>
              </view>
            </view>
            <view class="header-tags">
              <view wx:if="{{ item.type === 'icao900' }}" class="type-tag icao">ICAO</view>
              <view wx:if="{{ item.isEmergency }}" class="priority-tag emergency">特情</view>
              <view wx:if="{{ item.type === 'routine' }}" class="type-tag routine">日常</view>
            </view>
          </view>
          
          <!-- 主要内容 -->
          <view class="card-content">
            <view class="chinese-primary">{{ item.chinese }}</view>
            <view class="english-secondary">{{ item.english }}</view>
          </view>
          
          <!-- 卡片底部 -->
          <view class="card-footer">
            <view class="category-info">
              <view class="category-badge-extended {{ item.type }}">
                <text class="category-icon">{{ item.type === 'emergency' ? '🆘' : (item.type === 'routine' ? '💼' : '🗣️') }}</text>
                <text class="category-name-extended">{{ item.category }}</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 第一个搜索结果后插入横幅广告 -->
        <view wx:if="{{ idx === 0 && !isAdFree }}" class="ad-banner-container">
          <ad unit-id="adunit-d7a3b71f5ce0afca" ad-type="banner" ad-intervals="30"
              bindload="onAdLoad" binderror="onAdError"></ad>
        </view>

      </block>
      
      <!-- 加载更多按钮 -->
      <view wx:if="{{ hasMore && !isLoading }}" class="load-more-section">
        <view class="load-more-btn" bind:tap="loadMore">
          <text class="load-more-text">加载更多</text>
          <view class="load-more-icon">📱</view>
        </view>
        <view class="load-more-tip">还有 {{ filteredAllData.length - displayData.length }} 条数据</view>
      </view>
      
      <!-- 加载中状态 -->
      <view wx:if="{{ isLoading }}" class="loading-section">
        <view class="loading-spinner"></view>
        <text class="loading-text">加载中...</text>
      </view>
      
      <!-- 没有更多数据 -->
      <view wx:if="{{ !hasMore && displayData.length > 0 }}" class="no-more-section">
        <view class="no-more-icon">✅</view>
        <text class="no-more-text">已显示全部 {{ displayData.length }} 条数据</text>
      </view>
    </view>
    
    <!-- 无搜索结果 -->
    <view wx:else class="no-results">
      <view class="no-results-icon">🔍</view>
      <view class="no-results-text">未找到相关通信内容</view>
      <view class="no-results-tip">请尝试其他关键词或切换分类</view>
    </view>
  </view>

  <!-- 横幅广告 -->
  <view wx:if="{{ !isAdFree && nativeAdEnabled }}" class="ad-banner-container">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"
        bindload="onAdLoad" binderror="onAdError"></ad>
  </view>

</view>

<!-- 详情弹窗 -->
<van-popup
  show="{{ showDetailPopup }}"
  position="bottom"
  round
  closeable
  close-icon="close"
  bind:close="closeDetailPopup"
  custom-style="height: 70%; max-height: 70vh;"
>
  <view class="detail-popup" wx:if="{{ selectedItem && selectedItem.chinese }}">
    <view class="popup-header">
      <view class="popup-header-content">
        <view class="popup-title">{{ selectedItem.type === 'emergency' ? '应急特情' : (selectedItem.type === 'routine' ? '日常词汇' : 'ICAO标准句') }}</view>
        <view class="popup-subtitle">{{ selectedItem.category || '' }}</view>
      </view>
      <view class="popup-close-btn" bind:tap="closeDetailPopup">
        <van-icon name="cross" size="20px" color="white" />
      </view>
    </view>
    
    <scroll-view class="popup-content" scroll-y enhanced>
      <view class="detail-section">
        <view class="detail-label">中文</view>
        <view class="detail-content chinese-content">{{ selectedItem.chinese || '暂无中文' }}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">英文</view>
        <view class="detail-content english-content">{{ selectedItem.english || '暂无英文' }}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">分类</view>
        <view class="detail-content category-content">{{ selectedItem.category || '暂无分类信息' }}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">来源</view>
        <view class="detail-content source-content">{{ selectedItem.source || '暂无来源信息' }}</view>
      </view>
    </scroll-view>
  </view>
  
  <view wx:else class="detail-popup">
    <view class="popup-header">
      <view class="popup-title">加载中...</view>
    </view>
    <view class="popup-content">
      <view class="detail-section">
        <view class="detail-content">正在加载详情...</view>
      </view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />
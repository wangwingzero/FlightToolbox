<view class="container">
  <!-- é¡¶éƒ¨å›ºå®šåŒºåŸŸï¼šæ¨¡å¼åˆ‡æ¢ + æœç´¢ + åˆ†ç±» -->
  <view class="header-section">
    <!-- æ¨¡å¼åˆ‡æ¢å™¨ -->
    <view class="mode-switcher-container">
      <view class="mode-switcher">
        <view class="mode-option" bind:tap="openMedicalFromDiet">
          <view class="mode-icon">ğŸ¥</view>
          <text class="mode-label">ä½“æ£€æ ‡å‡†</text>
        </view>
        <view class="mode-option mode-option-active">
          <view class="mode-icon">ğŸ¥—</view>
          <text class="mode-label">ç©ºå‹¤ç¶</text>
        </view>
      </view>
    </view>

    <!-- æœç´¢æ¡† -->
    <view class="search-wrapper">
      <van-search
        value="{{ searchKeyword }}"
        placeholder="{{ searchPlaceholder }}"
        bind:change="onSearchChange"
        bind:clear="onSearchClear"
        shape="round"
        background="transparent"
        placeholder-style="color: #94a3b8;"
      />
    </view>
    
    <!-- åˆ†ç±»èœå• -->
    <view class="tabs-wrapper">
      <scroll-view class="tabs-scroll" scroll-x scroll-with-animation enhanced show-scrollbar="{{false}}">
        <view class="tabs-container">
          <view
            wx:for="{{ categoryList }}"
            wx:key="name"
            class="tab-item {{ activeTab === item.name ? 'active' : '' }}"
            bind:tap="onTabChange"
            data-name="{{ item.name }}"
          >
            <text class="tab-text">{{ item.title }}</text>
            <view class="tab-count" wx:if="{{ item.count > 0 }}">{{ item.count }}</view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- åˆ—è¡¨å†…å®¹åŒºåŸŸ (ç”±äºå¤´éƒ¨å›ºå®šï¼Œéœ€è¦padding-top) -->
  <view class="content-section">
    <view wx:if="{{ displayedGuides.length > 0 }}" class="card-list">
      <block wx:for="{{ displayedGuides }}" wx:key="id" wx:for-index="idx">
        <view
          class="guide-card"
          bind:tap="showGuideDetail"
          data-index="{{ idx }}"
          data-group="{{ item.group }}"
          hover-class="guide-card-hover"
          hover-stay-time="70"
        >
          <!-- å¡ç‰‡å¤´éƒ¨ï¼šæ ‡é¢˜ä¸æ ‡ç­¾ -->
          <view class="card-header">
            <view class="title-row">
              <text class="title-zh">{{ item.name_zh }}</text>
              <view class="tag-badge" data-group="{{ item.group }}">{{ item.categoryShort }}</view>
            </view>
            <text class="title-en">{{ item.name_en }}</text>
          </view>

          <!-- å¡ç‰‡å†…å®¹ï¼šæ‘˜è¦ -->
          <view class="card-body">
            <text class="brief-text">{{ item.brief }}</text>
          </view>

          <!-- å¡ç‰‡åº•éƒ¨ï¼šæ“ä½œæŒ‡å¼• -->
          <view class="card-footer">
            <view class="view-detail-btn">
              <text>æŸ¥çœ‹è¯¦æƒ…</text>
              <van-icon name="arrow" size="12px" style="margin-left: 4rpx;" />
            </view>
          </view>
        </view>

        <!-- åœ¨ç¬¬1ä¸ªå’Œç¬¬2ä¸ªç»“æœä¹‹é—´æ’å…¥å¹¿å‘Š -->
        <view
          wx:if="{{ idx === 0 && displayedGuides.length > 1 && !isAdFree }}"
          class="ad-banner-container"
          style="margin: 24rpx 0;"
        >
          <ad unit-id="adunit-3b2e78fbdab16389" ad-type="banner" ad-intervals="30"></ad>
        </view>
      </block>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{ hasMore }}" class="loading-state">
        <van-loading size="24px" type="spinner" color="#94a3b8" wx:if="{{loading}}" />
        <text class="loading-text" bind:tap="loadMoreGuides">{{ loading ? 'åŠ è½½ä¸­...' : 'ç‚¹å‡»åŠ è½½æ›´å¤š' }}</text>
      </view>
      <view wx:else class="end-state">
        <text>â€” ä¹Ÿå°±æ˜¯è¿™äº›äº† â€”</text>
      </view>
    </view>

    <!-- æ— æœç´¢ç»“æœ -->
    <view wx:else class="empty-state">
      <!-- ä½¿ç”¨å†…ç½®iconä»£æ›¿å›¾ç‰‡ä»¥é˜²è·¯å¾„é—®é¢˜ -->
      <van-icon name="search" size="64px" color="#cbd5e1" style="margin-bottom: 24rpx;" />
      <text class="empty-text">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</text>
      <text class="empty-sub">è¯•è¯•æœç´¢â€œé«˜è¡€å‹â€æˆ–â€œå¤œèˆªâ€</text>
    </view>
  </view>
</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<van-popup
  show="{{ showDetailPopup }}"
  position="bottom"
  round
  bind:close="closeDetailPopup"
  custom-style="height: 85vh; background-color: #fff;"
>
  <view class="popup-container" wx:if="{{ selectedGuide }}">
    <!-- å¼¹çª—å¤´éƒ¨ -->
    <view class="popup-nav">
      <view class="nav-close" bind:tap="closeDetailPopup">
        <van-icon name="arrow-down" size="20px" color="#64748b" />
      </view>
      <text class="nav-title">è†³é£Ÿå»ºè®®è¯¦æƒ…</text>
      <view class="nav-placeholder"></view>
    </view>

    <scroll-view class="popup-scroll" scroll-y enhanced show-scrollbar="{{false}}">
      <view class="popup-inner">
        <!-- æ ‡é¢˜åŒº -->
        <view class="detail-header">
          <view class="detail-tag">{{ selectedGuide.categoryShort }}</view>
          <view class="detail-title">{{ selectedGuide.name_zh }}</view>
          <view class="detail-subtitle">{{ selectedGuide.name_en }}</view>
        </view>

        <!-- æ ¸å¿ƒè¦ç‚¹ -->
        <view class="detail-card theme-green" wx:if="{{ selectedGuide.focusPoints && selectedGuide.focusPoints.length }}">
          <view class="detail-card-title">
            <van-icon name="fire" color="#059669" size="16px" style="margin-right:8rpx;" />
            <text>æ ¸å¿ƒé¥®é£Ÿè¦ç‚¹</text>
          </view>
          <view class="detail-list">
            <view wx:for="{{ selectedGuide.focusPoints }}" wx:key="index" class="list-item">
              <view class="list-dot"></view>
              <text class="list-content">{{ item }}</text>
            </view>
          </view>
        </view>

        <!-- ç¤ºä¾‹é£Ÿè°± -->
        <view class="detail-card theme-orange" wx:if="{{ selectedGuide.sampleMenu && selectedGuide.sampleMenu.length }}">
          <view class="detail-card-title">
            <van-icon name="shop-collect" color="#ea580c" size="16px" style="margin-right:8rpx;" />
            <text>{{ selectedGuide.sampleMenuTitle || 'ç¤ºä¾‹é£Ÿè°±' }}</text>
          </view>
          <view class="detail-list">
            <view wx:for="{{ selectedGuide.sampleMenu }}" wx:key="index" class="list-item">
              <view class="list-dot orange"></view>
              <text class="list-content">{{ item }}</text>
            </view>
          </view>
        </view>

        <!-- æ¥æºæ³¨è„š -->
        <view class="source-note" wx:if="{{ selectedGuide.source }}">
          <text>ä¾æ®ï¼š{{ selectedGuide.source }}</text>
        </view>

        <!-- åº•éƒ¨å ä½ -->
        <view style="height: 40rpx;"></view>
      </view>
    </scroll-view>

    <view wx:if="{{ fromMedical }}" class="popup-footer">
      <button class="popup-footer-btn" bind:tap="backToMedicalFromDiet">è¿”å›ä½“æ£€æ ‡å‡†</button>
    </view>
  </view>
</van-popup>

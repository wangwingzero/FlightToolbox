<view class="page-container">
  <!-- 顶部背景装饰 -->
  <view class="header-bg"></view>

  <!-- 搜索栏 -->
  <view class="search-box-container">
    <view class="search-box">
      <van-icon name="search" size="18px" color="#969799" />
      <input 
        class="search-input" 
        placeholder="{{ dataView === 'standard' ? '搜索标准规范' : '搜索规章或规范性文件' }}" 
        placeholder-class="search-placeholder"
        bindinput="onSearchInput"
        bindconfirm="onSearchInput"
        value="{{ searchKeyword }}"
      />
      <view class="search-action" wx:if="{{ searchKeyword }}" bindtap="onClearSearch">
        <van-icon name="clear" size="18px" color="#c8c9cc" />
      </view>
    </view>
  </view>

  <!-- 数据视图切换 -->
  <view class="view-switch-wrap">
    <view class="view-switch">
      <view class="view-switch-item {{ dataView === 'ccar' ? 'active' : '' }}" bindtap="onDataViewChange" data-view="ccar">
        规章/规范性文件
      </view>
      <view class="view-switch-item {{ dataView === 'standard' ? 'active' : '' }}" bindtap="onDataViewChange" data-view="standard">
        标准规范
      </view>
    </view>
  </view>

  <!-- 统计与筛选卡片 -->
  <view class="stats-filter-card">
    <!-- 状态切换 (Segmented Control 风格) -->
    <view class="status-tabs">
      <view class="status-tab {{ validityFilter === 'all' ? 'active' : '' }}" bindtap="onValidityFilterChange" data-filter="all">
        <text>全部</text>
        <text class="count-badge">{{ dataView === 'standard' ? (standardData.length || 0) : ((regulationData.length || 0) + (normativeData.length || 0)) }}</text>
      </view>
      <view class="status-tab {{ validityFilter === 'valid' ? 'active' : '' }}" bindtap="onValidityFilterChange" data-filter="valid">
        <text>有效</text>
        <text class="count-badge">{{ dataView === 'standard' ? validStandardsCount : (validRegulationsCount + validNormativesCount) }}</text>
      </view>
      <view class="status-tab {{ validityFilter === 'invalid' ? 'active' : '' }}" bindtap="onValidityFilterChange" data-filter="invalid">
        <text>失效</text>
        <text class="count-badge">{{ dataView === 'standard' ? invalidStandardsCount : (invalidRegulationsCount + invalidNormativesCount) }}</text>
      </view>
    </view>

    <!-- 分割线 -->
    <view class="divider"></view>

    <!-- 时间筛选 -->
    <view class="time-filter-row" bindtap="toggleTimeFilterDropdown">
      <view class="time-filter-label">
        <van-icon name="calendar-o" size="16px" color="#576b95" style="margin-right: 6px;" />
        <text>{{ dataView === 'standard' ? '标准规范时间' : '规范性文件时间' }}</text>
      </view>
      <view class="time-filter-value">
        <text>{{ timeFilterTitle }}</text>
        <van-icon name="arrow-down" size="12px" color="#969799" style="margin-left: 4px; transition: all 0.3s;" class="{{ showTimeFilterDropdown ? 'rotate-180' : '' }}" />
      </view>
    </view>
    
    <!-- 筛选清除按钮 (如果有筛选) -->
    <view class="filter-clear-btn" catchtap="onClearTimeFilter" wx:if="{{ timeFilter !== 'all' }}">
        <text>清除筛选</text>
    </view>
  </view>
  
  <!-- 时间筛选下拉面板 (绝对定位) -->
  <view class="dropdown-mask" wx:if="{{ showTimeFilterDropdown }}" bindtap="closeTimeFilterDropdown"></view>
  <view class="dropdown-panel {{ showTimeFilterDropdown ? 'show' : '' }}">
    <view class="dropdown-options">
        <view class="dropdown-option {{ timeFilter === item.value ? 'active' : '' }}" 
            wx:for="{{ timeFilterOptions }}" 
            wx:key="value"
            bindtap="onSelectTimeFilter"
            data-value="{{ item.value }}">
            {{ item.text }}
            <van-icon name="success" wx:if="{{ timeFilter === item.value }}" color="#1989fa" />
        </view>
    </view>
    
    <!-- 自定义时间选择 -->
    <view class="custom-date-panel" wx:if="{{ timeFilter === 'custom' }}">
        <view class="date-inputs">
            <picker mode="date" value="{{ customStartDate }}" bindchange="onStartDateChange">
                <view class="date-input {{ customStartDate ? 'filled' : '' }}">
                    {{ customStartDateDisplay || '开始日期' }}
                </view>
            </picker>
            <text class="date-separator">至</text>
            <picker mode="date" value="{{ customEndDate }}" bindchange="onEndDateChange">
                <view class="date-input {{ customEndDate ? 'filled' : '' }}">
                    {{ customEndDateDisplay || '结束日期' }}
                </view>
            </picker>
        </view>
        <view class="quick-tags">
            <view class="quick-tag" bindtap="selectLastWeek">近一周</view>
            <view class="quick-tag" bindtap="selectLastMonth">近一月</view>
            <view class="quick-tag" bindtap="selectLastYear">近一年</view>
        </view>
    </view>
  </view>

  <!-- 内容列表区域 -->
  <view class="content-area">
    <!-- 搜索结果 -->
    <block wx:if="{{ isSearchMode }}">
       <!-- 规章搜索结果 -->
        <view wx:if="{{ searchedRegulations.length > 0 }}" class="search-section-header">
          <view class="section-title">
             <van-icon name="orders-o" style="margin-right: 6px;" color="#1989fa" />
             <text>规章</text>
          </view>
          <view class="section-count">{{ searchedRegulations.length }}条</view>
        </view>
        
        <view class="modern-result-list" wx:if="{{ searchedRegulations.length > 0 }}">
            <block wx:for="{{ searchedRegulations }}" wx:key="doc_number">
                <view class="modern-result-card regulation-card" bindtap="onRegulationClick" data-regulation="{{ item }}">
                    <view class="validity-tag {{ item.validity === '有效' ? 'valid' : (item.validity === '废止' ? 'abolished' : 'invalid') }}">{{ item.validity }}</view>
                    <view class="card-main">
                        <view class="card-title">{{ item.title }}</view>
                        <view class="card-meta">
                            <text class="meta-tag primary">{{ item.doc_number }}</text>
                            <text class="meta-tag secondary">{{ item.office_unit }}</text>
                        </view>
                    </view>
                    <van-icon name="arrow" color="#c8c9cc" />
                </view>
            </block>
        </view>

        <!-- 规范性文件搜索结果 -->
        <view wx:if="{{ searchedNormatives.length > 0 }}" class="search-section-header" style="margin-top: 24rpx;">
          <view class="section-title">
             <van-icon name="description" style="margin-right: 6px;" color="#07c160" />
             <text>规范性文件</text>
          </view>
          <view class="section-count">{{ searchedNormatives.length }}条</view>
        </view>

        <view class="modern-result-list" wx:if="{{ searchedNormatives.length > 0 }}">
            <block wx:for="{{ searchedNormatives }}" wx:key="doc_number">
                <view class="modern-result-card normative-card" bindtap="onNormativeClick" data-normative="{{ item }}">
                    <view class="validity-tag {{ item.validity === '有效' ? 'valid' : (item.validity === '废止' ? 'abolished' : 'invalid') }}">{{ item.validity }}</view>
                    <view class="card-main">
                        <view class="card-title">{{ item.title }}</view>
                        <view class="card-meta">
                            <text class="meta-tag primary">{{ item.doc_number }}</text>
                            <text class="meta-tag date">{{ item.publish_date }}</text>
                            <text class="meta-tag secondary">{{ item.office_unit }}</text>
                        </view>
                    </view>
                    <van-icon name="arrow" color="#c8c9cc" />
                </view>
            </block>
        </view>

        <!-- 标准规范搜索结果 -->
        <view wx:if="{{ searchedStandards.length > 0 }}" class="search-section-header" style="margin-top: 24rpx;">
          <view class="section-title">
             <van-icon name="description" style="margin-right: 6px;" color="#ff9500" />
             <text>标准规范</text>
          </view>
          <view class="section-count">{{ searchedStandards.length }}条</view>
        </view>

        <view class="modern-result-list" wx:if="{{ searchedStandards.length > 0 }}">
            <block wx:for="{{ displayedStandards }}" wx:key="doc_number">
                <view class="modern-result-card standard-card" bindtap="onStandardClick" data-standard="{{ item }}">
                    <view class="validity-tag {{ item.validity === '有效' ? 'valid' : (item.validity === '废止' ? 'abolished' : 'invalid') }}">{{ item.validity }}</view>
                    <view class="card-main">
                        <view class="card-title">{{ item.title }}</view>
                        <view class="card-meta">
                            <text class="meta-tag primary">{{ item.doc_number }}</text>
                            <text class="meta-tag date">{{ item.publish_date }}</text>
                            <text class="meta-tag secondary">{{ item.office_unit }}</text>
                        </view>
                    </view>
                    <van-icon name="arrow" color="#c8c9cc" />
                </view>
            </block>
        </view>

        <view class="standard-load-more" wx:if="{{ dataView === 'standard' && searchedStandards.length > 0 }}">
          <text class="standard-load-more-text" wx:if="{{ loadingMoreStandards }}">加载中...</text>
          <text class="standard-load-more-text" wx:elif="{{ standardHasMore }}">上滑加载更多</text>
          <text class="standard-load-more-text end" wx:else>已显示全部 {{ searchedStandards.length }} 条</text>
        </view>
    </block>

    <!-- 分类列表 -->
    <block wx:else>
      <view class="category-list">
        <view 
          class="category-card" 
          wx:for="{{ filteredCategories }}" 
          wx:key="name"
          bindtap="onCategoryClick"
          data-category="{{ item }}"
        >
          <view class="category-icon-box">
            <text class="category-char">{{ item.firstChar }}</text>
          </view>
          <view class="category-info">
            <view class="category-main">
              <text class="category-name">{{ item.name }}</text>
              <text class="category-sub">{{ item.category }}</text>
            </view>
            <view class="category-stats-row">
               <view class="stat-tag">
                 <text class="num">{{ item.regulationCount }}</text>
                 <text class="unit">规章</text>
               </view>
               <view class="stat-tag secondary" wx:if="{{ item.normativeCount > 0 }}">
                 <text class="num">{{ item.normativeCount }}</text>
                 <text class="unit">文件</text>
               </view>
            </view>
          </view>
          <van-icon name="arrow" color="#c8c9cc" size="16px" />
        </view>
      </view>
    </block>
    
    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{ (isSearchMode && searchedRegulations.length === 0 && searchedNormatives.length === 0 && searchedStandards.length === 0) || (!isSearchMode && filteredCategories.length === 0 && !loading) }}">
        <image src="/miniprogram/assets/images/empty-search.png" mode="aspectFit" class="empty-img" wx:if="{{false}}" /> <!-- 暂无图片，使用图标代替 -->
        <van-icon name="search" size="64px" color="#e0e0e0" />
        <text class="empty-text">未找到相关内容</text>
    </view>
  </view>
</view>

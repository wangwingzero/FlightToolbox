<view class="container">
  <!-- 顶部有效性筛选标签 - 参考民航体检标准设计 -->
  <view class="category-tabs-container">
    <scroll-view class="category-tabs-scroll" scroll-x scroll-with-animation enhanced>
      <view class="category-tabs-wrapper">
        <view
          class="category-tab-item {{ validityFilter === 'all' ? 'active' : '' }}"
          bind:tap="onValidityFilterChange"
          data-filter="all"
        >
          <view class="category-badge">{{ (regulationData.length || 0) + (normativeData.length || 0) }}</view>
          <view class="category-title">全部</view>
        </view>
        <view
          class="category-tab-item {{ validityFilter === 'valid' ? 'active' : '' }}"
          bind:tap="onValidityFilterChange"
          data-filter="valid"
        >
          <view class="category-badge">{{ validRegulationsCount + validNormativesCount }}</view>
          <view class="category-title">有效</view>
        </view>
        <view
          class="category-tab-item {{ validityFilter === 'invalid' ? 'active' : '' }}"
          bind:tap="onValidityFilterChange"
          data-filter="invalid"
        >
          <view class="category-badge">{{ invalidRegulationsCount + invalidNormativesCount }}</view>
          <view class="category-title">失效</view>
        </view>
      </view>
    </scroll-view>
    
    <!-- 时间筛选区域 -->
    <view class="time-filter-section">
      <view class="time-filter-header">
        <view class="filter-title">
          <view class="filter-icon">📅</view>
          <text class="filter-text">规范性文件时间筛选</text>
        </view>
        <view wx:if="{{ timeFilter !== 'all' }}" class="clear-filter-btn" bind:tap="onClearTimeFilter">
          <view class="clear-icon">🗑️</view>
          <text class="clear-text">清除</text>
        </view>
      </view>
      
      <view class="time-filter-content">
        <view class="filter-selector">
          <!-- 使用自定义下拉选择器替代Vant组件 -->
          <view class="custom-dropdown {{ showTimeFilterDropdown ? 'active' : '' }}" catchtap="toggleTimeFilterDropdown" data-test="time-filter-dropdown">
            <view class="dropdown-inner">
              <view class="dropdown-icon">📆</view>
              <view class="dropdown-content">
                <text class="dropdown-label">时间范围</text>
                <text class="dropdown-value">{{ timeFilterTitle }}</text>
              </view>
              <view class="dropdown-arrow-wrapper">
                <text class="dropdown-arrow {{ showTimeFilterDropdown ? 'up' : '' }}">▼</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 自定义日期范围选择器 -->
        <view wx:if="{{ timeFilter === 'custom' }}" class="custom-date-range">
          <view class="date-range-container">
            <view class="date-range-item">
              <view class="date-label-row">
                <text class="range-label">起始日期</text>
                <text class="range-hint">选择开始时间</text>
              </view>
              <picker mode="date" start="1988-01-01" end="2025-12-31" value="{{ customStartDate }}" bind:change="onStartDateChange">
                <view class="date-picker-box">
                  <view class="date-icon">📅</view>
                  <text class="date-text">{{ customStartDateDisplay || '请选择日期' }}</text>
                  <view class="picker-arrow-icon">▼</view>
                </view>
              </picker>
            </view>
            
            <view class="date-range-separator">
              <view class="separator-line"></view>
              <text class="separator-text">至</text>
              <view class="separator-line"></view>
            </view>
            
            <view class="date-range-item">
              <view class="date-label-row">
                <text class="range-label">结束日期</text>
                <text class="range-hint">选择结束时间</text>
              </view>
              <picker mode="date" start="1988-01-01" end="2025-12-31" value="{{ customEndDate }}" bind:change="onEndDateChange">
                <view class="date-picker-box">
                  <view class="date-icon">📅</view>
                  <text class="date-text">{{ customEndDateDisplay || '请选择日期' }}</text>
                  <view class="picker-arrow-icon">▼</view>
                </view>
              </picker>
            </view>
          </view>
          
          <!-- 快捷选择按钮 -->
          <view class="quick-select-row">
            <text class="quick-select-title">快捷选择：</text>
            <view class="quick-select-buttons">
              <view class="quick-btn" bind:tap="selectLastWeek">最近一周</view>
              <view class="quick-btn" bind:tap="selectLastMonth">最近一月</view>
              <view class="quick-btn" bind:tap="selectLastYear">最近一年</view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 搜索区域 -->
  <view class="search-section">
    <van-search
      value="{{ searchKeyword }}"
      placeholder="搜索规章或规范性文件"
      bind:input="onSearchInput"
      bind:change="onSearchInput"
      shape="round"
      class="ccar-search"
    />
  </view>


  <!-- 分类标签页已删除 -->

  <!-- 搜索结果模式 -->
  <view wx:if="{{ isSearchMode }}" class="search-results">
    
    <!-- 规章搜索结果 -->
    <view wx:if="{{ searchedRegulations.length > 0 }}" class="result-section">
      <view class="section-header">
        <view class="section-title">
          <view class="section-icon">📋</view>
          <view class="section-text">规章 ({{ searchedRegulations.length }}条)</view>
        </view>
      </view>
      <view class="modern-result-list">
        <block wx:for="{{ searchedRegulations }}" wx:key="doc_number" wx:for-index="idx">
          <view 
            class="modern-result-card regulation-card" 
            bind:tap="onRegulationClick"
            data-regulation="{{ item }}"
          >
          <!-- 右上角有效性状态标签 -->
          <view class="validity-badge {{ item.validity === '有效' ? 'valid' : (item.validity === '废止' ? 'abolished' : 'invalid') }}">{{ item.validity }}</view>
          
          <view class="card-main">
            <view class="card-title">{{ item.title }}</view>
            <view class="card-meta">
              <view class="meta-badge primary">{{ item.doc_number }}</view>
              <view class="meta-badge secondary">{{ item.office_unit }}</view>
            </view>
          </view>
          
          <view class="card-arrow">
            <van-icon name="arrow" />
          </view>
          </view>
        </block>
      </view>
    </view>

    <!-- 搜索结果广告 -->
    <view wx:if="{{ searchedRegulations.length > 0 && searchedNormatives.length > 0 }}" class="ad-banner-container">
      <ad unit-id="adunit-3b2e78fbdab16389" ad-type="banner" ad-intervals="30"></ad>
    </view>

    <!-- 规范性文件搜索结果 -->
    <view wx:if="{{ searchedNormatives.length > 0 }}" class="result-section">
      <view class="section-header">
        <view class="section-title">
          <view class="section-icon">📄</view>
          <view class="section-text">规范性文件 ({{ searchedNormatives.length }}条)</view>
        </view>
      </view>
      <view class="modern-result-list">
        <block wx:for="{{ searchedNormatives }}" wx:key="doc_number" wx:for-index="idx">
          <view 
            class="modern-result-card normative-card" 
            bind:tap="onNormativeClick"
            data-normative="{{ item }}"
          >
          <!-- 右上角有效性状态标签 -->
          <view class="validity-badge {{ item.validity === '有效' ? 'valid' : (item.validity === '废止' ? 'abolished' : 'invalid') }}">{{ item.validity }}</view>
          
          <view class="card-main">
            <view class="card-title">{{ item.title }}</view>
            <view class="card-meta">
              <view class="meta-badge primary">{{ item.doc_number }}</view>
              <view class="meta-badge date">{{ item.publish_date }}</view>
              <view class="meta-badge secondary">{{ item.office_unit }}</view>
            </view>
          </view>
          
          <view class="card-arrow">
            <van-icon name="info-o" />
          </view>
          </view>
        </block>
      </view>
    </view>

    <!-- 无搜索结果 -->
    <view wx:if="{{ searchedRegulations.length === 0 && searchedNormatives.length === 0 }}" class="modern-empty-state">
      <view class="empty-icon">🔍</view>
      <view class="empty-text">未找到相关内容</view>
      <view class="empty-hint">请尝试其他搜索关键词</view>
    </view>
  </view>

  <!-- 分类列表模式 -->
  <view wx:if="{{ !isSearchMode }}" class="categories-content">
    <view wx:if="{{ filteredCategories.length === 0 && !loading }}" class="modern-empty-state">
      <view class="empty-icon">📋</view>
      <view class="empty-text">暂无相关规章分类</view>
      <view class="empty-hint">尝试更换搜索关键词或分类</view>
    </view>

    <view wx:else class="modern-categories-list">
      <block wx:for="{{ filteredCategories }}" wx:key="name" wx:for-index="idx">
        <view
          class="modern-category-card"
          bind:tap="onCategoryClick"
          data-category="{{ item }}"
        >
        <view class="category-header">
          <view class="category-name">{{ item.name }}</view>
          <view class="category-badge">{{ item.category }}</view>
        </view>

        <view class="category-stats">
          <view class="stat-card regulation-stat">
            <view class="stat-number">{{ item.regulationCount }}</view>
            <view class="stat-label">规章</view>
          </view>
          <view class="stat-card normative-stat">
            <view class="stat-number">{{ item.normativeCount }}</view>
            <view class="stat-label">文件</view>
          </view>
        </view>

        <view class="category-arrow">
          <van-icon name="arrow" />
        </view>
        </view>

        <!-- 在第一个分类后插入广告 -->
        <view wx:if="{{ idx === 0 && !isAdFree }}" class="ad-banner-container">
          <ad unit-id="adunit-d6c8a55bd3cb4fd1" ad-type="banner" ad-intervals="30"></ad>
        </view>
      </block>
    </view>
  </view>

  <!-- 横幅广告 -->
  <view wx:if="{{ !isAdFree }}" class="ad-banner-container">
    <ad unit-id="adunit-735d7d24032d4ca8" ad-type="banner" ad-intervals="30"></ad>
  </view>
</view>

<!-- 时间筛选下拉选项覆盖层 -->
<view wx:if="{{ showTimeFilterDropdown }}" class="dropdown-overlay" catchtap="closeTimeFilterDropdown">
  <view class="dropdown-options-popup" catchtap="noop">
    <view class="popup-header">
      <text class="popup-title">选择时间范围</text>
      <view class="popup-close" bind:tap="closeTimeFilterDropdown">✕</view>
    </view>
    <view 
      wx:for="{{ timeFilterOptions }}"
      wx:key="value"
      class="dropdown-option {{ timeFilter === item.value ? 'active' : '' }}"
      data-value="{{ item.value }}"
      bind:tap="onSelectTimeFilter"
    >
      <text>{{ item.text }}</text>
      <view wx:if="{{ timeFilter === item.value }}" class="option-check">✓</view>
    </view>
  </view>
</view>

<van-toast id="van-toast" />
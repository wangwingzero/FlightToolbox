<view class="container">
  <!-- é¡¶éƒ¨æœ‰æ•ˆæ€§ç­›é€‰æ ‡ç­¾ -->
  <view class="modern-tabs-container">
    <view class="tabs-wrapper">
      <view 
        class="modern-tab {{ validityFilter === 'all' ? 'active' : '' }}"
        bind:tap="onValidityFilterChange"
        data-filter="all"
      >
        <view class="tab-content">
          <view class="tab-icon">ğŸ“‹</view>
          <view class="tab-title">å…¨éƒ¨</view>
          <view class="tab-count">{{ (regulationData.length || 0) + (normativeData.length || 0) }}</view>
        </view>
        <view class="tab-indicator" wx:if="{{ validityFilter === 'all' }}"></view>
      </view>
      <view 
        class="modern-tab {{ validityFilter === 'valid' ? 'active' : '' }}"
        bind:tap="onValidityFilterChange"
        data-filter="valid"
      >
        <view class="tab-content">
          <view class="tab-icon">âœ…</view>
          <view class="tab-title">æœ‰æ•ˆ</view>
          <view class="tab-count">{{ validRegulationsCount + validNormativesCount }}</view>
        </view>
        <view class="tab-indicator" wx:if="{{ validityFilter === 'valid' }}"></view>
      </view>
      <view 
        class="modern-tab {{ validityFilter === 'invalid' ? 'active' : '' }}"
        bind:tap="onValidityFilterChange"
        data-filter="invalid"
      >
        <view class="tab-content">
          <view class="tab-icon">âŒ</view>
          <view class="tab-title">å¤±æ•ˆ</view>
          <view class="tab-count">{{ invalidRegulationsCount + invalidNormativesCount }}</view>
        </view>
        <view class="tab-indicator" wx:if="{{ validityFilter === 'invalid' }}"></view>
      </view>
    </view>
    
    <!-- æ—¶é—´ç­›é€‰åŒºåŸŸ -->
    <view class="time-filter-section">
      <view class="time-filter-header">
        <view class="filter-title">
          <view class="filter-icon">ğŸ“…</view>
          <text class="filter-text">è§„èŒƒæ€§æ–‡ä»¶æ—¶é—´ç­›é€‰</text>
        </view>
        <view wx:if="{{ timeFilter !== 'all' }}" class="clear-filter-btn" bind:tap="onClearTimeFilter">
          <view class="clear-icon">ğŸ—‘ï¸</view>
          <text class="clear-text">æ¸…é™¤</text>
        </view>
      </view>
      
      <view class="time-filter-content">
        <view class="filter-selector">
          <!-- ä½¿ç”¨è‡ªå®šä¹‰ä¸‹æ‹‰é€‰æ‹©å™¨æ›¿ä»£Vantç»„ä»¶ -->
          <view class="custom-dropdown {{ showTimeFilterDropdown ? 'active' : '' }}" catchtap="toggleTimeFilterDropdown" data-test="time-filter-dropdown">
            <view class="dropdown-inner">
              <view class="dropdown-icon">ğŸ“†</view>
              <view class="dropdown-content">
                <text class="dropdown-label">æ—¶é—´èŒƒå›´</text>
                <text class="dropdown-value">{{ timeFilterTitle }}</text>
              </view>
              <view class="dropdown-arrow-wrapper">
                <text class="dropdown-arrow {{ showTimeFilterDropdown ? 'up' : '' }}">â–¼</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨ -->
        <view wx:if="{{ timeFilter === 'custom' }}" class="custom-date-range">
          <view class="date-range-container">
            <view class="date-range-item">
              <view class="date-label-row">
                <text class="range-label">èµ·å§‹æ—¥æœŸ</text>
                <text class="range-hint">é€‰æ‹©å¼€å§‹æ—¶é—´</text>
              </view>
              <picker mode="date" start="1988-01-01" end="2025-12-31" value="{{ customStartDate }}" bind:change="onStartDateChange">
                <view class="date-picker-box">
                  <view class="date-icon">ğŸ“…</view>
                  <text class="date-text">{{ customStartDateDisplay || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</text>
                  <view class="picker-arrow-icon">â–¼</view>
                </view>
              </picker>
            </view>
            
            <view class="date-range-separator">
              <view class="separator-line"></view>
              <text class="separator-text">è‡³</text>
              <view class="separator-line"></view>
            </view>
            
            <view class="date-range-item">
              <view class="date-label-row">
                <text class="range-label">ç»“æŸæ—¥æœŸ</text>
                <text class="range-hint">é€‰æ‹©ç»“æŸæ—¶é—´</text>
              </view>
              <picker mode="date" start="1988-01-01" end="2025-12-31" value="{{ customEndDate }}" bind:change="onEndDateChange">
                <view class="date-picker-box">
                  <view class="date-icon">ğŸ“…</view>
                  <text class="date-text">{{ customEndDateDisplay || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</text>
                  <view class="picker-arrow-icon">â–¼</view>
                </view>
              </picker>
            </view>
          </view>
          
          <!-- å¿«æ·é€‰æ‹©æŒ‰é’® -->
          <view class="quick-select-row">
            <text class="quick-select-title">å¿«æ·é€‰æ‹©ï¼š</text>
            <view class="quick-select-buttons">
              <view class="quick-btn" bind:tap="selectLastWeek">æœ€è¿‘ä¸€å‘¨</view>
              <view class="quick-btn" bind:tap="selectLastMonth">æœ€è¿‘ä¸€æœˆ</view>
              <view class="quick-btn" bind:tap="selectLastYear">æœ€è¿‘ä¸€å¹´</view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç°ä»£åŒ–æœç´¢åŒºåŸŸ -->
  <view class="search-section">
    <view class="search-container">
      <view class="search-input-wrapper">
        <view class="search-icon">ğŸ”</view>
        <van-search
          value="{{ searchKeyword }}"
          placeholder="æœç´¢è§„ç« æˆ–è§„èŒƒæ€§æ–‡ä»¶"
          bind:input="onSearchInput"
          bind:change="onSearchInput"
          show-action="{{ false }}"
          class="ccar-search"
        />
      </view>
    </view>
    
  </view>


  <!-- åˆ†ç±»æ ‡ç­¾é¡µå·²åˆ é™¤ -->

  <!-- æœç´¢ç»“æœæ¨¡å¼ -->
  <view wx:if="{{ isSearchMode }}" class="search-results">
    
    <!-- è§„ç« æœç´¢ç»“æœ -->
    <view wx:if="{{ searchedRegulations.length > 0 }}" class="result-section">
      <view class="section-header">
        <view class="section-title">
          <view class="section-icon">ğŸ“‹</view>
          <view class="section-text">è§„ç«  ({{ searchedRegulations.length }}æ¡)</view>
        </view>
      </view>
      <view class="modern-result-list">
        <block wx:for="{{ searchedRegulations }}" wx:key="doc_number" wx:for-index="idx">
          <view 
            class="modern-result-card regulation-card" 
            bind:tap="onRegulationClick"
            data-regulation="{{ item }}"
          >
          <!-- å³ä¸Šè§’æœ‰æ•ˆæ€§çŠ¶æ€æ ‡ç­¾ -->
          <view class="validity-badge {{ item.validity === 'æœ‰æ•ˆ' ? 'valid' : (item.validity === 'åºŸæ­¢' ? 'abolished' : 'invalid') }}">{{ item.validity }}</view>
          
          <view class="card-main">
            <view class="card-title">{{ item.title }}</view>
            <view class="card-meta">
              <view class="meta-badge primary">{{ item.doc_number }}</view>
              <view class="meta-badge secondary">{{ item.office_unit }}</view>
            </view>
          </view>
          
          <view class="card-arrow">
            <van-icon name="arrow" />
          </view>
          </view>
        </block>
      </view>
    </view>

    <!-- è§„èŒƒæ€§æ–‡ä»¶æœç´¢ç»“æœ -->
    <view wx:if="{{ searchedNormatives.length > 0 }}" class="result-section">
      <view class="section-header">
        <view class="section-title">
          <view class="section-icon">ğŸ“„</view>
          <view class="section-text">è§„èŒƒæ€§æ–‡ä»¶ ({{ searchedNormatives.length }}æ¡)</view>
        </view>
      </view>
      <view class="modern-result-list">
        <block wx:for="{{ searchedNormatives }}" wx:key="doc_number" wx:for-index="idx">
          <view 
            class="modern-result-card normative-card" 
            bind:tap="onNormativeClick"
            data-normative="{{ item }}"
          >
          <!-- å³ä¸Šè§’æœ‰æ•ˆæ€§çŠ¶æ€æ ‡ç­¾ -->
          <view class="validity-badge {{ item.validity === 'æœ‰æ•ˆ' ? 'valid' : (item.validity === 'åºŸæ­¢' ? 'abolished' : 'invalid') }}">{{ item.validity }}</view>
          
          <view class="card-main">
            <view class="card-title">{{ item.title }}</view>
            <view class="card-meta">
              <view class="meta-badge primary">{{ item.doc_number }}</view>
              <view class="meta-badge date">{{ item.publish_date }}</view>
              <view class="meta-badge secondary">{{ item.office_unit }}</view>
            </view>
          </view>
          
          <view class="card-arrow">
            <van-icon name="info-o" />
          </view>
          </view>
        </block>
      </view>
    </view>

    <!-- æ— æœç´¢ç»“æœ -->
    <view wx:if="{{ searchedRegulations.length === 0 && searchedNormatives.length === 0 }}" class="modern-empty-state">
      <view class="empty-icon">ğŸ”</view>
      <view class="empty-text">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</view>
      <view class="empty-hint">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</view>
    </view>
  </view>

  <!-- åˆ†ç±»åˆ—è¡¨æ¨¡å¼ -->
  <view wx:if="{{ !isSearchMode }}" class="categories-content">
    <view wx:if="{{ filteredCategories.length === 0 && !loading }}" class="modern-empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <view class="empty-text">æš‚æ— ç›¸å…³è§„ç« åˆ†ç±»</view>
      <view class="empty-hint">å°è¯•æ›´æ¢æœç´¢å…³é”®è¯æˆ–åˆ†ç±»</view>
    </view>

    <view wx:else class="modern-categories-list">
      <block wx:for="{{ filteredCategories }}" wx:key="name" wx:for-index="idx">
        <view 
          class="modern-category-card" 
          bind:tap="onCategoryClick"
          data-category="{{ item }}"
        >
        <view class="category-header">
          <view class="category-name">{{ item.name }}</view>
          <view class="category-badge">{{ item.category }}</view>
        </view>
        
        <view class="category-stats">
          <view class="stat-card regulation-stat">
            <view class="stat-number">{{ item.regulationCount }}</view>
            <view class="stat-label">è§„ç« </view>
          </view>
          <view class="stat-card normative-stat">
            <view class="stat-number">{{ item.normativeCount }}</view>
            <view class="stat-label">æ–‡ä»¶</view>
          </view>
        </view>
        
        <view class="category-arrow">
          <van-icon name="arrow" />
        </view>
        </view>
      </block>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="modern-stats-footer" wx:if="{{ !isSearchMode }}">
    <view class="stats-container">
      <view class="stats-item">
        <view class="stats-number">{{ categories.length }}</view>
        <view class="stats-label">ä¸ªåˆ†ç±»</view>
      </view>
      <view class="stats-divider"></view>
      <view class="stats-item">
        <view class="stats-number">{{ regulationData.length }}</view>
        <view class="stats-label">ä¸ªè§„ç« </view>
      </view>
      <view class="stats-divider"></view>
      <view class="stats-item">
        <view class="stats-number">{{ normativeData.length }}</view>
        <view class="stats-label">ä¸ªæ–‡ä»¶</view>
      </view>
    </view>
  </view>

</view>

<!-- æ—¶é—´ç­›é€‰ä¸‹æ‹‰é€‰é¡¹è¦†ç›–å±‚ -->
<view wx:if="{{ showTimeFilterDropdown }}" class="dropdown-overlay" catchtap="closeTimeFilterDropdown">
  <view class="dropdown-options-popup" catchtap="noop">
    <view class="popup-header">
      <text class="popup-title">é€‰æ‹©æ—¶é—´èŒƒå›´</text>
      <view class="popup-close" bind:tap="closeTimeFilterDropdown">âœ•</view>
    </view>
    <view 
      wx:for="{{ timeFilterOptions }}"
      wx:key="value"
      class="dropdown-option {{ timeFilter === item.value ? 'active' : '' }}"
      data-value="{{ item.value }}"
      bind:tap="onSelectTimeFilter"
    >
      <text>{{ item.text }}</text>
      <view wx:if="{{ timeFilter === item.value }}" class="option-check">âœ“</view>
    </view>
  </view>
</view>

<van-toast id="van-toast" />
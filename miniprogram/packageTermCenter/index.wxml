<view class="term-center-page">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="term-header">
    <view class="header-content">
      <view class="title">æœ¯è¯­ä¸­å¿ƒ</view>
      <view class="subtitle">ç»Ÿä¸€æŸ¥è¯¢ç¼©å†™ã€æƒå¨å®šä¹‰ä¸ IOSA æœ¯è¯­</view>
    </view>
  </view>

  <view class="term-tabs">
    <view class="term-tab {{ activeTab === 'all' ? 'active' : '' }}" data-tab="all" bind:tap="onTabChange">
      <text class="tab-label">å…¨éƒ¨</text>
      <text class="tab-count" wx:if="{{ totalCount > 0 }}">{{ totalCount }}</text>
    </view>
    <view class="term-tab {{ activeTab === 'abbreviation' ? 'active' : '' }}" data-tab="abbreviation" bind:tap="onTabChange">
      <text class="tab-label">ç¼©å†™</text>
      <text class="tab-count" wx:if="{{ abbreviationCount > 0 }}">{{ abbreviationCount }}</text>
    </view>
    <view class="term-tab {{ activeTab === 'definition' ? 'active' : '' }}" data-tab="definition" bind:tap="onTabChange">
      <text class="tab-label">æƒå¨å®šä¹‰</text>
      <text class="tab-count" wx:if="{{ definitionCount > 0 }}">{{ definitionCount }}</text>
    </view>
    <view class="term-tab {{ activeTab === 'iosa' ? 'active' : '' }}" data-tab="iosa" bind:tap="onTabChange">
      <text class="tab-label">IOSA å®¡è®¡</text>
      <text class="tab-count" wx:if="{{ iosaCount > 0 }}">{{ iosaCount }}</text>
    </view>
  </view>

  <view class="search-wrapper">
    <van-search
      value="{{ searchValue }}"
      placeholder="æœç´¢ç¼©å†™ã€æœ¯è¯­åç§°æˆ–å®šä¹‰å†…å®¹"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>

  <view wx:if="{{ loadError }}" class="error-tip">
    <text>{{ loadError }}</text>
  </view>

  <scroll-view class="result-scroll" scroll-y="true">
    <view wx:if="{{ isLoading }}" class="loading-section">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨åŠ è½½æœ¯è¯­æ•°æ®...</text>
    </view>

    <view wx:elif="{{ !isLoading && displayResults.length === 0 }}" class="no-results">
      <view class="no-results-icon">ğŸ”</view>
      <view class="no-results-text">æœªæ‰¾åˆ°ç›¸å…³æœ¯è¯­</view>
      <view class="no-results-tip">è¯•è¯•æ›´çŸ­çš„å…³é”®è¯ï¼Œæˆ–åˆ‡æ¢ä¸Šæ–¹ç±»åˆ«</view>
    </view>

    <view wx:else class="result-list">
      <block wx:for="{{ displayResults }}" wx:key="id" wx:for-index="idx">
        <view class="result-card type-{{ item.type }}" bind:tap="onResultTap" data-index="{{ idx }}">
          <!-- å½©è‰²å·¦è¾¹æ¡† accent -->
          <view class="card-accent"></view>
          
          <view class="card-content">
            <view class="result-header">
              <view class="result-tag-wrapper">
                <!-- ç±»å‹å›¾æ ‡ + æ ‡ç­¾ -->
                <view class="type-icon {{ item.type }}">
                  <text class="icon-text">{{ item.type === 'abbreviation' ? 'AB' : (item.type === 'definition' ? 'DEF' : 'IOSA') }}</text>
                </view>
                <text class="type-label">{{ item.type === 'abbreviation' ? 'ç¼©å†™' : (item.type === 'definition' ? 'æƒå¨å®šä¹‰' : 'IOSAå®¡è®¡') }}</text>
              </view>
              <view class="result-source" wx:if="{{ item.source }}">
                {{ item.source }}
              </view>
            </view>
            
            <view class="result-title">{{ item.title }}</view>
            <view class="result-subtitle" wx:if="{{ item.subtitle }}">{{ item.subtitle }}</view>
            <view class="result-desc" wx:if="{{ item.description }}">{{ item.description }}</view>
          </view>
        </view>
      </block>

      <view wx:if="{{ hasMore }}" class="load-more" bind:tap="onLoadMore">
        <view class="load-more-button">
          <text class="load-more-text">åŠ è½½æ›´å¤š</text>
          <text class="load-more-icon">â†“</text>
        </view>
      </view>

      <view wx:if="{{ !hasMore }}" class="no-more">
        <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨ {{ totalCount }} æ¡ç»“æœ</text>
      </view>
    </view>
  </scroll-view>

  <van-popup
    show="{{ showDetailPopup }}"
    position="bottom"
    round
    bind:close="closeDetailPopup"
    custom-style="height: 80%; max-height: 80vh;"
  >
    <view wx:if="{{ selectedItem }}" class="detail-popup">
      <!-- æ¯›ç»ç’ƒæ•ˆæœå¤´éƒ¨ -->
      <view class="detail-header type-{{ selectedItem.type }}">
        <view class="detail-header-content">
          <view class="detail-header-row">
            <view class="detail-header-left">
              <view class="detail-type-badge">
                <text class="badge-icon">{{ selectedItem.type === 'abbreviation' ? 'AB' : (selectedItem.type === 'definition' ? 'DEF' : 'IOSA') }}</text>
                <text class="badge-label">{{ selectedItem.type === 'abbreviation' ? 'ç¼©å†™' : (selectedItem.type === 'definition' ? 'æƒå¨å®šä¹‰' : 'IOSAå®¡è®¡') }}</text>
              </view>
            </view>
            <view class="detail-header-right">
              <view class="detail-close-wrapper" bind:tap="closeDetailPopup">
                <text class="detail-close-icon">âœ•</text>
              </view>
            </view>
          </view>
          <view class="detail-title">{{ selectedItem.title }}</view>
        </view>
      </view>

      <scroll-view class="detail-body" scroll-y="true">
        <block wx:if="{{ selectedItem.type === 'abbreviation' }}">
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ”¤</text>
              <text class="detail-label">ç¼©å†™</text>
            </view>
            <view class="detail-content">{{ selectedItem.raw.abbreviation || 'æš‚æ— ' }}</view>
          </view>
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸŒ</text>
              <text class="detail-label">è‹±æ–‡å…¨ç§°</text>
            </view>
            <view class="detail-content">{{ selectedItem.raw.english_full || 'æš‚æ— ' }}</view>
          </view>
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ‡¨ğŸ‡³</text>
              <text class="detail-label">ä¸­æ–‡ç¿»è¯‘</text>
            </view>
            <view class="detail-content">{{ selectedItem.raw.chinese_translation || 'æš‚æ— ' }}</view>
          </view>
        </block>

        <block wx:if="{{ selectedItem.type === 'definition' }}">
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ‡¨ğŸ‡³</text>
              <text class="detail-label">ä¸­æ–‡åç§°</text>
            </view>
            <view class="detail-content">{{ selectedItem.raw.chinese_name || 'æš‚æ— ' }}</view>
          </view>
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸŒ</text>
              <text class="detail-label">è‹±æ–‡åç§°</text>
            </view>
            <view class="detail-content">{{ selectedItem.raw.english_name || 'æš‚æ— ' }}</view>
          </view>
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ“–</text>
              <text class="detail-label">å®šä¹‰</text>
            </view>
            <view class="detail-content definition-text">
              <block wx:if="{{ selectedItem.definitionParts && selectedItem.definitionParts.length > 0 }}">
                <block wx:for="{{ selectedItem.definitionParts }}" wx:key="index">
                  <text wx:if="{{ item.type === 'text' }}">{{ item.text }}</text>
                  <text
                    wx:elif="{{ item.type === 'term' }}"
                    class="clickable-term"
                    catchtap="onDefinitionTermClick"
                    data-term="{{ item.termName }}"
                  >{{ item.text }}</text>
                </block>
              </block>
              <text wx:else>{{ selectedItem.raw.definition || 'æš‚æ— ' }}</text>
            </view>
          </view>
        </block>

        <block wx:if="{{ selectedItem.type === 'iosa' }}">
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ‡¨ğŸ‡³</text>
              <text class="detail-label">ä¸­æ–‡åç§°</text>
            </view>
            <view class="detail-content">{{ selectedItem.raw.chinese_name || 'æš‚æ— ' }}</view>
          </view>
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸŒ</text>
              <text class="detail-label">è‹±æ–‡åç§°</text>
            </view>
            <view class="detail-content">{{ selectedItem.raw.english_name || 'æš‚æ— ' }}</view>
          </view>
          <view class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ“–</text>
              <text class="detail-label">å®šä¹‰</text>
            </view>
            <view class="detail-content definition-text">{{ selectedItem.raw.definition || 'æš‚æ— ' }}</view>
          </view>
          <view wx:if="{{ selectedItem.equivalentTermsArray && selectedItem.equivalentTermsArray.length }}" class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ”—</text>
              <text class="detail-label">ç­‰æ•ˆæœ¯è¯­</text>
            </view>
            <view class="detail-content">
              <block wx:for="{{ selectedItem.equivalentTermsArray }}" wx:key="index">
                <text
                  class="clickable-term"
                  catchtap="onIOSAEquivalentClick"
                  data-term="{{ item }}"
                >{{ item }}</text>
                <text wx:if="{{ index < selectedItem.equivalentTermsArray.length - 1 }}">ï¼Œ</text>
              </block>
            </view>
          </view>
          <view wx:if="{{ selectedItem.seeAlsoArray && selectedItem.seeAlsoArray.length }}" class="detail-section">
            <view class="section-header">
              <text class="section-icon">ğŸ“</text>
              <text class="detail-label">å‚è§</text>
            </view>
            <view class="detail-content">
              <block wx:for="{{ selectedItem.seeAlsoArray }}" wx:key="index">
                <text
                  class="clickable-term"
                  catchtap="onIOSAEquivalentClick"
                  data-term="{{ item }}"
                >{{ item }}</text>
                <text wx:if="{{ index < selectedItem.seeAlsoArray.length - 1 }}">ï¼Œ</text>
              </block>
            </view>
          </view>
        </block>

        <view wx:if="{{ selectedItem.source }}" class="detail-section source-section">
          <view class="section-header">
            <text class="section-icon">ğŸ“š</text>
            <text class="detail-label">æ¥æº</text>
          </view>
          <view class="detail-content source-text">{{ selectedItem.source }}</view>
        </view>
      </scroll-view>

      <!-- åº•éƒ¨æ“ä½œæ ï¼šä¼˜å…ˆæä¾›â€œè¿”å›â€ï¼Œå…³é—­äº¤ç”±å³ä¸Šè§’ âœ• -->
      <view class="detail-footer-bar">
        <view wx:if="{{ canGoBack }}" class="detail-footer-single secondary" bind:tap="onDetailBackTap">
          <text class="detail-footer-text">è¿”å›</text>
        </view>
        <view wx:else class="detail-footer-single primary" bind:tap="closeDetailPopup">
          <text class="detail-footer-text">å…³é—­</text>
        </view>
      </view>
    </view>
  </van-popup>
</view>

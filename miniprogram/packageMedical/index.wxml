<view class="container page-content">
  <!-- åˆ†ç±»èœå• -->
  <view class="category-tabs-container">
    <scroll-view class="category-tabs-scroll" scroll-x scroll-with-animation enhanced>
      <view class="category-tabs-wrapper">
        <view
          wx:for="{{ categoryList }}"
          wx:key="name"
          class="category-tab-item {{ activeTab === item.name ? 'active' : '' }}"
          bind:tap="onTabChange"
          data-name="{{ item.name }}"
        >
          <view class="category-badge">{{ item.count }}</view>
          <view class="category-title">{{ item.title }}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-section medical-search">
    <van-search
      value="{{ searchKeyword }}"
      placeholder="{{ searchPlaceholder }}"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>

  <!-- ä½“æ£€æ ‡å‡†åˆ—è¡¨ -->
  <view class="standards-section">
    <view wx:if="{{ displayedStandards.length > 0 }}" class="context7-content-container">
      <view class="context7-card-wrapper">
        <block wx:for="{{ displayedStandards }}" wx:key="id" wx:for-index="idx">
          <view
            class="context7-item-card medical-item-card"
            bind:tap="showStandardDetail"
            data-index="{{ idx }}"
          >
            <view class="item-card-header">
              <view class="item-primary">
                <text class="item-name-zh">{{ item.name_zh }}</text>
                <view class="item-badges">
                  <view class="medical-category-badge" data-category="{{ item.category }}">
                    <text>{{ item.categoryShort }}</text>
                  </view>
                </view>
              </view>
              <view class="item-secondary">
                <text class="item-name-en">{{ item.name_en }}</text>
              </view>
            </view>

            <view class="item-card-content">
              <!-- å•ä¸€è¯„å®šç»“æœï¼ˆå¯¹è±¡æ ¼å¼ï¼‰ -->
              <view wx:if="{{ item.standard.assessment }}" class="item-definition">
                <text class="assessment-badge">{{ item.standard.assessment }}</text>
              </view>
              <!-- å¤šç§è¯„å®šç»“æœï¼ˆæ•°ç»„æ ¼å¼ï¼‰ -->
              <view wx:elif="{{ item.standard.length > 0 }}" class="item-definition-multi">
                <text class="assessment-badge" wx:for="{{ item.standard }}" wx:key="assessment" wx:if="{{ index < 2 }}">
                  {{ item.assessment }}
                </text>
                <text wx:if="{{ item.standard.length > 2 }}" class="more-indicator">...</text>
              </view>

              <!-- æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ¡ä»¶ä½œä¸ºé¢„è§ˆ -->
              <view wx:if="{{ item.standard.conditions && item.standard.conditions.length > 0 }}" class="item-conditions-preview">
                <text class="condition-preview">{{ item.standard.conditions[0] }}</text>
                <text wx:if="{{ item.standard.conditions.length > 1 }}" class="more-conditions">ç­‰{{ item.standard.conditions.length }}æ¡</text>
              </view>
              <view wx:elif="{{ item.standard.length > 0 && item.standard[0].conditions }}" class="item-conditions-preview">
                <text class="condition-preview">{{ item.standard[0].conditions[0] }}</text>
                <text wx:if="{{ item.standard[0].conditions.length > 1 || item.standard.length > 1 }}" class="more-conditions">
                  ç­‰å¤šæ¡
                </text>
              </view>
            </view>

            <view class="item-card-footer">
              <view class="item-meta">
                <van-icon name="info-o" size="14px" />
                <text>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</text>
              </view>
              <view class="item-arrow">
                <van-icon name="arrow" size="16px" />
              </view>
            </view>
          </view>
        </block>
      </view>

      <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
      <view wx:if="{{ hasMore }}" class="load-more-container">
        <button
          class="load-more-btn {{ loading ? 'loading' : '' }}"
          bind:tap="loadMoreStandards"
          disabled="{{ loading }}"
        >
          <view wx:if="{{ loading }}" class="loading-icon">
            <van-loading size="20px" color="#22c55e" />
          </view>
          <text class="load-more-text">{{ loading ? 'åŠ è½½ä¸­...' : 'åŠ è½½æ›´å¤š' }}</text>
        </button>
        <view class="remaining-count">
          è¿˜æœ‰ {{ filteredStandards.length - displayedStandards.length }} æ¡æ•°æ®
        </view>
      </view>
    </view>

    <!-- æ— æœç´¢ç»“æœ -->
    <view wx:else class="no-results">
      <view class="no-results-icon">ğŸ”</view>
      <view class="no-results-text">æœªæ‰¾åˆ°ç›¸å…³ä½“æ£€æ ‡å‡†</view>
      <view class="no-results-tip">è¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–åˆ‡æ¢åˆ†ç±»</view>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{ activeTab === 'å…¨éƒ¨' && !searchKeyword }}" class="stats-section">
    <view class="stats-item">
      <text class="stats-number">{{ displayedStandards.length }}</text>
      <text class="stats-label">å·²æ˜¾ç¤º</text>
    </view>
    <view class="stats-item">
      <text class="stats-number">{{ totalCount }}</text>
      <text class="stats-label">æ€»æ ‡å‡†</text>
    </view>
    <view class="stats-item">
      <text class="stats-number">6</text>
      <text class="stats-label">ä¸ªåˆ†ç±»</text>
    </view>
  </view>

</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<van-popup
  show="{{ showDetailPopup }}"
  position="bottom"
  round
  closeable
  close-icon="close"
  bind:close="closeDetailPopup"
  custom-style="height: 80%; max-height: 80vh;"
>
  <view class="detail-popup" wx:if="{{ selectedStandard && selectedStandard.name_zh }}">
    <view class="popup-header">
      <!-- è¿”å›æŒ‰é’® - å½“æœ‰æµè§ˆå†å²æ—¶æ˜¾ç¤º -->
      <view wx:if="{{ canGoBack }}" class="popup-back-btn" bind:tap="goBackInHistory">
        <van-icon name="arrow-left" size="20px" color="white" />
      </view>

      <view class="popup-header-content">
        <view class="popup-title">{{ selectedStandard.name_zh || 'æ ‡å‡†è¯¦æƒ…' }}</view>
        <view class="popup-subtitle">{{ selectedStandard.name_en || '' }}</view>
      </view>

      <view class="popup-close-btn" bind:tap="closeDetailPopup">
        <van-icon name="cross" size="20px" color="white" />
      </view>
    </view>

    <scroll-view class="popup-content" scroll-y enhanced enable-flex show-scrollbar="{{false}}" scroll-with-animation="{{false}}" enable-back-to-top="{{false}}" throttle="{{false}}" scroll-anchoring="{{false}}" refresher-enabled="{{false}}">

      <!-- åŸºæœ¬ä¿¡æ¯åŒºå— -->
      <view class="info-block">
        <view class="info-block-title">åŸºæœ¬ä¿¡æ¯</view>
        <view class="info-block-content">
          <view class="info-row">
            <text class="info-label">åˆ†ç±»</text>
            <text class="info-value">{{ selectedStandard.category }}</text>
          </view>
        </view>
      </view>

      <!-- è¯„å®šç»“æœåŒºå— - å•ä¸€è¯„å®šç»“æœï¼ˆå¯¹è±¡æ ¼å¼ï¼‰ -->
      <view wx:if="{{ selectedStandard.standard.assessment }}" class="info-block">
        <view class="info-block-title">è¯„å®šç»“æœ</view>
        <view class="info-block-content">
          <view class="assessment-result-badge {{ selectedStandard.standard.badgeClass }}">
            {{ selectedStandard.standard.assessment }}
          </view>
        </view>
      </view>

      <!-- è¯„å®šæ¡ä»¶åŒºå— - å•ä¸€è¯„å®šç»“æœ -->
      <view wx:if="{{ selectedStandard.standard.conditions && selectedStandard.standard.conditions.length > 0 }}" class="info-block">
        <view class="info-block-title">è¯„å®šæ¡ä»¶</view>
        <view class="info-block-content">
          <view wx:for="{{ selectedStandard.standard.conditions }}" wx:key="index" class="condition-detail">
            <text class="condition-bullet">â€¢</text>
            <!-- ä½¿ç”¨segmentsç»“æ„æ”¯æŒç‚¹å‡»äº‹ä»¶ -->
            <view wx:if="{{ selectedStandard.standard.processedConditions && selectedStandard.standard.processedConditions[index] }}" class="condition-text-rich">
              <block wx:for="{{ selectedStandard.standard.processedConditions[index].segments }}" wx:key="index" wx:for-item="segment">
                <text wx:if="{{ segment.type === 'text' }}">{{ segment.content }}</text>
                <text
                  wx:elif="{{ segment.type === 'term' }}"
                  class="term-link"
                  bind:tap="onTermTap"
                  data-term="{{ segment.term }}"
                >{{ segment.content }}</text>
              </block>
            </view>
            <text wx:else class="condition-text">{{ item }}</text>
          </view>
        </view>
      </view>

      <!-- è¯„å®šæ ‡å‡†åŒºå— - å¤šç§è¯„å®šç»“æœï¼ˆæ•°ç»„æ ¼å¼ï¼‰ -->
      <view wx:if="{{ selectedStandard.standard.length > 0 }}" class="info-block">
        <view class="info-block-title">è¯„å®šæ ‡å‡†ï¼ˆå…±{{ selectedStandard.standard.length }}ç§æƒ…å†µï¼‰</view>
        <view class="info-block-content">
          <view wx:for="{{ selectedStandard.standard }}" wx:key="assessment" wx:for-item="stdItem" wx:for-index="stdIndex" class="assessment-group-item">
            <view class="assessment-header">
              <text class="assessment-number">æƒ…å†µ{{ stdIndex + 1 }}</text>
              <view class="assessment-result-badge {{ stdItem.badgeClass }}">
                {{ stdItem.assessment }}
              </view>
            </view>
            <view wx:if="{{ stdItem.conditions && stdItem.conditions.length > 0 }}" class="assessment-conditions">
              <text class="conditions-title">æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼š</text>
              <view wx:for="{{ stdItem.conditions }}" wx:key="index" wx:for-item="condition" wx:for-index="condIndex" class="condition-detail">
                <text class="condition-bullet">â€¢</text>
                <!-- ä½¿ç”¨segmentsç»“æ„æ”¯æŒç‚¹å‡»äº‹ä»¶ -->
                <view wx:if="{{ stdItem.processedConditions && stdItem.processedConditions[condIndex] }}" class="condition-text-rich">
                  <block wx:for="{{ stdItem.processedConditions[condIndex].segments }}" wx:key="index" wx:for-item="segment">
                    <text wx:if="{{ segment.type === 'text' }}">{{ segment.content }}</text>
                    <text
                      wx:elif="{{ segment.type === 'term' }}"
                      class="term-link"
                      bind:tap="onTermTap"
                      data-term="{{ segment.term }}"
                    >{{ segment.content }}</text>
                  </block>
                </view>
                <text wx:else class="condition-text">{{ condition }}</text>
              </view>
            </view>
            <view wx:if="{{ stdItem.notes }}" class="assessment-notes">
              <text class="notes-label">å¤‡æ³¨ï¼š</text>
              <text class="notes-text">{{ stdItem.notes }}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- ç‰¹åˆ«è¯´æ˜åŒºå— -->
      <view wx:if="{{ selectedStandard.standard.notes }}" class="info-block">
        <view class="info-block-title">ç‰¹åˆ«è¯´æ˜</view>
        <view class="info-block-content">
          <view class="notes-content">
            {{ selectedStandard.standard.notes }}
          </view>
        </view>
      </view>

      <!-- æ•°æ®æ¥æºåŒºå— -->
      <view class="info-block">
        <view class="info-block-title">æ•°æ®æ¥æº</view>
        <view class="info-block-content">
          <view class="source-content">
            ã€Šæ°‘ç”¨èˆªç©ºä½“æ£€é‰´å®šåŒ»å­¦æ ‡å‡†å®æ–½ç»†åˆ™ã€‹(AC-67FS-001R2)
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="popup-bottom-btn">
        <!-- å½“æœ‰æµè§ˆå†å²æ—¶ï¼Œæ˜¾ç¤ºè¿”å›å’Œå…³é—­ä¸¤ä¸ªæŒ‰é’® -->
        <block wx:if="{{ canGoBack }}">
          <button class="back-btn" bind:tap="goBackInHistory">è¿”å›</button>
          <button class="close-btn" bind:tap="closeDetailPopup">å…³é—­</button>
        </block>
        <!-- æ²¡æœ‰æµè§ˆå†å²æ—¶ï¼Œåªæ˜¾ç¤ºå…³é—­æŒ‰é’® -->
        <button wx:else class="close-btn close-btn-full" bind:tap="closeDetailPopup">å…³é—­</button>
      </view>
    </scroll-view>
  </view>

  <view wx:else class="detail-popup">
    <view class="popup-header">
      <view class="popup-title">åŠ è½½ä¸­...</view>
    </view>
    <view class="popup-content">
      <view class="detail-section">
        <view class="detail-content">æ­£åœ¨åŠ è½½æ ‡å‡†è¯¦æƒ…...</view>
      </view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />

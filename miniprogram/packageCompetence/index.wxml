<view class="container page-content">
  <!-- åˆ†ç±»æ ‡ç­¾é¡µ -->
  <view class="category-tabs-container">
    <van-tabs active="{{ activeCategory }}" bind:change="onCategoryChange" color="#667eea" title-active-color="#667eea">
      <van-tab wx:for="{{ categoryTabs }}" wx:key="id" name="{{ item.id }}" title="{{ item.name }}({{ item.count }})">
      </van-tab>
    </van-tabs>
  </view>

  <!-- æœç´¢åŒºåŸŸ -->
  <view class="search-section">
    <view class="premium-search-box {{ searchFocused ? 'focused' : '' }}">
      <view class="search-icon-wrapper">
        <van-icon name="search" size="20px" color="#6366f1" />
      </view>

      <input
        class="premium-search-input"
        value="{{ searchValue }}"
        placeholder="æœç´¢èƒœä»»åŠ›åç§°ã€æè¿°æˆ–è¡Œä¸ºæŒ‡æ ‡"
        placeholder-class="premium-search-placeholder"
        bindinput="onSearchInput"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
        confirm-type="search"
      />

      <view wx:if="{{ searchValue }}" class="search-clear-btn" bind:tap="onSearchClear">
        <van-icon name="clear" size="18px" color="#9ca3af" />
      </view>
    </view>

    <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
    <view wx:if="{{ filteredCount !== totalCount }}" class="search-stats">
      <view class="stats-content">
        <text class="stats-icon">âœ…</text>
        <text class="stats-text">æ‰¾åˆ° {{ filteredCount }} æ¡ç»“æœ</text>
      </view>
    </view>
  </view>

  <!-- èƒœä»»åŠ›åˆ—è¡¨ -->
  <view class="competencies-container">
    <!-- ç©ºçŠ¶æ€ -->
    <van-empty
      wx:if="{{ displayedCompetencies.length === 0 }}"
      image="search"
      description="æœªæ‰¾åˆ°ç›¸å…³èƒœä»»åŠ›"
    />

    <!-- èƒœä»»åŠ›åˆ—è¡¨ -->
    <view wx:else class="competencies-list">
      <block wx:for="{{ displayedCompetencies }}" wx:key="id" wx:for-index="idx">
        <view
          class="competency-card"
          bind:tap="onCompetencyTap"
          data-competency="{{ item }}"
        >
          <!-- å¡ç‰‡å¤´éƒ¨ -->
          <view class="card-header">
            <view class="card-title">{{ item.id }} - {{ item.chinese_name }}</view>
            <view class="category-badge {{ item.category === 'core' ? 'badge-core' : 'badge-instructor' }}">
              {{ item.category === 'core' ? 'æ ¸å¿ƒ' : 'æ•™å‘˜' }}
            </view>
          </view>

          <!-- è‹±æ–‡åç§° -->
          <view class="english-name">{{ item.english_name }}</view>

          <!-- æè¿°å†…å®¹åŒºåŸŸ -->
          <view class="description-box">
            <view class="description-text">{{ item.description }}</view>
          </view>

          <!-- è¡Œä¸ºæŒ‡æ ‡ç»Ÿè®¡ -->
          <view class="behavior-stats">
            <van-tag type="primary" plain>{{ item.behavior_count || 0 }} ä¸ªè¡Œä¸ºæŒ‡æ ‡</van-tag>
          </view>

          <!-- æ“ä½œæç¤º -->
          <view class="action-hint">
            <view class="hint-icon">ğŸ‘†</view>
            <view class="hint-text">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†å†…å®¹</view>
          </view>
        </view>
      </block>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{ hasMore }}" class="load-more-container">
        <view class="load-more-btn" bind:tap="onLoadMore">
          <van-loading type="spinner" size="16px" />
          <text class="load-more-text">åŠ è½½æ›´å¤š</text>
        </view>
      </view>

      <!-- å·²åŠ è½½å…¨éƒ¨ -->
      <view wx:else class="load-complete">
        <view class="load-complete-text">å·²æ˜¾ç¤ºå…¨éƒ¨ {{ filteredCount }} æ¡èƒœä»»åŠ›</view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½è¯´æ˜ -->
  <view class="tips-section">
    <view class="tips-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</view>
    <view class="tips-content">
      <view class="tip-item">â€¢ PLMèƒœä»»åŠ›åŠè¡Œä¸ºæŒ‡æ ‡æ¡†æ¶æƒå¨æŸ¥è¯¢</view>
      <view class="tip-item">â€¢ åŒ…å«9é¡¹æ ¸å¿ƒèƒœä»»åŠ›å’Œ4é¡¹æ£€æŸ¥å‘˜æ•™å‘˜èƒœä»»åŠ›</view>
      <view class="tip-item">â€¢ æ”¯æŒä¸­è‹±æ–‡èƒœä»»åŠ›åç§°å’Œæè¿°æœç´¢</view>
      <view class="tip-item">â€¢ ç‚¹å‡»ä»»æ„èƒœä»»åŠ›å¯æŸ¥çœ‹è¯¦ç»†çš„è¡Œä¸ºæŒ‡æ ‡</view>
      <view class="tip-item">â€¢ æ”¯æŒç¦»çº¿ä½¿ç”¨ï¼Œæ— éœ€ç½‘ç»œè¿æ¥</view>
    </view>
  </view>

</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<van-popup
  show="{{ showModal }}"
  bind:close="onModalClose"
  position="bottom"
  round="{{ true }}"
  close-on-click-overlay="{{ true }}"
  custom-style="height: 85vh; overflow: hidden; border-left: none; border-right: none; border: none;"
>
  <view class="detail-popup-container">
    <!-- å¼¹çª—æ ‡é¢˜æ  -->
    <view class="detail-header">
      <view class="header-left"></view>
      <view class="detail-title">{{ selectedCompetency.id }} - {{ selectedCompetency.chinese_name }}</view>
      <view class="header-right">
        <view class="close-btn" bind:tap="onModalClose" catchtap="onModalClose">
          <van-icon name="cross" class="close-icon" />
        </view>
      </view>
    </view>

    <!-- æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
    <scroll-view scroll-y class="detail-content" enable-flex enhanced show-scrollbar="{{ false }}">
      <!-- èƒœä»»åŠ›è¯¦æƒ… -->
      <view class="competency-detail">
        <van-cell-group title="èƒœä»»åŠ›ä¿¡æ¯" class="detail-section">
          <van-cell title="ä»£ç " value="{{ selectedCompetency.id }}" />
          <van-cell title="ä¸­æ–‡åç§°" value="{{ selectedCompetency.chinese_name }}" />
          <van-cell wx:if="{{ selectedCompetency.english_name }}" title="è‹±æ–‡åç§°" value="{{ selectedCompetency.english_name }}" />
          <van-cell title="ç±»åˆ«" value="{{ selectedCompetency.category === 'core' ? 'æ ¸å¿ƒèƒœä»»åŠ›' : 'æ£€æŸ¥å‘˜å’Œæ•™å‘˜èƒœä»»åŠ›' }}" />
          <van-cell title="è¡Œä¸ºæŒ‡æ ‡æ•°é‡" value="{{ selectedCompetency.behavior_count || 0 }}ä¸ª" />
        </van-cell-group>

        <van-cell-group title="æè¿° Description" class="detail-section">
          <view class="description-content">
            <view class="description-text">{{ selectedCompetency.description }}</view>
            <view wx:if="{{ selectedCompetency.description_en }}" class="description-text-en">{{ selectedCompetency.description_en }}</view>
          </view>
        </van-cell-group>

        <!-- è¡Œä¸ºæŒ‡æ ‡åˆ—è¡¨ -->
        <van-cell-group title="è¡Œä¸ºæŒ‡æ ‡ Observable Behaviours" class="detail-section">
          <view class="behaviors-list">
            <block wx:for="{{ selectedCompetency.behaviors }}" wx:key="id" wx:for-item="behavior">
              <view class="behavior-item">
                <view class="behavior-code">{{ behavior.code }}</view>
                <view class="behavior-chinese">{{ behavior.chinese }}</view>
                <view class="behavior-english">{{ behavior.english }}</view>
              </view>
            </block>
          </view>
        </van-cell-group>

        <!-- æ£€æŸ¥å‘˜æ•™å‘˜æ¡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰ -->
        <van-cell-group wx:if="{{ selectedCompetency.conditions }}" title="é€‚ç”¨æ¡ä»¶ Conditions" class="detail-section">
          <view class="description-content">
            <view class="condition-item">
              <view class="condition-label">åœ°é¢è®­ç»ƒï¼š</view>
              <view class="condition-text">{{ selectedCompetency.conditions.ground_training }}</view>
            </view>
            <view class="condition-item">
              <view class="condition-label">é£è¡Œè®­ç»ƒï¼š</view>
              <view class="condition-text">{{ selectedCompetency.conditions.flight_training }}</view>
            </view>
          </view>
        </van-cell-group>

        <van-cell-group title="æ¥æº" class="detail-section">
          <view class="description-content">
            <view class="source-text">{{ selectedCompetency.source }} ({{ selectedCompetency.section }})</view>
          </view>
        </van-cell-group>
      </view>
    </scroll-view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="detail-footer">
      <van-button type="primary" block bind:click="onModalClose" class="copy-button">
        <van-icon name="cross" class="button-icon" />
        å…³é—­
      </van-button>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />

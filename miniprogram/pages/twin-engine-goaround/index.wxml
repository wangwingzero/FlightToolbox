<view class="container">
  <!-- 警告弹窗 -->
  <van-dialog
    show="{{ showWarningDialog }}"
    title="⚠️ 重要警告"
    message="仅用于学习了解飞机大致性能，绝不可作为运行依据！！！"
    theme="round-button"
    confirm-button-text="我已了解"
    confirm-button-color="#1677ff"
    bind:confirm="closeWarningDialog"
    close-on-click-overlay="{{ false }}"
    z-index="9999"
    class="warning-dialog"
  />

  <!-- 飞机系列列表 -->
  <view wx:if="{{ showAircraftSeries }}" class="aircraft-series-section">
    <!-- 顶部广告 -->
    <view wx:if="{{ showSeriesTopAd }}" class="ad-section">
      <text class="ad-label">广告</text>
      <ad-template 
        unit-id="{{ seriesTopAdUnitId }}"
        ad-type="custom"
        bind:adload="onAdLoad"
        bind:aderror="onAdError"
      />
    </view>

    <view class="series-title-header">选择飞机系列</view>
    
    <!-- 飞机系列列表 -->
    <block wx:for="{{ aircraftSeries }}" wx:key="series">
      <view 
        class="aircraft-series-item"
        data-index="{{ index }}"
        bind:tap="onSeriesSelect"
      >
        <view class="series-icon">{{ item.series && item.series.charAt(0) || '?' }}</view>
        <view class="series-content">
          <view class="series-title">{{ item.series }}</view>
          <view class="series-subtitle">{{ item.count }}个机型变体</view>
        </view>
        <view class="series-count">{{ item.count }}</view>
      </view>
        
      <!-- A350和B737之间的广告 -->
      <view wx:if="{{ item.series === 'A350系列' && showA350B737MiddleAd }}" class="ad-section">
        <text class="ad-label">广告</text>
        <ad-template 
          unit-id="{{ a350B737MiddleAdUnitId }}"
          ad-type="custom"
          bind:adload="onAdLoad"
          bind:aderror="onAdError"
        />
      </view>
    </block>

    <!-- 统计信息 -->
    <view class="stats-section">
      <view class="stats-item">
        <text class="stats-number">{{ performanceData.length }}</text>
        <text class="stats-label">个机型</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{ aircraftSeries.length }}</text>
        <text class="stats-label">个系列</text>
      </view>
    </view>
  </view>

  <!-- 机型列表 -->
  <view wx:if="{{ showModelList }}" class="model-list-section">
    <!-- 顶部广告 -->
    <view wx:if="{{ showModelTopAd }}" class="ad-section">
      <text class="ad-label">广告</text>
      <ad-template 
        unit-id="{{ modelTopAdUnitId }}"
        ad-type="custom"
        bind:adload="onAdLoad"
        bind:aderror="onAdError"
      />
    </view>

    <!-- 面包屑导航 -->
    <van-cell-group>
      <van-cell
        title="返回系列列表"
        icon="arrow-left"
        bind:click="backToSeriesList"
        class="back-cell"
      />
    </van-cell-group>

    <!-- 当前系列的机型列表 -->
    <van-cell-group title="{{ selectedSeries.series }} ({{ currentSeriesModels.length }}个机型)">
      <van-cell
        wx:for="{{ currentSeriesModels }}"
        wx:key="model"
        title="{{ item.model }}"
        label="温度: {{ item.temp || 'DISA+25°C' }} | 配置: {{ item.config || 'FULL' }}"
        is-link
        data-index="{{ index }}"
        bind:click="onModelSelect"
        custom-class="model-item"
      />
    </van-cell-group>
  </view>

  <!-- 查询结果显示 -->
  <view wx:if="{{ showResults }}" class="results-section">
    <!-- 机型信息 -->
    <van-cell-group title="机型信息">
      <van-cell title="机型" value="{{ currentModelData.model }}" />
      <van-cell title="温度条件" value="{{ currentModelData.conditions.temperature }}" />
      <van-cell title="空调" value="{{ currentModelData.conditions.air_con }}" />
      <van-cell title="防冰" value="{{ currentModelData.conditions.anti_ice }}" />
      <van-cell title="配置" value="{{ currentModelData.conditions.config }}" />
    </van-cell-group>

    <!-- 查询参数 -->
    <van-cell-group title="查询参数">
      <!-- 重量选择 -->
      <view wx:if="{{ currentModelData.data }}" class="parameter-section">
        <van-cell title="重量选择 ({{ currentModelData.data.length }}个选项)" size="large" />
        <van-cell
          title="重量"
          value="{{ selectedWeight ? selectedWeight + 'kg' : '点击选择重量' }}"
          is-link
          bind:click="showWeightPicker"
          custom-class="picker-trigger-cell"
        />
      </view>
        
      <!-- 重量Picker -->
      <van-popup
        show="{{ showWeightPicker }}"
        bind:close="closeWeightPicker"
        position="bottom"
        round="{{ true }}"
      >
        <van-picker
          columns="{{ weightColumns }}"
          bind:confirm="onWeightConfirm"
          bind:cancel="closeWeightPicker"
          title="选择重量"
          value="{{ selectedWeightIndex }}"
          bind:change="onWeightPickerChange"
          show-toolbar="{{ true }}"
          confirm-button-text="确认"
          cancel-button-text="取消"
        />
      </van-popup>

      <!-- 高度选择 -->
      <view wx:if="{{ currentModelData.data && selectedWeight }}" class="parameter-section">
        <van-cell title="高度选择 ({{ availableAltitudesForCurrentWeight.length }}个选项)" size="large" />
        <van-cell
          title="高度"
          value="{{ selectedAltitude ? selectedAltitude + 'ft' : '点击选择高度' }}"
          is-link
          bind:click="showAltitudePicker"
          disabled="{{ !selectedWeight }}"
          custom-class="picker-trigger-cell"
        />
      </view>
        
      <!-- 高度Picker -->
      <van-popup
        show="{{ showAltitudePicker }}"
        bind:close="closeAltitudePicker"
        position="bottom"
        round="{{ true }}"
      >
        <van-picker
          columns="{{ altitudeColumns }}"
          bind:confirm="onAltitudeConfirm"
          bind:cancel="closeAltitudePicker"
          title="选择高度"
          value="{{ selectedAltitudeIndex }}"
          bind:change="onAltitudePickerChange"
          show-toolbar="{{ true }}"
          confirm-button-text="确认"
          cancel-button-text="取消"
        />
      </van-popup>
      
      <!-- 高度选择提示 -->
      <block wx:if="{{ currentModelData.data && !selectedWeight }}">
        <van-cell custom-class="hint-cell">
          <view slot="title" class="no-weight-hint">
            <van-icon name="info-o" color="#999" size="16px" />
            <text class="hint-text">请先选择重量以查看可用高度</text>
          </view>
        </van-cell>
      </block>
    </van-cell-group>

    <!-- 结果卡片 -->
    <view wx:if="{{ gradient }}" class="result-card" id="result-card">
      <van-cell-group title="计算结果">
        <!-- 结果标题栏 -->
        <van-cell custom-class="result-header-cell">
          <view slot="title" class="result-header">
            <view class="header-left">
              <text class="result-title">复飞梯度</text>
              <text class="result-subtitle">{{ currentModelData.model }}</text>
            </view>
            <van-icon 
              name="replay" 
              class="refresh-icon" 
              bind:tap="queryGradient"
            />
          </view>
        </van-cell>

        <!-- 梯度值显示 -->
        <van-cell custom-class="gradient-value-cell">
          <view slot="title" class="gradient-value">
            <text class="value">{{ gradient }}</text>
            <text class="unit">%</text>
          </view>
        </van-cell>

        <!-- 参数摘要 -->
        <van-cell custom-class="params-summary-cell">
          <view slot="title" class="params-summary">
            <view class="param-item">
              <text class="param-label">重量</text>
              <text class="param-value">{{ selectedWeight }}kg</text>
            </view>
            <view class="param-item">
              <text class="param-label">高度</text>
              <text class="param-value">{{ selectedAltitude }}ft</text>
            </view>
          </view>
        </van-cell>

        <!-- 安全提示 -->
        <van-cell custom-class="safety-notice-cell">
          <view slot="title" class="safety-notice">
            <van-icon name="info-o" />
            <text>此数据仅供参考，不可作为实际运行依据</text>
          </view>
        </van-cell>
      </van-cell-group>
    </view>

    <!-- 无数据提示 -->
    <van-empty
      wx:if="{{ !gradient && selectedWeight && selectedAltitude }}"
      description="无法计算梯度，请尝试其他参数组合"
      image="error"
    />

    <!-- 广告区域 -->
    <view class="ad-section" wx:if="{{ showAd }}">
      <text class="ad-label">广告</text>
      <ad-template 
        unit-id="{{ adUnitId }}"
        ad-type="custom"
        bind:adload="onAdLoad"
        bind:aderror="onAdError"
      />
    </view>

    <!-- 返回按钮 -->
    <van-cell-group>
      <van-cell>
        <van-button type="default" block bind:click="backToModelList" custom-class="back-button">
          返回机型列表
        </van-button>
      </van-cell>
    </van-cell-group>
  </view>

  <!-- 加载状态 -->
  <van-empty
    wx:if="{{ !showAircraftSeries && !showModelList && !showResults && !showWarningDialog }}"
    description="加载中..."
  />
</view>
<!--
  åœ°å½¢å›¾é¡µé¢
  æä¾›å®Œæ•´çš„åœ°å½¢æŸ¥çœ‹å’Œèˆªç‚¹ç®¡ç†åŠŸèƒ½
-->

<view class="terrain-map-container">
  
  <!-- é¡¶éƒ¨åŠŸèƒ½æ  -->
  <view class="header-controls">
    <view class="control-group-left">
      <button 
        class="control-btn {{terrainEnabled ? 'active' : ''}}"
        catchtap="onTerrainToggle"
      >
        <text class="btn-icon">ğŸ—»</text>
        <text class="btn-text">{{terrainEnabled ? 'åœ°å½¢' : 'å…³é—­'}}</text>
      </button>
      
      <button 
        class="control-btn {{showWaypointList ? 'active' : ''}}"
        catchtap="onWaypointListToggle"
      >
        <text class="btn-icon">ğŸ“</text>
        <text class="btn-text">èˆªç‚¹</text>
        <text class="badge" wx:if="{{waypoints.length > 0}}">{{waypoints.length}}</text>
      </button>
    </view>
    
    <view class="control-group-right">
      <button class="control-btn" catchtap="onCurrentLocation">
        <text class="btn-icon">ğŸ¯</text>
        <text class="btn-text">å®šä½</text>
      </button>
      
      <button class="control-btn" catchtap="onSettings">
        <text class="btn-icon">âš™ï¸</text>
        <text class="btn-text">è®¾ç½®</text>
      </button>
    </view>
  </view>
  
  <!-- åœ°å½¢å›¾åŒºåŸŸ -->
  <view class="map-container">
    <!-- è…¾è®¯åœ°å›¾ç»„ä»¶ -->
    <map 
      id="terrainMap"
      class="terrain-map"
      longitude="{{currentLocation.longitude || 116.397}}"
      latitude="{{currentLocation.latitude || 39.909}}"
      scale="{{mapScale}}"
      show-location="{{true}}"
      enable-3D="{{true}}"
      show-compass="{{true}}"
      enable-overlooking="{{true}}"
      enable-zoom="{{true}}"
      enable-scroll="{{true}}"
      enable-rotate="{{true}}"
      enable-satellite="{{terrainEnabled}}"
      enable-traffic="{{false}}"
      subkey="your-tencent-map-key"
      layer-style="{{terrainEnabled ? 2 : 1}}"
      markers="{{mapMarkers}}"
      polyline="{{mapPolylines}}"
      circles="{{mapCircles}}"
      bindmarkertap="onMarkerTap"
      bindlongtap="onMapLongTap"
      bindregionchange="onRegionChange"
      bindzoomchange="onZoomChange"
      bindtap="onMapTap"
    ></map>
    
    <!-- Canvasè¦†ç›–å±‚ï¼ˆç”¨äºè‡ªå®šä¹‰ç»˜åˆ¶ï¼‰ -->
    <canvas 
      id="terrainMapCanvas"
      class="terrain-canvas-overlay"
      type="2d"
      catchtouchstart="onCanvasTouchStart"
      catchtouchmove="onCanvasTouchMove"
      catchtouchend="onCanvasTouchEnd"
      wx:if="{{showCustomOverlay}}"
    ></canvas>
    
    <!-- åœ°å›¾ä¿¡æ¯å åŠ å±‚ -->
    <view class="map-overlay">
      <!-- GPSåæ ‡æ˜¾ç¤º -->
      <view class="gps-info" wx:if="{{currentLocation}}">
        <text class="coord-text">{{formatCoordinate(currentLocation.latitude, currentLocation.longitude)}}</text>
        <text class="accuracy-text">ç²¾åº¦: {{currentLocation.accuracy}}m</text>
      </view>
      
      <!-- åœ°å½¢å›¾ä¾‹ -->
      <view class="terrain-legend" wx:if="{{terrainEnabled && showLegend}}">
        <view class="legend-title">åœ°å½¢é«˜åº¦</view>
        <view class="legend-items">
          <view class="legend-item" wx:for="{{terrainLegend}}" wx:key="label">
            <view class="legend-color" style="background-color: {{item.color}}"></view>
            <text class="legend-text">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- ç¼©æ”¾çº§åˆ«æ˜¾ç¤º -->
      <view class="zoom-info">
        <text class="zoom-text">{{currentRange}} NM</text>
        <text class="scale-text">æ¯”ä¾‹: 1:{{mapScale * 1000}}</text>
      </view>
    </view>
    
    <!-- é•¿æŒ‰æç¤º -->
    <view class="long-press-hint" wx:if="{{showLongPressHint}}">
      <view class="hint-content">
        <text class="hint-icon">ğŸ‘†</text>
        <text class="hint-text">é•¿æŒ‰åœ°å›¾åˆ›å»ºèˆªç‚¹</text>
      </view>
    </view>
  </view>
  
  <!-- åº•éƒ¨èˆªç‚¹åˆ—è¡¨ -->
  <view class="waypoint-panel {{showWaypointList ? 'expanded' : 'collapsed'}}">
    <view class="panel-header" catchtap="onWaypointListToggle">
      <view class="header-left">
        <text class="panel-title">èˆªç‚¹åˆ—è¡¨</text>
        <text class="waypoint-count">({{waypoints.length}})</text>
      </view>
      <view class="header-right">  
        <text class="expand-icon {{showWaypointList ? 'rotated' : ''}}">â–¼</text>
      </view>
    </view>
    
    <scroll-view class="waypoint-list" scroll-y="true" wx:if="{{showWaypointList}}">
      <view class="waypoint-item" wx:if="{{waypoints.length === 0}}">
        <view class="empty-state">
          <text class="empty-icon">ğŸ“</text>
          <text class="empty-text">æš‚æ— èˆªç‚¹</text>
          <text class="empty-hint">é•¿æŒ‰åœ°å›¾åˆ›å»ºèˆªç‚¹</text>
        </view>
      </view>
      
      <view 
        class="waypoint-item {{item.enabled ? 'enabled' : 'disabled'}} {{selectedWaypoint === item.id ? 'selected' : ''}}"
        wx:for="{{waypoints}}"
        wx:key="id"
        catchtap="onWaypointSelect"
        data-waypoint-id="{{item.id}}"
      >
        <view class="waypoint-header">
          <view class="waypoint-info">
            <view class="waypoint-name-row">
              <view class="waypoint-color" style="background-color: {{item.color}}"></view>
              <text class="waypoint-name">{{item.name}}</text>
              <text class="waypoint-type">{{getWaypointTypeName(item.type)}}</text>
            </view>
            <text class="waypoint-coords">{{formatCoordinate(item.lat, item.lng)}}</text>
          </view>
          
          <view class="waypoint-actions">
            <view class="distance-info" wx:if="{{item.distance !== undefined}}">
              <text class="distance-text">{{formatDistance(item.distance)}}</text>
              <text class="bearing-text">{{formatBearing(item.bearing)}}Â°</text>
            </view>
            <view class="action-buttons">
              <button 
                class="action-btn edit-btn"
                size="mini"
                catchtap="onWaypointEdit"
                data-waypoint-id="{{item.id}}"
              >ç¼–è¾‘</button>
              <button 
                class="action-btn toggle-btn {{item.enabled ? 'enabled' : 'disabled'}}"
                size="mini"
                catchtap="onWaypointToggle"
                data-waypoint-id="{{item.id}}"
              >{{item.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}}</button>
            </view>
          </view>
        </view>
        
        <!-- èˆªç‚¹è¯¦ç»†ä¿¡æ¯ -->
        <view class="waypoint-details" wx:if="{{selectedWaypoint === item.id}}">
          <view class="detail-row" wx:if="{{item.altitude}}">
            <text class="detail-label">åœ°å½¢é«˜åº¦:</text>
            <text class="detail-value">{{item.altitude}}ç±³</text>
          </view>
          <view class="detail-row" wx:if="{{item.enabled}}">
            <text class="detail-label">æé†’è·ç¦»:</text>
            <text class="detail-value">{{item.alertRadius}}æµ·é‡Œ</text>
          </view>
          <view class="detail-row" wx:if="{{item.notes}}">
            <text class="detail-label">å¤‡æ³¨:</text>
            <text class="detail-value">{{item.notes}}</text>
          </view>
          <view class="detail-row">
            <text class="detail-label">åˆ›å»ºæ—¶é—´:</text>
            <text class="detail-value">{{formatTime(item.createTime)}}</text>
          </view>
        </view>
      </view>
    </scroll-view>
    
    <!-- å¿«é€Ÿæ“ä½œæ  -->
    <view class="quick-actions" wx:if="{{showWaypointList}}">
      <button class="quick-btn primary" catchtap="onCreateWaypoint">
        <text class="btn-icon">â•</text>
        <text class="btn-text">åˆ›å»ºèˆªç‚¹</text>
      </button>
      <button class="quick-btn" catchtap="onImportWaypoints">
        <text class="btn-icon">ğŸ“¥</text>
        <text class="btn-text">å¯¼å…¥</text>
      </button>
      <button class="quick-btn" catchtap="onExportWaypoints" wx:if="{{waypoints.length > 0}}">
        <text class="btn-icon">ğŸ“¤</text>
        <text class="btn-text">å¯¼å‡º</text>
      </button>
    </view>
  </view>
  
  <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
  <view class="floating-actions">
    <button 
      class="fab location-fab"
      catchtap="onCurrentLocation"
      wx:if="{{!currentLocation}}"
    >
      <text class="fab-icon">ğŸ“</text>
    </button>
    
    <button 
      class="fab create-fab"
      catchtap="onCreateWaypoint"
      wx:if="{{!showWaypointList}}"
    >
      <text class="fab-icon">â•</text>
    </button>
    
    <!-- åœ°å›¾æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
    <button 
      class="fab mode-fab"
      catchtap="onMapModeToggle"
    >
      <text class="fab-icon">{{terrainEnabled ? 'ğŸ—ºï¸' : 'ğŸ›°ï¸'}}</text>
    </button>
  </view>
  
  <!-- èˆªç‚¹ç¼–è¾‘å™¨ç»„ä»¶ -->
  <waypoint-editor
    visible="{{showWaypointEditor}}"
    edit-mode="{{waypointEditMode}}"
    waypoint-id="{{editingWaypointId}}"
    initial-data="{{waypointInitialData}}"
    terrain-info="{{selectedTerrainInfo}}"
    bind:close="onWaypointEditorClose"
    bind:cancel="onWaypointEditorCancel"
    bind:create="onWaypointCreate"
    bind:save="onWaypointSave"
    bind:delete="onWaypointDelete"
    bind:mapselect="onMapSelect"
  />
  
  <!-- è®¾ç½®é¢æ¿ -->
  <view class="settings-panel" wx:if="{{showSettings}}" catchtap="onSettingsOverlayTap">
    <view class="settings-content" catchtap="onSettingsContentTap">
      <view class="settings-header">
        <text class="settings-title">åœ°å½¢å›¾è®¾ç½®</text>
        <button class="close-btn" catchtap="onSettingsClose">âœ•</button>
      </view>
      
      <view class="settings-body">
        <view class="setting-item">
          <text class="setting-label">å«æ˜Ÿåœ°å›¾</text>
          <switch 
            checked="{{terrainEnabled}}"
            bindchange="onTerrainToggle"
            color="#FF6600"
          />
        </view>
        
        <view class="setting-item">
          <text class="setting-label">æ˜¾ç¤ºå›¾ä¾‹</text>
          <switch 
            checked="{{showLegend}}"
            bindchange="onLegendToggle"
            color="#FF6600"
          />
        </view>
        
        <view class="setting-item">
          <text class="setting-label">é•¿æŒ‰æç¤º</text>
          <switch 
            checked="{{showLongPressHint}}"
            bindchange="onHintToggle"
            color="#FF6600"
          />
        </view>
        
        <view class="setting-item">
          <text class="setting-label">è‡ªåŠ¨å®šä½</text>
          <switch 
            checked="{{autoLocation}}"
            bindchange="onAutoLocationToggle"
            color="#FF6600"
          />
        </view>
        
        <view class="setting-item">
          <text class="setting-label">éœ‡åŠ¨åé¦ˆ</text>
          <switch 
            checked="{{vibrationEnabled}}"
            bindchange="onVibrationToggle"
            color="#FF6600"
          />
        </view>
        
        <view class="setting-item">
          <text class="setting-label">è‡ªå®šä¹‰è¦†ç›–å±‚</text>
          <switch 
            checked="{{showCustomOverlay}}"
            bindchange="onCustomOverlayToggle"
            color="#FF6600"
          />
        </view>
      </view>
    </view>
  </view>
  
</view>
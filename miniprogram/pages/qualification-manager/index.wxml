<view class="container">
  <!-- èµ„è´¨åˆ—è¡¨ -->
  <view wx:if="{{ qualifications.length > 0 }}">
    <van-cell-group title="æˆ‘çš„èµ„è´¨ ({{ qualifications.length }}é¡¹)">
      <van-cell 
        wx:for="{{ qualifications }}" 
        wx:key="id"
        title="{{ item.name }}"
        bind:click="showRecordPopup"
        data-id="{{ item.id }}"
        is-link
      >
        <!-- æ¨¡å¼æ ‡è¯† -->
        <view slot="label" class="mode-description">
          <text wx:if="{{ item.mode === 'daily' }}">
            {{ item.dailyPeriod }}å¤©{{ item.dailyRequired }}æ¬¡ - å½“å‰{{ item.currentCount || 0 }}/{{ item.dailyRequired }}æ¬¡
          </text>
          <text wx:elif="{{ item.mode === 'monthly' }}">
            {{ item.monthlyPeriod }}ä¸ªæœˆ{{ item.monthlyRequired }}æ¬¡ - å½“å‰{{ item.currentCount || 0 }}/{{ item.monthlyRequired }}æ¬¡
          </text>
          <text wx:elif="{{ item.mode === 'expiry' }}">
            åˆ°æœŸæ—¥æœŸï¼š{{ item.expiryDate || 'æœªè®¾ç½®' }}
          </text>
        </view>
        
        <view slot="right-icon" class="status-container">
          <!-- çŠ¶æ€æ ‡ç­¾ -->
          <van-tag 
            wx:if="{{ item.status === 'valid' }}" 
            type="success" 
            size="medium"
          >
            æ­£å¸¸
          </van-tag>
          <van-tag 
            wx:if="{{ item.status === 'warning' }}" 
            type="warning" 
            size="medium"
          >
            å³å°†åˆ°æœŸ
          </van-tag>
          <van-tag 
            wx:if="{{ item.status === 'expired' }}" 
            type="danger" 
            size="medium"
          >
            {{ item.mode === 'expiry' ? 'å·²è¿‡æœŸ' : 'ä¸è¾¾æ ‡' }}
          </van-tag>
          
          <!-- å€’è®¡æ—¶æ˜¾ç¤º -->
          <view class="countdown-container">
            <text wx:if="{{ item.status === 'expired' }}" class="countdown-text expired">
              {{ item.mode === 'expiry' ? 'å·²è¿‡æœŸ' : 'ä¸è¾¾æ ‡' }}
            </text>
            <text wx:elif="{{ item.daysRemaining > 0 }}" class="countdown-text {{ item.status }}">
              è¿˜å‰©{{ item.daysRemaining }}å¤©
            </text>
            <text wx:else class="countdown-text expired">
              å·²è¿‡æœŸ
            </text>
          </view>
          
          <!-- åˆ é™¤æŒ‰é’® -->
          <van-icon 
            name="delete" 
            size="18px" 
            color="#ff4444"
            bind:click="deleteQualification"
            data-id="{{ item.id }}"
            catch:tap="deleteQualification"
            class="delete-icon"
          />
        </view>
      </van-cell>
    </van-cell-group>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <van-empty 
    wx:if="{{ qualifications.length === 0 }}"
    description="è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•èµ„è´¨"
    image="search"
  />

  <!-- æ·»åŠ èµ„è´¨æŒ‰é’®ç»„ -->
  <view class="add-button-container">
    <van-button 
      type="primary" 
      block 
      bind:click="showModeSelection"
      icon="plus"
      style="margin-bottom: 16rpx;"
    >
      è‡ªå®šä¹‰åˆ›å»ºèµ„è´¨
    </van-button>
    <van-button 
      type="default" 
      block 
      bind:click="showTemplateSelection"
      icon="apps-o"
    >
      ä»æ¨¡æ¿åˆ›å»º
    </van-button>
  </view>

  <!-- å€’è®¡æ—¶æ¨¡å¼é€‰æ‹© -->
  <van-action-sheet
    show="{{ showModeSelectionSheet }}"
    title="é€‰æ‹©å€’è®¡æ—¶æ¨¡å¼"
    bind:close="closeModeSelectionSheet"
    bind:select="onModeSelect"
    actions="{{ countdownModes }}"
  />

  <!-- æ¨¡æ¿é€‰æ‹© -->
  <van-action-sheet
    show="{{ showTemplateSheet }}"
    title="é€‰æ‹©èµ„è´¨æ¨¡æ¿"
    bind:close="closeTemplateSheet"
    bind:select="onTemplateSelect"
    actions="{{ qualificationTemplates }}"
  />

  <!-- åˆ›å»ºèµ„è´¨å¼¹çª— -->
  <van-popup
    show="{{ showAddPopup }}"
    bind:close="closeAddPopup"
    position="bottom"
    round="{{ true }}"
  >
    <view class="popup-content">
      <view class="popup-header">
        <van-icon 
          name="arrow-left" 
          size="20px" 
          bind:click="closeAddPopup"
          class="popup-back-btn"
        />
        <text class="popup-title">
          åˆ›å»ºèµ„è´¨ - 
          <text wx:if="{{ selectedMode === 'monthly' }}">æœˆå‘¨æœŸæ¨¡å¼</text>
          <text wx:elif="{{ selectedMode === 'daily' }}">æ—¥å‘¨æœŸæ¨¡å¼</text>
          <text wx:elif="{{ selectedMode === 'expiry' }}">åˆ°æœŸæ—¥æœŸæ¨¡å¼</text>
        </text>
        <view style="width: 40rpx;"></view> <!-- å ä½å…ƒç´ ä¿æŒæ ‡é¢˜å±…ä¸­ -->
      </view>
      
      <van-cell-group>
        <!-- èµ„è´¨åç§° -->
        <van-field
          label="èµ„è´¨åç§°"
          value="{{ newQualificationForm.name }}"
          placeholder="è¯·è¾“å…¥èµ„è´¨åç§°"
          bind:change="onFormInput"
          data-field="name"
          required
        />
        
        <!-- æœˆå‘¨æœŸæ¨¡å¼å‚æ•° -->
        <view wx:if="{{ selectedMode === 'monthly' }}">
          <van-field
            label="å‘¨æœŸï¼ˆæœˆï¼‰"
            value="{{ newQualificationForm.monthlyPeriod }}"
            placeholder="å¦‚ï¼š12è¡¨ç¤º12ä¸ªæœˆ"
            type="number"
            bind:change="onFormNumberInput"
            data-field="monthlyPeriod"
          />
          <van-field
            label="è¦æ±‚æ¬¡æ•°"
            value="{{ newQualificationForm.monthlyRequired }}"
            placeholder="å¦‚ï¼š2è¡¨ç¤ºéœ€è¦2æ¬¡"
            type="number"
            bind:change="onFormNumberInput"
            data-field="monthlyRequired"
          />
        </view>
        
        <!-- æ—¥å‘¨æœŸæ¨¡å¼å‚æ•° -->
        <view wx:if="{{ selectedMode === 'daily' }}">
          <van-field
            label="å‘¨æœŸï¼ˆå¤©ï¼‰"
            value="{{ newQualificationForm.dailyPeriod }}"
            placeholder="å¦‚ï¼š90è¡¨ç¤º90å¤©"
            type="number"
            bind:change="onFormNumberInput"
            data-field="dailyPeriod"
          />
          <van-field
            label="è¦æ±‚æ¬¡æ•°"
            value="{{ newQualificationForm.dailyRequired }}"
            placeholder="å¦‚ï¼š3è¡¨ç¤ºéœ€è¦3æ¬¡"
            type="number"
            bind:change="onFormNumberInput"
            data-field="dailyRequired"
          />
        </view>
        
        <!-- åˆ°æœŸæ—¥æœŸæ¨¡å¼å‚æ•° -->
        <view wx:if="{{ selectedMode === 'expiry' }}">
          <van-cell
            title="åˆ°æœŸæ—¥æœŸ"
            value="{{ newQualificationForm.expiryDate || 'ç‚¹å‡»é€‰æ‹©åˆ°æœŸæ—¥æœŸ' }}"
            is-link
            bind:click="showExpiryDatePicker"
          />
        </view>
        
        <!-- å…¬å…±å‚æ•° -->
        <van-field
          label="è­¦å‘Šå¤©æ•°"
          value="{{ newQualificationForm.warningDays }}"
          placeholder="æå‰å¤šå°‘å¤©è­¦å‘Š"
          type="number"
          bind:change="onFormNumberInput"
          data-field="warningDays"
        />
        <van-field
          label="æè¿°"
          value="{{ newQualificationForm.description }}"
          placeholder="èµ„è´¨æè¿°ï¼ˆå¯é€‰ï¼‰"
          type="textarea"
          autosize
          bind:change="onFormInput"
          data-field="description"
        />
      </van-cell-group>

      <view class="popup-buttons">
        <van-button bind:click="closeAddPopup">å–æ¶ˆ</van-button>
        <van-button type="primary" bind:click="saveNewQualification">åˆ›å»º</van-button>
      </view>
    </view>
  </van-popup>

  <!-- è®°å½•å¼¹çª— -->
  <van-popup
    show="{{ showRecordPopup }}"
    bind:close="closeRecordPopup"
    position="bottom"
    round="{{ true }}"
  >
    <view class="popup-content">
      <view class="popup-header">
        <van-icon 
          name="arrow-left" 
          size="20px" 
          bind:click="closeRecordPopup"
          class="popup-back-btn"
        />
        <text class="popup-title">{{ currentQualification.name }}</text>
        <view style="width: 40rpx;"></view> <!-- å ä½å…ƒç´ ä¿æŒæ ‡é¢˜å±…ä¸­ -->
      </view>
      
      <van-cell-group>
        <van-cell
          title="{{ currentQualification.mode === 'expiry' ? 'åˆ°æœŸæ—¥æœŸ' : 'å½•å…¥æ—¥æœŸ' }}"
          value="{{ newRecord.date || (currentQualification.mode === 'expiry' ? 'ç‚¹å‡»é€‰æ‹©åˆ°æœŸæ—¥æœŸ' : 'ç‚¹å‡»é€‰æ‹©å½•å…¥æ—¥æœŸ') }}"
          is-link
          bind:click="showDatePicker"
        />
        <van-field
          wx:if="{{ currentQualification.mode !== 'expiry' }}"
          label="æ‰€éœ€æ¬¡æ•°"
          value="{{ newRecord.count }}"
          placeholder="è¯·è¾“å…¥æ‰€éœ€æ¬¡æ•°"
          type="number"
          bind:input="onCountInput"
        />
      </van-cell-group>

      <!-- æé†’è®¾ç½® -->
      <van-cell-group title="æé†’è®¾ç½®">
        <van-cell title="æé†’çŠ¶æ€">
          <van-switch
            slot="right-icon"
            checked="{{ currentQualification.reminderEnabled !== false }}"
            bind:change="onReminderToggle"
          />
        </van-cell>
        <van-field
          label="æé†’å¤©æ•°"
          value="{{ currentQualification.warningDays || '' }}"
          placeholder="æå‰å¤šå°‘å¤©æé†’"
          type="number"
          bind:input="onWarningDaysInput"
          disabled="{{ currentQualification.reminderEnabled === false }}"
        />
      </van-cell-group>

      <!-- èµ„è´¨çŠ¶æ€ä¿¡æ¯ -->
      <van-cell-group title="èµ„è´¨çŠ¶æ€">
        <van-cell
          wx:if="{{ currentQualification.mode === 'daily' }}"
          title="å‘¨æœŸè¦æ±‚"
          value="{{ currentQualification.dailyPeriod }}å¤©å†…{{ currentQualification.dailyRequired }}æ¬¡"
        />
        <van-cell
          wx:if="{{ currentQualification.mode === 'monthly' }}"
          title="å‘¨æœŸè¦æ±‚"
          value="{{ currentQualification.monthlyPeriod }}ä¸ªæœˆå†…{{ currentQualification.monthlyRequired }}æ¬¡"
        />
        <van-cell
          wx:if="{{ currentQualification.mode !== 'expiry' }}"
          title="å½“å‰å®Œæˆ"
          value="{{ currentQualification.currentCount || 0 }}æ¬¡"
        />
        <van-cell
          title="åˆ°æœŸæ—¥æœŸ"
          value="{{ currentQualification.calculatedExpiryDate || currentQualification.expiryDate || 'æœªè®¾ç½®' }}"
        />
        <van-cell
          title="å‰©ä½™å¤©æ•°"
          value="{{ currentQualification.daysRemaining > 0 ? currentQualification.daysRemaining + 'å¤©' : 'å·²è¿‡æœŸ' }}"
        />
      </van-cell-group>

      <!-- å†å²è®°å½• -->
      <van-cell-group 
        wx:if="{{ displayRecords && displayRecords.length > 0 }}"
        title="å†å²è®°å½•ï¼ˆæœ€è¿‘3æ¬¡ï¼‰"
      >
        <van-cell 
          wx:for="{{ displayRecords }}" 
          wx:key="id"
          title="{{ item.date }}"
        >
          <view slot="right-icon" class="record-actions">
            <van-tag 
              wx:if="{{ currentQualification.mode !== 'expiry' && item.count }}" 
              type="primary" 
              size="medium"
              style="margin-right: 10rpx;"
            >
              {{ item.count }}æ¬¡
            </van-tag>
            <van-icon 
              name="delete" 
              size="16px" 
              color="#ff4444"
              catch:tap="deleteRecord"
              data-record-id="{{ item.id }}"
            />
          </view>
        </van-cell>
      </van-cell-group>

      <view class="popup-buttons">
        <van-button 
          type="danger" 
          bind:click="confirmDeleteQualification"
          data-id="{{ currentQualification.id }}"
        >
          åˆ é™¤æ­¤ç›‘æ§
        </van-button>
        <van-button type="primary" bind:click="addRecord">
          <text wx:if="{{ currentQualification.mode === 'expiry' }}">è®¾ç½®åˆ°æœŸæ—¶é—´</text>
          <text wx:else>æ·»åŠ è®°å½•</text>
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- è®°å½•æ—¥æœŸé€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showDatePicker }}"
    bind:close="closeDatePicker"
    position="bottom"
    round="{{ true }}"
  >
    <van-datetime-picker
      type="date"
      value="{{ selectedDateTimestamp }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="selectDate"
      bind:cancel="closeDatePicker"
      title="{{ currentQualification.mode === 'expiry' ? 'é€‰æ‹©åˆ°æœŸæ—¥æœŸ' : 'é€‰æ‹©å½•å…¥æ—¥æœŸ' }}"
    />
  </van-popup>

  <!-- åˆ°æœŸæ—¥æœŸé€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showExpiryDatePicker }}"
    bind:close="closeExpiryDatePicker"
    position="bottom"
    round="{{ true }}"
  >
    <van-datetime-picker
      type="date"
      value="{{ selectedExpiryDate.getTime() }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="selectExpiryDate"
      bind:cancel="closeExpiryDatePicker"
      title="é€‰æ‹©åˆ°æœŸæ—¥æœŸ"
    />
  </van-popup>

  <!-- ä½¿ç”¨è¯´æ˜ -->
  <view class="help-section">
    <van-cell-group title="ä½¿ç”¨è¯´æ˜">
      <van-cell 
        title="ğŸ“… å€’è®¡æ—¶æ¨¡å¼" 
        label="æ”¯æŒ3ç§æ¨¡å¼ï¼šXå¤©Yæ¬¡(å¦‚90å¤©3æ¬¡èµ·è½)ã€XæœˆYæ¬¡(å¦‚36æœˆ1æ¬¡ICAOè‹±è¯­)ã€åˆ°æœŸæ—¥æœŸ(å¦‚ä½“æ£€åˆ°æœŸ)"
      />
      <van-cell 
        title="ğŸ”„ æ™ºèƒ½è®¡ç®—" 
        label="è‡ªåŠ¨åŸºäºæœ€æ–°è®°å½•è®¡ç®—åˆ°æœŸæ—¶é—´ï¼Œé‡‡ç”¨'æœ€æ–°Yæ¬¡'ç®—æ³•ç¡®ä¿å‡†ç¡®æ€§"
      />
      <van-cell 
        title="â° æé†’åŠŸèƒ½" 
        label="å¯è®¾ç½®æå‰æé†’å¤©æ•°ï¼Œåœ¨å®ç”¨å·¥å…·é¡µé¢æ˜¾ç¤ºä»ªè¡¨æ¿å¹¶å¼¹çª—æé†’"
      />
      <van-cell 
        title="ğŸ“Š çŠ¶æ€æ ‡è¯†" 
        label="ğŸŸ¢æ­£å¸¸ ğŸŸ¡è­¦å‘Š(å³å°†åˆ°æœŸ) ğŸ”´è¿‡æœŸ/ä¸è¾¾æ ‡ï¼ŒçŠ¶æ€å®æ—¶æ›´æ–°"
      />
      <van-cell 
        title="ğŸ“ è®°å½•ç®¡ç†" 
        label="æ”¯æŒæ·»åŠ ã€åˆ é™¤è®°å½•ï¼Œè‡ªåŠ¨ä¿ç•™æœ€è¿‘3æ¡è®°å½•ï¼Œå†å²æ•°æ®æ¸…æ™°å¯è§"
      />
      <van-cell 
        title="ğŸ¯ æ¨¡æ¿åˆ›å»º" 
        label="æä¾›å¸¸ç”¨èµ„è´¨æ¨¡æ¿(90å¤©3æ¬¡èµ·è½ã€ICAOè‹±è¯­ã€ä½“æ£€ç­‰)ï¼Œä¸€é”®å¿«é€Ÿåˆ›å»º"
      />
    </van-cell-group>
  </view>

  <!-- Toast -->
  <van-toast id="van-toast" />
</view> 
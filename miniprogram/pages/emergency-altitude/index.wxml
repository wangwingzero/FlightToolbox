<view class="emergency-container">
  
  <!-- ä¸»ç•Œé¢ - ç¨‹åºåˆ†ç±»é€‰æ‹© -->
  <view wx:if="{{ !selectedEmergencyType }}" class="emergency-main-page">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <view class="page-header emergency-header">
      <view class="header-title">ğŸš¨ ç´§æ€¥æ”¹å˜é«˜åº¦ç¨‹åº</view>
      <view class="header-subtitle">èˆªç©ºç´§æ€¥æƒ…å†µä¸‹çš„æ ‡å‡†é«˜åº¦æ”¹å˜ç¨‹åº</view>
      <view class="emergency-warning">
        <view class="warning-icon">âš ï¸</view>
        <view class="warning-text">ç¡®ä¿èˆªç©ºå™¨å®‰å…¨æ˜¯ç¬¬ä¸€ä¼˜å…ˆçº§</view>
      </view>
    </view>

    <!-- ç´§æ€¥ç¨‹åºåˆ†ç±»å¡ç‰‡ -->
    <view class="emergency-categories">
      <block wx:for="{{ emergencyData.categories }}" wx:key="id">
        <view class="emergency-card {{ item.priority }}-priority"
              bind:tap="selectEmergencyType"
              data-type="{{ item.id }}"
              style="border-left: 6rpx solid {{ item.color }};">

          <view class="emergency-card-header">
            <view class="card-icon emergency-icon">{{ item.icon }}</view>
            <view class="card-priority-badge {{ item.priority }}">{{ item.priority === 'critical' ? 'å±é™©' : item.priority === 'high' ? 'é«˜' : 'ä¸­' }}</view>
          </view>

          <view class="card-content">
            <view class="card-title emergency-title">{{ item.title }}</view>
            <view class="card-subtitle emergency-subtitle">{{ item.subtitle }}</view>
            <view class="emergency-code">{{ item.emergencyCode }}</view>
          </view>

          <!-- å…³é”®è¦ç‚¹é¢„è§ˆ -->
          <view class="key-points-preview">
            <view wx:for="{{ item.keyPoints }}" wx:for-item="point" wx:key="index"
                  wx:if="{{ index < 3 }}"
                  class="point-preview {{ point.priority }}">
              <text class="point-icon">{{ point.icon }}</text>
              <text class="point-text">{{ point.text }}</text>
            </view>
          </view>

          <view class="card-action">
            <view class="action-arrow">â†’</view>
            <view class="action-text">æŸ¥çœ‹ç¨‹åº</view>
          </view>
        </view>

        <!-- åœ¨ç¬¬ä¸€ä¸ªå¡ç‰‡åæ’å…¥æ¨ªå¹…å¹¿å‘Š -->
      </block>
    </view>

  </view>

  <!-- è¯¦ç»†ç¨‹åºé¡µé¢ -->
  <view wx:if="{{ selectedEmergencyType }}" class="emergency-detail-page">
    <!-- è¿”å›æŒ‰é’® -->
    <view class="back-button" bind:tap="backToEmergencyMain">
      <text class="back-icon">â†</text>
      <text class="back-text">è¿”å›</text>
    </view>

    <!-- å½“å‰ç¨‹åºä¿¡æ¯ -->
    <view wx:for="{{ emergencyData.categories }}" wx:key="id" wx:if="{{ item.id === selectedEmergencyType }}">
      
      <!-- ç¨‹åºæ ‡é¢˜ -->
      <view class="procedure-header" style="background: {{ item.color }};">
        <view class="procedure-icon">{{ item.icon }}</view>
        <view class="procedure-info">
          <view class="procedure-title">{{ item.title }}</view>
          <view class="procedure-subtitle">{{ item.subtitle }}</view>
          <view class="procedure-code">ç´§æ€¥ä»£ç : {{ item.emergencyCode }}</view>
        </view>
      </view>

      <!-- å…³é”®è¦ç‚¹ -->
      <view class="key-points-section">
        <view class="section-title">
          <text class="section-icon">ğŸ¯</text>
          <text class="section-text">å…³é”®è¦ç‚¹</text>
        </view>
        <view class="key-points-list">
          <view wx:for="{{ item.keyPoints }}" wx:for-item="point" wx:key="index" 
                class="key-point-item {{ point.priority }}">
            <view class="point-priority-indicator {{ point.priority }}"></view>
            <view class="point-icon">{{ point.icon }}</view>
            <view class="point-text">{{ point.text }}</view>
          </view>
        </view>
      </view>

      <!-- æ“ä½œæ­¥éª¤ -->
      <view class="procedure-steps-section">
        <view class="section-title">
          <text class="section-icon">ğŸ“‹</text>
          <text class="section-text">æ“ä½œæ­¥éª¤</text>
        </view>
        <view class="steps-list">
          <view wx:for="{{ item.procedures }}" wx:for-item="step" wx:key="step" 
                class="step-item {{ step.urgency }}" 
                bind:tap="toggleProcedureStep" 
                data-step="{{ index }}">
            
            <view class="step-header">
              <view class="step-number {{ step.urgency }}">{{ step.step }}</view>
              <view class="step-basic-info">
                <view class="step-title">{{ step.title }}</view>
                <view class="step-urgency {{ step.urgency }}">{{ step.urgency === 'immediate' ? 'ç«‹å³' : step.urgency === 'critical' ? 'å…³é”®' : step.urgency === 'high' ? 'é«˜' : 'ä¸­' }}</view>
              </view>
            </view>

            <view class="step-content" wx:if="{{ emergencyStepsExpanded.indexOf(index) > -1 }}">
              <view class="step-main-content">{{ step.content }}</view>
              <view class="step-detail" wx:if="{{ step.detail }}">{{ step.detail }}</view>
              <view class="step-icon-large">{{ step.icon }}</view>
            </view>
          </view>
        </view>
      </view>

      <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
      <view class="quick-actions">
        <view class="action-button emergency-call" 
              bind:tap="emergencyQuickAction" 
              data-action="call-atc" 
              data-type="{{ selectedEmergencyType }}">
          <text class="action-icon">ğŸ“»</text>
          <text class="action-text">è”ç³»ATC</text>
        </view>
        <view class="action-button emergency-frequency" 
              bind:tap="emergencyQuickAction" 
              data-action="emergency-frequency">
          <text class="action-icon">ğŸ“¡</text>
          <text class="action-text">ç´§æ€¥é¢‘ç‡</text>
        </view>
        <view class="action-button altitude-table" 
              wx:if="{{ selectedEmergencyType === 'weather-deviation' }}"
              bind:tap="emergencyQuickAction" 
              data-action="altitude-table" 
              data-type="{{ selectedEmergencyType }}">
          <text class="action-icon">ğŸ“Š</text>
          <text class="action-text">é«˜åº¦è¡¨æ ¼</text>
        </view>
      </view>

      <!-- å‚è€ƒè¡¨æ ¼æˆ–å›¾ç‰‡ -->
      <view wx:if="{{ item.altitudeTable }}" class="reference-section">
        <view class="section-title">
          <text class="section-icon">ğŸ“Š</text>
          <text class="section-text">{{ item.altitudeTable.title }}</text>
        </view>
        <view class="reference-table">
          <view class="table-header">
            <view wx:for="{{ item.altitudeTable.headers }}" wx:key="index" class="table-header-cell">{{ item }}</view>
          </view>
          <view wx:for="{{ item.altitudeTable.rows }}" wx:for-index="rowIndex" wx:key="index" class="table-row">
            <view wx:for="{{ item }}" wx:for-item="cell" wx:for-index="cellIndex" wx:key="index" class="table-cell">{{ cell }}</view>
          </view>
        </view>
      </view>

      <!-- æ´‹åŒºå‚è€ƒä¿¡æ¯ -->
      <view wx:if="{{ item.oceanicReference }}" class="reference-section">
        <view class="section-title">
          <text class="section-icon">ğŸŒŠ</text>
          <text class="section-text">{{ item.oceanicReference.title }}</text>
        </view>
        <view class="oceanic-reference">
          <view wx:for="{{ item.oceanicReference.sections }}" wx:key="index" class="oceanic-item">
            <view class="oceanic-condition">{{ item.condition }}</view>
            <view class="oceanic-action">{{ item.action }}</view>
            <view class="oceanic-reason">{{ item.reason }}</view>
          </view>
        </view>
      </view>

      <!-- RVSMæƒ…å†µåˆ†ç±» -->
      <view wx:if="{{ item.rvsmSituations }}" class="reference-section">
        <view class="section-title">
          <text class="section-icon">ğŸ“Š</text>
          <text class="section-text">RVSMæƒ…å†µåˆ†ç±»</text>
        </view>
        <view class="rvsm-situations">
          <view wx:for="{{ item.rvsmSituations }}" wx:key="index" class="rvsm-item">
            <view class="rvsm-situation">{{ item.situation }}</view>
            <view class="rvsm-threshold">{{ item.threshold }}</view>
            <view class="rvsm-action">{{ item.action }}</view>
            <view class="rvsm-spacing">{{ item.spacing }}</view>
          </view>
        </view>
      </view>

    </view>
  </view>

  <view wx:if="{{ !isAdFree }}" class="ad-banner-container">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"></ad>
  </view>
</view>

<van-toast id="van-toast" />
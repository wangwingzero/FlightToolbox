<view class="container page-content">
  <!-- æ¨¡å¼åˆ‡æ¢å™¨ -->
  <view class="mode-switcher-container">
    <view class="mode-switcher">
      <view class="mode-option mode-option-active">
        <view class="mode-icon">ğŸ’¬</view>
        <text class="mode-label">é™†ç©ºé€šè¯</text>
      </view>
      <view class="mode-option" bind:tap="openCommunicationRules">
        <view class="mode-icon">ğŸ“š</view>
        <text class="mode-label">æŠ€æœ¯è¦ç‚¹</text>
      </view>
    </view>
  </view>

  <view class="page-header">
    <view class="page-title">é™†ç©ºé€šè¯</view>
    <view class="page-subtitle">æ ‡å‡†é€šè¯ + æ°‘èˆªè‹±è¯­è¯æ±‡ä¸€ç«™å¼æŸ¥è¯¢</view>
  </view>

  <!-- åˆ†ç±»èœå• -->
  <view class="category-tabs-container">
    <scroll-view 
      class="category-tabs-scroll" 
      scroll-x 
      scroll-with-animation 
      enhanced 
      enable-flex 
      show-scrollbar="{{false}}"
      scroll-anchoring="{{false}}"
      refresher-enabled="{{false}}"
      throttle="{{false}}"
      fast-deceleration="{{false}}"
    >
      <view class="category-tabs-wrapper">
        <view 
          wx:for="{{ categoryList }}" 
          wx:key="name"
          class="category-tab-item {{ activeTab === item.name ? 'active' : '' }}"
          bind:tap="onTabChange"
          data-name="{{ item.name }}"
        >
          <view class="category-badge">{{ item.count }}</view>
          <view class="category-title">{{ item.title }}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-section phraseology-search">
    <van-search
      value="{{ searchKeyword }}"
      placeholder="{{ searchPlaceholder }}"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>


  <!-- é€šä¿¡ç”¨è¯­åˆ—è¡¨ -->
  <view class="phraseology-section">
    <view wx:if="{{ displayData.length > 0 }}" class="context7-content-container">
      <view class="context7-card-wrapper">
        <!-- ç¬¬ä¸€ä¸ªç»“æœ -->
        <view
          wx:if="{{ displayData.length > 0 }}"
          class="context7-item-card phraseology-item-card"
          bind:tap="showPhraseDetail"
          data-index="0"
        >
          <view class="item-card-header">
            <view class="item-primary">
              <view class="item-name-zh">
                <rich-text wx:if="{{ displayData[0].situation_cn_highlighted }}" nodes="{{ displayData[0].situation_cn_highlighted }}"></rich-text>
                <text wx:else>{{ displayData[0].situation_cn }}</text>
              </view>
              <view class="item-badges">
                <view class="speaker-badge speaker-{{ displayData[0].speakerClass }}">
                  <text>{{ displayData[0].speaker }}</text>
                </view>
              </view>
            </view>
            <view class="item-secondary">
              <view class="item-name-en">
                <rich-text wx:if="{{ displayData[0].situation_highlighted }}" nodes="{{ displayData[0].situation_highlighted }}"></rich-text>
                <text wx:else>{{ displayData[0].situation }}</text>
              </view>
            </view>
          </view>

          <view class="item-card-content">
            <view class="item-definition">
              <view class="phrase-en">
                <rich-text wx:if="{{ displayData[0].phrase_en_highlighted }}" nodes="{{ displayData[0].phrase_en_highlighted }}"></rich-text>
                <text wx:else>{{ displayData[0].phrase_en }}</text>
              </view>
              <view class="phrase-cn">
                <rich-text wx:if="{{ displayData[0].phrase_cn_highlighted }}" nodes="{{ displayData[0].phrase_cn_highlighted }}"></rich-text>
                <text wx:else>{{ displayData[0].phrase_cn }}</text>
              </view>
            </view>
          </view>

          <view class="item-card-footer">
            <view class="item-meta">
              <view wx:if="{{ displayData[0].sourceType == 'phraseology' }}" class="meta-info">
                <van-icon name="chat-o" size="14px" color="#64748b" />
                <text class="meta-text">ICAOæ ‡å‡†å¯¹è¯</text>
              </view>
              <view wx:else class="meta-info">
                <van-icon name="orders-o" size="14px" color="#64748b" />
                <text class="meta-text">æ°‘èˆªè‹±è¯­è¯æ±‡</text>
              </view>
            </view>
            <view class="item-arrow">
              <van-icon name="arrow" size="16px" color="#94a3b8" />
            </view>
          </view>
        </view>

        <!-- ç¬¬ä¸€ä¸ªç»“æœå’Œç¬¬äºŒä¸ªç»“æœä¹‹é—´æ’å…¥æ¨ªå¹…å¹¿å‘Š -->
        <view wx:if="{{ displayData.length > 1 && !isAdFree }}" class="ad-banner-container">
          <ad unit-id="adunit-d6c8a55bd3cb4fd1" ad-type="banner" ad-intervals="30"
              bindload="onAdLoad" binderror="onAdError"></ad>
        </view>

        <!-- å…¶ä½™ç»“æœï¼ˆä»ç¬¬äºŒä¸ªå¼€å§‹ï¼‰ -->
        <view
          wx:for="{{ displayData }}"
          wx:key="id"
          wx:for-index="idx"
          wx:if="{{ idx > 0 }}"
          class="context7-item-card phraseology-item-card"
          bind:tap="showPhraseDetail"
          data-index="{{ idx }}"
        >
          <view class="item-card-header">
            <view class="item-primary">
              <view class="item-name-zh">
                <rich-text wx:if="{{ item.situation_cn_highlighted }}" nodes="{{ item.situation_cn_highlighted }}"></rich-text>
                <text wx:else>{{ item.situation_cn }}</text>
              </view>
              <view class="item-badges">
                <view class="speaker-badge speaker-{{ item.speakerClass }}">
                  <text>{{ item.speaker }}</text>
                </view>
              </view>
            </view>
            <view class="item-secondary">
              <view class="item-name-en">
                <rich-text wx:if="{{ item.situation_highlighted }}" nodes="{{ item.situation_highlighted }}"></rich-text>
                <text wx:else>{{ item.situation }}</text>
              </view>
            </view>
          </view>

          <view class="item-card-content">
            <view class="item-definition">
              <view class="phrase-en">
                <rich-text wx:if="{{ item.phrase_en_highlighted }}" nodes="{{ item.phrase_en_highlighted }}"></rich-text>
                <text wx:else>{{ item.phrase_en }}</text>
              </view>
              <view class="phrase-cn">
                <rich-text wx:if="{{ item.phrase_cn_highlighted }}" nodes="{{ item.phrase_cn_highlighted }}"></rich-text>
                <text wx:else>{{ item.phrase_cn }}</text>
              </view>
            </view>
          </view>

          <view class="item-card-footer">
            <view class="item-meta">
              <view class="meta-info">
                <van-icon name="chat-o" size="14px" color="#64748b" />
                <text class="meta-text">ICAOæ ‡å‡†å¯¹è¯</text>
              </view>
            </view>
            <view class="item-arrow">
              <van-icon name="arrow" size="16px" color="#94a3b8" />
            </view>
          </view>
        </view>

      </view>
      
      <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
      <view wx:if="{{ hasMore }}" class="load-more-container">
        <view class="load-more-btn" bind:tap="loadMore">
          <view wx:if="{{ isLoading }}" class="loading-text">
            <van-loading size="16px" color="#007bff" />
            <text class="loading-label">åŠ è½½ä¸­...</text>
          </view>
          <view wx:else class="load-more-text">
            <van-icon name="down" size="16px" color="#007bff" />
            <text class="load-more-label">åŠ è½½æ›´å¤š</text>
            <text class="remaining-count">è¿˜æœ‰ {{ filteredPhraseology.length - displayData.length }} æ¡æ•°æ®</text>
          </view>
        </view>
      </view>
      
      <!-- å·²åŠ è½½å®Œæˆæç¤º -->
      <view wx:else class="load-complete-container">
        <view class="load-complete-text">
          <van-icon name="checked" size="16px" color="#28a745" />
          <text>å·²åŠ è½½å…¨éƒ¨ {{ displayData.length }} æ¡æ•°æ®</text>
        </view>
      </view>
    </view>
    
    <!-- æ— æœç´¢ç»“æœ -->
    <view wx:else class="no-results">
      <view class="no-results-icon">ğŸ”</view>
      <view class="no-results-text">æœªæ‰¾åˆ°ç›¸å…³å†…å®¹</view>
      <view class="no-results-tip">è¯·å°è¯•å…¶ä»–å…³é”®è¯æˆ–åˆ‡æ¢èŒƒå›´</view>
    </view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{ activeTab === 'all' && !searchKeyword }}" class="stats-section">
    <view class="stats-item">
      <text class="stats-number">{{ phraseologyList.length }}</text>
      <text class="stats-label">æ¡å†…å®¹</text>
    </view>
    <view class="stats-item">
      <text class="stats-number">3</text>
      <text class="stats-label">ä¸ªèŒƒå›´</text>
    </view>
  </view>

</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<van-popup
  show="{{ showDetailPopup }}"
  position="bottom"
  round
  closeable
  close-icon="close"
  bind:close="closeDetailPopup"
  custom-style="height: 80%; max-height: 80vh;"
>
  <view class="detail-popup" wx:if="{{ selectedPhrase && selectedPhrase.situation_cn }}">
    <view class="popup-header">
      <view class="popup-header-content">
        <view class="popup-title">
          <rich-text wx:if="{{ selectedPhrase.situation_cn_highlighted }}" nodes="{{ selectedPhrase.situation_cn_highlighted }}"></rich-text>
          <text wx:else>{{ selectedPhrase.situation_cn || 'é€šä¿¡ç”¨è¯­è¯¦æƒ…' }}</text>
        </view>
        <view class="popup-subtitle">
          <rich-text wx:if="{{ selectedPhrase.situation_highlighted }}" nodes="{{ selectedPhrase.situation_highlighted }}"></rich-text>
          <text wx:else>{{ selectedPhrase.situation || '' }}</text>
        </view>
      </view>
      <view class="popup-close-btn" bind:tap="closeDetailPopup">
        <van-icon name="cross" size="20px" color="white" />
      </view>
    </view>
    
    <scroll-view 
      class="popup-content" 
      scroll-y 
      enhanced 
      enable-flex 
      show-scrollbar="{{false}}" 
      scroll-with-animation="{{true}}" 
      enable-back-to-top="{{false}}" 
      throttle="{{false}}" 
      scroll-anchoring="{{false}}" 
      refresher-enabled="{{false}}"
      fast-deceleration="{{true}}"
      scroll-top="{{0}}"
      bindscrolltoupper=""
      bindscrolltolower=""
    >
      <view class="detail-section">
        <view class="detail-label">åˆ†ç±»</view>
        <view class="detail-content">{{ selectedPhrase.category }}</view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">å­åˆ†ç±»</view>
        <view class="detail-content">
          <rich-text wx:if="{{ selectedPhrase.situation_highlighted }}" nodes="{{ selectedPhrase.situation_highlighted }}"></rich-text>
          <text wx:else>{{ selectedPhrase.situation }}</text>
        </view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">ä½¿ç”¨æƒ…æ™¯</view>
        <view class="detail-content">
          <rich-text wx:if="{{ selectedPhrase.situation_cn_highlighted }}" nodes="{{ selectedPhrase.situation_cn_highlighted }}"></rich-text>
          <text wx:else>{{ selectedPhrase.situation_cn }}</text>
        </view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">æ ‡å‡†ç”¨è¯­</view>
        <view class="detail-content">
          <view class="phrase-content">
            <view class="phrase-en">
              <rich-text wx:if="{{ selectedPhrase.phrase_en_highlighted }}" nodes="{{ selectedPhrase.phrase_en_highlighted }}"></rich-text>
              <text wx:else>{{ selectedPhrase.phrase_en }}</text>
            </view>
            <view class="phrase-cn">
              <rich-text wx:if="{{ selectedPhrase.phrase_cn_highlighted }}" nodes="{{ selectedPhrase.phrase_cn_highlighted }}"></rich-text>
              <text wx:else>{{ selectedPhrase.phrase_cn }}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="detail-section">
        <view class="detail-label">ä½¿ç”¨è€…</view>
        <view class="detail-content">
          <view class="speaker-tag speaker-{{ selectedPhrase.speakerClass }}">
            {{ selectedPhrase.speaker }}
          </view>
        </view>
      </view>
      

      
      <view class="detail-section">
        <view class="detail-label">æ•°æ®æ¥æº</view>
        <view class="detail-content disclaimer-content">
          ICAO Doc 4444
        </view>
      </view>
    </scroll-view>
  </view>
  
  <view wx:else class="detail-popup">
    <view class="popup-header">
      <view class="popup-title">åŠ è½½ä¸­...</view>
    </view>
    <view class="popup-content">
      <view class="detail-section">
        <view class="detail-content">æ­£åœ¨åŠ è½½é€šä¿¡ç”¨è¯­è¯¦æƒ…...</view>
      </view>
    </view>
  </view>
</van-popup>

<van-toast id="van-toast" />
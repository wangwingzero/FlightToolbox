<view class="cockpit-container">
  <!-- 标题栏 -->
  <view class="cockpit-header">
    <view class="gps-status" wx:if="{{gpsStatus}}">
      <view class="gps-status-main">
        <text class="status-text {{gpsInterference || gpsSpoofing ? 'status-interference' : gpsStatusClass}}">
          {{gpsStatus || '无信号'}}
        </text>
        <!-- GPS欺骗监控开关 -->
        <view class="gps-spoofing-switch">
          <text class="spoofing-switch-label">GPS欺骗监控</text>
          <switch class="spoofing-switch-control" checked="{{spoofingDetectionEnabled}}" bindchange="onSpoofingDetectionToggle" color="#00ff88" />
        </view>
      </view>
      
      
      <!-- GPS欺骗警告 -->
      <view wx:if="{{gpsSpoofing && spoofingDetectionEnabled}}" class="spoofing-warning">
        <van-icon name="warning-o" size="16px" color="#ff0000" />
        <text class="warning-text">检测到GPS欺骗 - 首次 {{firstSpoofingTime}}</text>
      </view>
      
      <!-- 原有GPS干扰警告 -->
      <view wx:if="{{gpsInterference}}" class="interference-warning">
        <van-icon name="warning-o" size="16px" color="#ff3333" />
        <text class="warning-text">检测到GPS干扰</text>
      </view>
      <view wx:if="{{lastInterferenceTime && !gpsInterference}}" class="interference-history">
        <text class="history-text">上次干扰: {{lastInterferenceTime}}</text>
      </view>
    </view>
  </view>
  
  <!-- 权限错误提示 -->
  <view wx:if="{{locationError}}" class="error-container">
    <van-icon name="location-o" size="60px" color="#999" />
    <text class="error-text">{{locationError}}</text>
    <view class="error-actions">
      <van-button type="primary" size="small" bind:click="openSetting">打开设置</van-button>
      <van-button wx:if="{{isOffline || isOfflineMode}}" type="default" size="small" bind:click="startSimulatedMode">继续使用</van-button>
    </view>
  </view>
  
  <!-- 仪表盘主体 -->
  <view wx:else class="instruments-container">
    <!-- 姿态仪显示 - 独立控制 -->
    <view class="attitude-instrument" hidden="{{!showAttitudeIndicator}}">
      <!-- Grid布局容器 - 使用动态响应式参数 -->
      <view class="attitude-instrument__grid"
            style="grid-gap: {{attitudeGridGap}}rpx; padding: {{attitudeGridPadding}};">
        <!-- 左上角初始按钮 -->
        <view class="attitude-control-button attitude-control-button--default"
              bindtap="onAttitudeInitialTap">
          <text class="attitude-control-text">初始</text>
        </view>


        <!-- 左侧俯仰角显示 -->
        <view class="attitude-instrument__left">
          <view class="attitude-instrument__panel attitude-instrument__panel--pitch">
            <text class="attitude-instrument__label attitude-instrument__label--pitch">PITCH</text>
            <text class="attitude-instrument__value attitude-instrument__value--pitch {{pitch < 0 ? 'attitude-instrument__value--negative' : ''}}">{{pitch}}</text>
          </view>
        </view>

        <!-- 中央Canvas区域 - 使用动态响应式尺寸 -->
        <view class="attitude-instrument__center">
          <canvas
            type="2d"
            id="attitudeIndicator"
            class="attitude-instrument__canvas"
            style="width: {{attitudeCanvasSize}}rpx; height: {{attitudeCanvasSize}}rpx;">
          </canvas>
        </view>
        
        <!-- 右侧坡度显示 -->
        <view class="attitude-instrument__right">
          <view class="attitude-instrument__panel attitude-instrument__panel--roll">
            <text class="attitude-instrument__label attitude-instrument__label--roll">ROLL</text>
            <text class="attitude-instrument__value attitude-instrument__value--roll {{roll < 0 ? 'attitude-instrument__value--negative' : ''}}">{{roll}}</text>
          </view>
        </view>
        
        <!-- 右上角校准按钮 -->
        <view class="attitude-control-button attitude-control-button--reset" 
              bindtap="onAttitudeCalibrateTap">
          <text class="attitude-control-text">校准</text>
        </view>
      </view>
    </view>
    
    <!-- 第一行：速度和高度（含附属仪表） -->
    <view class="instruments-row">
      <!-- 左侧：GPS地速及加速度 -->
      <view class="instrument-column">
        <view class="instrument speed-indicator">
          <view class="instrument-label">GPS地速</view>
          <view class="instrument-value">
            <text class="value-number">{{speed === null || speed === undefined ? '--' : speed}}</text>
            <text class="value-unit">kt</text>
          </view>

        </view>
      </view>
      
      <!-- 右侧：GPS高度及升降率 -->
      <view class="instrument-column">
        <view class="instrument altitude-indicator">
          <view class="instrument-label">GPS高度</view>
          <view class="instrument-value">
            <text class="value-number">{{altitude === null || altitude === undefined || !debugData.altitudeValid ? '--' : altitude}}</text>
            <text class="value-unit">ft</text>
          </view>

        </view>
      </view>
    </view>
    
    <!-- 第二行：航向 -->
    <view class="instruments-row">
      <view class="instrument modern-heading-indicator">
        <!-- 模式切换器 -->
        <view class="heading-mode-switcher" bindtap="toggleHeadingMode">
          <view class="mode-option {{headingMode === 'heading' ? 'active' : ''}}">
            <text class="mode-text">HDG</text>
          </view>
          <view class="mode-option {{headingMode === 'track' ? 'active' : ''}}">
            <text class="mode-text">TRK</text>
          </view>
        </view>
        
        <!-- 主要数值显示 -->
        <view class="heading-main-display">
          <text class="heading-number">{{headingMode === 'heading' ? heading : track}}</text>
          <text class="heading-unit">°</text>
        </view>
        
        <!-- 修复后的方向指示 -->
        <view class="direction-indicator">
          <text class="direction-text">{{headingMode === 'heading' ? '航向' : '航迹'}}</text>
          <view class="direction-compass">
            <!-- 固定的罗盘刻度 -->
            <view class="compass-dial">
              <view class="compass-directions">
                <text class="dir-n">N</text>
                <text class="dir-e">E</text>
                <text class="dir-s">S</text>
                <text class="dir-w">W</text>
              </view>
              
              <!-- 圆周刻度线 -->
              <view class="compass-ticks">
                <view wx:for="{{[0,30,60,90,120,150,180,210,240,270,300,330]}}" wx:key="item" 
                      class="tick-mark" 
                      style="transform: rotate({{item}}deg);">
                  <view class="tick-line"></view>
                </view>
              </view>
              
              <!-- 航向/航迹标记 -->
              <view class="heading-marker" 
                    style="transform: rotate({{headingMode === 'heading' ? heading : track}}deg); transition: transform 0.3s ease-out;">
                <view class="marker-dot"></view>
              </view>
            </view>
            
            <!-- 中心点 -->
            <view class="compass-center"></view>
          </view>
        </view>
        

      </view>
    </view>
    
    
    <!-- GPS干扰提示区 -->
    <view wx:if="{{gpsInterference}}" class="interference-alert">
      <van-icon name="warning" size="40px" color="#ff3333" />
      <view class="alert-content">
        <text class="alert-title">⚠️ GPS干扰警告</text>
        <text class="alert-desc">检测到GPS信号异常跳变，请使用其他导航参考</text>
        <text class="alert-time">发生时间: {{lastInterferenceTime}}</text>
      </view>
    </view>

    <!-- 经纬度显示 -->
    <view class="coordinates-display">
        <text class="coord-label">{{latitude}}</text>
        <text class="coord-divider">|</text>
        <text class="coord-label">{{longitude}}</text>
        <text class="coord-system" wx:if="{{showCoordinateSystem}}"> ({{coordinateSystemDisplay}})</text>
    </view>

    <!-- 地图图例已删除 - 避免显示异常 -->

    <!-- GPS权限和API调试面板 -->
    <view class="debug-panel">
      <view class="debug-header" bindtap="toggleDebugPanel">
        <text class="debug-title">GPS权限调试 {{debugPanelExpanded ? '▼' : '▶'}}</text>
      </view>
      
      <view wx:if="{{debugPanelExpanded}}" class="debug-content">
        <!-- 权限状态 -->
        <view class="permission-status">
          <text class="section-title">位置API权限状态</text>
          
          <view class="api-item">
            <view class="api-name">wx.getLocation</view>
            <view class="api-status {{getLocationPermission ? 'status-granted' : 'status-denied'}}">
              {{getLocationPermission ? '已授权' : '未授权'}}
            </view>
          </view>
          
          <view class="api-item">
            <view class="api-name">wx.chooseLocation</view>
            <view class="api-status status-granted">可用</view>
          </view>
          
          <view class="api-item">
            <view class="api-name">wx.startLocationUpdate</view>
            <view class="api-status {{locationUpdateActive ? 'status-active' : 'status-inactive'}}">
              {{locationUpdateActive ? '运行中' : '未启动'}}
            </view>
          </view>
          
          <view class="api-item">
            <view class="api-name">wx.onLocationChange</view>
            <view class="api-status {{locationChangeListening ? 'status-active' : 'status-inactive'}}">
              {{locationChangeListening ? '监听中' : '未监听'}}
            </view>
          </view>
        </view>
        
        <!-- 实时数据 -->
        <view class="realtime-data">
          <text class="section-title">实时GPS数据</text>
          
          <!-- 🆕 定位类型和状态 -->
          <view class="data-group {{debugData.providerType === 'network' ? 'data-warning' : ''}}">
            <text class="data-label">定位提供商:</text>
            <text class="data-value">{{debugData.providerType || 'unknown'}} {{debugData.isGPSLocation ? '(GPS)' : '(网络)'}}</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">定位模式:</text>
            <text class="data-value">{{debugData.isHighAccuracy ? '高精度模式' : '普通模式'}}</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">GPS获取尝试:</text>
            <text class="data-value">{{debugData.gpsAttemptCount || 0}}/3次 {{debugData.gpsStatus || ''}}</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">原始GPS高度:</text>
            <text class="data-value">{{debugData.rawAltitude !== null && debugData.rawAltitude !== undefined ? debugData.rawAltitude + 'm' : 'null'}} ({{debugData.altitudeType || 'unknown'}})</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">显示高度:</text>
            <text class="data-value">{{altitude}}ft (有效: {{debugData.altitudeValid ? '是' : '否'}})</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">GPS精度:</text>
            <text class="data-value">{{debugData.accuracy || 0}}m</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">更新频率:</text>
            <text class="data-value">{{updateCount}}次 ({{debugData.updateInterval || 0}}ms间隔)</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">最后更新:</text>
            <text class="data-value">{{debugData.lastUpdateTime || '未更新'}}</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">滤波器状态:</text>
            <text class="data-value">{{debugData.filterType || '无'}}</text>
          </view>

          <!-- 🛡️ GPS欺骗检测缓冲区状态 -->
          <view wx:if="{{spoofingDetectionEnabled}}" class="data-group" style="background: rgba(255, 107, 0, 0.1); padding: 10rpx; border-radius: 8rpx;">
            <text class="data-label">欺骗检测缓冲区:</text>
            <text class="data-value">有效数据: {{debugData.spoofingBufferSize || 0}}/10 点 (总数: {{debugData.spoofingBufferTotal || 0}})</text>
          </view>

          <view wx:if="{{spoofingDetectionEnabled}}" class="data-group" style="background: rgba(255, 107, 0, 0.1); padding: 10rpx; border-radius: 8rpx;">
            <text class="data-label">检测器状态:</text>
            <text class="data-value">{{debugData.spoofingDetectionState || 'NORMAL'}}</text>
          </view>
        </view>

        <!-- 调试操作 -->
        <view class="debug-actions">
          <van-button size="small" type="primary" bind:click="testGetLocation">测试getLocation</van-button>
          <van-button size="small" type="default" bind:click="testChooseLocation">测试chooseLocation</van-button>
          <van-button size="small" type="{{locationUpdateActive ? 'danger' : 'info'}}" bind:click="toggleLocationUpdate">
            {{locationUpdateActive ? '停止' : '开始'}}持续定位
          </van-button>
          
          <!-- 权限管理按钮 -->
          <van-button wx:if="{{!getLocationPermission || showGPSWarning}}" 
                      size="small" 
                      type="warning" 
                      bind:click="openSetting">
            打开权限设置
          </van-button>
          
          <!-- 切换离线模式 -->
          <van-button size="small" 
                      type="{{isOfflineMode ? 'success' : 'default'}}" 
                      bind:click="toggleOfflineMode">
            {{isOfflineMode ? '退出' : '进入'}}离线模式
          </van-button>
          
          <!-- 机场数据缓存管理 -->
          <van-button size="small" 
                      type="warning" 
                      bind:click="clearAirportCache">
            清除机场缓存
          </van-button>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 距离圈级别选择器 -->
  <van-action-sheet
    show="{{ showRangeSelector }}"
    actions="{{ rangeOptions }}"
    bind:close="onRangeSelectorClose"
    bind:select="onRangeSelect"
    title="选择地图距离圈范围"
    cancel-text="取消"
    z-index="99999"
  />
  
  <!-- GPS欺骗检测配置弹窗 -->
  <view wx:if="{{ showSpoofingConfig }}" class="spoofing-modal-overlay" bindtap="closeSpoofingConfig">
    <view class="spoofing-modal-content" bindtap="stopPropagation">
    <view class="spoofing-config-container">
      <view class="config-header">
        <text class="config-title">GPS欺骗监控设置</text>
        <view class="config-close" bindtap="closeSpoofingConfig">
          <van-icon name="cross" size="20px" color="#666" />
        </view>
      </view>
      
      <view class="config-content">
        <!-- 监控总开关 -->
        <view class="config-item" catchtap="stopPropagation">
          <view class="item-label">
            <text class="label-text">启用GPS欺骗监控</text>
            <text class="label-desc">开启后将实时监控GPS信号异常</text>
          </view>
          <van-switch
            checked="{{ spoofingDetectionEnabled }}"
            bind:change="onSpoofingDetectionToggle"
            size="24px"
            active-color="#00ff88"
          />
        </view>
        
        <!-- 检测模式选择 -->
        <view class="config-item" wx:if="{{spoofingDetectionEnabled}}" catchtap="stopPropagation">
          <view class="item-label">
            <text class="label-text">检测模式</text>
            <text class="label-desc">选择适合当前场景的检测模式</text>
          </view>
          <view class="mode-toggle-container">
            <view class="toggle-button {{spoofingMode === 'ground' ? 'active' : ''}}" 
                  catchtap="onModeToggle" data-mode="ground">
              <text class="toggle-text">地面模式</text>
            </view>
            <view class="toggle-button {{spoofingMode === 'airborne' ? 'active' : ''}}" 
                  catchtap="onModeToggle" data-mode="airborne">
              <text class="toggle-text">空中模式</text>
            </view>
          </view>
        </view>
        
        <!-- 地面模式设置 -->
        <view class="config-item" wx:if="{{spoofingDetectionEnabled && spoofingMode === 'ground'}}" catchtap="stopPropagation">
          <view class="item-label">
            <text class="label-text">当前机场标高</text>
            <text class="label-desc">设置当前机场的标高，用于地面模式检测</text>
          </view>
          <view class="elevation-input-container">
            <van-field
              value="{{ currentElevation }}"
              type="number"
              placeholder="请输入标高(英尺)"
              bind:change="onElevationChange"
              suffix="ft"
              border="{{ false }}"
            />
            <van-button 
              size="mini" 
              type="info" 
              bind:click="getNearestAirportElevation"
              loading="{{ loadingNearestElevation }}"
            >
              获取最近机场
            </van-button>
          </view>
        </view>
        
        <!-- 语音提示开关 -->
        <view class="config-item" wx:if="{{spoofingDetectionEnabled}}" catchtap="stopPropagation">
          <view class="item-label">
            <text class="label-text">语音警告</text>
            <text class="label-desc">检测到欺骗时播放语音提示(最多3次)</text>
          </view>
          <van-switch
            checked="{{ voiceAlertEnabled }}"
            bind:change="onVoiceAlertToggle"
            size="24px"
            active-color="#00ff88"
          />
        </view>
        
        <!-- 当前状态显示 - 隐藏内部调试信息 -->
        <!-- 
        <view class="config-status" wx:if="{{spoofingDetectionEnabled}}">
          <view class="status-item">
            <text class="status-label">检测状态:</text>
            <text class="status-value {{gpsSpoofing ? 'status-warning' : 'status-normal'}}">
              {{gpsSpoofing ? '检测到欺骗' : '信号正常'}}
            </text>
          </view>
          <view class="status-item" wx:if="{{firstSpoofingTime}}">
            <text class="status-label">首次检测:</text>
            <text class="status-value">{{firstSpoofingTime}}</text>
          </view>
          <view class="status-item" wx:if="{{spoofingMode === 'ground'}}">
            <text class="status-label">当前高度差:</text>
            <text class="status-value">{{currentAltitudeDiff || 0}}ft</text>
          </view>
          <view class="status-item" wx:if="{{spoofingMode === 'airborne'}}">
            <text class="status-label">当前地速:</text>
            <text class="status-value">{{speed || 0}}kt</text>
          </view>
        </view>
        -->
      </view>
      
      <view class="config-actions">
        <van-button 
          type="primary" 
          size="large" 
          bind:click="saveSpoofingConfig"
          block
        >
          保存设置
        </van-button>
      </view>
    </view>
    </view>
  </view>

  <!-- 横幅广告 -->
  <view wx:if="{{ !isAdFree }}" class="ad-banner-container">
    <ad unit-id="adunit-2f5afef0d27dc863" ad-type="banner" ad-intervals="30"></ad>
  </view>
</view>


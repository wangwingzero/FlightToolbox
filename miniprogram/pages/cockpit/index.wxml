<view class="cockpit-container">
  <!-- 标题栏 -->
  <view class="cockpit-header">
    <view class="gps-status" wx:if="{{gpsStatus}}">
      <text class="status-text {{gpsInterference ? 'status-interference' : gpsStatusClass}}">
        GPS: {{gpsStatus || '初始化中'}}
      </text>
      <view wx:if="{{gpsInterference}}" class="interference-warning">
        <van-icon name="warning-o" size="16px" color="#ff3333" />
        <text class="warning-text">检测到GPS干扰</text>
      </view>
      <view wx:if="{{lastInterferenceTime && !gpsInterference}}" class="interference-history">
        <text class="history-text">上次干扰: {{lastInterferenceTime}}</text>
      </view>
    </view>
  </view>
  
  <!-- 权限错误提示 -->
  <view wx:if="{{locationError}}" class="error-container">
    <van-icon name="location-o" size="60px" color="#999" />
    <text class="error-text">{{locationError}}</text>
    <view class="error-actions">
      <van-button type="primary" size="small" bind:click="openSetting">打开设置</van-button>
      <van-button wx:if="{{isOffline || isOfflineMode}}" type="default" size="small" bind:click="startSimulatedMode">继续使用</van-button>
    </view>
  </view>
  
  <!-- 仪表盘主体 -->
  <view wx:else class="instruments-container">
    <!-- GPS警告提示(非阻塞) -->
    <view wx:if="{{showGPSWarning}}" class="gps-warning-banner">
      <view class="warning-content">
        <van-icon name="warning-o" size="20px" color="#ff6b00" />
        <text class="warning-text">{{isOfflineMode ? '离线模式 - 使用模拟数据' : 'GPS信号不可用'}}</text>
        <van-icon name="cross" size="20px" color="#999" bind:tap="dismissGPSWarning" />
      </view>
    </view>
    <!-- 第一行：速度和高度（含附属仪表） -->
    <view class="instruments-row">
      <!-- 左侧：GPS地速及加速度 -->
      <view class="instrument-column">
        <view class="instrument speed-indicator">
          <view class="instrument-label">GPS地速</view>
          <view class="instrument-value">
            <text class="value-number">{{speed}}</text>
            <text class="value-unit">kt</text>
          </view>

        </view>
        <!-- 加速度小仪表 -->
        <view class="instrument small-instrument acceleration-indicator">
          <view class="small-instrument-label">加速度</view>
          <view class="small-instrument-value-container">
            <text class="small-instrument-number {{acceleration > 0 ? 'positive' : acceleration < 0 ? 'negative' : ''}}">
              {{acceleration > 0 ? '+' : ''}}{{acceleration}}
            </text>
            <text class="small-value-unit-right">kt/s</text>
          </view>
        </view>
      </view>
      
      <!-- 右侧：GPS高度及升降率 -->
      <view class="instrument-column">
        <view class="instrument altitude-indicator">
          <view class="instrument-label">GPS高度</view>
          <view class="instrument-value">
            <text class="value-number">{{altitude}}</text>
            <text class="value-unit">ft</text>
          </view>

        </view>
        <!-- 升降率小仪表 -->
        <view class="instrument small-instrument vsi-small-indicator">
          <view class="small-instrument-label">升降率</view>
          <view class="small-instrument-value-container">
            <text class="small-instrument-number {{verticalSpeed > 0 ? 'positive' : verticalSpeed < 0 ? 'negative' : ''}}">
              {{verticalSpeed > 0 ? '+' : ''}}{{verticalSpeed}}
            </text>
            <text class="small-value-unit-right">ft/min</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 第二行：航向 -->
    <view class="instruments-row">
      <view class="instrument modern-heading-indicator">
        <!-- 模式切换器 -->
        <view class="heading-mode-switcher" bindtap="toggleHeadingMode">
          <view class="mode-option {{headingMode === 'heading' ? 'active' : ''}}">
            <text class="mode-text">HDG</text>
          </view>
          <view class="mode-option {{headingMode === 'track' ? 'active' : ''}}">
            <text class="mode-text">TRK</text>
          </view>
        </view>
        
        <!-- 主要数值显示 -->
        <view class="heading-main-display">
          <text class="heading-number">{{headingMode === 'heading' ? heading : track}}</text>
          <text class="heading-unit">°</text>
        </view>
        
        <!-- 修复后的方向指示 -->
        <view class="direction-indicator">
          <text class="direction-text">{{headingMode === 'heading' ? '航向' : '航迹'}}</text>
          <view class="direction-compass">
            <!-- 固定的罗盘刻度 -->
            <view class="compass-dial">
              <view class="compass-directions">
                <text class="dir-n">N</text>
                <text class="dir-e">E</text>
                <text class="dir-s">S</text>
                <text class="dir-w">W</text>
              </view>
              
              <!-- 圆周刻度线 -->
              <view class="compass-ticks">
                <view wx:for="{{[0,30,60,90,120,150,180,210,240,270,300,330]}}" wx:key="item" 
                      class="tick-mark" 
                      style="transform: rotate({{item}}deg);">
                  <view class="tick-line"></view>
                </view>
              </view>
              
              <!-- 航向/航迹标记 -->
              <view class="heading-marker" 
                    style="transform: rotate({{headingMode === 'heading' ? heading : track}}deg); transition: transform 0.3s ease-out;">
                <view class="marker-dot"></view>
              </view>
            </view>
            
            <!-- 中心点 -->
            <view class="compass-center"></view>
          </view>
        </view>
        

      </view>
    </view>
    
    
    <!-- GPS干扰提示区 -->
    <view wx:if="{{gpsInterference}}" class="interference-alert">
      <van-icon name="warning" size="40px" color="#ff3333" />
      <view class="alert-content">
        <text class="alert-title">⚠️ GPS干扰警告</text>
        <text class="alert-desc">检测到GPS信号异常跳变，请使用其他导航参考</text>
        <text class="alert-time">发生时间: {{lastInterferenceTime}}</text>
      </view>
    </view>
    
    <!-- 机场信息显示区域 -->
    <view class="airports-info-section">
      <!-- 左侧机场 -->
      <view class="airport-info-card left" bindtap="onAirportCardTap" data-airport="{{leftAirport}}" data-type="left">
        <text wx:if="{{leftAirport}}" class="airport-code">{{leftAirport.ICAOCode}}</text>
        <text wx:else class="airport-code no-data">---</text>
        
        <text wx:if="{{leftAirport}}" class="airport-name">{{leftAirport.ShortName}}</text>
        <text wx:else class="airport-name no-data">无机场</text>
        
        <text wx:if="{{leftAirport}}" class="airport-distance">{{leftAirport.distance}} NM</text>
        <text wx:else class="airport-distance no-data">--- NM</text>
        
        <text wx:if="{{leftAirport}}" class="airport-bearing">{{leftAirport.bearing}}°</text>
        <text wx:else class="airport-bearing no-data">---°</text>
        
        <text class="airport-label">{{leftAirportLabel}}</text>
      </view>
      
      <!-- 中间用户指定机场 -->
      <view class="airport-info-card center" bindtap="onAirportCardTap" data-airport="{{centerAirport}}" data-type="center">
        <text wx:if="{{centerAirport}}" class="airport-code">{{centerAirport.ICAOCode}}</text>
        <text wx:else class="airport-code no-data">---</text>
        
        <text wx:if="{{centerAirport}}" class="airport-name">{{centerAirport.ShortName}}</text>
        <text wx:else class="airport-name no-data">用户指定</text>
        
        <text wx:if="{{centerAirport}}" class="airport-distance">{{centerAirport.distance}} NM</text>
        <text wx:else class="airport-distance no-data">--- NM</text>
        
        <text wx:if="{{centerAirport}}" class="airport-bearing">{{centerAirport.bearing}}°</text>
        <text wx:else class="airport-bearing no-data">---°</text>
        
        <text class="airport-label">指定机场</text>
      </view>
      
      <!-- 右侧机场 -->
      <view class="airport-info-card right" bindtap="onAirportCardTap" data-airport="{{rightAirport}}" data-type="right">
        <text wx:if="{{rightAirport}}" class="airport-code">{{rightAirport.ICAOCode}}</text>
        <text wx:else class="airport-code no-data">---</text>
        
        <text wx:if="{{rightAirport}}" class="airport-name">{{rightAirport.ShortName}}</text>
        <text wx:else class="airport-name no-data">无机场</text>
        
        <text wx:if="{{rightAirport}}" class="airport-distance">{{rightAirport.distance}} NM</text>
        <text wx:else class="airport-distance no-data">--- NM</text>
        
        <text wx:if="{{rightAirport}}" class="airport-bearing">{{rightAirport.bearing}}°</text>
        <text wx:else class="airport-bearing no-data">---°</text>
        
        <text class="airport-label">{{rightAirportLabel}}</text>
      </view>
    </view>
    
    <!-- 导航地图显示 -->
    <view class="navigation-map-container">
      <view class="map-header">
        <!-- 左侧：GS显示和H按钮 -->
        <view class="left-controls">
          <view class="gs-display">
            <text class="gs-label">GS</text>
            <text class="gs-value">{{speed}}</text>
          </view>
          <view class="orientation-toggle" bindtap="toggleMapOrientation">
            <text class="orientation-text">{{mapOrientationMode === 'north-up' ? 'N' : 'H'}}</text>
          </view>
        </view>
        
        <!-- 中间：追踪机场输入框 -->
        <view class="track-airport-input">
          <input
            class="airport-input"
            type="text"
            placeholder="ICAO/IATA/机场名"
            value="{{trackAirportInput}}"
            bindinput="onTrackAirportInput"
            bindconfirm="onTrackAirportConfirm"
            maxlength="20"
          />
        </view>
        
        <!-- 右侧：缩放控制 -->
        <view class="right-controls">
          <view class="zoom-level-display" bindtap="showRangeSelector">
            <text class="zoom-level-text">{{mapRange}} NM</text>
            <van-icon name="arrow-down" size="12px" color="#fff" style="margin-left: 4rpx;" />
          </view>
        </view>
      </view>
      
      <view class="map-canvas-wrapper">
        <canvas 
          type="2d"
          id="navigationMap" 
          class="navigation-canvas"
          bindtouchstart="onMapTouchStart"
          bindtouchmove="onMapTouchMove"
          bindtouchend="onMapTouchEnd"
          bindtouchcancel="onMapTouchEnd">
        </canvas>
        
        <!-- 地图信息叠加层 -->
        <view class="map-overlay">
          <!-- 机场信息已移至上方独立显示 -->
        </view>
      </view>
      
      
      <!-- 经纬度显示 -->
      <view class="coordinates-display">
        <text class="coord-label">{{latitude}}</text>
        <text class="coord-divider">|</text>
        <text class="coord-label">{{longitude}}</text>
        <text class="coord-system" wx:if="{{showCoordinateSystem}}"> ({{coordinateSystemDisplay}})</text>
      </view>
      
      <!-- 地图图例 -->
      <view class="map-legend">
        <view class="legend-item">
          <view class="legend-symbol airport-symbol"></view>
          <text class="legend-text">机场</text>
        </view>
        <view class="legend-item">
          <view class="legend-symbol aircraft-symbol"></view>
          <text class="legend-text">当前位置</text>
        </view>
        <view class="legend-item">
          <view class="legend-symbol range-ring"></view>
          <text class="legend-text">距离圈</text>
        </view>
        <view class="legend-item">
          <view class="legend-symbol track-line"></view>
          <text class="legend-text">TRK 航迹</text>
        </view>
        <view class="legend-item">
          <view class="legend-symbol heading-square"></view>
          <text class="legend-text">HDG 航向</text>
        </view>
        <view class="legend-item">
          <view class="legend-symbol tracking-indicator"></view>
          <text class="legend-text">指定机场</text>
        </view>
      </view>
    </view>
    
    <!-- 查看机场信息按钮 -->
    <view class="location-actions-container">
      <van-button 
        type="primary" 
        size="large"
        custom-class="airport-info-button"
        bind:click="viewAirportInfo"
        icon="location-o"
      >
        查看机场信息
      </van-button>
    </view>
    
    <!-- GPS权限和API调试面板 -->
    <view class="debug-panel">
      <view class="debug-header" bindtap="toggleDebugPanel">
        <text class="debug-title">GPS权限调试 {{debugPanelExpanded ? '▼' : '▶'}}</text>
      </view>
      
      <view wx:if="{{debugPanelExpanded}}" class="debug-content">
        <!-- 权限状态 -->
        <view class="permission-status">
          <text class="section-title">位置API权限状态</text>
          
          <view class="api-item">
            <view class="api-name">wx.getLocation</view>
            <view class="api-status {{getLocationPermission ? 'status-granted' : 'status-denied'}}">
              {{getLocationPermission ? '已授权' : '未授权'}}
            </view>
          </view>
          
          <view class="api-item">
            <view class="api-name">wx.chooseLocation</view>
            <view class="api-status status-granted">可用</view>
          </view>
          
          <view class="api-item">
            <view class="api-name">wx.startLocationUpdate</view>
            <view class="api-status {{locationUpdateActive ? 'status-active' : 'status-inactive'}}">
              {{locationUpdateActive ? '运行中' : '未启动'}}
            </view>
          </view>
          
          <view class="api-item">
            <view class="api-name">wx.onLocationChange</view>
            <view class="api-status {{locationChangeListening ? 'status-active' : 'status-inactive'}}">
              {{locationChangeListening ? '监听中' : '未监听'}}
            </view>
          </view>
        </view>
        
        <!-- 实时数据 -->
        <view class="realtime-data">
          <text class="section-title">实时GPS数据</text>
          
          <view class="data-group">
            <text class="data-label">原始高度数据:</text>
            <text class="data-value">{{debugData.rawAltitude || 'null'}} ({{debugData.altitudeType || 'unknown'}})</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">处理后高度:</text>
            <text class="data-value">{{altitude}}ft (有效: {{debugData.altitudeValid ? '是' : '否'}})</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">GPS精度:</text>
            <text class="data-value">{{debugData.accuracy || 0}}m</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">更新频率:</text>
            <text class="data-value">{{updateCount}}次 ({{debugData.updateInterval || 0}}ms间隔)</text>
          </view>
          
          <view class="data-group">
            <text class="data-label">滤波器状态:</text>
            <text class="data-value">{{debugData.filterType || '无'}}</text>
          </view>
        </view>
        
        <!-- 调试操作 -->
        <view class="debug-actions">
          <van-button size="small" type="primary" bind:click="testGetLocation">测试getLocation</van-button>
          <van-button size="small" type="default" bind:click="testChooseLocation">测试chooseLocation</van-button>
          <van-button size="small" type="{{locationUpdateActive ? 'danger' : 'info'}}" bind:click="toggleLocationUpdate">
            {{locationUpdateActive ? '停止' : '开始'}}持续定位
          </van-button>
          
          <!-- 权限管理按钮 -->
          <van-button wx:if="{{!getLocationPermission || showGPSWarning}}" 
                      size="small" 
                      type="warning" 
                      bind:click="openSetting">
            打开权限设置
          </van-button>
          
          <!-- 切换离线模式 -->
          <van-button size="small" 
                      type="{{isOfflineMode ? 'success' : 'default'}}" 
                      bind:click="toggleOfflineMode">
            {{isOfflineMode ? '退出' : '进入'}}离线模式
          </van-button>
          
          <!-- 机场数据缓存管理 -->
          <van-button size="small" 
                      type="warning" 
                      bind:click="clearAirportCache">
            清除机场缓存
          </van-button>
        </view>
      </view>
    </view>
  </view>
  
  <!-- 距离圈级别选择器 -->
  <van-action-sheet
    show="{{ showRangeSelector }}"
    actions="{{ rangeOptions }}"
    bind:close="onRangeSelectorClose"
    bind:select="onRangeSelect"
    title="选择地图距离圈范围"
    cancel-text="取消"
    z-index="99999"
  />
</view>
<view class="container" data-theme="{{ isDarkMode ? 'dark' : 'light' }}">
  <!-- ä¸»é¡µé¢ - åŠŸèƒ½å¡ç‰‡é€‰æ‹© -->
  <view wx:if="{{ !selectedModule }}" class="main-page">
    <view class="page-header">
      <view class="header-title">ğŸ“¡ é™†ç©ºé€šè¯åŠ©æ‰‹</view>
      <view class="header-subtitle">æ ‡å‡†é€šè¯ï¼Œå®‰å…¨é£è¡Œ</view>
    </view>

    <!-- å¹¿å‘Šä½ -->
    <view wx:if="{{ showAd && !userPreferences.reduceAds }}" class="calculator-ad-container">
      <ad-template 
        unit-id="{{ adUnitId }}"
        ad-type="custom"
        context="communication"
        bind:adload="onAdLoad"
        bind:aderror="onAdError"
      />
    </view>

    <!-- åŠŸèƒ½å¡ç‰‡ç½‘æ ¼ -->
    <view class="modules-grid">
      <view class="module-card" bind:tap="selectModule" data-module="airline-recordings">
        <view class="module-icon">ğŸ§</view>
        <view class="module-title">èˆªçº¿å½•éŸ³</view>
        <view class="module-desc">çœŸå®é™†ç©ºé€šè¯å½•éŸ³å­¦ä¹ </view>
        <view class="module-count">å…¨çƒèˆªçº¿è¦†ç›–</view>
      </view>

      <view class="module-card" bind:tap="selectModule" data-module="communication-rules">
        <view class="module-icon">ğŸ“–</view>
        <view class="module-title">é€šä¿¡è§„èŒƒ</view>
        <view class="module-desc">ä¸“ä¸šé€šä¿¡è§„èŒƒè¯¦è§£</view>
        <view class="module-count">å®Œæ•´è§„èŒƒ</view>
      </view>
    </view>
  </view>


  <!-- èˆªçº¿å½•éŸ³é¡µé¢ -->
  <view wx:if="{{ selectedModule === 'airline-recordings' }}" class="module-page">
    <!-- åœ°åŒºé€‰æ‹©é¡µé¢ - æ¿å—å¼å¸ƒå±€ -->
    <view wx:if="{{ !selectedRegion }}" class="recordings-main">

      <!-- åŠŸèƒ½ä»‹ç»å¡ç‰‡ -->
      <view class="feature-intro-card">
        <view class="intro-header">
          <view class="intro-icon">
            <text class="emoji-icon large">ğŸ§</text>
          </view>
          <view class="intro-content">
            <view class="intro-title">çœŸå®é™†ç©ºé€šè¯å½•éŸ³å­¦ä¹ </view>
            <view class="intro-desc">æ”¶å½•å…¨çƒä¸»è¦èˆªçº¿çš„çœŸå®é€šè¯å½•éŸ³ï¼Œå¸®åŠ©æ‚¨æå‡ä¸“ä¸šè‹±è¯­èƒ½åŠ›</view>
          </view>
        </view>
      </view>

      <!-- åˆ†æ¿å—çš„åœ°åŒºé€‰æ‹© - ç±»ä¼¼é¦–é¡µé£æ ¼ -->
      <view class="recording-categories">
        <view wx:for="{{ groupedRegions }}" wx:key="id" class="category-section">
          <!-- å¤§æ´²æ ‡é¢˜å¤´éƒ¨ -->
          <view class="category-header">
            <view class="category-icon">
              <text class="emoji-icon">{{ item.icon }}</text>
              <view class="icon-bg" style="background: {{ item.color }}20;"></view>
            </view>
            <view class="category-info">
              <text class="category-title">{{ item.name }}</text>
              <text class="category-desc">{{ item.description }}</text>
            </view>
            <view class="category-badge">{{ item.regionCount }}</view>
          </view>
          
          <!-- è¯¥å¤§æ´²ä¸‹çš„å›½å®¶å¡ç‰‡ -->
          <van-row gutter="32">
            <van-col span="12" wx:for="{{ item.regions }}" wx:for-item="region" wx:key="id">
              <view class="region-card {{ region.hasRealRecordings ? '' : 'disabled' }}" bind:tap="{{ region.hasRealRecordings ? 'selectRegion' : 'showComingSoon' }}" data-region="{{ region.id }}">
                <view class="region-icon">
                  <text class="emoji-icon">{{ region.flag }}</text>
                  <view class="region-icon-bg"></view>
                </view>
                <view class="region-content">
                  <view class="region-name">{{ region.name }}</view>
                  <view class="region-desc">{{ region.description }}</view>
                  <view class="region-status">
                    <van-tag wx:if="{{ region.hasRealRecordings }}" type="primary" size="mini">{{ region.count }}ä¸ªå½•éŸ³</van-tag>
                    <van-tag wx:else type="default" size="mini">å¾…æ·»åŠ </van-tag>
                  </view>
                </view>
              </view>
            </van-col>
          </van-row>
        </view>
      </view>
    </view>


    <!-- å½•éŸ³åˆ†ç±»é€‰æ‹©é¡µé¢ -->
    <view wx:if="{{ selectedRegion && !selectedCategory && recordingCategories.length > 0 }}" class="categories-list">

      <!-- åŠŸèƒ½ä»‹ç»å¡ç‰‡ -->
      <view class="feature-intro-card">
        <view class="intro-header">
          <view class="intro-icon">
            <text class="emoji-icon large">ğŸ§</text>
          </view>
          <view class="intro-content">
            <view class="intro-title">é€‰æ‹©å½•éŸ³åˆ†ç±»</view>
            <view class="intro-desc">æŒ‰ç…§é€šä¿¡ç±»å‹åˆ†ç±»çš„çœŸå®é™†ç©ºé€šè¯å½•éŸ³</view>
          </view>
        </view>
      </view>

      <!-- åˆ†ç±»å¡ç‰‡ç½‘æ ¼ -->
      <view class="categories-grid">
        <view wx:for="{{ recordingCategories }}" wx:key="id" class="category-card" bind:tap="selectCategory" data-category="{{ item.id }}">
          <view class="category-icon-large">
            <text class="emoji-icon">{{ item.icon }}</text>
            <view class="category-icon-bg" style="background: {{ item.color }}20;"></view>
          </view>
          <view class="category-name">{{ item.name }}</view>
          <view class="category-count">{{ item.clips.length }}ä¸ªå½•éŸ³</view>
        </view>
      </view>
    </view>

    <!-- å½•éŸ³æ’­æ”¾é¡µé¢ -->
    <view wx:if="{{ selectedRegion && selectedCategory && categoryClips.length > 0 }}" class="recording-player">


      <!-- å½•éŸ³å¡ç‰‡ç½‘æ ¼ -->
      <view class="clips-grid">
        <view class="grid-header">
          <view class="header-title">å½•éŸ³å¡ç‰‡</view>
          <view class="header-count">{{ categoryClips.length }}ä¸ªå½•éŸ³</view>
        </view>
        
        <!-- åœ¨çº¿éŸ³é¢‘æç¤º -->
        <view wx:if="{{ currentAirportData && currentAirportData.hasMoreClips }}" class="more-clips-tip">
          <view class="tip-icon">ğŸŒ</view>
          <view class="tip-content">
            <view class="tip-title">æ›´å¤šå½•éŸ³åœ¨çº¿è·å–</view>
            <view class="tip-desc">æœ¬åœ°ä»…å±•ç¤ºç²¾é€‰å½•éŸ³ï¼Œæ›´å¤šå†…å®¹å°†åœ¨ç½‘ç»œç¯å¢ƒä¸‹è‡ªåŠ¨åŠ è½½</view>
          </view>
        </view>
        
        <!-- å½•éŸ³å¡ç‰‡ç½‘æ ¼ -->
        <van-row gutter="24">
          <van-col span="12" wx:for="{{ categoryClips }}" wx:key="index">
            <view class="audio-card" bind:tap="selectClip" data-index="{{ index }}">
              <view class="card-header">
                <view class="card-number">{{ index + 1 }}</view>
                <view class="learned-status" bind:tap="toggleLearnedStatus" data-index="{{ index }}">
                  {{ item.isLearned ? 'âœ…' : 'âŒ' }}
                </view>
              </view>
              
              <view class="card-content">
                <view class="card-label">{{ item.label }}</view>
                <view class="card-title">{{ item.isLearned ? item.full_transcript : '???' }}</view>
                <view class="card-subtitle">{{ item.isLearned ? item.translation_cn : 'è¯·å…ˆå­¦ä¹ è¿™æ®µå½•éŸ³' }}</view>
              </view>
              
              <view class="card-footer">
                <view class="play-icon">ğŸ§</view>
                <view class="play-text">ç‚¹å‡»æ’­æ”¾</view>
              </view>
            </view>
          </van-col>
        </van-row>
      </view>
    </view>
  </view>


  <!-- é€šä¿¡è§„åˆ™é¡µé¢ -->
  <view wx:if="{{ selectedModule === 'communication-rules' }}" class="module-page">
    <!-- ç« èŠ‚åˆ—è¡¨é¡µé¢ -->
    <view wx:if="{{ !selectedChapter }}" class="rules-main">

      <!-- æ–‡æ¡£æ ‡é¢˜ -->
      <view class="document-header">
        <view class="document-title">{{ communicationRules.documentTitle }}</view>
        <view class="document-org">{{ communicationRules.organization }}</view>
      </view>

      <!-- æœç´¢æ¡† -->
      <view class="search-section">
        <van-search
          value="{{ rulesSearchKeyword }}"
          placeholder="æœç´¢é€šä¿¡è§„åˆ™..."
          bind:search="onRulesSearch"
          bind:input="onRulesSearchInput"
          background="transparent"
        />
      </view>

      <!-- å¿«é€Ÿå·¥å…· -->
      <view class="quick-tools-section">
        <view class="section-title">ğŸ› ï¸ å¿«é€Ÿå·¥å…·</view>
        <view class="tools-grid">
          <view class="tool-card" bind:tap="openNumberConverter">
            <view class="tool-icon">ğŸ”¢</view>
            <view class="tool-title">æ•°å­—è½¬æ¢</view>
          </view>
          <view class="tool-card" bind:tap="openAltitudeConverter">
            <view class="tool-icon">ğŸ“</view>
            <view class="tool-title">é«˜åº¦è¯»æ³•</view>
          </view>
          <view class="tool-card" bind:tap="openTimeConverter">
            <view class="tool-icon">â°</view>
            <view class="tool-title">æ—¶é—´è¯»æ³•</view>
          </view>
          <view class="tool-card" bind:tap="openQuickReference">
            <view class="tool-icon">ğŸ“–</view>
            <view class="tool-title">å¿«é€ŸæŸ¥è¯¢</view>
          </view>
        </view>
      </view>

      <!-- ç« èŠ‚åˆ—è¡¨ -->
      <view class="rules-chapters">
        <view wx:for="{{ filteredChapters }}" wx:key="id" class="chapter-card" bind:tap="selectChapter" data-chapter-id="{{ item.id }}">
          <view class="chapter-icon" style="background: {{ item.color }}">{{ item.icon }}</view>
          <view class="chapter-content">
            <view class="chapter-title">{{ item.title }}</view>
            <view class="chapter-sections">{{ item.sections.length }}ä¸ªç« èŠ‚</view>
          </view>
          <view class="chapter-arrow">></view>
        </view>
      </view>
    </view>

    <!-- ç« èŠ‚è¯¦æƒ…é¡µé¢ -->
    <view wx:if="{{ selectedChapter && !selectedSection }}" class="chapter-detail">

      <!-- èŠ‚åˆ—è¡¨ -->
      <view class="sections-list">
        <view wx:for="{{ communicationRules.chapters }}" wx:key="id">
          <view wx:if="{{ item.id === selectedChapter }}">
            <view wx:for="{{ item.sections }}" wx:for-item="section" wx:key="id" class="section-card" bind:tap="selectSection" data-section-id="{{ section.id }}">
              <view class="section-icon">{{ section.icon }}</view>
              <view class="section-content">
                <view class="section-title">{{ section.title }}</view>
                <view class="section-subsections">{{ section.subsections.length }}ä¸ªå°èŠ‚</view>
              </view>
              <view class="section-arrow">></view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- èŠ‚è¯¦æƒ…é¡µé¢ -->
    <view wx:if="{{ selectedChapter && selectedSection }}" class="section-detail">

      <!-- å°èŠ‚å†…å®¹ -->
      <view class="subsections-content">
        <view wx:for="{{ communicationRules.chapters }}" wx:key="id">
          <view wx:if="{{ item.id === selectedChapter }}">
            <view wx:for="{{ item.sections }}" wx:for-item="section" wx:key="id">
              <view wx:if="{{ section.id === selectedSection }}">
                <van-collapse value="{{ activeRulesCategories }}" bind:change="onRulesChange">
                  <view wx:for="{{ section.subsections }}" wx:for-item="subsection" wx:key="id">
                    <van-collapse-item title="{{ subsection.title }}" name="{{ subsection.id }}">
                      
                      <!-- æ–‡æœ¬å†…å®¹ -->
                      <view wx:if="{{ subsection.content }}" class="subsection-content">
                        <view wx:for="{{ subsection.content }}" wx:key="index" class="content-item" bind:tap="copyRulesContent" data-content="{{ item }}">
                          <view class="content-text">{{ item }}</view>
                        </view>
                      </view>

                      <!-- è§„åˆ™å†…å®¹ -->
                      <view wx:if="{{ subsection.rules }}" class="rules-content">
                        <view wx:for="{{ subsection.rules }}" wx:key="index" class="rule-item">
                          <view class="rule-condition">{{ item.condition }}</view>
                          <view class="rule-structure" bind:tap="copyRulesContent" data-content="{{ item.structure }}">{{ item.structure }}</view>
                          <view wx:if="{{ item.englishStructure }}" class="rule-english" bind:tap="copyRulesContent" data-content="{{ item.englishStructure }}">{{ item.englishStructure }}</view>
                        </view>
                        <view wx:if="{{ subsection.note }}" class="subsection-note">{{ subsection.note }}</view>
                      </view>

                      <!-- æŠ€å·§æç¤º -->
                      <view wx:if="{{ subsection.tips }}" class="tips-content">
                        <view wx:for="{{ subsection.tips }}" wx:key="index" class="tip-item" bind:tap="copyRulesContent" data-content="{{ item }}">
                          <view class="tip-icon">ğŸ’¡</view>
                          <view class="tip-text">{{ item }}</view>
                        </view>
                      </view>

                      <!-- è¡¨æ ¼å†…å®¹ -->
                      <view wx:if="{{ subsection.table }}" class="table-content">
                        <view class="table-title">{{ subsection.table.name }}</view>
                        <view wx:if="{{ subsection.table.note }}" class="table-note">{{ subsection.table.note }}</view>
                        <view class="pronunciation-table">
                          <view class="table-header">
                            <view class="table-cell">{{ subsection.table.headers[0] }}</view>
                            <view class="table-cell">{{ subsection.table.headers[1] }}</view>
                            <view class="table-cell">{{ subsection.table.headers[2] }}</view>
                          </view>
                          <view wx:for="{{ subsection.table.data }}" wx:key="index" class="table-row">
                            <view class="table-cell number-cell" bind:tap="copyRulesContent" data-content="{{ item.number || item.digit || item.altitude || item.time }}">{{ item.number || item.digit || item.altitude || item.time }}</view>
                            <view class="table-cell chinese-cell" bind:tap="copyRulesContent" data-content="{{ item.chinese }}">{{ item.chinese }}</view>
                            <view class="table-cell english-cell" bind:tap="copyRulesContent" data-content="{{ item.english }}">{{ item.english }}</view>
                          </view>
                        </view>
                      </view>

                      <!-- ç¤ºä¾‹å†…å®¹ -->
                      <view wx:if="{{ subsection.examples }}" class="examples-content">
                        <view wx:for="{{ subsection.examples }}" wx:key="index" class="example-item">
                          <view class="example-number" bind:tap="copyRulesContent" data-content="{{ item.number || item.time }}">{{ item.number || item.time }}</view>
                          <view class="example-chinese" bind:tap="copyRulesContent" data-content="{{ item.chinese }}">{{ item.chinese }}</view>
                          <view class="example-english" bind:tap="copyRulesContent" data-content="{{ item.english }}">{{ item.english }}</view>
                        </view>
                      </view>

                      <!-- é€šè¯çŸ­è¯­ -->
                      <view wx:if="{{ subsection.phrases }}" class="phrases-content">
                        <view wx:for="{{ subsection.phrases }}" wx:key="index" class="phrase-card">
                          <view class="phrase-scenario">{{ item.scenario }}</view>
                          <view class="phrase-chinese" bind:tap="copyRulesContent" data-content="{{ item.chinese }}">{{ item.chinese }}</view>
                          <view class="phrase-english" bind:tap="copyRulesContent" data-content="{{ item.english }}">{{ item.english }}</view>
                          <view class="phrase-usage">{{ item.usage }}</view>
                        </view>
                      </view>

                    </van-collapse-item>
                  </view>
                </van-collapse>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<van-toast id="van-toast" />
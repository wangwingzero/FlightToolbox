<view class="container">
  <!-- æœç´¢æ¡† -->
  <view class="search-section">
    <van-search
      value="{{ searchValue }}"
      placeholder="æœç´¢å±é™©å“åç§°æˆ–ç±»åˆ«..."
      bind:search="onSearch"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      show-action="{{ false }}"
      background="#f7f8fa"
      shape="round"
    >
      <view slot="right-icon" class="search-icon-slot" bind:tap="onSearch">
        <van-icon name="search" class="search-icon" />
      </view>
    </van-search>
  </view>

  <!-- æ ‡ç­¾é¡µ -->
  <van-tabs active="{{ activeTab }}" bind:click="onTabChange" sticky>
    <!-- æºå¸¦è§„å®šæ ‡ç­¾é¡µ -->
    <van-tab title="æºå¸¦è§„å®š" name="regulations">
      <!-- ğŸ¯ åŸºäºContext7æœ€ä½³å®è·µï¼šå¹¿å‘ŠåŒºåŸŸ - å±é™©å“ä¸»é¢˜è‰² -->
      <view class="ad-section" wx:if="{{ showAd }}">
        <text class="ad-label">å¹¿å‘Š</text>
        <ad-template 
          unit-id="{{ adUnitId }}"
          ad-type="custom"
          bind:adload="onAdLoad"
          bind:aderror="onAdError"
        />
      </view>
      
      <view wx:if="{{ loading }}" class="loading-section">
        <van-loading size="24px" vertical>æ•°æ®åŠ è½½ä¸­...</van-loading>
      </view>
      
      <view wx:else class="regulations-section">
        <view wx:if="{{ filteredRegulations.length > 0 }}" class="results-section">
          <van-cell-group title="å±é™©å“æºå¸¦è§„å®š ({{ filteredRegulations.length }}æ¡)">
            <van-cell 
              wx:for="{{ filteredRegulations }}" 
              wx:key="item_name"
              title="{{ item.item_name }}"
              label="{{ item.description && item.description.length > 80 ? item.description.substring(0, 80) + '...' : (item.description || 'æš‚æ— æè¿°') }}"
              is-link
              bind:click="viewRegulationDetail"
              data-item="{{ item }}"
              class="regulation-cell"
            >
              <view slot="right-icon" class="regulation-status">
                <van-tag wx:if="{{ item.allowed_in_carry_on }}" type="success" size="mini">å¯æ‰‹æ</van-tag>
                <van-tag wx:if="{{ item.allowed_in_checked_baggage }}" type="primary" size="mini">å¯æ‰˜è¿</van-tag>
                <van-tag wx:if="{{ !item.allowed_in_carry_on && !item.allowed_in_checked_baggage }}" type="danger" size="mini">ç¦æ­¢</van-tag>
              </view>
            </van-cell>
          </van-cell-group>
        </view>

        <van-empty
          wx:if="{{ filteredRegulations.length === 0 && searchValue }}"
          description="æœªæ‰¾åˆ°ç›¸å…³å±é™©å“è§„å®š"
        />
      </view>
    </van-tab>

    <!-- åº”æ€¥å“åº”æ ‡ç­¾é¡µ -->
    <van-tab title="åº”æ€¥å“åº”" name="emergency">
      <!-- ğŸ¯ åŸºäºContext7æœ€ä½³å®è·µï¼šå¹¿å‘ŠåŒºåŸŸ - å±é™©å“ä¸»é¢˜è‰² -->
      <view class="ad-section" wx:if="{{ showAd }}">
        <text class="ad-label">å¹¿å‘Š</text>
        <ad-template 
          unit-id="{{ adUnitId }}"
          ad-type="custom"
          bind:adload="onAdLoad"
          bind:aderror="onAdError"
        />
      </view>
      
      <view wx:if="{{ loading }}" class="loading-section">
        <van-loading size="24px" vertical>æ•°æ®åŠ è½½ä¸­...</van-loading>
      </view>
      
      <view wx:else class="emergency-section">
        <view wx:if="{{ filteredEmergency.length > 0 }}" class="results-section">
          <van-cell-group title="åº”æ€¥å“åº”ç¨‹åº ({{ filteredEmergency.length }}æ¡)">
            <van-cell 
              wx:for="{{ filteredEmergency }}" 
              wx:key="code"
              title="ä»£ç  {{ item.code }}"
              label="{{ item.inherent_hazard }}"
              is-link
              bind:click="viewEmergencyDetail"
              data-item="{{ item }}"
              class="emergency-cell"
            >
              <view slot="right-icon" class="emergency-code">
                <van-tag type="warning" size="mini">{{ item.code }}</van-tag>
              </view>
            </van-cell>
          </van-cell-group>
        </view>

        <van-empty
          wx:if="{{ filteredEmergency.length === 0 && searchValue }}"
          description="æœªæ‰¾åˆ°ç›¸å…³åº”æ€¥å“åº”ç¨‹åº"
        />
      </view>
    </van-tab>

    <!-- éšå«å±é™©å“æ ‡ç­¾é¡µ -->
    <van-tab title="éšå«å±é™©å“" name="hidden">
      <!-- ğŸ¯ åŸºäºContext7æœ€ä½³å®è·µï¼šå¹¿å‘ŠåŒºåŸŸ - å±é™©å“ä¸»é¢˜è‰² -->
      <view class="ad-section" wx:if="{{ showAd }}">
        <text class="ad-label">å¹¿å‘Š</text>
        <ad-template 
          unit-id="{{ adUnitId }}"
          ad-type="custom"
          bind:adload="onAdLoad"
          bind:aderror="onAdError"
        />
      </view>
      
      <view wx:if="{{ loading }}" class="loading-section">
        <van-loading size="24px" vertical>æ•°æ®åŠ è½½ä¸­...</van-loading>
      </view>
      
      <view wx:else class="hidden-section">
        <view wx:if="{{ filteredHidden.length > 0 }}" class="results-section">
          <van-cell-group title="éšå«å±é™©å“ç±»åˆ« ({{ filteredHidden.length }}æ¡)">
            <van-cell 
              wx:for="{{ filteredHidden }}" 
              wx:key="category_zh"
              title="{{ item.category_zh }}"
              label="{{ item.category_en }}"
              is-link
              bind:click="viewHiddenDetail"
              data-item="{{ item }}"
              class="hidden-cell"
            >
            </van-cell>
          </van-cell-group>
        </view>

        <van-empty
          wx:if="{{ filteredHidden.length === 0 && searchValue }}"
          description="æœªæ‰¾åˆ°ç›¸å…³éšå«å±é™©å“"
        />
      </view>
    </van-tab>
  </van-tabs>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <van-popup
    show="{{ showDetailPopup }}"
    bind:close="closeDetailPopup"
    position="bottom"
    round="{{ true }}"
    close-on-click-overlay="{{ true }}"
    custom-style="height: 70vh; overflow: hidden;"
  >
    <view class="detail-popup-container">
      <!-- å¼¹çª—æ ‡é¢˜æ  -->
      <view class="detail-header">
        <view class="detail-title">{{ detailData.title }}</view>
        <van-icon name="cross" bind:click="closeDetailPopup" class="close-btn" />
      </view>

          <!-- æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
    <scroll-view scroll-y class="detail-content" enable-flex enhanced show-scrollbar="{{ false }}">
        <!-- æºå¸¦è§„å®šè¯¦æƒ… -->
        <view wx:if="{{ detailType === 'regulation' }}" class="regulation-detail">
          <!-- ç‰©å“åŸºæœ¬ä¿¡æ¯ -->
          <van-cell-group title="åŸºæœ¬ä¿¡æ¯" class="detail-section">
            <van-cell title="ç‰©å“åç§°" value="{{ detailData.item_name }}" />
          </van-cell-group>

          <!-- æºå¸¦æ¡ä»¶ -->
          <van-cell-group title="æºå¸¦æ¡ä»¶" class="detail-section">
            <view class="conditions-grid">
              <view class="condition-item {{ detailData.allowed_in_carry_on ? 'allowed' : 'forbidden' }}">
                <van-icon name="{{ detailData.allowed_in_carry_on ? 'success' : 'close' }}" />
                <text>æ‰‹æè¡Œæ</text>
              </view>
              <view class="condition-item {{ detailData.allowed_in_checked_baggage ? 'allowed' : 'forbidden' }}">
                <van-icon name="{{ detailData.allowed_in_checked_baggage ? 'success' : 'close' }}" />
                <text>æ‰˜è¿è¡Œæ</text>
              </view>
            </view>
            
            <!-- ç‰¹æ®Šæ¡ä»¶ -->
            <view wx:if="{{ detailData.requires_operator_approval || detailData.requires_captain_notification || detailData.special_condition }}" class="special-conditions">
              <van-notice-bar
                wx:if="{{ detailData.requires_operator_approval }}"
                text="éœ€è¦èˆªç©ºå…¬å¸æ‰¹å‡†"
                mode="alert"
                color="#ff976a"
                background="#fff7cc"
              />
              <van-notice-bar
                wx:if="{{ detailData.requires_captain_notification }}"
                text="éœ€è¦é€šçŸ¥æœºé•¿"
                mode="alert"
                color="#ff976a"
                background="#fff7cc"
              />
              <view wx:if="{{ detailData.special_condition }}" class="special-note">
                <van-tag type="warning" size="large">ç‰¹æ®Šè¯´æ˜</van-tag>
                <text class="note-text">{{ detailData.special_condition }}</text>
              </view>
            </view>
          </van-cell-group>

          <!-- è¯¦ç»†è¯´æ˜ -->
          <van-cell-group title="è¯¦ç»†è¯´æ˜" class="detail-section">
            <view class="description-content">
              <text class="description-text">{{ detailData.description }}</text>
            </view>
          </van-cell-group>
        </view>

        <!-- åº”æ€¥å“åº”è¯¦æƒ… -->
        <view wx:if="{{ detailType === 'emergency' }}" class="emergency-detail">
          <!-- ä»£ç ä¿¡æ¯ -->
          <van-cell-group title="ä»£ç ä¿¡æ¯" class="detail-section">
            <van-cell title="åº”æ€¥ä»£ç " value="{{ detailData.code }}" />
          </van-cell-group>

          <!-- å±é™©ç±»å‹ -->
          <van-cell-group title="å±é™©ç±»å‹" class="detail-section">
            <view class="hazard-item">
              <view class="hazard-title">
                <van-icon name="warning" color="#ff976a" />
                <text>å›ºæœ‰å±é™©</text>
              </view>
              <text class="hazard-content">{{ detailData.inherent_hazard }}</text>
            </view>
            
            <view class="hazard-item">
              <view class="hazard-title">
                <van-icon name="cluster" color="#ee0a24" />
                <text>å¯¹èˆªç©ºå™¨çš„å±é™©</text>
              </view>
              <text class="hazard-content">{{ detailData.aircraft_hazard }}</text>
            </view>
            
            <view class="hazard-item">
              <view class="hazard-title">
                <van-icon name="friends" color="#ff976a" />
                <text>å¯¹ä¹˜å‘˜çš„å±é™©</text>
              </view>
              <text class="hazard-content">{{ detailData.occupant_hazard }}</text>
            </view>
          </van-cell-group>

          <!-- åº”æ€¥ç¨‹åº -->
          <van-cell-group title="åº”æ€¥ç¨‹åº" class="detail-section">
            <van-collapse value="{{ activeCollapse }}" bind:change="onCollapseChange">
              <van-collapse-item title="æ³„æ¼å¤„ç†ç¨‹åº" name="spill">
                <text class="procedure-text">{{ detailData.spill_leak_procedure }}</text>
              </van-collapse-item>
              <van-collapse-item title="ç­ç«ç¨‹åº" name="fire">
                <text class="procedure-text">{{ detailData.fire_fighting_procedure }}</text>
              </van-collapse-item>
              <van-collapse-item title="å…¶ä»–è€ƒè™‘" name="other">
                <text class="procedure-text">{{ detailData.other_considerations }}</text>
              </van-collapse-item>
            </van-collapse>
          </van-cell-group>
        </view>

        <!-- éšå«å±é™©å“è¯¦æƒ… -->
        <view wx:if="{{ detailType === 'hidden' }}" class="hidden-detail">
          <!-- ç±»åˆ«ä¿¡æ¯ -->
          <van-cell-group title="ç±»åˆ«ä¿¡æ¯" class="detail-section">
            <van-cell title="ä¸­æ–‡åç§°" value="{{ detailData.category_zh }}" />
            <van-cell title="è‹±æ–‡åç§°" value="{{ detailData.category_en }}" />
          </van-cell-group>

          <!-- è¯´æ˜ -->
          <van-cell-group title="è¯¦ç»†è¯´æ˜" class="detail-section">
            <view class="description-content">
              <text class="description-text">{{ detailData.description }}</text>
            </view>
          </van-cell-group>

          <!-- å¯èƒ½åŒ…å«çš„ç‰©å“ -->
          <van-cell-group wx:if="{{ detailData.possible_items && detailData.possible_items.length > 0 }}" title="å¯èƒ½åŒ…å«çš„ç‰©å“" class="detail-section">
            <view class="possible-items">
              <van-tag
                wx:for="{{ detailData.possible_items }}"
                wx:key="*this"
                type="primary"
                size="medium"
                class="item-tag"
              >
                {{ item }}
              </van-tag>
            </view>
          </van-cell-group>
        </view>
      </scroll-view>

      <!-- åº•éƒ¨æ“ä½œæ  -->
      <view class="detail-footer">
        <van-button type="primary" block bind:click="closeDetailPopup">
          çŸ¥é“äº†
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{ !loading && !searchValue }}" class="stats-section">
    <view class="stats-grid">
      <view class="stats-item">
        <text class="stats-number">{{ regulationsData.length }}</text>
        <text class="stats-label">æºå¸¦è§„å®š</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{ emergencyData.length }}</text>
        <text class="stats-label">åº”æ€¥ç¨‹åº</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{ hiddenGoodsData.length }}</text>
        <text class="stats-label">éšå«å±é™©å“</text>
      </view>
    </view>
  </view>
</view> 
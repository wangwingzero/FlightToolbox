<view class="radiation-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-title">â˜¢ï¸ èˆªç©ºè¾å°„è®¡ç®—</view>
    <view class="header-subtitle">åŸºäºWMM2020ç‰©ç†æ¨¡å‹çš„ç²¾ç¡®è®¡ç®—</view>
  </view>

  <!-- Tabåˆ‡æ¢ -->
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" color="#667eea">
    <!-- å•ç‚¹è®¡ç®—Tab -->
    <van-tab title="å•ç‚¹è®¡ç®—" name="single">
      <view class="tab-content">

        <!-- ä½ç½®è¾“å…¥æ–¹å¼é€‰æ‹© -->
        <view class="section-card">
          <view class="section-title">ğŸ“ ä½ç½®è¾“å…¥æ–¹å¼</view>
          <view class="input-mode-tabs">
            <view
              class="mode-tab {{ inputMode === 'manual' ? 'active' : '' }}"
              bindtap="switchInputMode"
              data-mode="manual"
            >
              æ‰‹åŠ¨è¾“å…¥
            </view>
            <view
              class="mode-tab {{ inputMode === 'airport' ? 'active' : '' }}"
              bindtap="switchInputMode"
              data-mode="airport"
            >
              é€‰æ‹©æœºåœº
            </view>
          </view>
        </view>

        <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
        <view wx:if="{{ inputMode === 'manual' }}" class="section-card">
          <view class="input-group">
            <view class="input-label">çº¬åº¦(Â°)</view>
            <van-field
              value="{{ singlePoint.latitude }}"
              type="digit"
              placeholder="ä¾‹å¦‚ï¼š39.9ï¼ˆ-90 åˆ° 90ï¼‰"
              bind:change="onLatitudeChange"
            />
          </view>

          <view class="input-group">
            <view class="input-label">ç»åº¦(Â°)</view>
            <van-field
              value="{{ singlePoint.longitude }}"
              type="digit"
              placeholder="ä¾‹å¦‚ï¼š116.4ï¼ˆ-180 åˆ° 180ï¼‰"
              bind:change="onLongitudeChange"
            />
          </view>
        </view>

        <!-- æœºåœºé€‰æ‹©æ¨¡å¼ -->
        <view wx:if="{{ inputMode === 'airport' }}" class="section-card">
          <view class="airport-selector" bindtap="showAirportPicker">
            <view class="selector-label">é€‰æ‹©æœºåœº</view>
            <view class="selector-value">
              {{ selectedAirport ? selectedAirport.ShortName + ' (' + selectedAirport.ICAOCode + ')' : 'ç‚¹å‡»é€‰æ‹©æœºåœº' }}
            </view>
            <van-icon name="arrow" class="selector-icon" />
          </view>

          <view wx:if="{{ selectedAirport }}" class="airport-info">
            <view class="info-item">
              <text class="info-label">çº¬åº¦ï¼š</text>
              <text class="info-value">{{ selectedAirport.Latitude }}Â°</text>
            </view>
            <view class="info-item">
              <text class="info-label">ç»åº¦ï¼š</text>
              <text class="info-value">{{ selectedAirport.Longitude }}Â°</text>
            </view>
          </view>
        </view>

        <!-- é«˜åº¦å’Œæ—¥æœŸè¾“å…¥ -->
        <view class="section-card">
          <view class="input-group">
            <view class="input-label">é£è¡Œé«˜åº¦ï¼ˆè‹±å°ºï¼‰</view>
            <van-field
              value="{{ singlePoint.altitude }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š40000ï¼ˆå·¡èˆªé«˜åº¦ï¼‰"
              bind:change="onAltitudeChange"
            >
              <view slot="button" class="altitude-tips">
                <van-tag type="primary" size="small">å»ºè®®30000è‹±å°ºä»¥ä¸Š</van-tag>
              </view>
            </van-field>
          </view>

          <view class="input-group">
            <view class="input-label">æ—¥æœŸ</view>
            <view class="date-selector" bindtap="showDatePicker">
              <text>{{ singlePoint.date || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</text>
              <van-icon name="calendar-o" class="selector-icon" />
            </view>
          </view>
        </view>

        <!-- è®¡ç®—æŒ‰é’® -->
        <view class="action-section">
          <van-button type="primary" size="large" bind:click="calculateSinglePoint" block>
            ğŸš€ è®¡ç®—è¾å°„å‰‚é‡
          </van-button>
        </view>

        <!-- è®¡ç®—ç»“æœ -->
        <view wx:if="{{ singlePoint.result }}" class="result-card">
          <view class="result-header">
            <text class="result-title">ğŸ“Š è®¡ç®—ç»“æœ</text>
          </view>

          <view class="result-main">
            <view class="result-value-large">
              {{ singlePoint.result.doseRate }}
            </view>
            <view class="result-unit">Î¼Sv/h</view>
            <view class="result-label">ç¬æ—¶è¾å°„å‰‚é‡ç‡</view>
          </view>

          <view class="result-details">
            <view class="detail-item">
              <text class="detail-label">åœ°ç†ä½ç½®ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.latitude }}Â°, {{ singlePoint.result.longitude }}Â°</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">é£è¡Œé«˜åº¦ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.altitudeFeet }}è‹±å°º</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">è®¡ç®—æ—¥æœŸï¼š</text>
              <text class="detail-value">{{ singlePoint.result.date }}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">å¤ªé˜³è°ƒåˆ¶ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.solarModulation }} MV</text>
            </view>
            <view wx:if="{{ singlePoint.result.solarComparisons && singlePoint.result.solarComparisons.length }}" class="detail-subsection">
              <text class="detail-subtitle">â˜€ï¸ å¤ªé˜³è°ƒåˆ¶æ¢ç®—</text>
              <view
                wx:for="{{ singlePoint.result.solarComparisons }}"
                wx:key="year"
                class="comparison-item"
              >
                <text class="comparison-label">{{ item.label }}ï¼ˆ{{ item.year }}å¹´ï¼ŒÎ¦â‰ˆ{{ item.modulation }} MVï¼‰</text>
                <text class="comparison-value">{{ item.doseRate }} Î¼Sv/hï¼ˆ{{ item.deltaDirection }}{{ item.deltaAbsPercent }}%ï¼‰</text>
              </view>
              <view wx:if="{{ singlePoint.result.solarCycleNote }}" class="detail-note-text">
                {{ singlePoint.result.solarCycleNote }}
              </view>
            </view>
          </view>
        </view>

      </view>
    </van-tab>

    <!-- èˆªçº¿è®¡ç®—Tab -->
    <van-tab title="èˆªçº¿è®¡ç®—" name="route">
      <view class="tab-content">

        <!-- èµ·é£æœºåœº -->
        <view class="section-card">
          <view class="section-title">ğŸ›« èµ·é£æœºåœº</view>
          <view class="airport-selector" bindtap="showDepartureAirportPicker">
            <view class="selector-value">
              {{ route.departure ? route.departure.ShortName + ' (' + route.departure.ICAOCode + ')' : 'ç‚¹å‡»é€‰æ‹©èµ·é£æœºåœº' }}
            </view>
            <van-icon name="arrow" class="selector-icon" />
          </view>

          <view wx:if="{{ route.departure }}" class="airport-info-compact">
            <text>{{ route.departure.Latitude }}Â°, {{ route.departure.Longitude }}Â°</text>
          </view>
        </view>

        <!-- ç›®çš„åœ°æœºåœº -->
        <view class="section-card">
          <view class="section-title">ğŸ›¬ ç›®çš„åœ°æœºåœº</view>
          <view class="airport-selector" bindtap="showArrivalAirportPicker">
            <view class="selector-value">
              {{ route.arrival ? route.arrival.ShortName + ' (' + route.arrival.ICAOCode + ')' : 'ç‚¹å‡»é€‰æ‹©ç›®çš„åœ°æœºåœº' }}
            </view>
            <van-icon name="arrow" class="selector-icon" />
          </view>

          <view wx:if="{{ route.arrival }}" class="airport-info-compact">
            <text>{{ route.arrival.Latitude }}Â°, {{ route.arrival.Longitude }}Â°</text>
          </view>
        </view>

        <!-- å·¡èˆªé«˜åº¦å’Œæ—¥æœŸ -->
        <view class="section-card">
          <view class="input-group">
            <view class="input-label">å·¡èˆªé«˜åº¦ï¼ˆè‹±å°ºï¼‰</view>
            <van-field
              value="{{ route.cruiseAltitude }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š36000"
              bind:change="onCruiseAltitudeChange"
            />
          </view>

          <view class="input-group">
            <view class="input-label">é£è¡Œæ—¥æœŸ</view>
            <view class="date-selector" bindtap="showRouteDatePicker">
              <text>{{ route.date || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</text>
              <van-icon name="calendar-o" class="selector-icon" />
            </view>
          </view>
        </view>

        <!-- è®¡ç®—æŒ‰é’® -->
        <view class="action-section">
          <van-button type="primary" size="large" bind:click="calculateRoute" block>
            ğŸš€ è®¡ç®—èˆªçº¿è¾å°„
          </van-button>
        </view>

        <!-- èˆªçº¿è®¡ç®—ç»“æœ -->
        <view wx:if="{{ route.result }}" class="result-card">
          <view class="result-header">
            <text class="result-title">ğŸ“Š èˆªçº¿è¾å°„è®¡ç®—ç»“æœ</text>
          </view>

          <view class="result-main">
            <view class="result-value-large">
              {{ route.result.totalDose }}
            </view>
            <view class="result-unit">Î¼Sv</view>
            <view class="result-label">ç´¯è®¡è¾å°„å‰‚é‡</view>
          </view>

          <view class="result-details">
            <view class="detail-item">
              <text class="detail-label">å¹³å‡å‰‚é‡ç‡ï¼š</text>
              <text class="detail-value">{{ route.result.avgDoseRate }} Î¼Sv/h</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">èˆªçº¿è·ç¦»ï¼š</text>
              <text class="detail-value">{{ route.result.distance }} km</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">ä¼°ç®—é£è¡Œæ—¶é—´ï¼š</text>
              <text class="detail-value">{{ route.result.flightTime }} å°æ—¶</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">å·¡èˆªé«˜åº¦ï¼š</text>
              <text class="detail-value">{{ route.result.cruiseAltitudeFeet }}è‹±å°º</text>
            </view>
            <view wx:if="{{ route.result.solarComparisons && route.result.solarComparisons.length }}" class="detail-subsection">
              <text class="detail-subtitle">â˜€ï¸ å¤ªé˜³è°ƒåˆ¶æ¢ç®—</text>
              <view
                wx:for="{{ route.result.solarComparisons }}"
                wx:key="year"
                class="comparison-item"
              >
                <view class="comparison-label">{{ item.label }}ï¼ˆ{{ item.year }}å¹´ï¼ŒÎ¦â‰ˆ{{ item.modulation }} MVï¼‰</view>
                <view class="comparison-value">
                  <text>{{ item.totalDose }} Î¼Svï¼ˆ{{ item.deltaDirection }}{{ item.deltaAbsPercent }}%ï¼‰</text>
                  <text class="comparison-subvalue">å¯¹åº”å‰‚é‡ç‡ï¼š{{ item.doseRate }} Î¼Sv/h</text>
                </view>
              </view>
              <view wx:if="{{ route.result.solarCycleNote }}" class="detail-note-text">
                {{ route.result.solarCycleNote }}
              </view>
            </view>
            <view wx:if="{{ route.result.speedAssumption }}" class="detail-item detail-note">
              <text class="detail-label">âš ï¸ è¯´æ˜ï¼š</text>
              <text class="detail-value">{{ route.result.speedAssumption }}</text>
            </view>
          </view>
        </view>

      </view>
    </van-tab>
  </van-tabs>

  <!-- å…è´£å£°æ˜ -->
  <view class="disclaimer-card">
    <view class="disclaimer-title">âš ï¸ å…è´£å£°æ˜</view>
    <view class="disclaimer-content">
      æœ¬è®¡ç®—ç»“æœåŸºäºå…¬å¼€ç‰©ç†æ¨¡å‹å’ŒWMM2020æ•°æ®çš„ä¼°ç®—å€¼ï¼Œæ— æ³•æ›¿ä»£ä¸“ä¸šæœºè½½æµ‹é‡è®¾å¤‡ã€‚ä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºä¸“ä¸šåŒ»ç–—æˆ–é£è¡Œå†³ç­–ä¾æ®ã€‚
    </view>
  </view>

  <!-- æœºåœºé€‰æ‹©å¼¹çª— -->
  <van-popup
    show="{{ showAirportPopup }}"
    position="bottom"
    custom-style="height: 80%;"
    bind:close="closeAirportPicker"
    round
  >
    <view class="airport-picker">
      <view class="picker-header">
        <text class="picker-title">é€‰æ‹©æœºåœº</text>
        <van-icon name="cross" bind:tap="closeAirportPicker" />
      </view>

      <van-search
        value="{{ airportSearchKeyword }}"
        placeholder="æœç´¢æœºåœºåç§°æˆ–ICAOä»£ç "
        bind:change="onAirportSearch"
      />

      <view class="airport-list">
        <view
          wx:for="{{ filteredAirports }}"
          wx:key="ICAOCode"
          class="airport-item"
          bindtap="selectAirport"
          data-airport="{{ item }}"
        >
          <view class="airport-name">{{ item.ShortName }}</view>
          <view class="airport-code">{{ item.ICAOCode }} / {{ item.IATACode }}</view>
          <view class="airport-location">{{ item.Latitude }}Â°, {{ item.Longitude }}Â°</view>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showDatePopup }}"
    position="bottom"
    bind:close="closeDatePicker"
    round
  >
    <van-datetime-picker
      type="date"
      value="{{ currentDate }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="onDateConfirm"
      bind:cancel="closeDatePicker"
    />
  </van-popup>

</view>

<van-toast id="van-toast" />

<view class="radiation-container">
  <!-- Tabåˆ‡æ¢ -->
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" color="#667eea">
    <!-- å•ç‚¹è®¡ç®—Tab -->
    <van-tab title="å•ç‚¹è®¡ç®—" name="single">
      <view class="tab-content">

        <!-- å¿«æ·æœºåœºè¾“å…¥ -->
        <view class="section-card">
          <view class="section-title">ğŸ¢ å‘¨è¾¹æœºåœºå¿«æ·è¾“å…¥</view>
          <van-field
            value="{{ quickAirportInput }}"
            placeholder="è¾“å…¥ICAO/IATAä»£ç æˆ–ä¸­æ–‡å"
            clearable="{{ true }}"
            bind:change="onQuickAirportInput"
            bind:clear="onQuickAirportClear"
          />
          <view class="field-tip">æ”¯æŒç›´æ¥è¾“å…¥å››å­—ç ã€ä¸‰å­—ç æˆ–ä¸­æ–‡åç§°ï¼Œè‡ªåŠ¨åŒ¹é…ç»çº¬åº¦</view>

          <view wx:if="{{ quickAirportSuggestions.length }}" class="airport-suggestion-list">
            <view
              wx:for="{{ quickAirportSuggestions }}"
              wx:key="ICAOCode"
              class="airport-suggestion-item"
              bindtap="selectQuickAirport"
              data-airport="{{ item }}"
            >
              <view class="suggestion-main">
                <text class="suggestion-name">{{ item.ShortName || item.EnglishName }}</text>
                <text class="suggestion-code">{{ item.ICAOCode }}{{ item.IATACode ? ' / ' + item.IATACode : '' }}</text>
              </view>
              <view class="suggestion-location">{{ item.Latitude }}Â°, {{ item.Longitude }}Â°</view>
            </view>
          </view>

          <view wx:if="{{ selectedAirport }}" class="airport-info quick">
            <view class="info-item">
              <text class="info-label">æœºåœºï¼š</text>
              <text class="info-value">{{ selectedAirport.ShortName }} ({{ selectedAirport.ICAOCode }})</text>
            </view>
            <view class="info-item">
              <text class="info-label">åæ ‡ï¼š</text>
              <text class="info-value">{{ selectedAirport.Latitude }}Â°, {{ selectedAirport.Longitude }}Â°</text>
            </view>
          </view>
        </view>

        <!-- ç»çº¬åº¦è¾“å…¥ -->
        <view class="section-card">
          <view class="section-title">ğŸ“ æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦</view>
          <view class="input-group">
            <view class="input-label">çº¬åº¦(Â°)</view>
            <van-field
              value="{{ singlePoint.latitude }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š39.9ï¼ˆ-90 åˆ° 90ï¼‰"
              bind:change="onLatitudeChange"
            />
          </view>

          <view class="input-group">
            <view class="input-label">ç»åº¦(Â°)</view>
            <van-field
              value="{{ singlePoint.longitude }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š116.4ï¼ˆ-180 åˆ° 180ï¼‰"
              bind:change="onLongitudeChange"
            />
          </view>
        </view>

        <!-- é«˜åº¦å’Œæ—¥æœŸè¾“å…¥ -->
        <view class="section-card">
          <view class="input-group">
            <view class="input-label">é£è¡Œé«˜åº¦ï¼ˆè‹±å°ºï¼‰</view>
            <van-field
              value="{{ singlePoint.altitude }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š40000ï¼ˆå·¡èˆªé«˜åº¦ï¼‰"
              bind:change="onAltitudeChange"
            >
              <view slot="button" class="altitude-tips">
                <van-tag type="primary" size="small">å»ºè®®30000è‹±å°ºä»¥ä¸Š</van-tag>
              </view>
            </van-field>
          </view>

          <view class="input-group">
            <view class="input-label">é£è¡Œæ—¶é—´ï¼ˆå°æ—¶ï¼‰</view>
            <van-field
              value="{{ singlePoint.flightHours }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š1ï¼ˆé»˜è®¤1å°æ—¶ï¼‰"
              bind:change="onFlightHoursChange"
            />
          </view>

          <view class="input-group">
            <view class="input-label">æ—¥æœŸ</view>
            <view class="date-selector" bindtap="showDatePicker">
              <text>{{ singlePoint.date || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</text>
              <van-icon name="calendar-o" class="selector-icon" />
            </view>
          </view>
        </view>

        <!-- è®¡ç®—æŒ‰é’® -->
        <view class="action-section">
          <van-button type="primary" size="large" bind:click="calculateSinglePoint" block>
            ğŸš€ è®¡ç®—è¾å°„å‰‚é‡
          </van-button>
        </view>

        <!-- è®¡ç®—ç»“æœ -->
        <view wx:if="{{ singlePoint.result }}" class="result-card">
          <view class="result-header">
            <text class="result-title">ğŸ“Š è®¡ç®—ç»“æœ</text>
          </view>

          <view class="result-main">
            <view class="result-value-large">
              {{ singlePoint.result.totalDose }}
            </view>
            <view class="result-unit">Î¼Sv</view>
            <view class="result-label">ç´¯è®¡è¾å°„å‰‚é‡ï¼ˆå¾®è¥¿å¼—ï¼‰</view>
          </view>

          <view class="result-details">
            <view class="detail-item">
              <text class="detail-label">åœ°ç†ä½ç½®ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.latitude }}Â°, {{ singlePoint.result.longitude }}Â°</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">é£è¡Œé«˜åº¦ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.altitudeFeet }}è‹±å°º</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">é£è¡Œæ—¶é—´ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.flightHours }} å°æ—¶</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">å‰‚é‡ç‡ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.doseRate }} Î¼Sv/hï¼ˆå¾®è¥¿å¼—/å°æ—¶ï¼‰</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">ç´¯è®¡å‰‚é‡ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.totalDose }} Î¼Svï¼ˆå¾®è¥¿å¼—ï¼‰</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">è®¡ç®—æ—¥æœŸï¼š</text>
              <text class="detail-value">{{ singlePoint.result.date }}</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">å¤ªé˜³è°ƒåˆ¶ï¼š</text>
              <text class="detail-value">{{ singlePoint.result.solarModulation }} MV</text>
            </view>
            <view wx:if="{{ singlePoint.result.altitudeVariants && singlePoint.result.altitudeVariants.length }}" class="detail-subsection">
              <text class="detail-subtitle">ğŸ“ˆ é«˜åº¦å‰‚é‡å‚è€ƒ</text>
              <view
                wx:for="{{ singlePoint.result.altitudeVariants }}"
                wx:key="altitudeFeet"
                class="comparison-item"
              >
                <text class="comparison-label">{{ item.altitudeFeet }} ft</text>
                <text class="comparison-value">{{ item.doseRate }} Î¼Sv/h Â· {{ item.totalDose }} Î¼Sv</text>
              </view>
            </view>
            <view class="dose-limit-warning">
              <view class="warning-icon">âš ï¸</view>
              <view class="warning-content">
                <view class="warning-title">èŒä¸šå‰‚é‡é™åˆ¶ï¼š</view>
                <view class="warning-text">ä¾æ® ICRP 103ï¼š5å¹´å‘¨æœŸå¹³å‡æ¯å¹´â‰¤20 mSvï¼ˆæ¯«è¥¿å¼—ï¼Œçº¦20000 Î¼Sv/å¾®è¥¿å¼—ï¼‰ï¼Œä¸”ä»»ä¸€å¹´ä¸è¶…è¿‡50 mSvï¼ˆæ¯«è¥¿å¼—ï¼‰ã€‚</view>
              </view>
            </view>
            <view wx:if="{{ singlePoint.result.solarComparisons && singlePoint.result.solarComparisons.length }}" class="detail-subsection">
              <text class="detail-subtitle">â˜€ï¸ å¤ªé˜³è°ƒåˆ¶æ¢ç®—</text>
              <view
                wx:for="{{ singlePoint.result.solarComparisons }}"
                wx:key="year"
                class="comparison-item"
              >
                <text class="comparison-label">{{ item.label }}ï¼ˆ{{ item.year }}å¹´ï¼ŒÎ¦â‰ˆ{{ item.modulation }} MVï¼‰</text>
                <text class="comparison-value">{{ item.doseRate }} Î¼Sv/hï¼ˆ{{ item.deltaDirection }}{{ item.deltaAbsPercent }}%ï¼‰</text>
              </view>
            </view>
          </view>
        </view>

      </view>
    </van-tab>

    <!-- èˆªçº¿è®¡ç®—Tab -->
    <van-tab title="èˆªçº¿è®¡ç®—" name="route">
      <view class="tab-content">

        <!-- èµ·é£æœºåœº -->
        <view class="section-card">
          <view class="section-title">ğŸ›« èµ·é£æœºåœº</view>
          <van-field
            value="{{ routeDepartureInput }}"
            placeholder="è¾“å…¥ICAO/IATAæˆ–ä¸­æ–‡åç§°"
            clearable
            bind:change="onRouteDepartureInput"
            bind:clear="clearRouteDeparture"
          />
          <view wx:if="{{ route.departure }}" class="airport-info-compact">
            <text>{{ route.departure.Latitude.toFixed(4) }}Â°, {{ route.departure.Longitude.toFixed(4) }}Â°</text>
          </view>
        </view>

        <!-- ç›®çš„åœ°æœºåœº -->
        <view class="section-card">
          <view class="section-title">ğŸ›¬ ç›®çš„åœ°æœºåœº</view>
          <van-field
            value="{{ routeArrivalInput }}"
            placeholder="è¾“å…¥ICAO/IATAæˆ–ä¸­æ–‡åç§°"
            clearable
            bind:change="onRouteArrivalInput"
            bind:clear="clearRouteArrival"
          />
          <view wx:if="{{ route.arrival }}" class="airport-info-compact">
            <text>{{ route.arrival.Latitude.toFixed(4) }}Â°, {{ route.arrival.Longitude.toFixed(4) }}Â°</text>
          </view>
        </view>

        <!-- å·¡èˆªé«˜åº¦å’Œæ—¥æœŸ -->
        <view class="section-card">
          <view class="input-group">
            <view class="input-label">å·¡èˆªé«˜åº¦ï¼ˆè‹±å°ºï¼‰</view>
            <van-field
              value="{{ route.cruiseAltitude }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š36000"
              bind:change="onCruiseAltitudeChange"
            />
          </view>

          <view class="input-group">
            <view class="input-label">é£è¡Œæ—¶é—´ï¼ˆå°æ—¶ï¼‰</view>
            <van-field
              value="{{ route.flightHours }}"
              type="number"
              placeholder="ä¾‹å¦‚ï¼š5ï¼ˆè‡ªå®šä¹‰é£è¡Œæ—¶é•¿ï¼‰"
              bind:change="onRouteFlightHoursChange"
            />
          </view>

          <!-- æåœ°èˆªçº¿å¼€å…³ -->
          <view class="input-group">
            <view class="polar-route-section">
              <view class="polar-switch-row">
                <text class="polar-label">â„ï¸ æåœ°èˆªçº¿</text>
                <van-switch
                  checked="{{ route.isPolarRoute }}"
                  active-color="#667eea"
                  bind:change="onPolarRouteChange"
                />
              </view>
            </view>
          </view>

          <view class="input-group">
            <view class="input-label">é£è¡Œæ—¥æœŸ</view>
            <view class="date-selector" bindtap="showRouteDatePicker">
              <text>{{ route.date || 'è¯·é€‰æ‹©æ—¥æœŸ' }}</text>
              <van-icon name="calendar-o" class="selector-icon" />
            </view>
          </view>
        </view>

        <!-- è®¡ç®—æŒ‰é’® -->
        <view class="action-section">
          <van-button type="primary" size="large" bind:click="calculateRoute" block>
            ğŸš€ è®¡ç®—èˆªçº¿è¾å°„
          </van-button>
        </view>

        <!-- èˆªçº¿è®¡ç®—ç»“æœ -->
        <view wx:if="{{ route.result }}" class="result-card">
          <view class="result-header">
            <text class="result-title">ğŸ“Š èˆªçº¿è¾å°„è®¡ç®—ç»“æœ</text>
          </view>

          <view class="result-main">
            <view class="result-value-large">
              {{ route.result.totalDose }}
            </view>
            <view class="result-unit">Î¼Sv</view>
            <view class="result-label">ç´¯è®¡è¾å°„å‰‚é‡</view>
          </view>

          <view class="result-details">
            <view class="detail-item">
              <text class="detail-label">å¹³å‡å‰‚é‡ç‡ï¼š</text>
              <text class="detail-value">{{ route.result.avgDoseRate }} Î¼Sv/h</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">å¤ªé˜³è°ƒåˆ¶ï¼š</text>
              <text class="detail-value">{{ route.result.solarModulation }} MV</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">èˆªçº¿è·ç¦»ï¼š</text>
              <text class="detail-value">{{ route.result.distance }} km</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">é£è¡Œæ—¶é—´ï¼š</text>
              <text class="detail-value">{{ route.result.flightHours }} å°æ—¶</text>
            </view>
            <view class="detail-item">
              <text class="detail-label">å·¡èˆªé«˜åº¦ï¼š</text>
              <text class="detail-value">{{ route.result.cruiseAltitudeFeet }}è‹±å°º</text>
            </view>
            <view wx:if="{{ route.result.isPolarRoute }}" class="detail-item">
              <text class="detail-label">æåœ°èˆªçº¿å¢é‡ï¼š</text>
              <text class="detail-value">+{{ route.result.polarIncrement }} Î¼Svï¼ˆå¾®è¥¿å¼—ï¼‰</text>
            </view>
            <view wx:if="{{ route.result.altitudeVariants && route.result.altitudeVariants.length }}" class="detail-subsection">
              <text class="detail-subtitle">ğŸ“ˆ é«˜åº¦å‰‚é‡å‚è€ƒ</text>
              <view
                wx:for="{{ route.result.altitudeVariants }}"
                wx:key="altitudeFeet"
                class="comparison-item"
              >
                <text class="comparison-label">{{ item.altitudeFeet }} ft</text>
                <text class="comparison-value">{{ item.doseRate }} Î¼Sv/h Â· {{ item.totalDose }} Î¼Sv</text>
              </view>
            </view>
            <view class="dose-limit-warning">
              <view class="warning-icon">âš ï¸</view>
              <view class="warning-content">
                <view class="warning-title">èŒä¸šå‰‚é‡é™åˆ¶ï¼š</view>
                <view class="warning-text">ä¾æ® ICRP 103ï¼š5å¹´å‘¨æœŸå¹³å‡æ¯å¹´â‰¤20 mSvï¼ˆæ¯«è¥¿å¼—ï¼Œçº¦20000 Î¼Sv/å¾®è¥¿å¼—ï¼‰ï¼Œä¸”ä»»ä¸€å¹´ä¸è¶…è¿‡50 mSvï¼ˆæ¯«è¥¿å¼—ï¼‰ã€‚</view>
              </view>
            </view>
            <view wx:if="{{ route.result.solarComparisons && route.result.solarComparisons.length }}" class="detail-subsection">
              <text class="detail-subtitle">â˜€ï¸ å¤ªé˜³è°ƒåˆ¶æ¢ç®—</text>
              <view
                wx:for="{{ route.result.solarComparisons }}"
                wx:key="year"
                class="comparison-item"
              >
                <view class="comparison-label">{{ item.label }}ï¼ˆ{{ item.year }}å¹´ï¼ŒÎ¦â‰ˆ{{ item.modulation }} MVï¼‰</view>
                <view class="comparison-value">
                  <text>{{ item.totalDose }} Î¼Svï¼ˆ{{ item.deltaDirection }}{{ item.deltaAbsPercent }}%ï¼‰</text>
                  <text class="comparison-subvalue">å¯¹åº”å‰‚é‡ç‡ï¼š{{ item.doseRate }} Î¼Sv/h</text>
                </view>
              </view>
            </view>
          </view>
        </view>

      </view>
    </van-tab>
  </van-tabs>

  <!-- å…è´£å£°æ˜ -->
  <view class="disclaimer-card">
    <view class="disclaimer-title">âš ï¸ å…è´£å£°æ˜</view>
    <view class="disclaimer-content">
      æœ¬è®¡ç®—ç»“æœåŸºäºå…¬å¼€ç‰©ç†æ¨¡å‹å’ŒWMM2020æ•°æ®çš„ä¼°ç®—å€¼ï¼Œæ— æ³•æ›¿ä»£ä¸“ä¸šæœºè½½æµ‹é‡è®¾å¤‡ã€‚ä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºä¸“ä¸šåŒ»ç–—æˆ–é£è¡Œå†³ç­–ä¾æ®ã€‚
    </view>
  </view>

  <!-- æ—¥æœŸé€‰æ‹©å™¨ -->
  <van-popup
    show="{{ showDatePopup }}"
    position="bottom"
    bind:close="closeDatePicker"
    round
  >
    <van-datetime-picker
      type="date"
      value="{{ currentDate }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="onDateConfirm"
      bind:cancel="closeDatePicker"
    />
  </van-popup>

</view>

<van-toast id="van-toast" />

<view class="history-container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-content">
      <text class="page-title">å†å²è®°å½•</text>
      <text class="page-subtitle">Event Report History</text>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-section">
    <van-search 
      value="{{ searchValue }}"
      placeholder="æœç´¢èˆªç­å·ã€èˆªçº¿ã€äº‹ä»¶æè¿°..."
      bind:search="onSearch"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      show-action="{{ false }}"
    />
  </view>

  <!-- æ“ä½œæ  -->
  <view class="toolbar" wx:if="{{ historyList.length > 0 }}">
    <view class="toolbar-info">
      <text class="total-count">å…± {{ historyList.length }} æ¡è®°å½•</text>
      <text class="filtered-count" wx:if="{{ searchValue }}">
        æ˜¾ç¤º {{ filteredList.length }} æ¡
      </text>
    </view>
    <van-button 
      type="danger" 
      size="mini" 
      bind:click="clearAllHistory"
    >
      æ¸…ç©ºè®°å½•
    </van-button>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{ loading }}" class="loading-section">
    <van-loading size="24px" vertical>åŠ è½½ä¸­...</van-loading>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view wx:elif="{{ filteredList.length > 0 }}" class="history-list">
    <view 
      class="history-item" 
      wx:for="{{ filteredList }}" 
      wx:key="id"
      bind:tap="viewDetail"
      data-index="{{ index }}"
    >
      <view class="item-header">
        <view class="flight-info">
          <text class="flight-number">{{ item.flightNumber }}</text>
          <text class="route">{{ item.route }}</text>
        </view>
        <view class="submit-time">{{ item.submitTimeFormatted }}</view>
      </view>
      
      <view class="item-content">
        <view class="aircraft-info">
          <text class="aircraft-type">{{ item.aircraftType }}/{{ item.aircraftReg }}</text>
          <text class="department">{{ item.department }}</text>
        </view>
        
        <view class="event-info">
          <text class="location">{{ item.location }}</text>
          <text class="phase">{{ item.flightPhase }}</text>
        </view>
        
        <view class="event-description">
          {{ item.eventDescriptionShort }}
        </view>
      </view>
      
      <view class="item-footer">
        <van-tag type="primary" size="mini">{{ item.date }}</van-tag>
        <van-tag type="success" size="mini">å·²æäº¤</van-tag>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view wx:else class="empty-state">
    <view class="empty-icon">ğŸ“‹</view>
    <view class="empty-title" wx:if="{{ searchValue }}">æœªæ‰¾åˆ°ç›¸å…³è®°å½•</view>
    <view class="empty-title" wx:else>æš‚æ— å†å²è®°å½•</view>
    <view class="empty-subtitle" wx:if="{{ searchValue }}">è¯·å°è¯•å…¶ä»–å…³é”®è¯</view>
    <view class="empty-subtitle" wx:else>æäº¤çš„äº‹ä»¶æŠ¥å‘Šå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <van-popup
    show="{{ showDetailModal }}"
    position="bottom"
    bind:close="closeDetailModal"
    round="{{ true }}"
    safe-area-inset-bottom="{{ true }}"
    custom-style="height: 85vh;"
  >
    <view class="detail-modal" wx:if="{{ selectedReport }}">
      <view class="modal-header">
        <text class="modal-title">æŠ¥å‘Šè¯¦æƒ…</text>
        <view class="modal-subtitle">
          <text>{{ selectedReport.flightNumber }} â€¢ {{ selectedReport.route }}</text>
        </view>
      </view>
      
      <scroll-view class="modal-content" scroll-y>
        <view class="detail-section">
          <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
          <view class="detail-row">
            <text class="label">æ—¥æœŸï¼š</text>
            <text class="value">{{ selectedReport.date }}</text>
          </view>
          <view class="detail-row">
            <text class="label">åˆ†éƒ¨ï¼š</text>
            <text class="value">{{ selectedReport.department }}</text>
          </view>
          <view class="detail-row">
            <text class="label">æœºå‹ï¼š</text>
            <text class="value">{{ selectedReport.aircraftType }}/{{ selectedReport.aircraftReg }}</text>
          </view>
          <view class="detail-row">
            <text class="label">èˆªç­ï¼š</text>
            <text class="value">{{ selectedReport.flightNumber }}ï¼ˆ{{ selectedReport.route }}ï¼‰</text>
          </view>
        </view>

        <view class="detail-section">
          <view class="section-title">æ—¶é—´ä¿¡æ¯</view>
          <view class="detail-row">
            <text class="label">èµ·é£ï¼š</text>
            <text class="value">{{ selectedReport.takeoffTime }}</text>
          </view>
          <view class="detail-row">
            <text class="label">ç€é™†ï¼š</text>
            <text class="value">{{ selectedReport.landingTime }}</text>
          </view>
          <view class="detail-row">
            <text class="label">äº‹å‘ï¼š</text>
            <text class="value">{{ selectedReport.eventTime }}</text>
          </view>
        </view>

        <view class="detail-section">
          <view class="section-title">æœºç»„ä¿¡æ¯</view>
          <view class="detail-row">
            <text class="label">æœºé•¿ï¼š</text>
            <text class="value">{{ selectedReport.captain }}</text>
          </view>
          <view class="detail-row" wx:if="{{ selectedReport.firstOfficer }}">
            <text class="label">å‰¯é©¾é©¶ï¼š</text>
            <text class="value">{{ selectedReport.firstOfficer }}</text>
          </view>
          <view class="detail-row" wx:if="{{ selectedReport.observer }}">
            <text class="label">è§‚å¯Ÿå‘˜ï¼š</text>
            <text class="value">{{ selectedReport.observer }}</text>
          </view>
        </view>

        <view class="detail-section">
          <view class="section-title">äº‹å‘æƒ…å†µ</view>
          <view class="detail-row">
            <text class="label">åœ°ç‚¹ï¼š</text>
            <text class="value">{{ selectedReport.location }}</text>
          </view>
          <view class="detail-row" wx:if="{{ selectedReport.area }}">
            <text class="label">åŒºåŸŸï¼š</text>
            <text class="value">{{ selectedReport.area }}</text>
          </view>
          <view class="detail-row">
            <text class="label">é˜¶æ®µï¼š</text>
            <text class="value">{{ selectedReport.flightPhase }}</text>
          </view>
          <view class="detail-row" wx:if="{{ selectedReport.weather }}">
            <text class="label">å¤©æ°”ï¼š</text>
            <text class="value">{{ selectedReport.weather }}</text>
          </view>
        </view>

        <view class="detail-section">
          <view class="section-title">äº‹ä»¶ç»è¿‡</view>
          <view class="detail-content">{{ selectedReport.eventDescription }}</view>
        </view>

        <view class="detail-section" wx:if="{{ selectedReport.personnelFactor }}">
          <view class="section-title">äººå‘˜å› ç´ </view>
          <view class="detail-content">{{ selectedReport.personnelFactor }}</view>
        </view>

        <view class="detail-section" wx:if="{{ selectedReport.equipmentFactor }}">
          <view class="section-title">è®¾å¤‡å› ç´ </view>
          <view class="detail-content">{{ selectedReport.equipmentFactor }}</view>
        </view>

        <view class="detail-section" wx:if="{{ selectedReport.weatherFactor }}">
          <view class="section-title">å¤©æ°”å› ç´ </view>
          <view class="detail-content">{{ selectedReport.weatherFactor }}</view>
        </view>

        <view class="detail-section" wx:if="{{ selectedReport.otherInfo }}">
          <view class="section-title">å…¶ä»–ä¿¡æ¯</view>
          <view class="detail-content">{{ selectedReport.otherInfo }}</view>
        </view>

        <view class="detail-section">
          <view class="section-title">æäº¤ä¿¡æ¯</view>
          <view class="detail-row">
            <text class="label">æäº¤æ—¶é—´ï¼š</text>
            <text class="value">{{ selectedReport.submitTime }}</text>
          </view>
        </view>
      </scroll-view>
      
      <view class="modal-footer">
        <van-button 
          type="default" 
          bind:click="copyReport"
          custom-style="margin-right: 10px; flex: 1;"
        >
          å¤åˆ¶æŠ¥å‘Š
        </van-button>
        <van-button 
          type="danger" 
          bind:click="deleteReport"
          custom-style="flex: 1;"
        >
          åˆ é™¤è®°å½•
        </van-button>
      </view>
    </view>
  </van-popup>
</view>
<view class="container" data-theme="{{ isDarkMode ? 'dark' : 'light' }}">
  <!-- 页面标题 -->
  <view class="page-header">
    <view class="header-title">✈️ 飞行速算工具</view>
    <view class="header-subtitle">专业飞行计算，精确可靠</view>
  </view>

  <!-- 广告位 -->
  <view wx:if="{{ showAd && !userPreferences.reduceAds }}" class="calculator-ad-container">
    <ad-template 
      unit-id="{{ adUnitId }}"
      ad-type="custom"
      context="calculator"
      bind:adload="onAdLoad"
      bind:aderror="onAdError"
    />
  </view>

  <!-- 功能模块选择 -->
  <view wx:if="{{ !selectedModule }}" class="modules-grid">
    <view class="module-card" bind:tap="selectModule" data-module="descent">
      <view class="module-icon">📉</view>
      <view class="module-title">下降率计算</view>
      <view class="module-desc">计算飞行下降率、角度和时间</view>
    </view>

    <view class="module-card" bind:tap="selectModule" data-module="crosswind">
      <view class="module-icon">🧭</view>
      <view class="module-title">侧风分量</view>
      <view class="module-desc">计算侧风、顶风分量和偏流角</view>
    </view>

    <view class="module-card" bind:tap="selectModule" data-module="turn">
      <view class="module-icon">🔄</view>
      <view class="module-title">转弯半径</view>
      <view class="module-desc">计算转弯半径和转弯率</view>
    </view>

    <view class="module-card" bind:tap="selectModule" data-module="glideslope">
      <view class="module-icon">📐</view>
      <view class="module-title">下滑线高度</view>
      <view class="module-desc">计算ILS下滑线高度</view>
    </view>

    <view class="module-card" bind:tap="selectModule" data-module="detour">
      <view class="module-icon">🛣️</view>
      <view class="module-title">绕飞耗油</view>
      <view class="module-desc">计算绕飞距离和燃油消耗</view>
    </view>
  </view>

  <!-- 下降率计算模块 -->
  <view wx:if="{{ selectedModule === 'descent' }}" class="calculation-module">
    <view class="module-header">
      <view class="back-btn" bind:tap="backToModules">← 返回</view>
      <view class="module-title">📉 下降率计算</view>
    </view>

    <view class="input-section">
      <view class="input-group">
        <view class="input-label">📏 当前高度</view>
        <van-field
          value="{{ currentAltitude }}"
          placeholder="请输入当前高度"
          type="digit"
          bind:change="onCurrentAltitudeChange"
        >
          <view slot="right-icon" class="unit-label">英尺</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">🎯 目标高度</view>
        <van-field
          value="{{ targetAltitude }}"
          placeholder="请输入目标高度"
          type="digit"
          bind:change="onTargetAltitudeChange"
        >
          <view slot="right-icon" class="unit-label">英尺</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">📍 相距距离</view>
        <van-field
          value="{{ distanceNM }}"
          placeholder="请输入距离"
          type="digit"
          bind:change="onDistanceNMChange"
        >
          <view slot="right-icon" class="unit-label">海里</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">⚡ 当前地速</view>
        <van-field
          value="{{ currentGroundSpeed }}"
          placeholder="请输入地速"
          type="digit"
          bind:change="onCurrentGroundSpeedChange"
        >
          <view slot="right-icon" class="unit-label">节</view>
        </van-field>
      </view>
    </view>

    <view class="action-buttons">
      <van-button type="primary" bind:click="calculateDescentRate" block>
        🚀 计算下降率
      </van-button>
      <van-button type="default" bind:click="clearDescentRate" block>
        🗑️ 清空数据
      </van-button>
    </view>

    <view wx:if="{{ descentRate }}" class="result-section">
      <view class="result-title">📊 计算结果</view>
      <view class="result-grid">
        <view class="result-item">
          <view class="result-label">所需下降率</view>
          <view class="result-value">{{ descentRate }} 英尺/分钟</view>
        </view>
        <view class="result-item">
          <view class="result-label">下降角度</view>
          <view class="result-value">{{ descentAngle }}°</view>
        </view>
        <view class="result-item">
          <view class="result-label">下降时间</view>
          <view class="result-value">{{ timeToDescend }} 分钟</view>
        </view>
        <view class="result-item">
          <view class="result-label">下降梯度</view>
          <view class="result-value">{{ descentGradient }}%</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 侧风分量计算模块 -->
  <view wx:if="{{ selectedModule === 'crosswind' }}" class="calculation-module">
    <view class="module-header">
      <view class="back-btn" bind:tap="backToModules">← 返回</view>
      <view class="module-title">🧭 侧风分量计算</view>
    </view>

    <view class="input-section">
      <view class="input-group">
        <view class="input-label">✈️ 真空速 (TAS)</view>
        <van-field
          value="{{ crosswindTrueAirspeed }}"
          placeholder="请输入真空速"
          type="digit"
          bind:change="onCrosswindTrueAirspeedChange"
        >
          <view slot="right-icon" class="unit-label">节</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">🧭 航向</view>
        <van-field
          value="{{ crosswindHeading }}"
          placeholder="请输入航向"
          type="digit"
          bind:change="onCrosswindHeadingChange"
        >
          <view slot="right-icon" class="unit-label">度</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">🌪️ 风向</view>
        <van-field
          value="{{ crosswindDirection }}"
          placeholder="请输入风向"
          type="digit"
          bind:change="onCrosswindDirectionChange"
        >
          <view slot="right-icon" class="unit-label">度</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">💨 风速</view>
        <van-field
          value="{{ crosswindSpeed }}"
          placeholder="请输入风速"
          type="digit"
          bind:change="onCrosswindSpeedChange"
        >
          <view slot="right-icon" class="unit-label">节</view>
        </van-field>
      </view>
    </view>

    <view class="action-buttons">
      <van-button type="primary" bind:click="calculateCrosswind" block>
        🚀 计算侧风分量
      </van-button>
      <van-button type="default" bind:click="clearCrosswind" block>
        🗑️ 清空数据
      </van-button>
    </view>

    <view wx:if="{{ crosswindComponent }}" class="result-section">
      <view class="result-title">📊 计算结果</view>
      <view class="result-grid">
        <view class="result-item">
          <view class="result-label">侧风分量</view>
          <view class="result-value">{{ crosswindDisplayText }}</view>
        </view>
        <view class="result-item">
          <view class="result-label">顶风分量</view>
          <view class="result-value">{{ headwindDisplayText }}</view>
        </view>
        <view class="result-item">
          <view class="result-label">偏流角</view>
          <view class="result-value">{{ driftAngle }}°</view>
        </view>
        <view class="result-item">
          <view class="result-label">地速</view>
          <view class="result-value">{{ groundSpeed }} 节</view>
        </view>
        <view class="result-item">
          <view class="result-label">航迹</view>
          <view class="result-value">{{ track }}°</view>
        </view>
      </view>

      <!-- 风向罗盘 -->
      <view class="compass-section">
        <view class="compass-title">🧭 风向罗盘</view>
        <view class="compass-container">
          <view class="compass-needle wind-needle" style="transform: rotate({{ windAngle }}deg);"></view>
          <view class="compass-needle heading-needle" style="transform: rotate({{ headingAngle }}deg);"></view>
          <view class="compass-needle track-needle" style="transform: rotate({{ trackAngle }}deg);"></view>
          <view class="compass-degrees north">{{ compassNorth }}</view>
          <view class="compass-degrees east">{{ compassEast }}</view>
          <view class="compass-degrees south">{{ compassSouth }}</view>
          <view class="compass-degrees west">{{ compassWest }}</view>
          <view class="compass-center"></view>
        </view>
        <view class="compass-legend">
          <view class="legend-item">
            <view class="legend-color wind-color"></view>
            <text>风向</text>
          </view>
          <view class="legend-item">
            <view class="legend-color heading-color"></view>
            <text>航向</text>
          </view>
          <view class="legend-item">
            <view class="legend-color track-color"></view>
            <text>航迹</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 转弯半径计算模块 -->
  <view wx:if="{{ selectedModule === 'turn' }}" class="calculation-module">
    <view class="module-header">
      <view class="back-btn" bind:tap="backToModules">← 返回</view>
      <view class="module-title">🔄 转弯半径计算</view>
    </view>

    <view class="input-section">
      <view class="input-group">
        <view class="input-label">📐 坡度角</view>
        <van-field
          value="{{ turnBankAngle }}"
          placeholder="请输入坡度角"
          type="digit"
          bind:change="onTurnBankAngleChange"
        >
          <view slot="right-icon" class="unit-label">度</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">⚡ 地速</view>
        <van-field
          value="{{ turnGroundSpeed }}"
          placeholder="请输入地速"
          type="digit"
          bind:change="onTurnGroundSpeedChange"
        >
          <view slot="right-icon" class="unit-label">节</view>
        </van-field>
      </view>
    </view>

    <view class="action-buttons">
      <van-button type="primary" bind:click="calculateTurnRadius" block>
        🚀 计算转弯半径
      </van-button>
      <van-button type="default" bind:click="clearTurn" block>
        🗑️ 清空数据
      </van-button>
    </view>

    <view wx:if="{{ turnRadiusMeters }}" class="result-section">
      <view class="result-title">📊 计算结果</view>
      <view class="result-grid">
        <view class="result-item">
          <view class="result-label">转弯半径(米)</view>
          <view class="result-value">{{ turnRadiusMeters }} 米</view>
        </view>
        <view class="result-item">
          <view class="result-label">转弯半径(英尺)</view>
          <view class="result-value">{{ turnRadiusFeet }} 英尺</view>
        </view>
        <view class="result-item">
          <view class="result-label">转弯半径(海里)</view>
          <view class="result-value">{{ turnRadiusNauticalMiles }} 海里</view>
        </view>
        <view class="result-item">
          <view class="result-label">转弯率</view>
          <view class="result-value">{{ turnRate }} 度/秒</view>
        </view>
        <view class="result-item">
          <view class="result-label">360°转弯时间</view>
          <view class="result-value">{{ turnTime360 }} 秒</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 下滑线高度计算模块 -->
  <view wx:if="{{ selectedModule === 'glideslope' }}" class="calculation-module">
    <view class="module-header">
      <view class="back-btn" bind:tap="backToModules">← 返回</view>
      <view class="module-title">📐 下滑线高度计算</view>
    </view>

    <view class="input-section">
      <view class="input-group">
        <view class="input-label">📐 下滑角</view>
        <van-field
          value="{{ glideslopeAngle }}"
          placeholder="请输入下滑角"
          type="digit"
          bind:change="onGlideslopeAngleChange"
        >
          <view slot="right-icon" class="unit-label">度</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">📍 距离跑道头</view>
        <van-field
          value="{{ distanceFromThreshold }}"
          placeholder="请输入距离"
          type="digit"
          bind:change="onDistanceFromThresholdChange"
        >
          <view slot="right-icon" class="unit-label">海里</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">🏔️ 机场标高</view>
        <van-field
          value="{{ airportElevation }}"
          placeholder="请输入机场标高"
          type="digit"
          bind:change="onAirportElevationChange"
        >
          <view slot="right-icon" class="unit-label">英尺</view>
        </van-field>
      </view>
    </view>

    <view class="action-buttons">
      <van-button type="primary" bind:click="calculateGlideslope" block>
        🚀 计算下滑线高度
      </van-button>
      <van-button type="default" bind:click="clearGlideslope" block>
        🗑️ 清空数据
      </van-button>
    </view>

    <view wx:if="{{ glideslopeAltitude }}" class="result-section">
      <view class="result-title">📊 计算结果</view>
      <view class="result-grid">
        <view class="result-item">
          <view class="result-label">相对高度(AGL)</view>
          <view class="result-value">{{ glideslopeAltitude }} 英尺</view>
        </view>
        <view class="result-item">
          <view class="result-label">绝对高度(QNH)</view>
          <view class="result-value">{{ glideslopeAbsoluteAltitude }} 英尺</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 绕飞耗油计算模块 -->
  <view wx:if="{{ selectedModule === 'detour' }}" class="calculation-module">
    <view class="module-header">
      <view class="back-btn" bind:tap="backToModules">← 返回</view>
      <view class="module-title">🛣️ 绕飞耗油计算</view>
    </view>

    <view class="input-section">
      <view class="input-group">
        <view class="input-label">📍 申请偏离距离</view>
        <van-field
          value="{{ detourDistance }}"
          placeholder="请输入偏离距离"
          type="digit"
          bind:change="onDetourDistanceChange"
        >
          <view slot="right-icon" class="unit-label">海里</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">⚡ 地速</view>
        <van-field
          value="{{ detourGroundSpeed }}"
          placeholder="请输入地速"
          type="digit"
          bind:change="onDetourGroundSpeedChange"
        >
          <view slot="right-icon" class="unit-label">节</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">⛽ 油耗</view>
        <van-field
          value="{{ detourFuelConsumption }}"
          placeholder="请输入油耗"
          type="digit"
          bind:change="onDetourFuelConsumptionChange"
        >
          <view slot="right-icon" class="unit-label">KG/H</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">📐 偏航角度</view>
        <van-field
          value="{{ detourDepartureAngle }}"
          placeholder="请输入偏航角度"
          type="digit"
          bind:change="onDetourDepartureAngleChange"
        >
          <view slot="right-icon" class="unit-label">度</view>
        </van-field>
      </view>

      <view class="input-group">
        <view class="input-label">📐 返回角度</view>
        <van-field
          value="{{ detourReturnAngle }}"
          placeholder="请输入返回角度"
          type="digit"
          bind:change="onDetourReturnAngleChange"
        >
          <view slot="right-icon" class="unit-label">度</view>
        </van-field>
      </view>
    </view>

    <view class="action-buttons">
      <van-button type="primary" bind:click="calculateDetourFuel" block>
        🚀 计算绕飞耗油
      </van-button>
      <van-button type="default" bind:click="clearDetourFuel" block>
        🗑️ 清空数据
      </van-button>
    </view>

    <view wx:if="{{ detourFuelResult }}" class="result-section">
      <view class="result-title">📊 计算结果</view>
      <view class="result-grid">
        <view class="result-item">
          <view class="result-label">额外燃油消耗</view>
          <view class="result-value">{{ detourFuelResult }}</view>
        </view>
        <view class="result-item">
          <view class="result-label">额外飞行时间</view>
          <view class="result-value">{{ detourTimeResult }}</view>
        </view>
        <view class="result-item">
          <view class="result-label">实际多飞距离</view>
          <view class="result-value">{{ detourActualDistance }} 海里</view>
        </view>
        <view class="result-item">
          <view class="result-label">偏航段距离</view>
          <view class="result-value">{{ detourDepartureSegment }} 海里</view>
        </view>
        <view class="result-item">
          <view class="result-label">返回段距离</view>
          <view class="result-value">{{ detourReturnSegment }} 海里</view>
        </view>
        <view class="result-item">
          <view class="result-label">原直线距离</view>
          <view class="result-value">{{ detourDirectDistance }} 海里</view>
        </view>
      </view>

      <view wx:if="{{ detourCalculationDetails }}" class="calculation-details">
        <view class="details-title">📋 计算详情</view>
        <view class="details-content">{{ detourCalculationDetails }}</view>
      </view>
    </view>
  </view>
</view>
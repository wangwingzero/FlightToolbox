<view class="container" data-theme="{{ isDarkMode ? 'dark' : 'light' }}">
  <!-- å¤´éƒ¨çŠ¶æ€å¡ç‰‡ -->
  <view class="todo-status-card">
    <view class="status-header">
      <view class="todo-avatar">
        <text class="emoji-icon">ğŸ“‹</text>
        <view class="avatar-ring"></view>
      </view>
      <view class="todo-info">
        <view class="todo-title">å¾…åŠæ¸…å•</view>
        <view class="todo-subtitle">{{ stats.total }}é¡¹ä»»åŠ¡ï¼Œ{{ stats.pending }}é¡¹å¾…å®Œæˆ</view>
      </view>
      <view class="status-display" bind:tap="showStats">
        <view class="status-value">{{ stats.pending }}</view>
        <view class="status-unit">å¾…åŠ</view>
        <view class="status-ring"></view>
      </view>
    </view>
    
    <!-- å¿«é€Ÿæ“ä½œåŒº -->
    <view class="quick-actions">
      <view class="action-item" bind:tap="showAddTodo">
        <view class="action-icon">
          <text class="emoji-icon">â•</text>
        </view>
        <view class="action-content">
          <text class="action-text">æ–°å¢å¾…åŠ</text>
        </view>
        <view class="action-ripple"></view>
      </view>
      
      <view class="action-item" bind:tap="toggleSearch">
        <view class="action-icon">
          <text class="emoji-icon">ğŸ”</text>
        </view>
        <view class="action-content">
          <text class="action-text">æœç´¢</text>
        </view>
        <view class="action-ripple"></view>
      </view>
      
      <view class="action-item" bind:tap="toggleSelectionMode" wx:if="{{ todos.length > 0 }}">
        <view class="action-icon">
          <text class="emoji-icon">{{ selectionMode ? 'âŒ' : 'â˜‘ï¸' }}</text>
        </view>
        <view class="action-content">
          <text class="action-text">{{ selectionMode ? 'å–æ¶ˆé€‰æ‹©' : 'æ‰¹é‡æ“ä½œ' }}</text>
        </view>
        <view class="action-ripple"></view>
      </view>
    </view>
    
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <view class="status-stats" wx:if="{{ stats.total > 0 }}">
      <view class="stat-item today" wx:if="{{ stats.dueToday > 0 }}">
        <text class="emoji-icon">ğŸ“…</text>
        <text class="stat-text">{{ stats.dueToday }}é¡¹ä»Šæ—¥åˆ°æœŸ</text>
      </view>
      <view class="stat-item overdue" wx:if="{{ stats.overdue > 0 }}">
        <text class="emoji-icon">âš ï¸</text>
        <text class="stat-text">{{ stats.overdue }}é¡¹å·²è¿‡æœŸ</text>
      </view>
      <view class="stat-item completed" wx:if="{{ stats.completed > 0 }}">
        <text class="emoji-icon">âœ…</text>
        <text class="stat-text">{{ stats.completed }}é¡¹å·²å®Œæˆ</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-container" wx:if="{{ showSearch }}">
    <van-search
      value="{{ searchText }}"
      placeholder="æœç´¢å¾…åŠäº‹é¡¹..."
      bind:change="onSearchInput"
      bind:clear="onSearchInput"
      shape="round"
    />
  </view>

  <!-- ç­›é€‰å’Œæ’åº - å§‹ç»ˆæ˜¾ç¤ºï¼Œä¸å†ä¾èµ–todos.length -->
  <view class="filter-container">
    <scroll-view class="filter-scroll" scroll-x="{{ true }}" show-scrollbar="{{ false }}">
      <view class="filter-items">
        <view 
          wx:for="{{ filters }}" 
          wx:key="value"
          class="filter-item {{ currentFilter === item.value ? 'active' : '' }}"
          data-filter="{{ item.value }}"
          bind:tap="switchFilter"
        >
          <text class="emoji-icon small">{{ item.icon }}</text>
          <text class="filter-text">{{ item.label }}</text>
        </view>
      </view>
    </scroll-view>
    
    <view class="sort-container">
      <text class="sort-label">æ’åºï¼š</text>
      <text 
        class="sort-option {{ sortBy === 'dueDate' ? 'active' : '' }}"
        data-sort="dueDate"
        bind:tap="switchSort"
      >æ—¶é—´</text>
      <text 
        class="sort-option {{ sortBy === 'priority' ? 'active' : '' }}"
        data-sort="priority"
        bind:tap="switchSort"
      >ä¼˜å…ˆçº§</text>
    </view>
  </view>

  <!-- æ‰¹é‡æ“ä½œæ  -->
  <view class="batch-actions" wx:if="{{ selectionMode && selectedTodos.length > 0 }}">
    <view class="batch-info">å·²é€‰æ‹© {{ selectedTodos.length }} é¡¹</view>
    <view class="batch-buttons">
      <view class="batch-btn complete" bind:tap="batchComplete">
        <text class="emoji-icon small">âœ…</text>
        <text>å®Œæˆ</text>
      </view>
      <view class="batch-btn delete" bind:tap="batchDelete">
        <text class="emoji-icon small">ğŸ—‘ï¸</text>
        <text>åˆ é™¤</text>
      </view>
    </view>
  </view>

  <!-- å¾…åŠåˆ—è¡¨ -->
  <view class="todo-list" wx:if="{{ todos.length > 0 }}">
    <view 
      wx:for="{{ todos }}" 
      wx:key="id"
      class="todo-item {{ item.completed ? 'completed' : '' }} {{ item.priority }}"
      data-id="{{ item.id }}"
    >
      <!-- é€‰æ‹©æ¡†ï¼ˆæ‰¹é‡æ¨¡å¼ï¼‰ -->
      <view 
        class="todo-checkbox" 
        wx:if="{{ selectionMode }}"
        data-id="{{ item.id }}"
        bind:tap="toggleTodoSelection"
      >
        <text class="emoji-icon small">{{ selectedTodos.includes(item.id) ? 'â˜‘ï¸' : 'â¬œ' }}</text>
      </view>
      
      <!-- å®ŒæˆçŠ¶æ€åˆ‡æ¢ -->
      <view 
        class="todo-complete-btn"
        wx:if="{{ !selectionMode }}"
        data-id="{{ item.id }}"
        bind:tap="toggleComplete"
      >
        <text class="emoji-icon small">{{ item.completed ? 'âœ…' : 'â­•' }}</text>
      </view>
      
      <!-- å¾…åŠå†…å®¹ -->
      <view class="todo-content" data-id="{{ item.id }}" bind:tap="showEditTodo">
        <view class="todo-header">
          <view class="todo-title-row">
            <text class="todo-title">{{ item.title }}</text>
            <view class="priority-indicator priority-{{ item.priority }}">
              <text class="emoji-icon small">{{ item.priority === 'high' ? 'ğŸ”´' : item.priority === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢' }}</text>
            </view>
          </view>
          
          <view class="todo-meta">
            <text class="todo-category" wx:if="{{ item.category }}">{{ item.category }}</text>
            <text class="todo-due-date" wx:if="{{ item.dueDate }}">
              {{ formatDate(item.dueDate) }}
              <text class="todo-due-time" wx:if="{{ formatTime(item.dueDate) }}">{{ formatTime(item.dueDate) }}</text>
            </text>
          </view>
        </view>
        
        <view class="todo-description" wx:if="{{ item.description }}">
          {{ item.description }}
        </view>
        
        <view class="todo-tags" wx:if="{{ item.tags && item.tags.length > 0 }}">
          <text 
            wx:for="{{ item.tags }}" 
            wx:for-item="tag"
            wx:key="*this"
            class="todo-tag"
          >#{{ tag }}</text>
        </view>
        

        
        <view class="todo-advance-reminder" wx:if="{{ item.formattedAdvanceReminder && item.dueDate }}">
          <text class="emoji-icon small">â°</text>
          <text class="advance-reminder-text">æå‰{{ item.formattedAdvanceReminder }}æé†’</text>
        </view>
      </view>
      
      <!-- åˆ é™¤æŒ‰é’® -->
      <view 
        class="todo-delete-btn"
        wx:if="{{ !selectionMode }}"
        data-id="{{ item.id }}"
        bind:tap="deleteTodo"
      >
        <text class="emoji-icon small">ğŸ—‘ï¸</text>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ - åŒºåˆ†é¦–æ¬¡ä½¿ç”¨å’Œç­›é€‰åæ— ç»“æœ -->
  <view class="empty-state" wx:if="{{ todos.length === 0 }}">
    <view class="empty-icon">
      <text class="emoji-icon extra-large">{{ stats.total > 0 ? 'ğŸ”' : 'ğŸ“' }}</text>
    </view>
    <view class="empty-title">{{ stats.total > 0 ? 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å¾…åŠäº‹é¡¹' : 'è¿˜æ²¡æœ‰å¾…åŠäº‹é¡¹' }}</view>
    <view class="empty-subtitle">{{ stats.total > 0 ? 'å°è¯•åˆ‡æ¢ç­›é€‰æ¡ä»¶æˆ–åˆ›å»ºæ–°çš„å¾…åŠ' : 'ç‚¹å‡»"æ–°å¢å¾…åŠ"åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡' }}</view>
    <view class="empty-action" bind:tap="showAddTodo">
      <text class="emoji-icon">â•</text>
      <text>æ–°å¢å¾…åŠ</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-actions" wx:if="{{ todos.length > 0 }}">
    <view class="bottom-btn" bind:tap="exportTodos">
      <text class="emoji-icon small">ğŸ“¤</text>
      <text class="bottom-btn-text">å¯¼å‡º</text>
    </view>
    <view class="bottom-btn" bind:tap="showImport">
      <text class="emoji-icon small">ğŸ“¥</text>
      <text class="bottom-btn-text">å¯¼å…¥</text>
    </view>
    <view class="bottom-btn" bind:tap="showStats">
      <text class="emoji-icon small">ğŸ“Š</text>
      <text class="bottom-btn-text">ç»Ÿè®¡</text>
    </view>
  </view>

  <!-- æ–°å¢/ç¼–è¾‘å¾…åŠå¼¹çª— -->
  <van-popup 
    show="{{ showAddModal || showEditModal }}" 
    position="bottom" 
    round="{{ true }}"
    bind:close="closeModal"
    custom-style="height: 80vh;"
  >
    <view class="modal-container">
      <view class="modal-header">
        <view class="modal-title">{{ editingTodo ? 'ç¼–è¾‘å¾…åŠ' : 'æ–°å¢å¾…åŠ' }}</view>
        <view class="modal-close" bind:tap="closeModal">
          <text class="emoji-icon close-icon">âŒ</text>
        </view>
      </view>
      
      <scroll-view class="modal-content" scroll-y="{{ true }}">
        <!-- æ ‡é¢˜ -->
        <view class="form-group">
          <view class="form-label">æ ‡é¢˜ *</view>
          <van-field
            value="{{ form.title }}"
            placeholder="è¯·è¾“å…¥å¾…åŠæ ‡é¢˜"
            bind:change="onTitleInput"
            maxlength="50"
          />
        </view>
        
        <!-- æè¿° -->
        <view class="form-group">
          <view class="form-label">æè¿°</view>
          <van-field
            value="{{ form.description }}"
            placeholder="è¯·è¾“å…¥è¯¦ç»†æè¿°ï¼ˆå¯é€‰ï¼‰"
            type="textarea"
            autosize="{{ true }}"
            bind:change="onDescriptionInput"
            maxlength="200"
          />
        </view>
        
        <!-- ä¼˜å…ˆçº§ -->
        <view class="form-group">
          <view class="form-label">ä¼˜å…ˆçº§</view>
          <view class="priority-options">
            <view 
              wx:for="{{ priorities }}" 
              wx:key="value"
              class="priority-option {{ form.priority === item.value ? 'selected' : '' }}"
              data-priority="{{ item.value }}"
              bind:tap="selectPriority"
            >
              <text class="emoji-icon small">{{ item.icon }}</text>
              <text class="priority-label">{{ item.label }}</text>
            </view>
          </view>
        </view>
        
        <!-- åˆ†ç±» -->
        <view class="form-group">
          <view class="form-label">åˆ†ç±»</view>
          <scroll-view class="category-scroll" scroll-x="{{ true }}" show-scrollbar="{{ false }}">
            <view class="category-options">
              <view 
                wx:for="{{ categories }}" 
                wx:key="*this"
                class="category-option {{ form.category === item ? 'selected' : '' }}"
                data-category="{{ item }}"
                bind:tap="selectCategory"
              >
                {{ item }}
              </view>
            </view>
          </scroll-view>
        </view>
        
        <!-- æˆªæ­¢æ—¥æœŸ -->
        <view class="form-group">
          <view class="form-label">æˆªæ­¢æ—¥æœŸ</view>
          <view class="date-time-row">
            <picker 
              mode="date" 
              value="{{ form.dueDate }}" 
              data-field="dueDate"
              bind:change="onDateChange"
            >
              <van-field
                value="{{ form.dueDate }}"
                placeholder="é€‰æ‹©æ—¥æœŸ"
                readonly="{{ true }}"
                right-icon="arrow"
              />
            </picker>
            <picker 
              mode="time" 
              value="{{ form.dueTime }}" 
              data-field="dueTime"
              bind:change="onTimeChange"
            >
              <van-field
                value="{{ form.dueTime }}"
                placeholder="é€‰æ‹©æ—¶é—´"
                readonly="{{ true }}"
                right-icon="arrow"
              />
            </picker>
          </view>
        </view>
        

        
        <!-- æ ‡ç­¾ -->
        <view class="form-group">
          <view class="form-label">æ ‡ç­¾</view>
          <van-field
            value="{{ form.tags }}"
            placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨ç©ºæ ¼åˆ†éš”"
            bind:change="onTagsInput"
          />
        </view>
        
        <!-- æå‰æé†’ -->
        <view class="form-group">
          <view class="form-label">æå‰æé†’</view>
          <view class="advance-reminder-options">
            <view 
              wx:for="{{ advanceReminderOptions }}" 
              wx:key="value"
              class="reminder-option {{ form.advanceReminderMinutes === item.value ? 'selected' : '' }}"
              data-minutes="{{ item.value }}"
              bind:tap="selectAdvanceReminder"
            >
              <text class="reminder-text">{{ item.label }}</text>
              <text class="reminder-check" wx:if="{{ form.advanceReminderMinutes === item.value }}">âœ“</text>
            </view>
          </view>
        </view>
      </scroll-view>
      
      <view class="modal-footer">
        <van-button 
          type="default" 
          size="large" 
          bind:click="closeModal"
          custom-style="margin-right: 16rpx; flex: 1;"
        >
          å–æ¶ˆ
        </van-button>
        <van-button 
          type="primary" 
          size="large" 
          bind:click="saveTodo"
          custom-style="flex: 1;"
          loading="{{ false }}"
        >
          {{ editingTodo ? 'æ›´æ–°' : 'ä¿å­˜' }}
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- ç»Ÿè®¡ä¿¡æ¯å¼¹çª— -->
  <van-popup 
    show="{{ showStatsModal }}" 
    position="center" 
    round="{{ true }}"
    bind:close="closeModal"
  >
    <view class="stats-modal">
      <view class="stats-header">
        <view class="stats-title">ğŸ“Š å¾…åŠç»Ÿè®¡</view>
        <view class="stats-close" bind:tap="closeModal">
          <text class="emoji-icon close-icon">âŒ</text>
        </view>
      </view>
      
      <view class="stats-content">
        <view class="stats-row">
          <view class="stats-item">
            <view class="stats-number">{{ stats.total }}</view>
            <view class="stats-label">æ€»è®¡</view>
          </view>
          <view class="stats-item">
            <view class="stats-number">{{ stats.pending }}</view>
            <view class="stats-label">å¾…å®Œæˆ</view>
          </view>
          <view class="stats-item">
            <view class="stats-number">{{ stats.completed }}</view>
            <view class="stats-label">å·²å®Œæˆ</view>
          </view>
        </view>
        
        <view class="stats-row">
          <view class="stats-item warning">
            <view class="stats-number">{{ stats.overdue }}</view>
            <view class="stats-label">å·²è¿‡æœŸ</view>
          </view>
          <view class="stats-item today">
            <view class="stats-number">{{ stats.dueToday }}</view>
            <view class="stats-label">ä»Šæ—¥åˆ°æœŸ</view>
          </view>
          <view class="stats-item tomorrow">
            <view class="stats-number">{{ stats.dueTomorrow }}</view>
            <view class="stats-label">æ˜æ—¥åˆ°æœŸ</view>
          </view>
        </view>
        
        <view class="completion-rate">
          <view class="completion-label">å®Œæˆç‡</view>
          <view class="completion-bar">
            <view 
              class="completion-fill" 
              style="width: {{ completionPercentage }}%"
            ></view>
          </view>
          <view class="completion-text">
            {{ completionPercentage }}%
          </view>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- å¯¼å…¥æ•°æ®å¼¹çª— -->
  <van-popup 
    show="{{ showImportModal }}" 
    position="center" 
    round="{{ true }}"
    bind:close="closeModal"
    custom-style="width: 90%; max-height: 70vh;"
  >
    <view class="import-modal">
      <view class="import-header">
        <view class="import-title">ğŸ“¥ å¯¼å…¥æ•°æ®</view>
        <view class="import-close" bind:tap="closeModal">
          <text class="emoji-icon close-icon">âŒ</text>
        </view>
      </view>
      
      <view class="import-content">
        <view class="import-tip">
          ğŸ“¥ æ”¯æŒå¤šç§å¯¼å…¥æ ¼å¼ï¼š
        </view>
        <view class="import-formats">
          <view class="format-item">
            <text class="format-icon">ğŸ“</text>
            <view class="format-text">
              <view class="format-title">ç®€å•æ–‡æœ¬</view>
              <view class="format-desc">æ¯è¡Œä¸€ä¸ªå¾…åŠäº‹é¡¹</view>
            </view>
          </view>
          <view class="format-item">
            <text class="format-icon">ğŸ“‹</text>
            <view class="format-text">
              <view class="format-title">Markdownæ ¼å¼</view>
              <view class="format-desc">å¯¼å‡ºçš„å®Œæ•´æ ¼å¼</view>
            </view>
          </view>
          <view class="format-item">
            <text class="format-icon">âš™ï¸</text>
            <view class="format-text">
              <view class="format-title">JSONæ ¼å¼</view>
              <view class="format-desc">æŠ€æœ¯ç”¨æˆ·ä¸“ç”¨</view>
            </view>
          </view>
        </view>
        <van-field
          value="{{ importData }}"
          type="textarea"
          placeholder="ç¤ºä¾‹ï¼š&#10;å®Œæˆé¡¹ç›®æŠ¥å‘Š ğŸ”´&#10;è´­ä¹°æœºç¥¨&#10;~~å·²å®Œæˆçš„ä»»åŠ¡~~&#10;&#10;æˆ–ç²˜è´´å¯¼å‡ºçš„å®Œæ•´æ•°æ®..."
          autosize="{{ true }}"
          bind:change="onImportInput"
        />
      </view>
      
      <view class="import-footer">
        <van-button 
          type="default" 
          size="large" 
          bind:click="closeModal"
          custom-style="margin-right: 16rpx;"
        >
          å–æ¶ˆ
        </van-button>
        <van-button 
          type="primary" 
          size="large" 
          bind:click="importTodos"
        >
          å¯¼å…¥
        </van-button>
      </view>
    </view>
  </van-popup>
</view>
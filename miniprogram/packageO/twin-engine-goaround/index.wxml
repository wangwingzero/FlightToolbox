<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ - è‹¹æœé£æ ¼ -->
  <view class="page-header">
    <view class="header-content">
      <view class="title-icon">âœˆï¸</view>
      <view class="title-text">
        <view class="main-title">åŒå‘å¤é£æ¢¯åº¦</view>
        <view class="sub-title">Twin Engine Go-Around Gradient</view>
      </view>
    </view>

    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <view class="steps-indicator">
      <!-- æ­¥éª¤1: ç³»åˆ— -->
      <view
        class="step-item {{ currentStep >= 1 ? 'active' : '' }} {{ currentStep > 1 ? 'completed' : '' }}"
        data-step="1"
        bind:tap="jumpToStep"
      >
        <view class="step-circle">
          <view wx:if="{{ currentStep === 1 }}" class="step-number">1</view>
          <view wx:elif="{{ currentStep > 1 }}" class="step-check">âœ“</view>
        </view>
        <view class="step-label">ç³»åˆ—</view>
      </view>

      <view class="step-line {{ currentStep > 1 ? 'active' : '' }}"></view>

      <!-- æ­¥éª¤2: æœºå‹ -->
      <view
        class="step-item {{ currentStep >= 2 ? 'active' : '' }} {{ currentStep > 2 ? 'completed' : '' }}"
        data-step="2"
        bind:tap="jumpToStep"
      >
        <view class="step-circle">
          <view wx:if="{{ currentStep === 2 }}" class="step-number">2</view>
          <view wx:elif="{{ currentStep > 2 }}" class="step-check">âœ“</view>
          <view wx:else class="step-number inactive">2</view>
        </view>
        <view class="step-label">æœºå‹</view>
      </view>

      <view class="step-line {{ currentStep > 2 ? 'active' : '' }}"></view>

      <!-- æ­¥éª¤3: é‡é‡ -->
      <view
        class="step-item {{ currentStep >= 3 ? 'active' : '' }} {{ currentStep > 3 ? 'completed' : '' }}"
        data-step="3"
        bind:tap="jumpToStep"
      >
        <view class="step-circle">
          <view wx:if="{{ currentStep === 3 }}" class="step-number">3</view>
          <view wx:elif="{{ currentStep > 3 }}" class="step-check">âœ“</view>
          <view wx:else class="step-number inactive">3</view>
        </view>
        <view class="step-label">é‡é‡</view>
      </view>

      <view class="step-line {{ currentStep > 3 ? 'active' : '' }}"></view>

      <!-- æ­¥éª¤4: é«˜åº¦ -->
      <view
        class="step-item {{ currentStep >= 4 ? 'active' : '' }} {{ currentStep > 4 ? 'completed' : '' }}"
        data-step="4"
        bind:tap="jumpToStep"
      >
        <view class="step-circle">
          <view wx:if="{{ currentStep === 4 }}" class="step-number">4</view>
          <view wx:elif="{{ currentStep > 4 }}" class="step-check">âœ“</view>
          <view wx:else class="step-number inactive">4</view>
        </view>
        <view class="step-label">é«˜åº¦</view>
      </view>

      <view class="step-line {{ currentStep > 4 ? 'active' : '' }}"></view>

      <!-- æ­¥éª¤5: ç»“æœ -->
      <view
        class="step-item {{ currentStep >= 5 ? 'active' : '' }} {{ currentStep > 5 ? 'completed' : '' }}"
        data-step="5"
        bind:tap="jumpToStep"
      >
        <view class="step-circle">
          <view wx:if="{{ currentStep === 5 }}" class="step-number">5</view>
          <view wx:elif="{{ currentStep > 5 }}" class="step-check">âœ“</view>
          <view wx:else class="step-number inactive">5</view>
        </view>
        <view class="step-label">ç»“æœ</view>
      </view>
    </view>
  </view>

  <!-- é£æœºç³»åˆ—åˆ—è¡¨ -->
  <view wx:if="{{ showAircraftSeries }}" class="aircraft-series-section">

    <view class="series-title-header">é€‰æ‹©é£æœºç³»åˆ—</view>
    
    <!-- é£æœºç³»åˆ—åˆ—è¡¨ -->
    <block wx:for="{{ aircraftSeries }}" wx:key="series">
      <view
        class="aircraft-series-item"
        data-index="{{ index }}"
        bind:tap="onSeriesSelect"
      >
        <view class="series-icon">{{ item.series && item.series.charAt(0) || '?' }}</view>
        <view class="series-content">
          <view class="series-title">{{ item.series }}</view>
          <view class="series-subtitle">{{ item.count }}ä¸ªæœºå‹å˜ä½“</view>
        </view>
        <view class="series-count">{{ item.count }}</view>
      </view>

      <!-- åœ¨ç¬¬ä¸€ä¸ªç³»åˆ—åæ’å…¥å¹¿å‘Š -->
      <view wx:if="{{ index === 0 && !isAdFree }}" class="ad-banner-container">
        <ad unit-id="adunit-d6c8a55bd3cb4fd1" ad-type="banner" ad-intervals="30"></ad>
      </view>
    </block>
  </view>

  <!-- æœºå‹åˆ—è¡¨ -->
  <view wx:if="{{ showModelList }}" class="model-list-section">

    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <van-cell-group>
      <van-cell
        title="è¿”å›ç³»åˆ—åˆ—è¡¨"
        icon="arrow-left"
        bind:click="backToSeriesList"
        class="back-cell"
      />
    </van-cell-group>

    <!-- å½“å‰ç³»åˆ—çš„æœºå‹åˆ—è¡¨ -->
    <van-cell-group title="{{ selectedSeries.series }} ({{ currentSeriesModels.length }}ä¸ªæœºå‹)">
      <van-cell
        wx:for="{{ currentSeriesModels }}"
        wx:key="model"
        title="{{ item.model }}"
        label="æ¸©åº¦: {{ item.temp || 'DISA+25Â°C' }} | é…ç½®: {{ item.config || 'FULL' }}"
        is-link
        data-index="{{ index }}"
        bind:click="onModelSelect"
        custom-class="model-item"
      />
    </van-cell-group>
  </view>

  <!-- æŸ¥è¯¢ç»“æœæ˜¾ç¤º -->
  <view wx:if="{{ showResults }}" class="results-section">
    <!-- æœºå‹ä¿¡æ¯ -->
    <van-cell-group title="æœºå‹ä¿¡æ¯">
      <van-cell title="æœºå‹" value="{{ currentModelData.model }}" />
      <van-cell title="æ¸©åº¦æ¡ä»¶" value="{{ currentModelData.conditions.temperature }}" />
      <van-cell title="ç©ºè°ƒ" value="{{ currentModelData.conditions.air_con }}" />
      <van-cell title="é˜²å†°" value="{{ currentModelData.conditions.anti_ice }}" />
      <van-cell title="é…ç½®" value="{{ currentModelData.conditions.config }}" />
    </van-cell-group>

    <!-- å‚æ•°é€‰æ‹©åŒºåŸŸ - é‡æ–°è®¾è®¡ -->
    <view class="params-container">
      <view class="params-title">ğŸ“Š æŸ¥è¯¢å‚æ•°</view>
      
      <!-- é‡é‡é€‰æ‹© -->
      <view wx:if="{{ currentModelData.data }}" class="parameter-section">
        <van-cell title="âœˆï¸ é‡é‡é€‰æ‹© ({{ currentModelData.data.length }}ä¸ªé€‰é¡¹)" size="large" />
        <view 
          class="picker-trigger-cell clickable-param"
          bind:tap="showWeightPicker"
        >
          <view class="param-info">
            <text class="param-title">é£æœºé‡é‡</text>
            <text class="param-subtitle">ç‚¹å‡»é€‰æ‹©èµ·é£é‡é‡</text>
          </view>
          <view class="param-value-container">
            <text class="param-value">{{ selectedWeight ? selectedWeight + 'kg' : 'è¯·é€‰æ‹©' }}</text>
            <van-icon name="arrow" size="16px" color="#667eea" />
          </view>
        </view>
      </view>
        
      <!-- é‡é‡Picker -->
      <van-popup
        show="{{ showWeightPicker }}"
        bind:close="closeWeightPicker"
        position="bottom"
        round="{{ true }}"
      >
        <van-picker
          columns="{{ weightColumns }}"
          bind:confirm="onWeightConfirm"
          bind:cancel="closeWeightPicker"
          title="é€‰æ‹©é‡é‡"
          value="{{ selectedWeightIndex }}"
          bind:change="onWeightPickerChange"
          show-toolbar="{{ true }}"
          confirm-button-text="ç¡®è®¤"
          cancel-button-text="å–æ¶ˆ"
        />
      </van-popup>

      <!-- é«˜åº¦é€‰æ‹© -->
      <view wx:if="{{ currentModelData.data && selectedWeight }}" class="parameter-section">
        <van-cell title="ğŸŒ¤ï¸ é«˜åº¦é€‰æ‹© ({{ availableAltitudesForCurrentWeight.length }}ä¸ªé€‰é¡¹)" size="large" />
        <view 
          class="picker-trigger-cell clickable-param"
          bind:tap="showAltitudePicker"
        >
          <view class="param-info">
            <text class="param-title">é£è¡Œé«˜åº¦</text>
            <text class="param-subtitle">ç‚¹å‡»é€‰æ‹©å¤é£é«˜åº¦</text>
          </view>
          <view class="param-value-container">
            <text class="param-value">{{ selectedAltitude ? selectedAltitude + 'ft' : 'è¯·é€‰æ‹©' }}</text>
            <van-icon name="arrow" size="16px" color="#667eea" />
          </view>
        </view>
      </view>
        
      <!-- é«˜åº¦Picker -->
      <van-popup
        show="{{ showAltitudePicker }}"
        bind:close="closeAltitudePicker"
        position="bottom"
        round="{{ true }}"
      >
        <van-picker
          columns="{{ altitudeColumns }}"
          bind:confirm="onAltitudeConfirm"
          bind:cancel="closeAltitudePicker"
          title="é€‰æ‹©é«˜åº¦"
          value="{{ selectedAltitudeIndex }}"
          bind:change="onAltitudePickerChange"
          show-toolbar="{{ true }}"
          confirm-button-text="ç¡®è®¤"
          cancel-button-text="å–æ¶ˆ"
        />
      </van-popup>
      
      <!-- é«˜åº¦é€‰æ‹©æç¤º -->
      <view wx:if="{{ currentModelData.data && !selectedWeight }}" class="hint-container">
        <van-icon name="info-o" size="20px" color="#f39c12" />
        <text class="hint-text">è¯·å…ˆé€‰æ‹©é‡é‡ä»¥æŸ¥çœ‹å¯ç”¨é«˜åº¦é€‰é¡¹</text>
      </view>

      <!-- æŸ¥è¯¢æŒ‰é’® -->
      <view wx:if="{{ selectedWeight && selectedAltitude }}" class="query-button-section">
        <van-button 
          type="primary" 
          block 
          size="large"
          loading="{{ isQuerying }}"
          loading-text="è®¡ç®—ä¸­..."
          bind:click="queryGradient"
          custom-class="query-button"
        >
          <van-icon name="search" slot="icon" />
          {{ isQuerying ? 'è®¡ç®—ä¸­...' : 'æŸ¥è¯¢å¤é£æ¢¯åº¦' }}
        </van-button>
      </view>
    </view>

    <!-- ç»“æœå¡ç‰‡ -->
    <view wx:if="{{ gradient }}" class="result-card" id="result-card">
      <van-cell-group title="è®¡ç®—ç»“æœ">
        <!-- ç»“æœæ ‡é¢˜æ  -->
        <van-cell custom-class="result-header-cell">
          <view slot="title" class="result-header">
            <view class="header-left">
              <text class="result-title">å¤é£æ¢¯åº¦</text>
              <text class="result-subtitle">{{ currentModelData.model }}</text>
            </view>
            <van-icon 
              name="replay" 
              class="refresh-icon" 
              bind:tap="queryGradient"
            />
          </view>
        </van-cell>

        <!-- æ¢¯åº¦å€¼æ˜¾ç¤º -->
        <van-cell custom-class="gradient-value-cell">
          <view slot="title" class="gradient-value">
            <text class="value">{{ gradient }}</text>
            <text class="unit">%</text>
          </view>
        </van-cell>

        <!-- å‚æ•°æ‘˜è¦ -->
        <van-cell custom-class="params-summary-cell">
          <view slot="title" class="params-summary">
            <view class="param-item">
              <text class="param-label">é‡é‡</text>
              <text class="param-value">{{ selectedWeight }}kg</text>
            </view>
            <view class="param-item">
              <text class="param-label">é«˜åº¦</text>
              <text class="param-value">{{ selectedAltitude }}ft</text>
            </view>
          </view>
        </van-cell>

        <!-- å®‰å…¨æç¤º -->
        <van-cell custom-class="safety-notice-cell">
          <view slot="title" class="safety-notice">
            <van-icon name="info-o" />
            <text>æ­¤æ•°æ®ä»…ä¾›å‚è€ƒï¼Œä¸å¯ä½œä¸ºå®é™…è¿è¡Œä¾æ®</text>
          </view>
        </van-cell>
      </van-cell-group>
    </view>

    <!-- æ— æ•°æ®æç¤º -->
    <van-empty
      wx:if="{{ !gradient && selectedWeight && selectedAltitude }}"
      description="æ— æ³•è®¡ç®—æ¢¯åº¦ï¼Œè¯·å°è¯•å…¶ä»–å‚æ•°ç»„åˆ"
      image="error"
    />


  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <van-empty
    wx:if="{{ !showAircraftSeries && !showModelList && !showResults && !showWarningDialog }}"
    description="åŠ è½½ä¸­..."
  />
</view>
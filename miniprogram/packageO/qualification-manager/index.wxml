<view class="container">
  <!-- 资质管理状态卡片 -->
  <view class="qualification-status-card">
    <view class="status-header">
      <view class="qualification-avatar">
        <text class="emoji-icon">🛡️</text>
        <view class="avatar-ring"></view>
      </view>
      <view class="qualification-info">
        <view class="qualification-title">资质管理中心</view>
        <view class="qualification-subtitle">{{ qualifications.length }}项资质监控中</view>
      </view>
      <view class="status-display">
        <view class="status-value">{{ validCount }}</view>
        <view class="status-unit">正常</view>
        <view class="status-ring"></view>
      </view>
    </view>
    
    <!-- 快速操作区 -->
    <view class="quick-actions">
      <view class="action-item" bind:tap="showModeSelection" hover-class="none">
        <view class="action-icon">
          <text class="emoji-icon">➕</text>
        </view>
        <view class="action-content">
          <text class="action-text">自定义创建</text>
        </view>
        <view class="action-ripple"></view>
      </view>
      
      <view class="action-item" bind:tap="showTemplateSelection" hover-class="none">
        <view class="action-icon">
          <text class="emoji-icon">📋</text>
        </view>
        <view class="action-content">
          <text class="action-text">模板创建</text>
        </view>
        <view class="action-ripple"></view>
      </view>
      
      <view class="action-item" bind:tap="showHelpInfo" wx:if="{{ qualifications.length > 0 }}" hover-class="none">
        <view class="action-icon">
          <text class="emoji-icon">📊</text>
        </view>
        <view class="action-content">
          <text class="action-text">统计信息</text>
        </view>
        <view class="action-ripple"></view>
      </view>
    </view>
    
    <!-- 状态统计 -->
    <view class="status-stats" wx:if="{{ qualifications.length > 0 }}">
      <view class="stat-item valid" hover-class="none">
        <text class="emoji-icon">✅</text>
        <text class="stat-text">{{ validCount }}项正常</text>
      </view>
      <view class="stat-item warning" wx:if="{{ warningCount > 0 }}" hover-class="none">
        <text class="emoji-icon">⚠️</text>
        <text class="stat-text">{{ warningCount }}项即将到期</text>
      </view>
      <view class="stat-item expired" wx:if="{{ expiredCount > 0 }}" hover-class="none">
        <text class="emoji-icon">❌</text>
        <text class="stat-text">{{ expiredCount }}项已过期</text>
      </view>
    </view>
  </view>

  <!-- 资质列表卡片 -->
  <view wx:if="{{ qualifications.length > 0 }}" class="qualification-list-card">
    <view class="list-header">
      <view class="list-icon">
        <text class="emoji-icon">📋</text>
      </view>
      <view class="list-content">
        <text class="list-title">我的资质</text>
        <text class="list-subtitle">{{ qualifications.length }}项监控中</text>
      </view>
    </view>
    
    <view class="qualification-items">
      <view 
        wx:for="{{ qualifications }}" 
        wx:key="id"
        class="qualification-card qualification-{{ item.status }}"
        bind:tap="showRecordPopup"
        hover-class="none"
        data-id="{{ item.id }}"
      >
        <view class="qual-header">
          <view class="qual-status-dot"></view>
          <view class="qual-name">{{ item.name }}</view>
          <view class="qual-actions">
            <text class="emoji-icon delete-btn" bind:tap="deleteQualification" data-id="{{ item.id }}" catch:tap="deleteQualification">🗑️</text>
          </view>
        </view>
        
        <view class="qual-details">
          <view class="qual-mode">
            <text wx:if="{{ item.mode === 'daily' }}">
              {{ item.dailyPeriod }}天{{ item.dailyRequired }}次 - {{ item.currentCount || 0 }}/{{ item.dailyRequired }}
            </text>
            <text wx:elif="{{ item.mode === 'monthly' }}">
              {{ item.monthlyPeriod }}个月{{ item.monthlyRequired }}次 - {{ item.currentCount || 0 }}/{{ item.monthlyRequired }}
            </text>
            <text wx:elif="{{ item.mode === 'expiry' }}">
              到期：{{ item.expiryDate || '未设置' }}
            </text>
          </view>
          
          <view class="qual-countdown">
            <text wx:if="{{ item.status === 'expired' }}" class="countdown-text expired">
              {{ item.mode === 'expiry' ? '已过期' : '不达标' }}
            </text>
            <text wx:elif="{{ item.daysRemaining > 0 }}" class="countdown-text {{ item.status }}">
              {{ item.daysRemaining }}天后到期
            </text>
            <text wx:else class="countdown-text expired">
              已过期
            </text>
          </view>
        </view>
        
        <view class="qual-progress" wx:if="{{ item.mode !== 'expiry' }}">
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{ (item.currentCount || 0) / (item.mode === 'daily' ? item.dailyRequired : item.monthlyRequired) * 100 }}%"></view>
          </view>
          <view class="progress-text">
            完成度 {{ (item.currentCount || 0) }}/{{ item.mode === 'daily' ? item.dailyRequired : item.monthlyRequired }}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 空状态卡片 -->
  <view wx:if="{{ qualifications.length === 0 }}" class="empty-state-card">
    <view class="empty-icon">
      <text class="emoji-icon extra-large">🛡️</text>
    </view>
    <view class="empty-title">开始管理您的资质</view>
    <view class="empty-subtitle">添加飞行资质，智能监控到期时间</view>
    <view class="empty-actions">
      <view class="empty-action-item" bind:tap="showTemplateSelection" hover-class="none">
        <text class="emoji-icon">📋</text>
        <text>快速模板</text>
      </view>
      <view class="empty-action-item" bind:tap="showModeSelection" hover-class="none">
        <text class="emoji-icon">➕</text>
        <text>自定义创建</text>
      </view>
    </view>
  </view>

  <!-- 倒计时模式选择 -->
  <van-action-sheet
    show="{{ showModeSelectionSheet }}"
    title="选择倒计时模式"
    bind:close="closeModeSelectionSheet"
    bind:select="onModeSelect"
    actions="{{ countdownModes }}"
  />

  <!-- 模板选择 -->
  <van-action-sheet
    show="{{ showTemplateSheet }}"
    title="选择资质模板"
    bind:close="closeTemplateSheet"
    bind:select="onTemplateSelect"
    actions="{{ qualificationTemplates }}"
  />

  <!-- 创建资质弹窗 -->
  <van-popup
    show="{{ showAddPopup }}"
    bind:close="closeAddPopup"
    position="bottom"
    round="{{ true }}"
  >
    <view class="popup-content">
      <view class="popup-header">
        <van-icon 
          name="arrow-left" 
          size="20px" 
          bind:click="closeAddPopup"
          class="popup-back-btn"
        />
        <text class="popup-title">
          创建资质 - 
          <text wx:if="{{ selectedMode === 'monthly' }}">月周期模式</text>
          <text wx:elif="{{ selectedMode === 'daily' }}">日周期模式</text>
          <text wx:elif="{{ selectedMode === 'expiry' }}">到期日期模式</text>
        </text>
        <view style="width: 40rpx;"></view> <!-- 占位元素保持标题居中 -->
      </view>
      
      <van-cell-group>
        <!-- 资质名称 -->
        <van-field
          label="资质名称"
          value="{{ newQualificationForm.name }}"
          placeholder="请输入资质名称"
          bind:change="onFormInput"
          data-field="name"
          required
        />
        
        <!-- 月周期模式参数 -->
        <view wx:if="{{ selectedMode === 'monthly' }}">
          <van-field
            label="周期（月）"
            value="{{ newQualificationForm.monthlyPeriod }}"
            placeholder="如：12表示12个月"
            type="number"
            bind:change="onFormNumberInput"
            data-field="monthlyPeriod"
          />
          <van-field
            label="要求次数"
            value="{{ newQualificationForm.monthlyRequired }}"
            placeholder="如：2表示需要2次"
            type="number"
            bind:change="onFormNumberInput"
            data-field="monthlyRequired"
          />
        </view>
        
        <!-- 日周期模式参数 -->
        <view wx:if="{{ selectedMode === 'daily' }}">
          <van-field
            label="周期（天）"
            value="{{ newQualificationForm.dailyPeriod }}"
            placeholder="如：90表示90天"
            type="number"
            bind:change="onFormNumberInput"
            data-field="dailyPeriod"
          />
          <van-field
            label="要求次数"
            value="{{ newQualificationForm.dailyRequired }}"
            placeholder="如：3表示需要3次"
            type="number"
            bind:change="onFormNumberInput"
            data-field="dailyRequired"
          />
        </view>
        
        <!-- 到期日期模式参数 -->
        <view wx:if="{{ selectedMode === 'expiry' }}">
          <van-cell
            title="到期日期"
            value="{{ newQualificationForm.expiryDate || '点击选择到期日期' }}"
            is-link
            bind:click="showExpiryDatePicker"
          />
        </view>
        
        <!-- 公共参数 -->
        <van-field
          label="警告天数"
          value="{{ newQualificationForm.warningDays }}"
          placeholder="提前多少天警告"
          type="number"
          bind:change="onFormNumberInput"
          data-field="warningDays"
        />
        <van-field
          label="描述"
          value="{{ newQualificationForm.description }}"
          placeholder="资质描述（可选）"
          type="textarea"
          autosize
          bind:change="onFormInput"
          data-field="description"
        />
      </van-cell-group>

      <view class="popup-buttons">
        <van-button bind:click="closeAddPopup">取消</van-button>
        <van-button type="primary" bind:click="saveNewQualification">创建</van-button>
      </view>
    </view>
  </van-popup>

  <!-- 记录弹窗 - 现代化设计 -->
  <van-popup
    show="{{ showRecordPopup }}"
    bind:close="closeRecordPopup"
    position="bottom"
    round="{{ true }}"
    custom-style="max-height: 90vh; overflow: hidden;"
  >
    <view class="record-popup-content">
      <!-- 顶部状态栏 - 固定不滚动 -->
      <view class="record-popup-header {{ currentQualification.status }}">
        <view class="record-popup-back" bind:tap="closeRecordPopup" hover-class="none">
          <text class="emoji-icon">←</text>
        </view>
        <view class="record-popup-title">{{ currentQualification.name }}</view>
        <view class="record-popup-status">
          <text class="status-badge {{ currentQualification.status }}">
            <text wx:if="{{ currentQualification.status === 'valid' }}">正常</text>
            <text wx:elif="{{ currentQualification.status === 'warning' }}">即将到期</text>
            <text wx:elif="{{ currentQualification.status === 'expired' }}">{{ currentQualification.mode === 'expiry' ? '已过期' : '不达标' }}</text>
          </text>
        </view>
      </view>

      <!-- 可滚动内容区域 -->
      <scroll-view class="record-popup-scroll" scroll-y="{{ true }}" enhanced="{{ true }}" show-scrollbar="{{ false }}">
      
      <!-- 资质状态卡片 -->
      <view class="record-status-card {{ currentQualification.status }}">
        <view class="record-status-info">
          <view class="record-status-row">
            <view class="record-status-label">
              <text class="emoji-icon">⏱️</text>
              <text>剩余时间</text>
            </view>
            <view class="record-status-value">
              <text wx:if="{{ currentQualification.daysRemaining > 0 }}">{{ currentQualification.daysRemaining }}天</text>
              <text wx:else class="expired-text">已过期</text>
            </view>
          </view>
          
          <view class="record-status-row">
            <view class="record-status-label">
              <text class="emoji-icon">📅</text>
              <text>到期日期</text>
            </view>
            <view class="record-status-value">
              {{ currentQualification.calculatedExpiryDate || currentQualification.expiryDate || '未设置' }}
            </view>
          </view>
          
          <view class="record-status-row" wx:if="{{ currentQualification.mode === 'daily' }}">
            <view class="record-status-label">
              <text class="emoji-icon">🔄</text>
              <text>周期要求</text>
            </view>
            <view class="record-status-value">
              {{ currentQualification.dailyPeriod }}天内{{ currentQualification.dailyRequired }}次
            </view>
          </view>
          
          <view class="record-status-row" wx:if="{{ currentQualification.mode === 'monthly' }}">
            <view class="record-status-label">
              <text class="emoji-icon">🔄</text>
              <text>周期要求</text>
            </view>
            <view class="record-status-value">
              {{ currentQualification.monthlyPeriod }}个月内{{ currentQualification.monthlyRequired }}次
            </view>
          </view>
          
          <view class="record-status-row" wx:if="{{ currentQualification.mode !== 'expiry' }}">
            <view class="record-status-label">
              <text class="emoji-icon">✅</text>
              <text>当前完成</text>
            </view>
            <view class="record-status-value">
              {{ currentQualification.currentCount || 0 }}次
            </view>
          </view>
        </view>
        
        <!-- 进度条 -->
        <view class="record-progress" wx:if="{{ currentQualification.mode !== 'expiry' }}">
          <view class="record-progress-bar">
            <view class="record-progress-fill {{ currentQualification.status }}" 
                  style="width: {{ (currentQualification.currentCount || 0) / (currentQualification.mode === 'daily' ? currentQualification.dailyRequired : currentQualification.monthlyRequired) * 100 }}%">
            </view>
          </view>
          <view class="record-progress-text">
            完成度: {{ (currentQualification.currentCount || 0) }}/{{ currentQualification.mode === 'daily' ? currentQualification.dailyRequired : currentQualification.monthlyRequired }}
          </view>
        </view>
      </view>
      
      <!-- 添加记录区域 -->
      <view class="record-add-section">
        <view class="record-section-title">
          <text class="emoji-icon">📝</text>
          <text>{{ currentQualification.mode === 'expiry' ? '设置到期日期' : '添加新记录' }}</text>
        </view>
        
        <view class="record-form">
          <view class="record-form-item">
            <view class="record-form-label">
              {{ currentQualification.mode === 'expiry' ? '到期日期' : '录入日期' }}
            </view>
            <view class="record-form-input date-input" bind:tap="showDatePicker" hover-class="none">
              <text>{{ newRecord.date || '点击选择日期' }}</text>
              <text class="emoji-icon">📅</text>
            </view>
          </view>
          
          <view class="record-form-item" wx:if="{{ currentQualification.mode !== 'expiry' }}">
            <view class="record-form-label">次数</view>
            <view class="record-form-input">
              <input 
                type="number" 
                value="{{ newRecord.count }}" 
                placeholder="请输入次数" 
                bindinput="onCountInput"
                class="count-input"
              />
            </view>
          </view>
          
          <view class="record-form-button">
            <button class="add-record-btn" bind:tap="addRecord" hover-class="none">
              <text class="emoji-icon">✅</text>
              <text wx:if="{{ currentQualification.mode === 'expiry' }}">设置到期时间</text>
              <text wx:else>添加记录</text>
            </button>
          </view>
        </view>
      </view>
      
      <!-- 历史记录区域 -->
      <view class="record-history-section">
        <view class="record-section-title">
          <text class="emoji-icon">📋</text>
          <text>历史记录</text>
        </view>
        
        <view class="record-history-list" wx:if="{{ displayRecords && displayRecords.length > 0 }}">
          <view 
            class="record-history-item" 
            wx:for="{{ displayRecords }}" 
            wx:key="id"
          >
            <view class="record-history-date">{{ item.date }}</view>
            <view class="record-history-count" wx:if="{{ currentQualification.mode !== 'expiry' && item.count }}">
              {{ item.count }}次
            </view>
            <view class="record-history-delete" bind:tap="deleteRecord" data-record-id="{{ item.id }}" hover-class="none">
              <text class="emoji-icon">🗑️</text>
            </view>
          </view>
          
          <!-- 清空记录按钮 -->
          <view 
            class="record-clear-all" 
            wx:if="{{ currentQualification.records && currentQualification.records.length > 1 }}"
            bind:tap="clearAllRecords"
            hover-class="none"
          >
            <text class="emoji-icon">🧹</text>
            <text>清空所有记录</text>
          </view>
        </view>
        
        <!-- 空记录状态 -->
        <view class="record-empty-state" wx:if="{{ !displayRecords || displayRecords.length === 0 }}">
          <text class="emoji-icon large">📝</text>
          <text class="empty-text">暂无历史记录</text>
          <text class="empty-subtext">
            {{ currentQualification.mode === 'expiry' ? '请设置到期时间' : '请添加新的记录' }}
          </text>
        </view>
      </view>
      
      <!-- 提醒设置区域 -->
      <view class="record-reminder-section">
        <view class="record-section-title">
          <text class="emoji-icon">⏰</text>
          <text>提醒设置</text>
        </view>
        
        <view class="record-reminder-form">
          <view class="record-reminder-item">
            <view class="record-reminder-label">提醒状态</view>
            <view class="record-reminder-switch">
              <switch 
                checked="{{ currentQualification.reminderEnabled !== false }}" 
                bindchange="onReminderToggle"
                color="#667eea"
              />
            </view>
          </view>
          
          <view class="record-reminder-item">
            <view class="record-reminder-label">提前提醒天数</view>
            <view class="record-reminder-input">
              <input 
                type="number" 
                value="{{ currentQualification.warningDays || '' }}" 
                placeholder="提前多少天提醒" 
                bindinput="onWarningDaysInput"
                disabled="{{ currentQualification.reminderEnabled === false }}"
                class="days-input {{ currentQualification.reminderEnabled === false ? 'disabled' : '' }}"
              />
            </view>
          </view>
        </view>
      </view>
      
      <!-- 底部操作区域 -->
      <view class="record-bottom-actions">
        <button 
          class="delete-qualification-btn" 
          bind:tap="confirmDeleteQualification" 
          data-id="{{ currentQualification.id }}"
          hover-class="none"
        >
          <text class="emoji-icon">🗑️</text>
          <text>删除此资质</text>
        </button>
      </view>

      <!-- 底部安全距离 -->
      <view class="record-bottom-safe-area"></view>
      </scroll-view>
    </view>
  </van-popup>

  <!-- 记录日期选择器 -->
  <van-popup
    show="{{ showDatePicker }}"
    bind:close="closeDatePicker"
    position="bottom"
    round="{{ true }}"
  >
    <van-datetime-picker
      type="date"
      value="{{ selectedDateTimestamp }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="selectDate"
      bind:cancel="closeDatePicker"
      title="{{ currentQualification.mode === 'expiry' ? '选择到期日期' : '选择录入日期' }}"
    />
  </van-popup>

  <!-- 到期日期选择器 -->
  <van-popup
    show="{{ showExpiryDatePicker }}"
    bind:close="closeExpiryDatePicker"
    position="bottom"
    round="{{ true }}"
  >
    <van-datetime-picker
      type="date"
      value="{{ selectedExpiryDate.getTime() }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="selectExpiryDate"
      bind:cancel="closeExpiryDatePicker"
      title="选择到期日期"
    />
  </van-popup>

  <!-- 横幅广告 -->
  <view wx:if="{{ !isAdFree && nativeAdEnabled }}" class="ad-banner-container">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"></ad>
  </view>

  <!-- 使用说明 -->
  <view class="help-section">
    <van-cell-group title="使用说明">
      <van-cell
        title="📅 倒计时模式"
        label="支持3种模式：X天Y次(如90天3次起落)、X月Y次(如36月1次ICAO英语)、到期日期(如体检到期)"
      />
      <van-cell
        title="🔄 智能计算"
        label="自动基于最新记录计算到期时间，采用'最新Y次'算法确保准确性"
      />
      <van-cell
        title="⏰ 提醒功能"
        label="可设置提前提醒天数，在我的首页页面显示仪表板并弹窗提醒"
      />
      <van-cell
        title="📊 状态标识"
        label="🟢正常 🟡警告(即将到期) 🔴过期/不达标，状态实时更新"
      />
      <van-cell
        title="📝 记录管理"
        label="支持添加、删除记录，自动保留最近3条记录，历史数据清晰可见"
      />
      <van-cell
        title="🎯 模板创建"
        label="提供常用资质模板(90天3次起落、ICAO英语、体检等)，一键快速创建"
      />
    </van-cell-group>
  </view>

  <!-- Toast -->
  <van-toast id="van-toast" />
</view> 
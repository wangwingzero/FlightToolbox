<view class="container">
  <!-- 主要内容区域 -->
  <view class="main-content">
    <!-- 检查单列表 -->
    <view class="checklist-list" wx:if="{{ checklists.length > 0 }}">
      <block wx:for="{{ checklists }}" wx:key="id">
        <view
          class="checklist-card {{ item.isCompleted ? 'completed' : '' }}"
          bind:tap="openChecklist"
          data-id="{{ item.id }}"
        >
          <view class="card-main">
            <view class="card-title">{{ item.name }}</view>
            <view class="card-meta">
              <view class="card-progress">
                <text class="progress-done">{{ item.completedCount || 0 }}</text>
                <text class="progress-sep">/</text>
                <text class="progress-total">{{ item.items ? item.items.length : 0 }}</text>
              </view>
              <view class="card-actions">
                <view class="action-btn" catch:tap="editChecklist" data-id="{{ item.id }}">
                  <text class="action-icon">✎</text>
                </view>
                <view class="action-btn delete" catch:tap="deleteChecklist" data-id="{{ item.id }}">
                  <text class="action-icon">✕</text>
                </view>
              </view>
            </view>
          </view>
          
          <view class="card-footer">
            <view class="progress-bar">
              <view class="progress-fill" style="width: {{ item.progressPercentage || 0 }}%"></view>
            </view>
            <view class="card-status {{ item.isCompleted ? 'done' : 'pending' }}">
              {{ item.isCompleted ? '已完成' : '进行中' }}
            </view>
          </view>
        </view>

        <!-- 广告 -->
        <view wx:if="{{ index === 0 && !isAdFree }}" class="ad-container">
          <ad unit-id="adunit-d6c8a55bd3cb4fd1" ad-type="banner" ad-intervals="30"></ad>
        </view>
      </block>
    </view>

    <!-- 创建新检查单 -->
    <view class="create-card" bind:tap="createCustomChecklist">
      <view class="create-icon">+</view>
      <view class="create-text">新建检查单</view>
    </view>

    <!-- 空状态 -->
    <view class="empty-state" wx:if="{{ checklists.length === 0 }}">
      <text class="empty-icon">📋</text>
      <text class="empty-title">暂无检查单</text>
      <text class="empty-desc">点击上方按钮创建您的第一个检查单</text>
    </view>
  </view>

  <!-- 检查单详情弹窗 -->
  <van-popup 
    show="{{ showChecklistDetail }}" 
    position="bottom" 
    round
    bind:close="closeChecklistDetail"
    custom-style="height: 80%; background: #F2F2F7;"
  >
    <view class="detail-sheet">
      <!-- 头部 -->
      <view class="sheet-header">
        <view class="sheet-title">{{ currentChecklist.name }}</view>
        <view class="sheet-close" bind:tap="closeChecklistDetail">完成</view>
      </view>

      <!-- 进度摘要 -->
      <view class="sheet-summary">
        <view class="summary-progress">
          <text class="summary-done">{{ currentChecklist.completedCount || 0 }}</text>
          <text class="summary-sep">/</text>
          <text class="summary-total">{{ currentChecklist.items ? currentChecklist.items.length : 0 }}</text>
        </view>
        <view class="summary-bar">
          <view class="summary-fill" style="width: {{ currentChecklist.progressPercentage || 0 }}%"></view>
        </view>
        <view class="summary-actions">
          <view class="summary-btn" bind:tap="editCurrentChecklist">编辑</view>
          <view class="summary-btn reset" bind:tap="resetChecklist">重置</view>
        </view>
      </view>

      <!-- 检查项列表 -->
      <scroll-view class="sheet-content" scroll-y>
        <van-checkbox-group value="{{ checkedItems }}" bind:change="onCheckboxChange">
          <view class="check-list">
            <view 
              class="check-item {{ (checkedItems && Array.isArray(checkedItems) && checkedItems.includes && checkedItems.includes(item.id)) ? 'checked' : '' }}"
              wx:for="{{ currentChecklist.items }}" 
              wx:key="id"
              bind:tap="toggleCheckbox"
              data-item-id="{{ item.id }}"
            >
              <van-checkbox 
                name="{{ item.id }}" 
                checked="{{ checkedItems && Array.isArray(checkedItems) && checkedItems.includes && checkedItems.includes(item.id) }}"
                shape="round"
                icon-size="22px"
              />
              <text class="check-text">{{ item.text }}</text>
            </view>
          </view>
        </van-checkbox-group>
      </scroll-view>
    </view>
  </van-popup>

  <!-- 新建/编辑检查单弹窗 -->
  <view class="modal-overlay" wx:if="{{showEditDialog}}" bindtap="closeEditDialog">
    <view class="edit-modal" catchtap="stopPropagation">
      <!-- 头部 -->
      <view class="modal-header">
        <view class="modal-cancel" bindtap="closeEditDialog">取消</view>
        <view class="modal-title">{{ editMode === 'create' ? '新建检查单' : '编辑检查单' }}</view>
        <view class="modal-save" bindtap="saveChecklist">保存</view>
      </view>

      <!-- 内容 -->
      <scroll-view class="modal-body" scroll-y>
        <!-- 名称输入 -->
        <view class="form-group">
          <view class="form-label">名称</view>
          <input 
            class="form-input" 
            placeholder="输入检查单名称"
            value="{{editingChecklist.name}}"
            bindinput="onNameChange"
            maxlength="50"
          />
        </view>

        <!-- 检查项列表 -->
        <view class="form-group">
          <view class="form-label">检查项 <text class="item-count">{{editingChecklist.items.length || 0}}</text></view>
          
          <view class="edit-items" wx:if="{{editingChecklist.items.length > 0}}">
            <view class="edit-item" wx:for="{{editingChecklist.items}}" wx:key="index">
              <text class="edit-item-num">{{index + 1}}</text>
              
              <!-- 编辑态 -->
              <block wx:if="{{editingItemIndex === index}}">
                <input 
                  class="edit-item-input" 
                  value="{{editingItemText}}"
                  bindinput="onEditingItemTextChange"
                  placeholder="输入内容"
                  focus="{{true}}"
                />
                <view class="edit-item-actions">
                  <text class="item-action save" bindtap="saveItemText">✓</text>
                  <text class="item-action" bindtap="cancelEditItem">✕</text>
                </view>
              </block>
              
              <!-- 显示态 -->
              <block wx:else>
                <text class="edit-item-text">{{item.text}}</text>
                <view class="edit-item-actions">
                  <text class="item-action" wx:if="{{index > 0}}" bindtap="moveItemUp" data-index="{{index}}">↑</text>
                  <text class="item-action" wx:if="{{index < editingChecklist.items.length - 1}}" bindtap="moveItemDown" data-index="{{index}}">↓</text>
                  <text class="item-action" bindtap="editItemText" data-index="{{index}}">✎</text>
                  <text class="item-action del" bindtap="deleteItem" data-index="{{index}}">✕</text>
                </view>
              </block>
            </view>
          </view>

          <view class="empty-items" wx:else>
            <text class="empty-items-text">暂无检查项</text>
          </view>

          <view class="add-item" bindtap="showAddItemDialog">
            <text class="add-item-icon">+</text>
            <text class="add-item-text">添加检查项</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 添加项目弹窗 -->
  <view class="modal-overlay" wx:if="{{showAddItemModal}}" bindtap="hideAddItemModal">
    <view class="add-modal" catchtap="stopPropagation">
      <view class="add-modal-title">添加检查项</view>
      <input 
        class="add-modal-input" 
        placeholder="输入检查项内容"
        value="{{newItemText}}"
        bindinput="onNewItemChange"
        maxlength="100"
        focus="{{showAddItemModal}}"
      />
      <view class="add-modal-btns">
        <view class="add-modal-btn cancel" bindtap="hideAddItemModal">取消</view>
        <view class="add-modal-btn confirm" bindtap="addNewItem">添加</view>
      </view>
    </view>
  </view>

  <van-toast id="van-toast" />
  <van-dialog id="van-dialog" />

  <!-- 底部广告 -->
  <view wx:if="{{ !isAdFree }}" class="bottom-ad">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"></ad>
  </view>
</view>
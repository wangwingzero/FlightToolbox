<view class="page-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-content">
      <view class="header-title">ä¸ªäººæ£€æŸ¥å•</view>
      <view class="header-subtitle">ç®¡ç†æ‚¨çš„é£è¡Œæ£€æŸ¥æ¸…å•</view>
    </view>
  </view>

  <!-- æ£€æŸ¥å•ç½‘æ ¼ -->
  <view class="checklist-grid" wx:if="{{ checklists.length > 0 }}">
    <view 
      class="checklist-card {{ item.isCompleted ? 'completed' : '' }}"
      wx:for="{{ checklists }}" 
      wx:key="id"
      bind:tap="openChecklist"
      data-id="{{ item.id }}"
    >
      <view class="card-header">
        <view class="card-title">{{ item.name }}</view>
        <view class="card-actions">
          <view 
            class="action-btn move-up-btn"
            catch:tap="moveChecklistUp"
            data-index="{{ index }}"
            wx:if="{{ index > 0 }}"
          >
            <van-icon name="arrow-up" size="18px" color="#10b981" />
          </view>
          <view 
            class="action-btn move-down-btn"
            catch:tap="moveChecklistDown"
            data-index="{{ index }}"
            wx:if="{{ index < checklists.length - 1 }}"
          >
            <van-icon name="arrow-down" size="18px" color="#10b981" />
          </view>
          <view 
            class="action-btn edit-btn"
            catch:tap="editChecklist"
            data-id="{{ item.id }}"
          >
            <van-icon name="edit" size="18px" />
          </view>
          <view 
            class="action-btn delete-btn"
            catch:tap="deleteChecklist"
            data-id="{{ item.id }}"
          >
            <van-icon name="delete-o" size="18px" />
          </view>
        </view>
      </view>
      
      <view class="card-content">
        <view class="progress-section">
          <view class="progress-bar">
            <view 
              class="progress-fill" 
              style="width: {{ item.progressPercentage || 0 }}%"
            ></view>
          </view>
          <view class="progress-text">
            {{ item.completedCount || 0 }}/{{ item.items ? item.items.length : 0 }} é¡¹å®Œæˆ
          </view>
        </view>
        
        <view class="completion-badge {{ item.isCompleted ? 'completed' : 'in-progress' }}">
          {{ item.isCompleted ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­' }}
        </view>
      </view>
    </view>
    
    <!-- æ–°å»ºæ£€æŸ¥å•å¡ç‰‡ -->
    <view class="add-checklist-card" bind:tap="createCustomChecklist">
      <view class="add-card-content">
        <view class="add-icon">
          <van-icon name="plus" size="48px" color="#667eea" />
        </view>
        <view class="add-title">æ–°å»ºæ£€æŸ¥å•</view>
        <view class="add-subtitle">åˆ›å»ºæ‚¨çš„ä¸“å±æ£€æŸ¥æ¸…å•</view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="checklist-grid" wx:if="{{ checklists.length === 0 }}">
    <view class="empty-state">
      <view class="empty-icon">
        <van-icon name="list-switch" size="80px" color="#e5e7eb" />
      </view>
      <view class="empty-content">
        <view class="empty-title">è¿˜æ²¡æœ‰æ£€æŸ¥å•</view>
        <view class="empty-description">åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªæ£€æŸ¥å•ï¼Œå¼€å§‹ç®¡ç†æ‚¨çš„é£è¡Œæ¸…å•</view>
      </view>
    </view>
    
    <!-- æ–°å»ºæ£€æŸ¥å•å¡ç‰‡ -->
    <view class="add-checklist-card" bind:tap="createCustomChecklist">
      <view class="add-card-content">
        <view class="add-icon">
          <van-icon name="plus" size="48px" color="#667eea" />
        </view>
        <view class="add-title">æ–°å»ºæ£€æŸ¥å•</view>
        <view class="add-subtitle">åˆ›å»ºæ‚¨çš„ä¸“å±æ£€æŸ¥æ¸…å•</view>
      </view>
    </view>
  </view>

  <!-- å¹¿å‘Šå·²ç§»é™¤ -->


  <!-- å¹¿å‘Šå·²ç§»é™¤ -->

  <!-- æ£€æŸ¥å•è¯¦æƒ…å¼¹çª— -->
  <van-popup 
    show="{{ showChecklistDetail }}" 
    position="bottom" 
    round
    bind:close="closeChecklistDetail"
    custom-style="height: 85%"
  >
    <view class="detail-container">
      <!-- è¯¦æƒ…å¤´éƒ¨ -->
      <view class="detail-header">
        <view class="header-top">
          <view class="detail-title">{{ currentChecklist.name }}</view>
          <view class="close-btn" bind:tap="closeChecklistDetail">
            <van-icon name="cross" size="20px" color="rgba(255,255,255,0.8)" />
          </view>
        </view>
        
        <view class="progress-overview">
          <view class="progress-circle">
            <view class="circle-bg">
              <view 
                class="circle-progress" 
                style="--progress: {{ currentChecklist.progressPercentage || 0 }}%"
              ></view>
              <view class="circle-text">
                {{ currentChecklist.progressPercentage || 0 }}%
              </view>
            </view>
          </view>
          
          <view class="progress-stats">
            <view class="stat-item">
              <view class="stat-number">{{ currentChecklist.completedCount || 0 }}</view>
              <view class="stat-label">å·²å®Œæˆ</view>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <view class="stat-number">{{ currentChecklist.items ? currentChecklist.items.length : 0 }}</view>
              <view class="stat-label">æ€»è®¡</view>
            </view>
          </view>
          
          <!-- è“è‰²èƒŒæ™¯å†…çš„ç¼–è¾‘æŒ‰é’® -->
          <view class="edit-btn-in-blue" bind:tap="editCurrentChecklist">
            ç¼–è¾‘æ£€æŸ¥å•
          </view>
        </view>
      </view>

      <!-- æ£€æŸ¥é¡¹ç›®åˆ—è¡¨ -->
      <view class="detail-content">
        <van-checkbox-group value="{{ checkedItems }}" bind:change="onCheckboxChange">
          <view class="items-list">
            <view 
              class="item-card {{ (checkedItems && checkedItems.includes(item.id)) ? 'completed' : '' }}"
              wx:for="{{ currentChecklist.items }}" 
              wx:key="id"
              bind:tap="toggleCheckbox"
              data-item-id="{{ item.id }}"
            >
              <view class="item-checkbox">
                <van-checkbox 
                  name="{{ item.id }}" 
                  checked="{{ checkedItems && checkedItems.includes(item.id) }}"
                  disabled="{{ false }}"
                  shape="square"
                />
              </view>
              
              <view class="item-content">
                <view class="item-text">{{ item.text }}</view>
                <view class="item-status" wx:if="{{ checkedItems && checkedItems.includes(item.id) }}">
                  <van-icon name="success" size="16px" color="#10b981" />
                  <text>å·²å®Œæˆ</text>
                </view>
              </view>
            </view>
          </view>
        </van-checkbox-group>
      </view>

      <!-- åº•éƒ¨é‡ç½®æŒ‰é’® -->
      <view class="detail-actions">
        <van-button 
          type="default" 
          size="normal"
          icon="replay"
          bind:click="resetChecklist"
          plain
          class="reset-only-btn"
        >
          é‡ç½®æ£€æŸ¥å•
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- æ–°å»º/ç¼–è¾‘æ£€æŸ¥å•å¼¹çª— -->
  <van-popup 
    show="{{ showEditDialog }}" 
    position="bottom" 
    round
    bind:close="closeEditDialog"
    custom-style="height: 85%"
  >
    <view class="edit-container">
      <!-- ç¼–è¾‘å¤´éƒ¨ -->
      <view class="edit-header">
        <view class="header-top">
          <view class="edit-title">
            {{ editMode === 'create' ? 'æ–°å»ºæ£€æŸ¥å•' : 'ç¼–è¾‘æ£€æŸ¥å•' }}
          </view>
          <view class="close-btn" bind:tap="closeEditDialog">
            <van-icon name="cross" size="24px" color="#9ca3af" />
          </view>
        </view>
        
        <view class="edit-progress" wx:if="{{ editMode === 'edit' }}">
          <view class="progress-indicator">
            <view class="step active">
              <view class="step-number">1</view>
              <view class="step-label">åŸºæœ¬ä¿¡æ¯</view>
            </view>
            <view class="step-line"></view>
            <view class="step active">
              <view class="step-number">2</view>
              <view class="step-label">æ£€æŸ¥é¡¹ç›®</view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç¼–è¾‘å†…å®¹ -->
      <view class="edit-content">
        <!-- åŸºæœ¬ä¿¡æ¯è¾“å…¥ -->
        <view class="form-section">
          <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
          <view class="form-item">
            <van-field
              label="æ£€æŸ¥å•åç§°"
              placeholder="è¯·è¾“å…¥æ£€æŸ¥å•åç§°"
              value="{{ editingChecklist.name }}"
              bind:input="onNameChange"
              class="custom-field"
            />
          </view>
        </view>

        <!-- æ£€æŸ¥é¡¹ç›®ç®¡ç† -->
        <view class="form-section">
          <view class="section-header">
            <view class="section-title">æ£€æŸ¥é¡¹ç›®</view>
            <view class="section-actions">
              <view class="item-count">{{ editingChecklist.items.length }} é¡¹</view>
              <view class="quick-add-btn" bind:tap="focusAddInput">
                <van-icon name="plus" size="16px" color="#667eea" />
                <text>å¿«é€Ÿæ·»åŠ </text>
              </view>
            </view>
          </view>
          
          <!-- æ–°é¡¹ç›®æ·»åŠ åŒºåŸŸ -->
          <view class="add-new-section">
            <van-field
              placeholder="è¾“å…¥æ–°çš„æ£€æŸ¥é¡¹ç›®"
              value="{{ newItemText }}"
              bind:input="onNewItemChange"
              bind:confirm="addNewItem"
              confirm-type="done"
              class="add-input-field"
              focus="{{ focusAddInput }}"
            >
              <van-button 
                slot="button" 
                size="normal" 
                type="primary"
                bind:click="addNewItem"
                disabled="{{ !newItemText }}"
                class="add-btn"
              >
                æ·»åŠ 
              </van-button>
            </van-field>
          </view>
          
          <!-- é¡¹ç›®åˆ—è¡¨ -->
          <view class="items-editor-new">
            <view 
              class="edit-item-card-new {{ editingItemIndex === index ? 'editing' : '' }}"
              wx:for="{{ editingChecklist.items }}" 
              wx:key="index"
              data-index="{{ index }}"
            >
              <!-- å·¦ä¾§æ“ä½œåŒº -->
              <view class="item-left-actions">
                <view class="drag-handle" bind:touchstart="onDragStart" bind:touchmove="onDragMove" bind:touchend="onDragEnd">
                  <van-icon name="bars" size="20px" color="#9ca3af" />
                </view>
                <view class="item-number">{{ index + 1 }}</view>
              </view>
              
              <!-- ä¸­é—´å†…å®¹åŒº -->
              <view class="item-content-area">
                <van-field
                  wx:if="{{ editingItemIndex === index }}"
                  value="{{ editingItemText }}"
                  placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°"
                  bind:input="onEditingItemTextChange"
                  bind:confirm="saveItemText"
                  bind:blur="cancelEditItem"
                  confirm-type="done"
                  focus="{{ true }}"
                  class="editing-field"
                />
                <view wx:else class="item-display-new" bind:tap="editItemText" data-index="{{ index }}">
                  <view class="item-text-new">{{ item.text }}</view>
                  <view class="edit-hint">ç‚¹å‡»ç¼–è¾‘</view>
                </view>
              </view>
              
              <!-- å³ä¾§æ“ä½œåŒº -->
              <view class="item-right-actions">
                <view class="action-btn move-up-btn" bind:tap="moveItemUp" data-index="{{ index }}" wx:if="{{ index > 0 }}">
                  <van-icon name="arrow-up" size="20px" color="#10b981" />
                </view>
                <view class="action-btn move-down-btn" bind:tap="moveItemDown" data-index="{{ index }}" wx:if="{{ index < editingChecklist.items.length - 1 }}">
                  <van-icon name="arrow-down" size="20px" color="#10b981" />
                </view>
                <view class="action-btn delete-btn" bind:tap="deleteItem" data-index="{{ index }}">
                  <van-icon name="delete-o" size="20px" color="#ef4444" />
                </view>
              </view>
            </view>
          </view>
          
          <!-- ç©ºçŠ¶æ€ -->
          <view class="empty-items" wx:if="{{ editingChecklist.items.length === 0 }}">
            <van-icon name="list-switch" size="48px" color="#d1d5db" />
            <view class="empty-text">è¿˜æ²¡æœ‰æ£€æŸ¥é¡¹ç›®</view>
            <view class="empty-hint">åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªæ£€æŸ¥é¡¹ç›®</view>
          </view>
        </view>
      </view>

      <!-- åº•éƒ¨æ“ä½œæ  -->
      <view class="edit-actions">
        <view class="action-group-horizontal">
          <van-button 
            type="primary" 
            size="large"
            icon="success"
            bind:click="saveChecklist"
            class="save-btn-half"
          >
            {{ editMode === 'create' ? 'åˆ›å»ºæ£€æŸ¥å•' : 'ä¿å­˜æ›´æ”¹' }}
          </van-button>
          
          <van-button 
            type="default" 
            size="large"
            bind:click="closeEditDialog"
            plain
            class="cancel-btn-half"
          >
            å–æ¶ˆ
          </van-button>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- Toast ç»„ä»¶ -->
  <van-toast id="van-toast" />
  
  <!-- Dialog ç»„ä»¶ -->
  <van-dialog id="van-dialog" />

  <!-- ğŸ¯ åŸºäºContext7æœ€ä½³å®è·µï¼šé¡¹ç›®æ“ä½œèœå• -->
  <van-action-sheet
    show="{{ showItemActionSheet }}"
    actions="{{ itemActions }}"
    bind:close="closeItemActionSheet"
    bind:select="onItemActionSelect"
    cancel-text="å–æ¶ˆ"
    description="é€‰æ‹©è¦æ‰§è¡Œçš„æ“ä½œ"
  />
</view> 
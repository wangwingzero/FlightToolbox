<view class="container page-content">
  <!-- æ–¹å‘æ ‡ç­¾é¡µ (ä¸Šè¡Œ/ä¸‹è¡Œ/å…¨éƒ¨) -->
  <view class="direction-tabs-container">
    <scroll-view class="direction-tabs-scroll" scroll-x scroll-with-animation enhanced>
      <view class="direction-tabs-wrapper">
        <view
          wx:for="{{ directionTabs }}"
          wx:key="id"
          class="direction-tab-item {{ activeDirection === item.id ? 'active' : '' }}"
          bind:tap="onDirectionTabTap"
          data-id="{{ item.id }}"
        >
          <view class="direction-badge">{{ item.count }}</view>
          <view class="direction-title">{{ item.name }}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-section cpdlc-search">
    <van-search
      value="{{ searchValue }}"
      placeholder="æœç´¢ç”µæ–‡ç¼–å·ã€ç”¨é€”æˆ–æ ¼å¼"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>

  <!-- äºŒçº§åˆ†ç±»æ ‡ç­¾ (æ¨ªå‘æ»šåŠ¨) -->
  <view wx:if="{{ categoryList.length > 1 }}" class="category-chips-container">
    <scroll-view scroll-x class="category-chips-scroll" enable-flex>
      <view class="category-chips">
        <view
          wx:for="{{ categoryList }}"
          wx:key="name"
          class="category-chip {{ activeCategory === item.name ? 'active' : '' }}"
          bind:tap="onCategoryChange"
          data-category="{{ item.name }}"
        >
          <text class="chip-text">{{ item.name }}</text>
          <text class="chip-count">{{ item.count }}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç”µæ–‡åˆ—è¡¨ -->
  <view class="messages-container">
    <!-- ç©ºçŠ¶æ€ -->
    <van-empty
      wx:if="{{ displayedMessages.length === 0 }}"
      image="search"
      description="æœªæ‰¾åˆ°ç›¸å…³ç”µæ–‡"
    />

    <!-- ç”µæ–‡åˆ—è¡¨ -->
    <view wx:else class="messages-list">
      <block wx:for="{{ displayedMessages }}" wx:key="id" wx:for-index="idx">
        <view
          class="message-card"
          bind:tap="onMessageTap"
          data-message="{{ item }}"
        >
          <!-- å¡ç‰‡å¤´éƒ¨ -->
          <view class="card-header">
            <view class="card-title-row">
              <view class="message-id-badge {{ item.direction === 'uplink' ? 'badge-uplink' : 'badge-downlink' }}">
                {{ item.direction === 'uplink' ? 'ä¸Šè¡Œ' : 'ä¸‹è¡Œ' }} {{ item.id }}
              </view>
              <view class="category-tag">{{ item.category }}</view>
            </view>

            <!-- ç´§æ€¥å’Œå‘Šè­¦çº§åˆ«å¾½ç«  -->
            <view class="status-badges">
              <view class="urgent-badge {{ item.urgent === 'D' ? 'badge-distress' : item.urgent === 'U' ? 'badge-urgent' : item.urgent === 'M' ? 'badge-medium' : 'badge-normal' }}">
                {{ item.urgent === 'D' ? 'é‡é™©' : item.urgent === 'U' ? 'ç´§æ€¥' : item.urgent === 'M' ? 'ä¸­ç­‰' : 'æ­£å¸¸' }}
              </view>
              <view class="alert-badge {{ item.alert === 'H' ? 'badge-alert-high' : item.alert === 'M' ? 'badge-alert-medium' : item.alert === 'L' ? 'badge-alert-low' : 'badge-alert-none' }}">
                å‘Šè­¦{{ item.alert === 'H' ? 'é«˜' : item.alert === 'M' ? 'ä¸­' : item.alert === 'L' ? 'ä½' : 'æ— ' }}
              </view>
            </view>
          </view>

          <!-- è‹±æ–‡æ ¼å¼ -->
          <view class="format-en">{{ item.format_en }}</view>

          <!-- ä¸­æ–‡æ ¼å¼ -->
          <view class="format-zh">{{ item.format_zh }}</view>

          <!-- ç”µæ–‡ç”¨é€” -->
          <view class="purpose-box">
            <view class="purpose-label">ç”¨é€”:</view>
            <view class="purpose-text">{{ item.purpose }}</view>
          </view>

          <!-- æ“ä½œæç¤º -->
          <view class="action-hint">
            <view class="hint-icon">ğŸ‘†</view>
            <view class="hint-text">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</view>
          </view>
        </view>

        <!-- ç¬¬ä¸€ä¸ªç»“æœåæ’å…¥æ¨ªå¹…å¹¿å‘Š -->
        <view wx:if="{{ idx === 0 }}" class="ad-banner-container">
          <ad unit-id="adunit-2f5afef0d27dc863" ad-type="banner" ad-intervals="30"
              bindload="onAdLoad" binderror="onAdError"></ad>
        </view>

      </block>

      <!-- åŠ è½½æ›´å¤š -->
      <view wx:if="{{ hasMore }}" class="load-more-container">
        <view class="load-more-btn" bind:tap="onLoadMore">
          <van-loading type="spinner" size="16px" />
          <text class="load-more-text">åŠ è½½æ›´å¤š</text>
        </view>
      </view>

      <!-- å·²åŠ è½½å…¨éƒ¨ -->
      <view wx:else class="load-complete">
        <view class="load-complete-text">å·²æ˜¾ç¤ºå…¨éƒ¨ {{ filteredCount }} æ¡ç”µæ–‡</view>
      </view>
    </view>
  </view>

  <!-- åŠŸèƒ½è¯´æ˜ -->
  <view class="tips-section">
    <view class="tips-title">ğŸ’¡ ä½¿ç”¨è¯´æ˜</view>
    <view class="tips-content">
      <view class="tip-item">â€¢ CPDLC - ç®¡åˆ¶å‘˜ä¸é£è¡Œå‘˜æ•°æ®é“¾é€šä¿¡ç”µæ–‡æŸ¥è¯¢</view>
      <view class="tip-item">â€¢ ä¸Šè¡Œç”µæ–‡: ç®¡åˆ¶å‘˜å‘é€ç»™é£è¡Œå‘˜çš„ç”µæ–‡</view>
      <view class="tip-item">â€¢ ä¸‹è¡Œç”µæ–‡: é£è¡Œå‘˜å‘é€ç»™ç®¡åˆ¶å‘˜çš„ç”µæ–‡</view>
      <view class="tip-item">â€¢ æ”¯æŒç”µæ–‡ç¼–å·ã€ç”¨é€”æè¿°ã€æ ¼å¼æœç´¢</view>
      <view class="tip-item">â€¢ å®Œå…¨ç¦»çº¿å¯ç”¨,æ— éœ€ç½‘ç»œè¿æ¥</view>
    </view>
  </view>

  <!-- æ¨ªå¹…å¹¿å‘Š -->
  <view class="ad-banner-container">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"
        bindload="onAdLoad" binderror="onAdError"></ad>
  </view>

</view>

<!-- è¯¦æƒ…å¼¹çª— - å‚è€ƒä½“æ£€æ ‡å‡†UIè®¾è®¡ -->
<van-popup
  show="{{ showModal }}"
  bind:close="onModalClose"
  position="bottom"
  round="{{ true }}"
  close-on-click-overlay="{{ true }}"
  custom-style="height: 85vh; overflow: hidden;"
>
  <view class="detail-popup">
    <!-- å¼¹çª—æ ‡é¢˜æ  - ç´«è‰²æ¸å˜èƒŒæ™¯ -->
    <view class="popup-header">
      <view class="popup-header-content">
        <view class="popup-title">
          {{ selectedMessage.direction === 'uplink' ? 'ä¸Šè¡Œç”µæ–‡' : 'ä¸‹è¡Œç”µæ–‡' }} {{ selectedMessage.id }}
        </view>
        <view class="popup-subtitle">{{ selectedMessage.category }}</view>
      </view>
      <view class="popup-close-btn" bind:tap="onModalClose" catchtap="onModalClose">
        <van-icon name="cross" size="20px" color="white" />
      </view>
    </view>

    <!-- æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
    <scroll-view scroll-y class="popup-content" enable-flex enhanced show-scrollbar="{{ false }}">

      <!-- ç”µæ–‡ä¿¡æ¯åŒºå— -->
      <view class="info-block">
        <view class="info-block-title">ç”µæ–‡ä¿¡æ¯</view>
        <view class="info-block-content">
          <view class="info-row">
            <text class="info-label">ç¼–å·</text>
            <text class="info-value">{{ selectedMessage.id }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">æ–¹å‘</text>
            <text class="info-value">{{ selectedMessage.direction === 'uplink' ? 'ä¸Šè¡Œ(ç®¡åˆ¶å‘˜â†’é£è¡Œå‘˜)' : 'ä¸‹è¡Œ(é£è¡Œå‘˜â†’ç®¡åˆ¶å‘˜)' }}</text>
          </view>
          <view class="info-row">
            <text class="info-label">åˆ†ç±»</text>
            <text class="info-value">{{ selectedMessage.category }}</text>
          </view>
        </view>
      </view>

      <!-- ç”µæ–‡ç”¨é€”åŒºå— -->
      <view class="info-block">
        <view class="info-block-title">ç”µæ–‡ç”¨é€”</view>
        <view class="info-block-content">
          <view class="purpose-content">{{ selectedMessage.purpose }}</view>
        </view>
      </view>

      <!-- ç”µæ–‡æ ¼å¼åŒºå— -->
      <view class="info-block">
        <view class="info-block-title">ç”µæ–‡æ ¼å¼ Format</view>
        <view class="info-block-content">
          <view class="format-section">
            <view class="format-label">è‹±æ–‡æ ¼å¼</view>
            <view class="format-value-en">{{ selectedMessage.format_en }}</view>
          </view>
          <view class="format-section">
            <view class="format-label">ä¸­æ–‡æ ¼å¼</view>
            <view class="format-value-zh">{{ selectedMessage.format_zh }}</view>
          </view>
        </view>
      </view>

      <!-- ç”µæ–‡å±æ€§åŒºå— -->
      <view class="info-block">
        <view class="info-block-title">ç”µæ–‡å±æ€§</view>
        <view class="info-block-content">
          <view class="attribute-row">
            <text class="attribute-label">ç´§æ€¥çº§åˆ«</text>
            <view class="urgent-badge-detail {{ selectedMessage.urgent === 'D' ? 'badge-distress' : selectedMessage.urgent === 'U' ? 'badge-urgent' : selectedMessage.urgent === 'M' ? 'badge-medium' : 'badge-normal' }}">
              {{ selectedMessage.urgent === 'D' ? 'é‡é™© Distress' : selectedMessage.urgent === 'U' ? 'ç´§æ€¥ Urgent' : selectedMessage.urgent === 'M' ? 'ä¸­ç­‰ Medium' : selectedMessage.urgent === 'L' ? 'ä½ Low' : 'æ­£å¸¸ Normal' }}
            </view>
          </view>
          <view class="attribute-row">
            <text class="attribute-label">å‘Šè­¦çº§åˆ«</text>
            <view class="alert-badge-detail {{ selectedMessage.alert === 'H' ? 'badge-alert-high' : selectedMessage.alert === 'M' ? 'badge-alert-medium' : selectedMessage.alert === 'L' ? 'badge-alert-low' : 'badge-alert-none' }}">
              {{ selectedMessage.alert === 'H' ? 'é«˜ High' : selectedMessage.alert === 'M' ? 'ä¸­ Medium' : selectedMessage.alert === 'L' ? 'ä½ Low' : 'æ—  None' }}
            </view>
          </view>
          <view class="attribute-row">
            <text class="attribute-label">å›ç­”è¦æ±‚</text>
            <text class="attribute-value">
              {{ selectedMessage.response === 'W/U' ? 'ç…§åŠ/ä¸èƒ½ W/U' : selectedMessage.response === 'Y' ? 'éœ€è¦ Y' : selectedMessage.response === 'N' ? 'ä¸éœ€è¦ N' : selectedMessage.response === 'R' ? 'æ”¶åˆ° R' : selectedMessage.response === 'A/N' ? 'æ˜¯/å¦ A/N' : selectedMessage.response }}
            </text>
          </view>
        </view>
      </view>

      <!-- çº§åˆ«è¯´æ˜åŒºå— -->
      <view class="info-block">
        <view class="info-block-title">çº§åˆ«è¯´æ˜</view>
        <view class="info-block-content">
          <view class="level-description">
            <view class="level-item">
              <text class="level-label">ç´§æ€¥çº§åˆ«:</text>
              <text class="level-text">N-æ­£å¸¸, L-ä½, M-ä¸­ç­‰, U-ç´§æ€¥, D-é‡é™©</text>
            </view>
            <view class="level-item">
              <text class="level-label">å‘Šè­¦çº§åˆ«:</text>
              <text class="level-text">N-æ— , L-ä½, M-ä¸­, H-é«˜</text>
            </view>
            <view class="level-item">
              <text class="level-label">å›ç­”è¦æ±‚:</text>
              <text class="level-text">N-ä¸éœ€è¦, Y-éœ€è¦, R-æ”¶åˆ°, W/U-ç…§åŠ/ä¸èƒ½, A/N-æ˜¯/å¦</text>
            </view>
          </view>
        </view>
      </view>

      <!-- æ•°æ®æ¥æºåŒºå— -->
      <view class="info-block">
        <view class="info-block-title">æ•°æ®æ¥æº</view>
        <view class="info-block-content">
          <view class="source-content">
            <view class="source-main">AC-91-FS-2016-32</view>
            <view class="source-subtitle">èˆªç©ºé€šä¿¡ç¨‹åºæŒ‡å—</view>
          </view>
        </view>
      </view>

    </scroll-view>
  </view>
</van-popup>

<van-toast id="van-toast" />

<!--é•¿èˆªçº¿æ¢ç­é¡µé¢ - åˆ†æ­¥å¼•å¯¼å¼è®¾è®¡-->
<view class="container">
  <!-- ç¾åŒ–çš„é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <view class="header-title">
      <text class="title-icon">âœˆï¸</text>
      <text class="title-text">é•¿èˆªçº¿æ¢ç­</text>
    </view>
    <view class="header-subtitle">ä¸“ä¸šé£è¡Œå‘˜å·¥å…· - åˆ†æ­¥å¼•å¯¼å¼æ¢ç­è®¡åˆ’ç”Ÿæˆ</view>
  </view>

  <!-- åˆ†æ­¥å¼•å¯¼ç»„ä»¶ -->
  <step-guide
    steps="{{ stepConfig }}"
    current-step="{{ currentStep }}"
    show-preview="{{ true }}"
    preview-title="ğŸš€ å®æ—¶æ¢ç­å®‰æ’é¢„è§ˆ"
    bind:stepchange="onStepChange"
    bind:next="onNextStep"
    bind:prev="onPrevStep"
    bind:complete="onComplete"
    disable-next="{{ !canProceedToNext }}"
  >
    <!-- å®æ—¶é¢„è§ˆå†…å®¹ -->
    <view slot="preview" class="preview-content">
      <!-- åŸºç¡€æ±‡æ€»ä¿¡æ¯ -->
      <view class="preview-summary">
        <view class="summary-item">
          <text class="summary-label">èµ·é£æ—¶é—´:</text>
          <text class="summary-value">{{ departureTimeDisplay || 'æœªè®¾ç½®' }}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">é¢„è®¡åˆ°è¾¾:</text>
          <text class="summary-value">{{ estimatedArrival || 'è®¡ç®—ä¸­' }}</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æœºç»„é…ç½®:</text>
          <text class="summary-value">{{ crewCount }}å¥—æœºç»„ / {{ rotationRounds }}è½®æ¢ç­</text>
        </view>
        <view class="summary-item">
          <text class="summary-label">æ•ˆç‡è¯„åˆ†:</text>
          <text class="summary-value efficiency-{{ efficiencyScore >= 80 ? 'good' : efficiencyScore >= 60 ? 'normal' : 'poor' }}">{{ efficiencyScore }}/100</text>
        </view>
      </view>
      
      <!-- åˆ†æ­¥é¢„è§ˆè¯¦æƒ… -->
      <view class="step-preview-detail" wx:if="{{ stepPreviewData }}">
        <view class="preview-step-header">
          <text class="preview-step-icon">{{ stepPreviewData.stepIcon }}</text>
          <text class="preview-step-title">{{ stepPreviewData.stepTitle }}</text>
        </view>
        <view class="preview-items-list">
          <view 
            wx:for="{{ stepPreviewData.previewItems }}" 
            wx:key="index"
            class="preview-item preview-status-{{ item.status }}"
          >
            <view class="preview-item-content">
              <text class="preview-item-label">{{ item.label }}:</text>
              <text class="preview-item-value">{{ item.value }}</text>
            </view>
            <view class="preview-item-indicator">
              <text class="status-icon status-{{ item.status }}">{{ item.status === 'success' ? 'âœ“' : item.status === 'warning' ? 'âš ' : item.status === 'error' ? 'âœ—' : 'â„¹' }}</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{ (currentStep / 5) * 100 }}%"></view>
      </view>
      <view class="progress-text">é…ç½®è¿›åº¦: {{ Math.round((currentStep / 5) * 100) }}%</view>
      
      <!-- å¿«é€Ÿæ“ä½œæç¤º -->
      <view class="quick-tips" wx:if="{{ currentStep < 5 }}">
        <text class="tip-text">ğŸ’¡ å®æ—¶é¢„è§ˆä¼šæ ¹æ®æ‚¨çš„é…ç½®è‡ªåŠ¨æ›´æ–°</text>
      </view>
    </view>

    <!-- æ­¥éª¤å†…å®¹ -->
    <view slot="content">
      <!-- ç¬¬1æ­¥ï¼šèˆªç­åŸºæœ¬ä¿¡æ¯ -->
      <view class="step-card" wx:if="{{ currentStep === 1 }}">
        <view class="step-title">
          <text class="step-icon">ğŸ›«</text>
          <text>ç¬¬ä¸€æ­¥ï¼šèˆªç­åŸºæœ¬ä¿¡æ¯</text>
        </view>
        <view class="step-description">è®¾ç½®èµ·é£æ—¶é—´å’Œé£è¡Œæ—¶é•¿ï¼Œè¿™æ˜¯è®¡ç®—æ¢ç­å®‰æ’çš„åŸºç¡€</view>
        
        <!-- èµ·é£æ—¶é—´è®¾ç½® -->
        <view class="input-group">
          <view class="input-label">èµ·é£æ—¶é—´</view>
          <view class="input-field" bind:tap="showDepartureTimePicker">
            <text class="field-value {{ !departureTimeDisplay ? 'placeholder' : '' }}">
              {{ departureTimeDisplay || 'ç‚¹å‡»é€‰æ‹©èµ·é£æ—¶é—´' }}
            </text>
            <text class="field-icon">ğŸ•</text>
          </view>
        </view>

        <!-- é£è¡Œæ—¶é—´è®¾ç½® -->
        <view class="input-group">
          <view class="input-label">é£è¡Œæ—¶é—´</view>
          <view class="input-field" bind:tap="showFlightDurationPicker">
            <text class="field-value">{{ flightHours }}å°æ—¶{{ flightMinutes }}åˆ†é’Ÿ</text>
            <text class="field-icon">â±ï¸</text>
          </view>
        </view>

        <!-- éªŒè¯æç¤º -->
        <view class="validation-tip" wx:if="{{ step1Validated }}">
          <text class="tip-icon">âœ…</text>
          <text class="tip-text">åŸºæœ¬ä¿¡æ¯å·²é…ç½®å®Œæˆ</text>
        </view>
      </view>

      <!-- ç¬¬2æ­¥ï¼šæœºç»„é…ç½® -->
      <view class="step-card" wx:if="{{ currentStep === 2 }}">
        <view class="step-title">
          <text class="step-icon">ğŸ‘¥</text>
          <text>ç¬¬äºŒæ­¥ï¼šæœºç»„é…ç½®</text>
        </view>
        <view class="step-description">è®¾ç½®æœºç»„å¥—æ•°å’Œåˆ†é…æ–¹å¼</view>
        
        <!-- æœºç»„å¥—æ•° -->
        <view class="input-group">
          <view class="input-label">æœºç»„å¥—æ•°</view>
          <view class="stepper-container">
            <view class="stepper-button" bind:tap="changeCrewCount" data-delta="-1">-</view>
            <view class="stepper-value">{{ crewCount }}å¥—</view>
            <view class="stepper-button" bind:tap="changeCrewCount" data-delta="1">+</view>
          </view>
        </view>

        <!-- åˆ†é…æ–¹å¼è¯´æ˜ -->
        <view class="info-card">
          <view class="info-header">
            <text class="info-icon">ğŸ“Š</text>
            <text class="info-title">åˆ†é…æ–¹å¼</text>
          </view>
          <view class="info-content">
            <text>æ€»é£è¡Œæ—¶é—´ Ã· æœºç»„å¥—æ•° Ã· æ¢ç­è½®æ•°</text>
            <text class="info-detail">é‡‡ç”¨å¹³å‡åˆ†é…ç­–ç•¥ï¼Œç¡®ä¿æ¯å¥—æœºç»„å·¥ä½œæ—¶é—´åŸºæœ¬ç›¸ç­‰</text>
          </view>
        </view>

        <!-- éªŒè¯æç¤º -->
        <view class="validation-tip" wx:if="{{ step2Validated }}">
          <text class="tip-icon">âœ…</text>
          <text class="tip-text">æœºç»„é…ç½®å·²å®Œæˆ</text>
        </view>
      </view>

      <!-- ç¬¬3æ­¥ï¼šæ¢ç­è§„åˆ™è®¾ç½® -->
      <view class="step-card" wx:if="{{ currentStep === 3 }}">
        <view class="step-title">
          <text class="step-icon">ğŸ”„</text>
          <text>ç¬¬ä¸‰æ­¥ï¼šæ¢ç­è§„åˆ™è®¾ç½®</text>
        </view>
        <view class="step-description">é…ç½®ç¬¬ä¸€å¥—æœºç»„å’Œå…¶ä»–æœºç»„çš„æ¢ç­è§„åˆ™</view>
        
        <!-- ç¬¬ä¸€å¥—æœºç»„è§„åˆ™ -->
        <view class="rule-card">
          <view class="rule-header">
            <text class="rule-icon">ğŸ¥‡</text>
            <text class="rule-title">ç¬¬ä¸€å¥—æœºç»„</text>
          </view>
          <view class="rule-content">
            <view class="rule-item">
              <text class="rule-label">è´Ÿè´£é˜¶æ®µ:</text>
              <text class="rule-value">èµ·é£ + ç€é™†</text>
            </view>
            <view class="rule-item">
              <text class="rule-label">å·¥ä½œæ¨¡å¼:</text>
              <text class="rule-value">èµ·é£æ—¶é—´ = å¹³å‡æ—¶é—´ - è¿›é©¾é©¶èˆ±æ—¶é—´</text>
            </view>
            <view class="rule-item">
              <text class="rule-label">ç€é™†å‡†å¤‡:</text>
              <text class="rule-value">ç€é™†å‰æŒ‡å®šæ—¶é—´é‡æ–°ä¸Šåº§</text>
            </view>
          </view>
        </view>

        <!-- å…¶ä»–æœºç»„è§„åˆ™ -->
        <view class="rule-card">
          <view class="rule-header">
            <text class="rule-icon">ğŸ”¢</text>
            <text class="rule-title">å…¶ä»–æœºç»„</text>
          </view>
          <view class="rule-content">
            <view class="rule-item">
              <text class="rule-label">è´Ÿè´£é˜¶æ®µ:</text>
              <text class="rule-value">å·¡èˆªè½®æ¢</text>
            </view>
            <view class="rule-item">
              <text class="rule-label">å·¥ä½œæ¨¡å¼:</text>
              <text class="rule-value">ç¬¬2å¥—æœºç»„ä½¿ç”¨å¹³å‡æ—¶é—´</text>
            </view>
            <view class="rule-item">
              <text class="rule-label">ç»§ç»­è½®æ¢:</text>
              <text class="rule-value">åç»­æœºç»„æŒ‰åºç»§ç»­è½®æ¢</text>
            </view>
          </view>
        </view>

        <!-- éªŒè¯æç¤º -->
        <view class="validation-tip" wx:if="{{ step3Validated }}">
          <text class="tip-icon">âœ…</text>
          <text class="tip-text">æ¢ç­è§„åˆ™å·²ç¡®è®¤</text>
        </view>
      </view>

      <!-- ç¬¬4æ­¥ï¼šé«˜çº§è®¾ç½® -->
      <view class="step-card" wx:if="{{ currentStep === 4 }}">
        <view class="step-title">
          <text class="step-icon">âš™ï¸</text>
          <text>ç¬¬å››æ­¥ï¼šé«˜çº§è®¾ç½®</text>
        </view>
        <view class="step-description">é…ç½®æ¢ç­è½®æ•°å’Œè¿›é©¾é©¶èˆ±æ—¶é—´</view>
        
        <!-- æ¢ç­è½®æ•° -->
        <view class="input-group">
          <view class="input-label">æ¢ç­è½®æ•°</view>
          <view class="stepper-container">
            <view class="stepper-button" bind:tap="changeRotationRounds" data-delta="-1">-</view>
            <view class="stepper-value">{{ rotationRounds }}è½®</view>
            <view class="stepper-button" bind:tap="changeRotationRounds" data-delta="1">+</view>
          </view>
        </view>

        <!-- è¿›é©¾é©¶èˆ±æ—¶é—´ -->
        <view class="input-group">
          <view class="input-label">è¿›é©¾é©¶èˆ±æ—¶é—´</view>
          <view class="input-field" bind:tap="showLandingAdvanceTimePicker">
            <text class="field-value">{{ landingAdvanceHours }}å°æ—¶{{ landingAdvanceMinutes }}åˆ†é’Ÿ</text>
            <text class="field-icon">ğŸ•</text>
          </view>
          <view class="input-hint">ç€é™†å‰å¤šä¹…ç¬¬ä¸€å¥—æœºç»„è¿›å…¥é©¾é©¶èˆ±å€¼ç­</view>
        </view>

        <!-- è®¡ç®—é¢„è§ˆ -->
        <view class="calculation-card">
          <view class="calc-header">
            <text class="calc-icon">ğŸ§®</text>
            <text class="calc-title">è®¡ç®—é¢„è§ˆ</text>
          </view>
          <view class="calc-content">
            <view class="calc-item">
              <text class="calc-label">æ¯å¥—æœºç»„å¹³å‡æ—¶é—´:</text>
              <text class="calc-value">{{ averageTimeDisplay }}</text>
            </view>
            <view class="calc-item">
              <text class="calc-label">æ€»æ¢ç­æ¬¡æ•°:</text>
              <text class="calc-value">{{ totalRotations }}æ¬¡</text>
            </view>
          </view>
        </view>

        <!-- éªŒè¯æç¤º -->
        <view class="validation-tip" wx:if="{{ step4Validated }}">
          <text class="tip-icon">âœ…</text>
          <text class="tip-text">é«˜çº§è®¾ç½®å·²é…ç½®</text>
        </view>
      </view>

      <!-- ç¬¬5æ­¥ï¼šé¢„è§ˆç¡®è®¤ -->
      <view class="step-card" wx:if="{{ currentStep === 5 }}">
        <view class="step-title">
          <text class="step-icon">ğŸ‘€</text>
          <text>ç¬¬äº”æ­¥ï¼šé¢„è§ˆç¡®è®¤</text>
        </view>
        <view class="step-description">æŸ¥çœ‹å®Œæ•´çš„æ¢ç­å®‰æ’ï¼Œç¡®è®¤æ— è¯¯åç”Ÿæˆæœ€ç»ˆç»“æœ</view>
        
        <!-- é…ç½®æ±‡æ€» -->
        <view class="summary-card">
          <view class="summary-header">
            <text class="summary-icon">ğŸ“‹</text>
            <text class="summary-title">é…ç½®æ±‡æ€»</text>
          </view>
          <view class="summary-grid">
            <view class="summary-row">
              <text class="summary-label">èµ·é£æ—¶é—´:</text>
              <text class="summary-value">{{ departureTimeDisplay }}</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">é£è¡Œæ—¶é—´:</text>
              <text class="summary-value">{{ flightHours }}å°æ—¶{{ flightMinutes }}åˆ†é’Ÿ</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">æœºç»„å¥—æ•°:</text>
              <text class="summary-value">{{ crewCount }}å¥—</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">æ¢ç­è½®æ•°:</text>
              <text class="summary-value">{{ rotationRounds }}è½®</text>
            </view>
            <view class="summary-row">
              <text class="summary-label">è¿›é©¾é©¶èˆ±æ—¶é—´:</text>
              <text class="summary-value">ç€é™†å‰{{ landingAdvanceHours }}å°æ—¶{{ landingAdvanceMinutes }}åˆ†é’Ÿ</text>
            </view>
          </view>
        </view>

        <!-- æ¢ç­å®‰æ’é¢„è§ˆ -->
        <view class="schedule-preview" wx:if="{{ previewSchedule.length > 0 }}">
          <view class="schedule-header">
            <text class="schedule-icon">ğŸ“…</text>
            <text class="schedule-title">æ¢ç­å®‰æ’é¢„è§ˆ</text>
          </view>
          <view class="schedule-list">
            <view 
              wx:for="{{ previewSchedule }}" 
              wx:key="index"
              class="schedule-item {{ item.phase }}"
            >
              <view class="schedule-crew">ç¬¬{{ item.crewNumber }}å¥—æœºç»„</view>
              <view class="schedule-phase">{{ item.phaseText }}</view>
              <view class="schedule-time">{{ item.displayStartTime }} - {{ item.displayEndTime }}</view>
              <view class="schedule-duration">{{ item.displayDuration }}</view>
            </view>
          </view>
        </view>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <view class="generate-section">
          <button class="generate-button" bind:tap="generateFinalResult">
            <text class="button-icon">ğŸš€</text>
            <text class="button-text">ç”Ÿæˆå®Œæ•´æ¢ç­å®‰æ’</text>
          </button>
        </view>
      </view>
    </view>
  </step-guide>

  <!-- è®¡ç®—ç»“æœå±•ç¤º -->
  <view wx:if="{{ showResult && rotationResult }}" class="result-section">
    <!-- æˆåŠŸæ ‡é¢˜ -->
    <view class="success-header">
      <view class="success-icon">ğŸ‰</view>
      <view class="success-title">æ¢ç­å®‰æ’ç”ŸæˆæˆåŠŸ</view>
      <view class="success-subtitle">ä¸“ä¸šçº§é•¿èˆªçº¿æ¢ç­è®¡åˆ’</view>
    </view>

    <!-- è¯¦ç»†å€¼å‹¤å®‰æ’ -->
    <view class="detailed-schedule">
      <view class="schedule-header">
        <text class="schedule-icon">ğŸ“Š</text>
        <text class="schedule-title">è¯¦ç»†å€¼å‹¤å®‰æ’</text>
      </view>
      
      <view class="duty-list">
        <view 
          wx:for="{{ rotationResult.dutySchedule }}" 
          wx:key="index"
          class="duty-card {{ item.phase === 'takeoff' ? 'takeoff-phase' : item.phase === 'landing' ? 'landing-phase' : 'crew-' + item.crewNumber }}"
        >
          <view class="duty-header">
            <view class="duty-tag">
              {{ item.phase === 'takeoff' ? 'èµ·é£' : item.phase === 'landing' ? 'ç€é™†' : 'å·¡èˆª' }}
            </view>
            <view class="duty-crew">ç¬¬{{ item.crewNumber }}å¥—æœºç»„</view>
          </view>
          <view class="duty-content">
            <view class="duty-time">{{ item.displayStartTime }} - {{ item.displayEndTime }}</view>
            <view class="duty-duration">{{ item.displayDuration }}</view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="action-button secondary" bind:tap="resetToFirstStep">
        <text class="button-icon">ğŸ”„</text>
        <text class="button-text">é‡æ–°é…ç½®</text>
      </button>
      <button class="action-button primary" bind:tap="shareRotation">
        <text class="button-icon">ğŸ“‹</text>
        <text class="button-text">å¤åˆ¶å®‰æ’</text>
      </button>
    </view>
  </view>
</view>

<!-- æ—¶é—´é€‰æ‹©å™¨å¼¹çª—ä¿æŒåŸæœ‰çš„è®¾è®¡ -->
<van-popup
  show="{{ showDepartureTimePicker }}"
  bind:close="closeDepartureTimePicker"
  position="bottom"
  round="{{ true }}"
>
  <van-datetime-picker
    type="time"
    value="{{ departureTimeValue }}"
    bind:confirm="confirmDepartureTime"
    bind:cancel="closeDepartureTimePicker"
    title="é€‰æ‹©èµ·é£æ—¶é—´"
  />
</van-popup>

<van-popup
  show="{{ showFlightDurationPicker }}"
  bind:close="closeFlightDurationPicker"
  position="bottom"
  round="{{ true }}"
>
  <van-picker
    columns="{{ flightDurationColumns }}"
    bind:confirm="confirmFlightDuration"
    bind:cancel="closeFlightDurationPicker"
    title="é€‰æ‹©é£è¡Œæ—¶é—´"
    show-toolbar="{{ true }}"
    confirm-button-text="ç¡®è®¤"
    cancel-button-text="å–æ¶ˆ"
  />
</van-popup>

<van-popup
  show="{{ showLandingAdvanceTimePicker }}"
  bind:close="closeLandingAdvanceTimePicker"
  position="bottom"
  round="{{ true }}"
>
  <van-picker
    columns="{{ landingAdvanceTimeColumns }}"
    bind:confirm="confirmLandingAdvanceTime"
    bind:cancel="closeLandingAdvanceTimePicker"
    title="é€‰æ‹©è¿›é©¾é©¶èˆ±æ—¶é—´"
    show-toolbar="{{ true }}"
    confirm-button-text="ç¡®è®¤"
    cancel-button-text="å–æ¶ˆ"
  />
</van-popup>
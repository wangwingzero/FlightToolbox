<!-- 长航线换班页面 - 分步式引导界面 -->
<view class="container">
  
  <!-- 顶部进度指示器 -->
  <view class="progress-container">
    <view class="progress-header">
      <text class="progress-title">长航线换班配置</text>
      <text class="progress-subtitle">步骤 {{currentStep}}/{{totalSteps}}</text>
    </view>
    
    <!-- 步骤指示器 -->
    <view class="steps-indicator">
      <view wx:for="{{steps}}" wx:key="id" class="step-item {{item.id <= currentStep ? 'active' : ''}} {{item.id === currentStep ? 'current' : ''}}" bindtap="goToStep" data-step="{{item.id}}">
        <view class="step-icon-wrapper">
          <van-icon name="{{item.icon}}" size="20px" color="{{item.id <= currentStep ? '#fff' : '#999'}}" />
          <view wx:if="{{item.id < steps.length}}" class="step-line {{item.id < currentStep ? 'active' : ''}}"></view>
        </view>
        <text class="step-name">{{item.name}}</text>
      </view>
    </view>
  </view>

  <!-- 步骤内容区域 -->
  <view class="step-content" animation="{{stepAnimation}}">
    
    <!-- 第一步：基本信息 -->
    <view wx:if="{{currentStep === 1}}" class="step-panel">
      <view class="step-header">
        <van-icon name="clock-o" size="48px" color="#ff9500" />
        <text class="step-title">设置航班基本信息</text>
        <text class="step-desc">请配置起飞时间和预计飞行时长</text>
      </view>
      
      <van-cell-group custom-class="form-group">
        <!-- 起飞时间 -->
        <van-cell 
          title="起飞时间" 
          title-class="cell-title"
          value="{{ departureTimeDisplay || '请选择起飞时间' }}"
          value-class="{{departureTimeDisplay ? 'cell-value' : 'cell-placeholder'}}"
          is-link
          bind:click="showDepartureTimePicker"
          custom-class="input-cell"
        >
          <van-icon slot="icon" name="clock-o" size="20px" color="#ff9500" custom-class="cell-icon" />
        </van-cell>

        <!-- 飞行时间 -->
        <van-cell 
          title="飞行时间" 
          title-class="cell-title"
          value="{{ flightHours }}小时{{ flightMinutes }}分钟"
          value-class="cell-value"
          is-link
          bind:click="showFlightDurationPicker"
          custom-class="input-cell"
        >
          <van-icon slot="icon" name="underway-o" size="20px" color="#ff9500" custom-class="cell-icon" />
        </van-cell>
      </van-cell-group>
      
      <!-- 快速提示 -->
      <view class="quick-tips">
        <van-icon name="info-o" size="16px" color="#ff9500" />
        <text>提示：选择准确的起飞时间有助于精确计算换班时刻</text>
      </view>
    </view>
    
    <!-- 第二步：机组配置 -->
    <view wx:if="{{currentStep === 2}}" class="step-panel">
      <view class="step-header">
        <van-icon name="friends-o" size="48px" color="#ff9500" />
        <text class="step-title">配置机组信息</text>
        <text class="step-desc">设置机组套数和换班轮数</text>
      </view>
      
      <van-cell-group custom-class="form-group">
        <!-- 机组套数 -->
        <van-cell title="机组套数" title-class="cell-title" center custom-class="stepper-cell">
          <van-icon slot="icon" name="friends-o" size="20px" color="#ff9500" custom-class="cell-icon" />
          <view slot="right-icon" class="stepper-wrapper">
            <van-stepper 
              value="{{ crewCount }}" 
              min="2" 
              max="5" 
              integer
              bind:change="onCrewCountChange"
              input-width="60px"
              button-size="32px"
              custom-class="custom-stepper"
            />
            <text class="stepper-hint">套</text>
          </view>
        </van-cell>
        
        <!-- 换班轮数 -->
        <van-cell title="换班轮数" title-class="cell-title" center custom-class="stepper-cell">
          <van-icon slot="icon" name="exchange" size="20px" color="#ff9500" custom-class="cell-icon" />
          <view slot="right-icon" class="stepper-wrapper">
            <van-stepper 
              value="{{ rotationRounds }}" 
              min="1" 
              max="5" 
              integer
              bind:change="onRotationRoundsChange"
              input-width="60px"
              button-size="32px"
              custom-class="custom-stepper"
            />
            <text class="stepper-hint">轮</text>
          </view>
        </van-cell>
      </van-cell-group>
      
      <!-- 换班规则说明 -->
      <view class="rule-explanation">
        <view class="rule-title">
          <van-icon name="bulb-o" size="18px" color="#ff9500" />
          <text>换班规则说明</text>
        </view>
        <view class="rule-content">
          <view class="rule-item">
            <text class="rule-label">分配方式：</text>
            <text class="rule-value">总飞行时间 ÷ 机组套数 ÷ 轮数</text>
          </view>
          <view class="rule-item">
            <text class="rule-label">当前配置：</text>
            <text class="rule-value">{{crewCount}}套机组，{{rotationRounds}}轮换班</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 第三步：换班规则 -->
    <view wx:if="{{currentStep === 3}}" class="step-panel">
      <view class="step-header">
        <van-icon name="setting-o" size="48px" color="#ff9500" />
        <text class="step-title">设置换班规则</text>
        <text class="step-desc">配置进驾驶舱时间等细节</text>
      </view>
      
      <van-cell-group custom-class="form-group">
        <!-- 进驾驶舱时间 -->
        <van-cell 
          title="进驾驶舱时间" 
          title-class="cell-title"
          value="{{ landingAdvanceHours }}小时{{ landingAdvanceMinutes }}分钟"
          value-class="cell-value"
          label="着陆前多久第一套机组进入驾驶舱"
          is-link
          bind:click="showLandingAdvanceTimePicker"
          custom-class="input-cell"
        >
          <van-icon slot="icon" name="aim" size="20px" color="#ff9500" custom-class="cell-icon" />
        </van-cell>
      </van-cell-group>
      
      <!-- 规则详解 -->
      <view class="rule-details">
        <view class="detail-card">
          <view class="detail-header">
            <van-icon name="user-circle-o" size="24px" color="#0ea5e9" />
            <text>第一套机组</text>
          </view>
          <view class="detail-content">
            <text>负责起飞和着陆阶段</text>
            <text>起飞时间 = 平均时间 - 进驾驶舱时间</text>
          </view>
        </view>
        
        <view class="detail-card">
          <view class="detail-header">
            <van-icon name="friends-o" size="24px" color="#14b8a6" />
            <text>其他机组</text>
          </view>
          <view class="detail-content">
            <text>负责巡航阶段轮换</text>
            <text>按照平均时间依次值班</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 第四步：确认计算 -->
    <view wx:if="{{currentStep === 4}}" class="step-panel">
      <view class="step-header-elegant">
        <van-icon name="certificate" size="54px" color="#ff9500" />
        <text class="step-title-elegant">换班配置总览</text>
        <text class="step-desc-elegant">基于您的配置，系统已自动完成计算</text>
      </view>
      
      <!-- 优化后的配置摘要卡片 -->
      <view class="config-cards">
        <view class="config-card flight-info">
          <view class="card-header">
            <van-icon name="send" size="28px" color="#0ea5e9" />
            <text class="card-title">航班信息</text>
          </view>
          <view class="card-content">
            <view class="info-row">
              <text class="info-label">起飞时间</text>
              <text class="info-value">{{departureTimeDisplay || '未设置'}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">飞行时长</text>
              <text class="info-value">{{flightHours}}小时{{flightMinutes}}分钟</text>
            </view>
          </view>
        </view>
        
        <view class="config-card crew-config">
          <view class="card-header">
            <van-icon name="friends-o" size="28px" color="#14b8a6" />
            <text class="card-title">机组配置</text>
          </view>
          <view class="card-content">
            <view class="info-row">
              <text class="info-label">机组套数</text>
              <text class="info-value">{{crewCount}}套</text>
            </view>
            <view class="info-row">
              <text class="info-label">换班轮数</text>
              <text class="info-value">{{rotationRounds}}轮</text>
            </view>
          </view>
        </view>
        
        <view class="config-card timing-rules">
          <view class="card-header">
            <van-icon name="aim" size="28px" color="#f59e0b" />
            <text class="card-title">时间规则</text>
          </view>
          <view class="card-content">
            <view class="info-row">
              <text class="info-label">进驾驶舱</text>
              <text class="info-value">着陆前{{getLandingAdvanceTimeDisplay()}}</text>
            </view>
            <view class="info-row" wx:if="{{rotationResult}}">
              <text class="info-label">平均时长</text>
              <text class="info-value">每套{{rotationResult.rotationInterval.hours}}小时{{rotationResult.rotationInterval.minutes}}分钟</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 计算状态指示器 -->
      <view class="calculation-status" wx:if="{{!showResult}}">
        <view class="status-icon">
          <van-loading type="spinner" size="32px" color="#ff9500" />
        </view>
        <text class="status-text">正在计算换班安排...</text>
        <text class="status-desc">系统正在基于您的配置生成最优化方案</text>
      </view>
      
      <!-- 计算完成提示 -->
      <view class="calculation-complete" wx:if="{{showResult && rotationResult}}">
        <view class="complete-icon">
          <van-icon name="checked" size="36px" color="#28a745" />
        </view>
        <text class="complete-text">计算完成</text>
        <text class="complete-desc">已为您生成详细的换班时间安排</text>
      </view>
    </view>
    
  </view>
  
  <!-- 底部导航按钮 -->
  <view class="navigation-bar">
    <van-button 
      wx:if="{{currentStep > 1}}" 
      type="default" 
      size="normal"
      custom-class="nav-button prev-button"
      bind:click="prevStep"
    >
      <van-icon name="arrow-left" />
      <text> 上一步</text>
    </van-button>
    
    <view wx:if="{{currentStep === 1}}" class="nav-spacer"></view>
    
    <van-button 
      wx:if="{{currentStep < totalSteps}}" 
      type="primary" 
      size="normal"
      custom-class="nav-button next-button"
      bind:click="nextStep"
      disabled="{{!canGoNext}}"
    >
      <text>下一步 </text>
      <van-icon name="arrow" />
    </van-button>
  </view>
  
  <!-- 计算结果 -->
  <view wx:if="{{ showResult && rotationResult }}" class="result-section" id="result-section">
    
    <!-- 结果标题 -->
    <view class="result-header-elegant">
      <view class="result-icon-wrapper">
        <van-icon name="checked" size="40px" color="#ffffff" />
      </view>
      <view class="result-text-wrapper">
        <text class="result-title-elegant">换班安排已生成</text>
        <text class="result-subtitle">基于您的配置计算的最优方案</text>
      </view>
    </view>

    <!-- 详细值勤安排 -->
    <view class="duty-schedule-container">
      <view class="schedule-header">
        <van-icon name="manager-o" size="24px" color="#ff9500" />
        <text class="schedule-title">详细值勤安排</text>
      </view>
      
      <view class="duty-timeline">
        <view 
          wx:for="{{ rotationResult.dutySchedule }}" 
          wx:key="index"
          class="duty-item {{ item.phase === 'takeoff' ? 'takeoff-phase' : item.phase === 'landing' ? 'landing-phase' : 'crew-' + item.crewNumber }}"
        >
          <view class="duty-marker">
            <view class="marker-dot {{ item.phase === 'takeoff' ? 'takeoff-dot' : item.phase === 'landing' ? 'landing-dot' : 'crew-' + item.crewNumber + '-dot' }}"></view>
            <view wx:if="{{index < rotationResult.dutySchedule.length - 1}}" class="marker-line"></view>
          </view>
          
          <view class="duty-content">
            <view class="duty-header">
              <view class="duty-tag {{ item.phase === 'takeoff' ? 'takeoff-tag' : item.phase === 'landing' ? 'landing-tag' : 'crew-' + item.crewNumber + '-tag' }}">
                {{ item.phase === 'takeoff' ? '起飞' : item.phase === 'landing' ? '着陆' : '巡航' }}
              </view>
              <text class="duty-title">第{{item.crewNumber}}套机组</text>
            </view>
            
            <view class="duty-details">
              <view class="time-range">
                <text class="start-time">{{item.displayStartTime}}</text>
                <view class="time-separator">
                  <view class="separator-line"></view>
                  <van-icon name="arrow" size="12px" color="#999" />
                </view>
                <text class="end-time">{{item.displayEndTime}}</text>
              </view>
              <text class="duration-badge">{{item.displayDuration}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="result-actions">
      <van-button 
        type="default" 
        size="large"
        custom-class="action-button secondary-button"
        bind:click="clearResult"
      >
        <van-icon name="replay" size="18px" />
        <text> 重新计算</text>
      </van-button>
      
      <van-button 
        type="primary" 
        size="large"
        custom-class="action-button primary-button"
        bind:click="shareRotation"
      >
        <van-icon name="share-o" size="18px" />
        <text> 复制安排</text>
      </van-button>
    </view>
  </view>

</view>

<!-- 起飞时间选择器 -->
<van-popup
  show="{{ showDepartureTimePicker }}"
  bind:close="closeDepartureTimePicker"
  position="bottom"
  round="{{ true }}"
>
  <van-datetime-picker
    type="time"
    value="{{ departureTimeValue }}"
    bind:confirm="confirmDepartureTime"
    bind:cancel="closeDepartureTimePicker"
    title="选择起飞时间"
  />
</van-popup>

<!-- 飞行时间选择器 -->
<van-popup
  show="{{ showFlightDurationPicker }}"
  bind:close="closeFlightDurationPicker"
  position="bottom"
  round="{{ true }}"
>
  <van-picker
    columns="{{ flightDurationColumns }}"
    bind:confirm="confirmFlightDuration"
    bind:cancel="closeFlightDurationPicker"
    title="选择飞行时间"
    show-toolbar="{{ true }}"
    confirm-button-text="确认"
    cancel-button-text="取消"
  />
</van-popup>

<!-- 进驾驶舱时间选择器 -->
<van-popup
  show="{{ showLandingAdvanceTimePicker }}"
  bind:close="closeLandingAdvanceTimePicker"
  position="bottom"
  round="{{ true }}"
>
  <van-picker
    columns="{{ landingAdvanceTimeColumns }}"
    bind:confirm="confirmLandingAdvanceTime"
    bind:cancel="closeLandingAdvanceTimePicker"
    title="选择进驾驶舱时间"
    show-toolbar="{{ true }}"
    confirm-button-text="确认"
    cancel-button-text="取消"
  />
</van-popup>
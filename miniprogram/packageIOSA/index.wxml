<!-- IOSA审计页面 -->
<wxs module="helper">
var getCategoryColor = function(englishName) {
  if (!englishName) return 'blue';
  var firstChar = englishName.trim().toUpperCase().substring(0, 1);
  
  if (firstChar >= 'A' && firstChar <= 'D') return 'blue';
  if (firstChar >= 'E' && firstChar <= 'H') return 'green';
  if (firstChar >= 'I' && firstChar <= 'L') return 'orange';
  if (firstChar >= 'M' && firstChar <= 'P') return 'purple';
  if (firstChar >= 'Q' && firstChar <= 'T') return 'red';
  if (firstChar >= 'U' && firstChar <= 'Z') return 'indigo';
  return 'blue';
};

var getCategoryLabel = function(englishName) {
  if (!englishName) return '';
  return englishName.trim().toUpperCase().substring(0, 1);
};

module.exports = {
  getCategoryColor: getCategoryColor,
  getCategoryLabel: getCategoryLabel
};
</wxs>

<view class="ios-container">
  <!-- 顶部背景模糊层 -->
  <view class="header-blur-bg"></view>

  <!-- 搜索与分类区域 -->
  <view class="header-section">
    <!-- 标题栏 (模拟导航栏大标题) -->
    <view class="page-title" style="padding-top: {{safeAreaInsets.top}}px;">IOSA审计</view>
    
    <!-- 搜索框 -->
    <view class="search-container">
      <van-search
        value="{{ searchValue }}"
        placeholder="搜索IOSA术语..."
        bind:change="onSearchChange"
        bind:clear="onSearchClear"
        shape="round"
        background="transparent"
        custom-class="ios-search"
      />
    </view>

    <!-- 分类标签 (Pills/Chips style with Colors) -->
    <scroll-view class="category-scroll" scroll-x scroll-with-animation enhanced show-scrollbar="{{false}}">
      <view class="category-wrapper">
        <view
          wx:for="{{ categoryList }}"
          wx:key="name"
          class="category-chip {{ activeTab === item.name ? 'active' : '' }}"
          data-name="{{ item.name }}"
          bind:tap="onTabChange"
        >
          <text class="chip-text">{{ item.title }}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 列表内容 -->
  <view class="content-section">
    <view wx:if="{{ loading }}" class="loading-container">
      <van-loading size="24px" color="#007AFF" vertical>数据加载中...</van-loading>
    </view>
    
    <view wx:else class="list-container">
      <view wx:if="{{ displayedDefinitions.length > 0 }}" class="term-list">
        <view class="list-header">
          <text class="list-count">共 {{ filteredCount }} 条</text>
        </view>

        <block wx:for="{{ displayedDefinitions }}" wx:key="id" wx:for-index="idx">
          <view 
            class="term-card color-{{helper.getCategoryColor(item.english_name)}}"
            bind:tap="viewDefinitionDetail"
            data-item="{{ item }}"
          >
            <view class="card-indicator"></view>
            <view class="card-content">
              <view class="card-header">
                <view class="term-english">{{ item.english_name }}</view>
                <view class="term-category-badge">{{helper.getCategoryLabel(item.english_name)}}</view>
              </view>
              <view class="term-chinese">{{ item.chinese_name }}</view>
            </view>
            <van-icon name="arrow" class="card-arrow" />
          </view>

          <!-- 广告插入 - 仅在原生广告开关开启时显示 -->
          <view wx:if="{{ idx === 0 && displayedDefinitions.length > 1 && !isAdFree && nativeAdEnabled }}" class="ad-wrapper">
            <ad unit-id="adunit-d7a3b71f5ce0afca" ad-type="banner" ad-intervals="30"></ad>
          </view>
        </block>
        
        <!-- 加载更多 -->
        <view wx:if="{{ hasMore && !isLoadingMore }}" class="load-more-trigger" bind:tap="loadMore">
          <text>加载更多</text>
          <van-icon name="arrow-down" />
        </view>
        
        <view wx:if="{{ isLoadingMore }}" class="bottom-loading">
          <van-loading size="20px" color="#8E8E93" />
        </view>
        
        <view wx:if="{{ !hasMore && displayedDefinitions.length > 0 }}" class="end-mark">
          <view class="end-dot"></view>
        </view>
      </view>

      <!-- 空状态 -->
      <view wx:if="{{ displayedDefinitions.length === 0 }}" class="empty-state">
        <image class="empty-icon" src="/miniprogram/assets/images/icons/empty-search.png" wx:if="{{false}}" /> 
        <!-- 使用 vant empty 作为替代 -->
        <van-empty
          image="search"
          description="{{ searchValue ? '未找到相关术语' : '暂无数据' }}"
        />
      </view>
    </view>
  </view>

  <!-- 详情弹窗 (iOS Sheet Style) -->
  <van-popup
    show="{{ showDetailPopup }}"
    bind:close="closeDetailPopup"
    position="bottom"
    round
    custom-style="height: 90vh; background: #F2F2F7;"
    close-on-click-overlay="{{ true }}"
  >
    <view class="sheet-container">
      <!-- 顶部拖拽条/操作栏 -->
      <view class="sheet-header">
        <view class="sheet-handle"></view>
        <view class="sheet-toolbar">
          <view class="nav-left">
            <view wx:if="{{ canGoBack }}" class="nav-btn back" bind:tap="goBackInHistory">
              <van-icon name="arrow-left" />
              <text>返回</text>
            </view>
          </view>
          <view class="nav-title">术语详情</view>
          <view class="nav-right">
            <view class="nav-btn done" bind:tap="closeDetailPopup">完成</view>
          </view>
        </view>
      </view>

      <scroll-view scroll-y class="sheet-content" enable-flex enhanced show-scrollbar="{{ false }}">
        <view class="detail-body">
          <!-- 标题卡片 -->
          <view class="detail-card header-card">
            <view class="detail-english">{{ detailData.english_name }}</view>
            <view class="detail-chinese">{{ detailData.chinese_name }}</view>
            <view class="detail-tag">IOSA术语</view>
          </view>

          <!-- 定义内容 -->
          <view class="section-title">定义内容</view>
          <view class="detail-card content-card">
            <view class="detail-text">{{ detailData.definition }}</view>
          </view>

          <!-- 等效术语 -->
          <block wx:if="{{ detailData.has_equivalent_terms }}">
            <view class="section-title">等效术语</view>
            <view class="detail-card content-card">
              <view wx:if="{{ detailData.equivalent_terms_array && detailData.equivalent_terms_array.length > 0 }}" class="link-group">
                <view wx:for="{{ detailData.equivalent_terms_array }}" wx:key="*this"
                      class="link-item" 
                      catchtap="onTermClick"
                      data-term="{{ item }}">
                  <text class="link-text">{{ item }}</text>
                  <van-icon name="arrow" color="#C7C7CC" size="14px" />
                </view>
              </view>
              <text wx:else class="detail-text secondary">{{ detailData.equivalent_terms }}</text>
            </view>
          </block>

          <!-- 参见 -->
          <block wx:if="{{ detailData.see_also_array && detailData.see_also_array.length > 0 }}">
            <view class="section-title">参见</view>
            <view class="detail-card content-card">
              <view class="link-group">
                <view wx:for="{{ detailData.see_also_array }}" wx:key="*this" class="link-item" 
                      bind:tap="onTermClick"
                      data-term="{{ item }}">
                  <text class="link-text">{{ item }}</text>
                  <van-icon name="arrow" color="#C7C7CC" size="14px" />
                </view>
              </view>
            </view>
          </block>

          <!-- 来源 -->
          <view class="section-title">来源</view>
          <view class="detail-card content-card">
            <view class="detail-text source">{{ detailData.source }}</view>
          </view>
          
          <!-- 底部占位 -->
          <view class="bottom-spacer"></view>
        </view>
      </scroll-view>
    </view>
  </van-popup>

  <!-- 底部横版广告 -->
  <view wx:if="{{ !isAdFree && nativeAdEnabled }}" class="footer-ad">
    <ad unit-id="adunit-3a1bf3800fa937a2" ad-type="banner" ad-intervals="30"></ad>
  </view>
</view>
<!-- IOSAå®¡è®¡é¡µé¢ - å‚è€ƒäº‹ä»¶è°ƒæŸ¥é¡µé¢æ ·å¼ -->
<view class="container">
  <!-- åˆ†ç±»èœå• -->
  <view class="category-tabs-container">
    <scroll-view class="category-tabs-scroll" scroll-x scroll-with-animation enhanced>
      <view class="category-tabs-wrapper">
        <view
          wx:for="{{ categoryList }}"
          wx:key="name"
          class="category-tab-item {{ activeTab === item.name ? 'active' : '' }}"
          bind:tap="onTabChange"
          data-name="{{ item.name }}"
        >
          <view class="category-badge">{{ item.count }}</view>
          <view class="category-title">{{ item.title }}</view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æœç´¢æ¡† -->
  <view class="search-section incident-search">
    <van-search
      value="{{ searchValue }}"
      placeholder="{{ searchPlaceholder }}"
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      shape="round"
    />
  </view>

  <!-- æœ¯è¯­åˆ—è¡¨å†…å®¹ -->
  <view class="tab-content">
    <view wx:if="{{ loading }}" class="loading-section">
      <van-loading size="24px" vertical>æ•°æ®åŠ è½½ä¸­...</van-loading>
    </view>
    
    <view wx:else class="definitions-section">
      <view wx:if="{{ displayedDefinitions.length > 0 }}" class="results-section">
        <van-cell-group title="IOSAå®¡è®¡æœ¯è¯­ ({{ filteredCount }}æ¡)">
          <block wx:for="{{ displayedDefinitions }}" wx:key="id" wx:for-index="idx">
            <van-cell 
              title="{{ item.chinese_name }}"
              label="{{ item.english_name }}"
              is-link
              bind:click="viewDefinitionDetail"
              data-item="{{ item }}"
              class="definition-cell"
            >
            <view slot="right-icon" class="definition-category">
              <van-tag type="primary" size="mini">IOSA</van-tag>
            </view>
            </van-cell>
          </block>
        </van-cell-group>
        
        <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
        <view wx:if="{{ hasMore && !isLoadingMore }}" class="load-more-section">
          <view class="load-more-btn" bind:tap="loadMore">
            <text class="load-more-text">åŠ è½½æ›´å¤š</text>
            <view class="load-more-icon">ğŸ“–</view>
          </view>
          <view class="load-more-tip">è¿˜æœ‰ {{ filteredCount - displayedDefinitions.length }} æ¡æ•°æ®</view>
        </view>
        
        <!-- åŠ è½½ä¸­çŠ¶æ€ -->
        <view wx:if="{{ isLoadingMore }}" class="loading-section">
          <view class="loading-spinner"></view>
          <text class="loading-text">åŠ è½½ä¸­...</text>
        </view>
        
        <!-- æ²¡æœ‰æ›´å¤šæ•°æ® -->
        <view wx:if="{{ !hasMore && displayedDefinitions.length > 0 }}" class="no-more-section">
          <view class="no-more-icon">âœ…</view>
          <text class="no-more-text">å·²æ˜¾ç¤ºå…¨éƒ¨ {{ displayedDefinitions.length }} æ¡æœ¯è¯­</text>
        </view>
      </view>

      <van-empty
        wx:if="{{ displayedDefinitions.length === 0 && searchValue }}"
        description="æœªæ‰¾åˆ°ç›¸å…³IOSAæœ¯è¯­"
      />
      
      <van-empty
        wx:if="{{ displayedDefinitions.length === 0 && !searchValue }}"
        description="æš‚æ— IOSAæœ¯è¯­æ•°æ®"
        image="search"
      />
    </view>
  </view>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <van-popup
    show="{{ showDetailPopup }}"
    bind:close="closeDetailPopup"
    position="bottom"
    round="{{ true }}"
    close-on-click-overlay="{{ true }}"
    custom-style="height: 85vh; overflow: hidden;"
  >
    <view class="detail-popup-container">
      <!-- å¼¹çª—æ ‡é¢˜æ  -->
      <view class="detail-header">
        <view class="header-left">
          <view wx:if="{{ canGoBack }}" class="back-btn" bind:tap="goBackInHistory" catchtap="goBackInHistory">
            <van-icon name="arrow-left" class="back-icon" />
          </view>
        </view>
        <view class="detail-title">{{ detailData.chinese_name }}</view>
        <view class="header-right">
          <view class="close-btn" bind:tap="closeDetailPopup" catchtap="closeDetailPopup">
            <van-icon name="cross" class="close-icon" />
          </view>
        </view>
      </view>

      <!-- æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
      <scroll-view scroll-y class="detail-content" enable-flex enhanced show-scrollbar="{{ false }}">
        <!-- æœ¯è¯­å®šä¹‰è¯¦æƒ… -->
        <view class="definition-detail">
          <van-cell-group title="æœ¯è¯­ä¿¡æ¯" class="detail-section">
            <van-cell title="ä¸­æ–‡åç§°" value="{{ detailData.chinese_name }}" />
            <van-cell wx:if="{{ detailData.english_name }}" title="è‹±æ–‡åç§°" value="{{ detailData.english_name }}" />
          </van-cell-group>

          <van-cell-group title="å®šä¹‰å†…å®¹" class="detail-section">
            <view class="description-content">
              <view class="description-text">{{ detailData.definition }}</view>
            </view>
          </van-cell-group>

          <!-- ç­‰æ•ˆæœ¯è¯­æ”¾åœ¨å®šä¹‰å†…å®¹ä¹‹å -->
          <van-cell-group wx:if="{{ detailData.has_equivalent_terms }}" title="ç­‰æ•ˆæœ¯è¯­" class="detail-section">
            <view class="equivalent-terms-content">
              <!-- ä¼˜å…ˆæ˜¾ç¤ºé“¾æ¥æ•°ç»„ -->
              <view wx:if="{{ detailData.equivalent_terms_array && detailData.equivalent_terms_array.length > 0 }}" class="equivalent-terms-links">
                <text wx:for="{{ detailData.equivalent_terms_array }}" wx:key="*this"
                      class="term-highlight clickable-term" 
                      catchtap="onTermClick"
                      data-term="{{ item }}">{{ item }}</text>
              </view>
              <!-- å…œåº•æ˜¾ç¤ºåŸå§‹æ–‡æœ¬ -->
              <text wx:else style="color: #64748b; font-size: 28rpx;">{{ detailData.equivalent_terms }}</text>
            </view>
          </van-cell-group>

          <!-- å‚è§é“¾æ¥ -->
          <van-cell-group wx:if="{{ detailData.see_also_array && detailData.see_also_array.length > 0 }}" title="å‚è§" class="detail-section">
            <view class="see-also-links">
              <view wx:for="{{ detailData.see_also_array }}" wx:key="*this" class="see-also-item">
                <text class="term-highlight clickable-term" 
                      bind:tap="onTermClick"
                      data-term="{{ item }}">{{ item }}</text>
              </view>
            </view>
          </van-cell-group>

          <van-cell-group title="æ¥æº" class="detail-section">
            <view class="description-content">
              <view class="source-text">{{ detailData.source }}</view>
            </view>
          </van-cell-group>
        </view>
      </scroll-view>

      <!-- åº•éƒ¨æ“ä½œæ  -->
      <view class="detail-footer">
        <view wx:if="{{ canGoBack }}" class="footer-buttons">
          <van-button type="default" bind:click="goBackInHistory" class="back-button">
            <van-icon name="arrow-left" class="button-icon" />
            è¿”å›
          </van-button>
          <van-button type="primary" bind:click="closeDetailPopup" class="close-button">
            <van-icon name="cross" class="button-icon" />
            å…³é—­
          </van-button>
        </view>
        <van-button wx:else type="primary" block bind:click="closeDetailPopup" class="close-button">
          <van-icon name="cross" class="button-icon" />
          å…³é—­
        </van-button>
      </view>
    </view>
  </van-popup>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view wx:if="{{ !loading && !searchValue }}" class="stats-section">
    <view class="stats-grid">
      <view class="stats-item">
        <text class="stats-number">{{ totalCount || 0 }}</text>
        <text class="stats-label">IOSAæœ¯è¯­</text>
      </view>
      <view class="stats-item">
        <text class="stats-number">{{ filteredCount || 0 }}</text>
        <text class="stats-label">å½“å‰æ˜¾ç¤º</text>
      </view>
    </view>
  </view>
</view>
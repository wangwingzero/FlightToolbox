# FlightToolbox 微信小程序开发指南

## 项目概述

FlightToolbox 是一个专为航空飞行员设计的微信小程序，专注于航空飞行工具和航线录音功能。

### 核心功能
- **🛫 航线飞行模块**：真实机场航线录音播放和学习
- **🔍 万能查询**：ICAO代码、缩写、定义、机场信息查询
- **🧮 飞行计算**：各种航空计算器和工具
- **📻 通信失效程序**：各地区通信失效处理差异程序
- **🛠️ 其他工具**：个人检查单、资质管理、事件报告等

### 技术栈
- **平台**：微信小程序
- **语言**：JavaScript (ES5兼容) + TypeScript
- **UI框架**：Vant Weapp (@vant/weapp)
- **架构**：分包架构，离线优先设计

## 🚨 关键设计原则

### 离线优先 (Offline First)
**必须能够在完全离线环境下正常运行**

#### 为什么必须离线？
1. **飞行安全要求**：飞行员在空中执行任务时，手机必须开启飞行模式
2. **高空网络限制**：万米高空中无法使用移动网络或WiFi
3. **紧急情况处理**：通信失效等紧急情况下，飞行员需要立即访问程序和数据
4. **法规遵循**：民航法规要求飞行过程中关闭无线通信功能

#### 技术要求
- ✅ **所有核心数据必须本地存储**：ICAO代码、机场数据、通信程序等
- ✅ **音频文件必须本地缓存**：航线录音、发音示例等
- ✅ **计算功能本地实现**：不依赖网络API
- ❌ **禁止核心功能依赖网络**

## 项目结构

### 主要目录
```
miniprogram/
├── pages/                    # 主包页面
├── packageA-packageO/        # 分包（数据和功能模块）
├── components/               # 自定义组件
├── data/                    # 核心数据文件
├── utils/                   # 工具函数
├── miniprogram_npm/         # npm依赖（主要是Vant组件）
└── typings/                 # TypeScript类型定义
```

### 分包架构
- **packageA-packageE**: 数据分包（ICAO、缩写、机场、定义等）
- **packageF-packageO**: 功能分包（计算器、工具等）
- **packageAmerica-packageUAE**: 音频分包（按地区分类）
- **packageHealth**: 健康相关数据
- **packagePerformance**: 性能参数数据

## 开发规范

### 语法兼容性
- **主要使用ES5语法**确保兼容性
- **TypeScript文件**：仅用于新功能开发
- **避免使用**：箭头函数、模板字符串、可选链等ES6+特性

### 文件命名规范
- **页面文件**：`index.js`, `index.wxml`, `index.wxss`, `index.json`
- **TypeScript页面**：`index.ts`（新功能）
- **数据文件**：小写英文命名，如 `singapore.js`

### 组件使用
- **UI组件库**：Vant Weapp (@vant/weapp)
- **自定义组件**：放在 `components/` 目录
- **组件引用**：在页面的 `.json` 文件中配置

## 数据管理

### 分包数据加载
使用统一数据管理器 (`utils/data-manager.js`)：
- 异步require和多层兜底机制
- 24小时缓存机制减少重复加载
- 支持数据格式转换

### 本地存储策略
```javascript
// 优先使用本地存储
wx.setStorageSync('key', data)
wx.getStorageSync('key')

// 避免依赖网络请求（核心功能）
// ❌ 禁止：wx.request() 用于核心功能
// ✅ 允许：wx.request() 仅用于非核心的增强功能
```

### 数据兜底机制
1. **第一层**：从对应分包加载数据
2. **第二层**：从主包data目录加载数据
3. **第三层**：使用默认数据

## 音频系统

### 预加载策略
- **关键发现**：预加载分包是音频真机播放的关键
- **2MB限制**：单页面预加载不能超过2MB
- **分散预加载**：利用多个常用页面分散预加载

### 音频分包结构
```
packageCountry/
├── index.js          # 分包入口
├── index.wxml        # 页面模板
├── index.json        # 页面配置
└── *.mp3            # 音频文件
```

## 性能优化

### 分包预加载配置
在 `app.json` 中配置：
```json
{
  "preloadRule": {
    "pages/abbreviations/index": {
      "network": "all",
      "packages": ["packageA", "packageB", "packageC", "packageD"]
    }
  }
}
```

### 启动优化
- 启用初始渲染缓存
- 分包预加载优化启动速度
- 本地数据缓存减少重复加载

## 开发工具和调试

### 必要工具
- **微信开发者工具**：主要开发环境
- **vConsole**：真机调试
- **分包测试功能**：在"我的首页"页面

### 调试要点
- 关注预加载日志：`preloadSubpackages: success`
- 验证分包数据加载：`✅ 成功从packageX加载数据`
- 测试离线功能：飞行模式下测试

## 测试要求

### 离线测试
- **所有新功能必须在飞行模式下测试**
- 确保无网络状态下功能完整可用
- 验证数据加载的兜底机制

### 真机测试
- 音频播放功能必须真机测试
- 分包预加载效果验证
- 性能表现测试

## 常见问题和解决方案

### Vant组件问题
- 使用 `fix-vant-components.cmd` 修复组件问题
- 检查组件路径配置
- 确认npm构建正确

### 分包问题
- 每个分包必须包含页面才能被识别
- 使用异步require进行跨分包数据加载
- 注意分包大小限制

### TypeScript兼容性
- 避免在小程序环境中使用高级TS特性
- 优先使用ES5语法确保兼容性
- 新功能可以使用TS，但要注意编译输出

## 部署和发布

### 版本管理
- 静态数据通过版本更新分发
- 避免依赖实时数据同步
- 本地数据版本管理

### 发布检查清单
- [ ] 离线功能测试通过
- [ ] 音频播放真机测试通过
- [ ] 分包预加载配置正确
- [ ] 性能指标达标
- [ ] 兼容性测试通过

## 重要文件说明

### 核心配置文件
- `app.json`: 小程序配置，包含分包和预加载规则
- `project.config.json`: 项目配置
- `app.ts/app.js`: 应用入口文件

### 关键工具文件
- `utils/data-manager.js`: 统一数据管理器
- `utils/subpackage-loader.js`: 分包加载器
- `utils/audio-config.js`: 音频配置管理
- `utils/theme-manager.js`: 主题管理

### 重要文档
- `docs/complete-audio-integration-guide.md`: 音频系统完整指南
- `.cursor/rules/*.mdc`: 开发规则和最佳实践

## 注意事项

### 强制要求
1. **修改前必须查阅微信小程序官方文档**
2. **所有核心功能必须支持离线运行**
3. **新增音频必须配置预加载**
4. **使用ES5语法确保兼容性**

### 禁止事项
- ❌ 核心功能依赖网络API
- ❌ 使用未经测试的ES6+特性
- ❌ 跳过离线测试
- ❌ 忽略分包大小限制

### 最佳实践
- ✅ 优先使用本地数据
- ✅ 实现多层兜底机制
- ✅ 遵循官方开发指导
- ✅ 保持代码ES5兼容

---

**记住：网络是增强，离线是基础。**

这个项目的核心价值在于为飞行员提供可靠的离线工具，任何开发工作都必须以此为前提。
# FlightToolbox 微信小程序开发指南

## 项目概述

FlightToolbox 是一个专为航空飞行员设计的微信小程序，提供航空飞行工具和航线录音功能。

### 核心功能
- **🛫 航线飞行模块**：真实机场航线录音播放和学习
- **🔍 资料查询**：ICAO代码、缩写、定义、机场信息查询
- **🧮 飞行计算**：各种航空计算器和工具
- **📻 通信失效程序**：各地区通信失效处理差异程序
- **🛠️ 其他工具**：个人检查单、资质管理、事件报告等

### 技术栈
- **框架**：微信小程序原生框架
- **UI组件库**：Vant Weapp v1.11.6
- **语言**：JavaScript (ES5) + TypeScript
- **包管理**：pnpm
- **基础库版本**：3.8.9

## 🚨 核心设计原则

### 1. 离线优先 (Offline First)
**这是不可妥协的底线要求**

- ✅ 所有核心功能必须在飞行模式下正常运行
- ✅ 所有数据必须本地存储（ICAO代码、机场数据、通信程序等）
- ✅ 音频文件必须本地缓存
- ✅ 计算器、检查单、程序查询等无网络依赖
- ❌ 禁止在线API调用作为核心功能依赖
- ❌ 禁止云端存储依赖

**测试要求**：所有新功能必须在飞行模式下验证可用性

### 2. 使用BasePage基类
所有新页面必须继承BasePage基类：

```javascript
var BasePage = require('../../utils/base-page.js');

var pageConfig = {
  data: {
    loading: false,
    list: []
  },
  
  customOnLoad: function(options) {
    console.log('页面加载，参数:', options);
    this.loadData();
  },
  
  loadData: function() {
    var self = this;
    this.loadDataWithLoading(function() {
      return new Promise(function(resolve) {
        setTimeout(function() {
          resolve([{id: 1, name: '示例数据'}]);
        }, 1000);
      });
    }, {
      dataKey: 'list',
      context: '加载数据'
    });
  }
};

Page(BasePage.createPage(pageConfig));
```

### 3. ES5语法兼容性
- 使用ES5语法确保小程序兼容性
- 避免使用`eval`、`new Function`（除`new Function('return this')`）
- 避免使用`Proxy`对象
- 项目已启用ES6转换，但建议优先使用ES5

## 📁 项目结构

### 主要目录
```
miniprogram/                 # 小程序主目录
├── pages/                   # 页面目录
├── components/              # 组件目录
├── utils/                   # 工具类目录
├── data/                    # 主包数据目录
├── packageA-Z/              # 分包目录
├── services/                # 服务层
├── styles/                  # 样式文件
└── typings/                 # TypeScript类型定义

.cursor/rules/               # 开发规则文档
docs/                        # 项目文档
data/                        # 任务数据
```

### 分包架构
项目采用分包策略解决主包2M限制：

- **packageA**: ICAO通信数据 (~200KB)
- **packageB**: 缩写数据 (~232KB)  
- **packageC**: 机场数据 (~100KB)
- **packageCCAR**: CCAR规章数据
- **packageD**: 定义数据 (~114KB)
- **packageHealth**: 健康医学数据
- **packageO**: 运营工具模块
- **packagePerformance**: 性能计算模块
- **package[Country]**: 各国航线录音数据

## 🛠️ 开发规范

### 页面开发
1. **继承BasePage**：所有页面必须使用BasePage基类
2. **错误处理**：使用统一的错误处理机制
3. **数据加载**：使用`loadDataWithLoading`方法
4. **分包数据**：使用`data-manager.js`统一管理

### 分包数据加载
```javascript
// 使用统一数据管理器
const dataManager = require('../../utils/data-manager.js');

// 异步加载分包数据
dataManager.loadIcaoData().then(function(data) {
  // 处理数据
});

// 多层兜底机制：分包→主包→默认数据
```

### 跨分包引用
```javascript
// 使用异步require
require('../packageA/data.js', successCallback, failCallback);

// 禁止直接跨分包引用
// ❌ var data = require('../packageA/data.js');
```

### 音频处理
- 音频文件按地区分包存储
- 支持离线播放
- 使用音频预加载机制

## 🔧 核心工具类

### BasePage (utils/base-page.js)
- 统一页面基类
- 提供数据加载、错误处理、生命周期管理
- 支持分包数据异步加载

### DataManager (utils/data-manager.js)
- 统一分包数据管理
- 24小时缓存机制
- 多层兜底策略

### SubpackageLoader (utils/subpackage-loader.js)
- 分包异步加载工具
- 跨分包require支持

### 其他工具
- `audio-config.js`: 音频配置管理
- `offline-manager.js`: 离线状态管理
- `search-manager.js`: 搜索性能优化
- `qualification-helper.js`: 资质管理计算

## 📱 主要功能模块

### 资料查询
- 支持ICAO代码、缩写、定义、机场信息查询
- 本地全文搜索，无网络依赖
- 使用分包数据，支持大量数据存储

### 飞行计算
- 各种航空专业计算器
- 单位换算工具
- 性能计算模块
- 所有计算本地实现

### 航线录音
- 按国家/地区分包存储
- 支持离线播放
- 真实ATC录音学习

### 通信失效程序
- 各地区差异化程序
- 国内外程序对比
- 紧急情况快速查询

### 个人工具
- 个人检查单管理
- 资质管理（X天Y次计算逻辑）
- 事件报告系统

## 🚀 开发流程

### 快速开始
```bash
# 1. 进入项目目录
cd miniprogram && npm install

# 2. 微信开发者工具
# - 导入项目
# - 工具 -> 构建npm
# - 编译运行

# 3. 测试验证
# - 开启飞行模式测试离线功能
# - 验证分包数据加载
# - 检查音频播放功能
```

### 新功能开发
1. **需求分析**：确认离线可用性要求
2. **数据设计**：规划本地存储方案
3. **分包规划**：确定数据分包策略
4. **页面开发**：使用BasePage基类
5. **离线测试**：飞行模式下完整测试

### 代码审查要点
- ✅ 检查离线功能完整性
- ✅ 验证BasePage使用
- ✅ 确认ES5语法兼容性
- ✅ 检查分包数据加载
- ✅ 验证错误处理机制

## 📋 测试要求

### 离线测试
- 所有功能在飞行模式下测试
- 验证数据加载兜底机制
- 确认音频离线播放

### 性能测试
- 启动性能监控
- 分包预加载效果
- 搜索响应速度

### 兼容性测试
- 不同版本微信客户端
- 不同设备性能表现
- 基础库版本兼容性

## 🔍 调试技巧

### 分包调试
- 使用vConsole查看`preloadSubpackages`日志
- 检查分包数据加载状态
- 验证缓存机制工作

### 性能监控
- 启用初始渲染缓存
- 监控内存使用
- 分析启动耗时

### 错误排查
- 查看BasePage错误日志
- 检查数据管理器状态
- 验证兜底数据可用性

## 📚 重要文档

### 开发规则
- `.cursor/rules/miniprogram-development-guide.mdc`: 微信小程序开发指南
- `.cursor/rules/offline-first-design.mdc`: 离线优先设计规则
- `.cursor/rules/wechat-miniprogram-subpackages.mdc`: 分包开发规则

### 技术文档
- `docs/complete-audio-integration-guide.md`: 音频集成指南
- `分包跨包require修复说明.md`: 分包引用解决方案
- `飞行计算页面设计优化方案.md`: 计算页面优化

### 专业文档
- `RODEX.md`: RODEX广播信息解码
- `RUSSIA.md`: 俄罗斯航空相关信息

## ⚠️ 注意事项

### 禁止事项
- ❌ 核心功能依赖网络API
- ❌ 直接跨分包require
- ❌ 使用eval、Proxy等不兼容语法
- ❌ 忽略离线测试

### 必须遵循
- ✅ 继承BasePage基类
- ✅ 使用统一数据管理器
- ✅ 实现离线优先设计
- ✅ 遵循ES5语法规范
- ✅ 完整错误处理机制

## 🎯 发布检查清单

### 功能检查
- [ ] 所有功能离线可用
- [ ] 分包数据正常加载
- [ ] 音频播放正常
- [ ] 计算功能准确

### 性能检查
- [ ] 启动速度优化
- [ ] 内存使用合理
- [ ] 搜索响应及时
- [ ] 分包预加载有效

### 兼容性检查
- [ ] 基础库版本兼容
- [ ] 不同设备测试
- [ ] 语法兼容性确认
- [ ] 错误处理完善

---

**记住：网络是增强，离线是基础。FlightToolbox必须在任何环境下都能可靠为飞行员服务。**
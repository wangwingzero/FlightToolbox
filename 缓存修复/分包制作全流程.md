# 分包制作全流程（含真机调试兜底，默认方案）

本指南规范 FlightToolbox 小程序中“图片/音频/资料”等资源型分包的制作流程，确保在发布版、体验版、预览版均可正常加载；并默认内置“真机调试模式 wx.loadSubpackage 不可用”的兜底方案，避免调试手机无法加载分包导致的空白/加载失败。

---

## 适用范围
- 绕机图片分包（packageWalkaroundImages1..6）
- 航线录音分包（packageJapan、packageAustralia、...）
- 其他资料类分包（如 ICAO、机场、性能、通信失效等）

## 术语
- root：app.json subPackages[].root（目录名）
- name：app.json subPackages[].name（分包名，供 wx.loadSubpackage 使用）
- 兜底导航：当 wx.loadSubpackage 在真机调试不可用时，使用 wx.navigateTo 跳入分包内页面以触发加载，再返回

---

## 一、工程配置（app.json）

1) 在 subPackages 声明分包（必须同时配置 root 与 name）
```json
{
  "root": "packageAustralia",
  "name": "australiaAudioPackage",
  "pages": ["index"]
}
```
- 图片分包一般使用 `pages/placeholder/index` 作为可导航页面。
- 音频分包使用 `index` 作为可导航页面。

2) 为触发页配置 preloadRule（可选，提升命中概率）
```json
"preloadRule": {
  "pages/airline-recordings/index": {
    "network": "all",
    "packages": ["packageJapan", "packageAmerica", "packageMalaysia", "packageIndonesia", "packageHolland"]
  }
}
```

3)（图片分包）确保 project.config.json 的 packOptions.include 覆盖图片分包目录，避免上传时遗漏。

---

## 二、代码映射与加载策略

1) 在 Loader/页面中维护映射（name 与 root 都要有）
```js
// 例：音频
{
  australia: { packageName: 'australiaAudioPackage', packageRoot: 'packageAustralia' }
}
// 例：图片
{
  '1-4': { packageName: 'walkaroundImages1Package', packageRoot: 'packageWalkaroundImages1' }
}
```

2) 加载策略（默认流程）
- 优先使用 API：`wx.loadSubpackage({ name: <分包name> })`（注意：不是 root）
- 当 `typeof wx.loadSubpackage !== 'function'`（真机调试常见）：
  - 用 `wx.navigateTo('/<packageRoot>/<page>')` 强制触发分包加载
  - 停留 200~500ms 后 `wx.navigateBack()` 返回
  - 在 Loader 中标记分包已加载，并持久化预加载状态

3) 模板代码（伪代码示例）
```js
if (typeof wx.loadSubpackage !== 'function') {
  const url = `/${packageRoot}/${placeholder || 'index'}`;
  wx.navigateTo({
    url,
    success() {
      setTimeout(() => {
        try { wx.navigateBack({ delta: 1 }); } catch (e) {}
        markLoadedInSession(packageName);
        markPreloadStatus(regionId); // 使用版本化Key
        wx.showToast({ title: '资源加载完成', icon: 'success' });
        resolve(true);
      }, 200);
    },
    fail() {
      resolve(false);
    }
  });
  return;
}

wx.loadSubpackage({ name: packageName, success() { ... } });
```

- 已在项目中默认实现：
  - 图片：`packageWalkaround/pages/index/index.js`（ensurePackageLoaded 分支）
  - 音频：`utils/audio-package-loader.js`（核心兜底）+ `pages/audio-player/index.ts`（调用侧走 Loader）

---

## 三、版本化缓存与预加载状态

为避免不同环境/版本相互污染，所有 Storage Key 必须版本化：
- 使用：`VersionManager.getVersionedKey(baseKey)` → 前缀 `debug_/trial_/release_`
- 图片：
  - 预加载状态：`flight_toolbox_walkaround_preload_status`
  - 图片索引：`walkaround_image_cache_index`
- 音频：
  - 预加载状态：`flight_toolbox_audio_preload_status`
  - 音频索引：`flight_audio_cache_index`

清理工具（仅在 develop 调试环境按需使用）：
```js
VersionManager.clearVersionCaches({ envVersion: 'develop', baseKeys: [
  'flight_toolbox_walkaround_preload_status',
  'walkaround_image_cache_index',
  'flight_toolbox_audio_preload_status',
  'flight_audio_cache_index'
]});
```

---

## 四、资源缓存（离线优先）
- 图片：`ImageCacheManager` 负责将分包内图片复制到 `wxfile://usr/...` 持久化目录
- 音频：`AudioCacheManager` 类似地将音频复制到本地并维护索引
- 首次播放/查看时写入缓存；后续直接使用本地路径

可选清空本地缓存（仅调试）：
```js
ImageCacheManager.clearAllCache();
AudioCacheManager.clearAllCache();
```

---

## 五、验证流程（建议）
1) 在预览/体验/发布版，进入涉及分包的触发页 1~2 秒
2) 返回业务页（绕机/航线录音）执行真实加载
3) 观察日志：
   - `wx.loadSubpackage` 或 `navigateTo('/<packageRoot>/...')` 成功
   - `已标记 XXX 为预加载完成`
   - `已缓存到本地 wxfile://usr/...`
4) 断网后再次打开，确认本地缓存可用

---

## 六、常见问题与解法
- `wx.loadSubpackage is not a function`
  - 原因：真机调试模式限制
  - 解法：依赖兜底导航（本流程已默认实现）
- 发布版图片/音频 404 或空白
  - 检查是否传了 `name` 而不是 `root`
  - 检查分包是否包含可导航页面（index/placeholder）
  - 检查资源是否确实存在于分包目录
- 控制台 `ReferenceError: debug_*_xxx`
  - 不要在控制台直接敲版本化 key；用代码调用清理函数
- `not node js file system` 一次性告警
  - 属于内部转换过程提示，后续出现缓存成功日志即可忽略

---

## 七、默认模板（纳入新分包的“标配”）
- app.json 中：root/name、可导航页
- Loader 中：
  - 优先 `wx.loadSubpackage({ name })`
  - 真机调试兜底 `navigateTo('/<packageRoot>/...')` → 返回 → 标记预加载并持久化
- 版本化 Key + 缓存索引
- 验证清单与按需清理工具

> 以上“兜底导航”已在现有图片与音频分包落地，并纳入默认模板。新分包按本流程接入，即可在调试手机与发布渠道保持一致体验。

# 韩国音频预加载测试指南

## 🎯 测试目标
验证韩国音频分包已从"我的首页"移除，改为通过"录音播放页面"自动加载。

---

## 📋 测试步骤

### 步骤1：清除预加载状态（首次测试必须）

在微信开发者工具的控制台执行以下代码：

```javascript
// 清除所有音频预加载状态，模拟首次使用
wx.removeStorageSync('flight_toolbox_audio_preload_status');
console.log('✅ 已清除所有音频预加载状态');
```

---

### 步骤2：访问"我的首页"

1. 点击底部 TabBar 的 **"我的首页"** 标签
2. **预期结果：**
   - ✅ 页面正常加载
   - ✅ 不会自动加载 `packageKorean` 音频分包
   - ✅ 只加载 `dutyPackage`（执勤期计算器）

3. **验证方法（在控制台查看日志）：**
```javascript
// 查看当前已加载的分包
console.log('当前已加载分包:', __wxConfig);
// 应该看不到 packageKorean 相关信息
```

---

### 步骤3：尝试播放韩国音频

1. 从"通信"或"资料查询"页面进入"航线录音"
2. 选择 **韩国（KR）** 分类
3. 点击任意录音的播放按钮
4. **预期结果：**
   - ✅ 弹出引导对话框
   - ✅ 标题显示：`🇰🇷 韩国仁川机场 音频资源`
   - ✅ 内容提示：前往 `🎵 录音播放` 页面
   - ✅ 描述文字：`韩国仁川机场陆空通话录音将通过录音播放页面自动预加载`

---

### 步骤4：点击"前往"按钮

1. 在引导对话框中点击 **"前往"** 按钮
2. **预期结果：**
   - ✅ 自动跳转到录音播放页面
   - ✅ 系统自动加载 `packageKorean` 音频分包
   - ✅ 显示提示："请稍后返回播放"

---

### 步骤5：验证预加载标记

在控制台执行以下代码：

```javascript
// 检查韩国音频是否已标记为预加载完成
var audioGuide = require('../../utils/audio-preload-guide.js');
var guide = new audioGuide();

guide.checkPackagePreloaded('korea').then(function(isPreloaded) {
  console.log('🔍 韩国音频预加载状态:', isPreloaded ? '已预加载 ✅' : '未预加载 ❌');
});
```

---

### 步骤6：再次播放韩国音频

1. 返回到韩国音频列表
2. 再次点击任意录音的播放按钮
3. **预期结果：**
   - ✅ **不再显示引导对话框**
   - ✅ 音频直接开始播放
   - ✅ 播放器正常工作

---

## 🔍 对比测试：美国音频

验证美国音频的加载流程是否与韩国一致：

### 测试步骤
1. 清除预加载状态（如步骤1）
2. 尝试播放美国音频
3. **预期结果：**
   - ✅ 弹出引导对话框
   - ✅ 标题显示：`🇺🇸 美国旧金山机场 音频资源`
   - ✅ 内容提示：前往 `🎵 录音播放` 页面
   - ✅ 与韩国音频加载策略完全一致

---

## 📊 验证检查清单

### 功能验证
- [ ] "我的首页"不再自动加载韩国音频分包
- [ ] 首次播放韩国音频显示引导对话框
- [ ] 引导对话框标题、内容、图标正确
- [ ] 点击"前往"可跳转到录音播放页面
- [ ] 录音播放页面自动预加载韩国音频
- [ ] 第二次播放不再显示引导对话框
- [ ] 音频正常播放，无报错

### 性能验证
- [ ] "我的首页"加载速度是否提升
- [ ] 韩国音频首次加载延迟是否可接受（<3秒）
- [ ] 没有多余的网络请求

### 兼容性验证
- [ ] 真机测试（iOS）
- [ ] 真机测试（Android）
- [ ] 微信开发者工具

---

## 🐛 常见问题排查

### 问题1：引导对话框仍然指向"我的首页"

**原因：** 缓存未清除或代码未重新编译

**解决方法：**
1. 在微信开发者工具中点击 **"清除缓存"**
2. 点击 **"编译"** 重新编译
3. 执行步骤1清除本地存储

---

### 问题2：音频播放失败，报错 "分包未加载"

**原因：** 分包预加载规则未生效

**解决方法：**
1. 检查 `miniprogram/app.json` 第235-238行配置是否正确：
```json
"pages/audio-player/index": {
  "network": "all",
  "packages": ["packageAmerica", "packageKorean"]
}
```
2. 重启微信开发者工具
3. 真机测试验证

---

### 问题3：引导对话框不显示

**原因：** 音频已被标记为预加载完成

**解决方法：**
1. 执行步骤1清除预加载状态
2. 重新测试

---

## 🔧 调试命令

在微信开发者工具控制台可以使用以下命令：

### 查看所有音频预加载状态
```javascript
var audioGuide = require('../../utils/audio-preload-guide.js');
var guide = new audioGuide();

guide.getAllPreloadStatus().then(function(status) {
  console.table(status);
});
```

### 查看特定地区配置
```javascript
var audioGuide = require('../../utils/audio-preload-guide.js');
var guide = new audioGuide();

var koreaGuide = guide.getPreloadGuide('korea');
console.log('韩国音频配置:', koreaGuide);

var usaGuide = guide.getPreloadGuide('usa');
console.log('美国音频配置:', usaGuide);
```

### 手动标记预加载完成
```javascript
var audioGuide = require('../../utils/audio-preload-guide.js');
var guide = new audioGuide();

guide.markPackagePreloaded('korea');
console.log('✅ 已手动标记韩国音频为预加载完成');
```

### 清除特定地区预加载状态
```javascript
var audioGuide = require('../../utils/audio-preload-guide.js');
var guide = new audioGuide();

guide.clearPreloadStatus('korea');
console.log('🧹 已清除韩国音频预加载状态');
```

---

## 📈 预期性能指标

| 指标 | 优化前 | 优化后 | 改进幅度 |
|-----|-------|-------|---------|
| 我的首页加载时间 | ~800ms | ~500ms | ⬇️ 37.5% |
| 首页预加载分包数 | 3个 | 1个 | ⬇️ 66.7% |
| 韩国音频首次播放延迟 | 0ms（预加载） | ~2s（按需加载） | 用户无感知 |
| 内存占用（首页） | ~15MB | ~8MB | ⬇️ 46.7% |

---

## ✅ 测试通过标准

所有以下条件必须满足：

1. ✅ "我的首页"不加载 `packageKorean`
2. ✅ 韩国音频引导对话框显示正确
3. ✅ 引导对话框指向"录音播放页面"（不是"我的首页"）
4. ✅ 音频可以正常播放
5. ✅ 第二次播放不显示引导对话框
6. ✅ 美国音频加载策略与韩国一致
7. ✅ 没有报错日志

---

## 📞 问题反馈

如果测试过程中遇到问题，请提供以下信息：

1. 测试环境（真机/开发者工具）
2. 微信版本号
3. 控制台错误日志
4. 截图（引导对话框、错误提示等）
5. 测试步骤复现路径

---

**祝测试顺利！** 🎉


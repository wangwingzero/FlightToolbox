# GPS欺骗检测系统 - 完整测试指南

## 📱 测试前准备

### 1. 环境检查
- ✅ 微信开发者工具已打开
- ✅ 小程序已编译（点击"编译"按钮）
- ✅ 控制台（Console）已打开
- ✅ 手机GPS已开启并授权给微信

### 2. 测试位置
- ✅ 空旷区域（室外）
- ✅ 避免高楼遮挡
- ✅ 确保手机能接收GPS信号

---

## 🔍 测试步骤

### 阶段1：基础功能验证（5分钟）

#### Step 1.1: 进入驾驶舱页面
```
小程序底部TabBar → 驾驶舱
```

#### Step 1.2: 检查GPS状态
- 查看顶部GPS状态显示：
  - ✅ 应显示"信号正常"（绿色）
  - ❌ 如果显示"无信号"或"未授权"，先解决GPS权限问题

#### Step 1.3: 打开GPS权限调试面板
- 滚动到页面底部
- 点击"GPS权限调试 ▶"展开面板
- 验证以下信息：
  ```
  位置API权限状态:
  - wx.getLocation: 已授权 ✅
  - wx.startLocationUpdate: 运行中 ✅
  - wx.onLocationChange: 监听中 ✅

  实时GPS数据:
  - 定位提供商: gps (GPS) 或 wgs84 (GPS) ✅
  - 定位模式: 高精度模式 ✅
  - GPS获取尝试: 1/3次 严格航空GPS定位成功 ✅
  - 原始GPS高度: XX.XXm (number) ✅
  - 显示高度: XXXft (有效: 是) ✅
  ```

#### Step 1.4: 开启GPS欺骗监控
- 在页面顶部找到"GPS欺骗监控"开关
- 点击开关，弹出确认对话框：
  ```
  GPS欺骗监控
  ⚠️ 此功能仅适用于空中飞行状态

  在地面时请勿开启，以免误报。

  是否同时开启声音提醒？
  ```
- 选择"静音开启"（测试时建议）
- 开关应变为绿色 ✅

---

### 阶段2：缓冲区累积验证（30秒）

#### Step 2.1: 观察控制台日志
打开微信开发者工具的Console标签，应该每秒看到类似日志：

```javascript
🛡️ GPS欺骗检测数据: {
  altitude传入值: 41.23,          // ✅ 应该有数值，不是null
  altitudeValue原始: 135,         // ✅ 英尺高度
  locationData.altitude: 135,      // ✅ 与原始值一致
  isGPSLocation: true,             // ✅ 应该是true
  provider: "gps"                  // ✅ 或 "wgs84"
}

🛡️ 检测器状态: {
  bufferSize: 5,                   // ✅ 应该逐渐增加
  state: "NORMAL",                 // ✅ 初始状态
  dataBuffer长度: 5,               // ✅ 应该与bufferSize接近
  bufferTotalSize: 5               // ✅ 应该与dataBuffer长度一致
}
```

#### Step 2.2: 观察调试面板显示
在"GPS权限调试"面板中，找到橙色背景的欺骗检测区域：

```
欺骗检测缓冲区: 有效数据: X/10 点 (总数: Y)
检测器状态: NORMAL
```

**预期变化过程**：
```
0秒:  有效数据: 0/10 点 (总数: 0)
3秒:  有效数据: 3/10 点 (总数: 3)
6秒:  有效数据: 6/10 点 (总数: 6)
10秒: 有效数据: 10/10 点 (总数: 10)
30秒: 有效数据: 30/10 点 (总数: 30)  ← 缓冲区已满
```

#### Step 2.3: 验证数据有效性

| 显示内容 | 含义 | 是否正常 | 解决方案 |
|---------|------|---------|---------|
| `有效: 0/10 (总数: 0)` | GPS完全无数据 | ❌ | 检查GPS权限和信号 |
| `有效: 0/10 (总数: 10+)` | GPS无高度数据 | ❌ | 网络定位，需要真GPS |
| `有效: 逐渐增加 (总数: 逐渐增加)` | 正常累积中 | ✅ | 继续等待 |
| `有效: 10+ (总数: 10+)` | 缓冲区已满 | ✅ | 检测器就绪 |

---

### 阶段3：欺骗检测触发验证（30秒）

#### Step 3.1: 理解检测逻辑
GPS欺骗检测条件：
- GPS高度数据**持续出现30秒**
- 每3秒为一个检测窗口，共10个窗口
- 至少9个窗口（90%）有有效数据

#### Step 3.2: 触发条件（地面测试）
在地面正常使用时：
- ✅ GPS高度数据持续接收
- ✅ 缓冲区有效数据达到10+
- ✅ 持续30秒以上

**预期结果**：
```
30秒后:
- 检测器状态: NORMAL → SPOOFING
- 顶部出现红色警告: "检测到GPS欺骗 - 首次14:42"
- 控制台输出: "🚨 GPS欺骗检测：NORMAL -> SPOOFING"
```

#### Step 3.3: 验证状态机转换

完整状态转换流程：

```
1. NORMAL (初始状态)
   ↓ [GPS高度持续30秒]

2. SPOOFING (欺骗检测)
   - 顶部红色警告显示
   - 检测器状态: SPOOFING
   - 语音警告播放（如果开启）
   ↓ [GPS高度消失]

3. COOLDOWN (冷却期，10分钟)
   - 警告消失
   - 检测器状态: COOLDOWN
   ↓ [10分钟后]

4. NORMAL (恢复正常)
```

**特殊状态**：
```
COOLDOWN 状态中再次检测到GPS高度
   ↓
SPOOFING_SILENT (静默欺骗)
   - 不显示警告
   - 不播放语音
   - 调试面板显示: SPOOFING_SILENT
```

---

## ⚠️ 常见问题排查

### 问题1: 缓冲区一直显示 0/10 点 (总数: 0)

**诊断步骤**：
1. 查看控制台日志中的 `altitude传入值`
   - 如果为 `null` → GPS管理器未获取到高度
   - 如果有数值 → 继续下一步

2. 查看 `isGPSLocation` 和 `provider`
   - `isGPSLocation: false` → 网络定位
   - `provider: "network"` → 网络定位
   - 需要真GPS定位才能获取高度数据

3. 检查GPS权限和硬件
   ```
   手机设置 → 隐私 → 定位服务 → 微信 → 使用期间允许
   ```

**解决方案**：
- 移动到空旷区域
- 确保GPS已开启
- 重启小程序
- 重新授权位置权限

---

### 问题2: 缓冲区显示 0/10 点 (总数: 10+)

**诊断**：
- 总数增加 → GPS数据正在接收
- 有效数据为0 → altitude字段为null

**原因**：
- 手机使用**网络定位**而非GPS定位
- 网络定位不包含高度数据

**验证**：
查看调试面板：
```
定位提供商: network (网络)  ← ❌ 错误
应该显示: gps (GPS) 或 wgs84 (GPS)  ← ✅ 正确
```

**解决方案**：
- 确保手机GPS已开启
- 移动到室外空旷区域
- 等待手机获取GPS信号（可能需要1-2分钟）
- 查看"GPS获取尝试"是否显示"严格航空GPS定位成功"

---

### 问题3: 缓冲区累积缓慢或不稳定

**现象**：
```
有效数据: 2/10 点 (总数: 8)
有效数据: 3/10 点 (总数: 12)
有效数据: 1/10 点 (总数: 15)  ← 有效数据反而减少
```

**原因**：
- GPS信号不稳定
- altitude数据间歇性丢失
- 60秒滑动窗口导致旧数据被清除

**解决方案**：
- 移动到信号更好的位置
- 避免高楼、树木遮挡
- 等待GPS信号稳定

---

### 问题4: 检测器一直不触发SPOOFING状态

**原因**：
- 需要**持续30秒**的GPS高度数据
- 90%窗口有效性要求（10个窗口中至少9个）

**验证步骤**：
1. 确认有效数据已达到10+
2. 确认至少持续30秒
3. 查看控制台是否有状态转换日志

**如果30秒后仍未触发**：
- 检查 `spoofingDetectionEnabled` 是否为true
- 查看控制台是否有错误日志
- 确认GPS高度数据是连续的（不是间歇性）

---

## 📊 完整测试报告模板

测试完成后，请记录以下信息：

```markdown
# GPS欺骗检测系统测试报告

**测试日期**: 2025-XX-XX
**测试环境**: 微信开发者工具 / 真机调试
**测试位置**: 室内 / 室外

## 1. 基础功能测试

### GPS状态
- [ ] GPS权限已授权
- [ ] 定位提供商: __________ (gps/network)
- [ ] 定位模式: __________ (高精度/普通)
- [ ] GPS高度数据: __________ m

### GPS欺骗监控开关
- [ ] 开关可以正常切换
- [ ] 确认对话框正常显示
- [ ] 语音选项可以选择

## 2. 缓冲区累积测试

### 初始状态 (0秒)
- 有效数据: ____ / 10 点
- 总数: ____ 点
- 检测器状态: __________

### 10秒后
- 有效数据: ____ / 10 点
- 总数: ____ 点
- 检测器状态: __________

### 30秒后
- 有效数据: ____ / 10 点
- 总数: ____ 点
- 检测器状态: __________

## 3. 欺骗检测触发测试

### 触发时间
- 首次检测到欺骗: __________ (时间戳)
- 状态转换: NORMAL → __________

### 警告显示
- [ ] 顶部红色警告显示
- [ ] 警告文本正确
- [ ] 语音警告播放（如果开启）

### 控制台日志
```javascript
// 粘贴关键日志
```

## 4. 问题记录

### 遇到的问题
1. __________
2. __________

### 解决方案
1. __________
2. __________

## 5. 测试结论

- [ ] 所有功能正常
- [ ] 存在已知问题（见上方）
- [ ] 需要进一步优化

**备注**: __________
```

---

## 🎯 预期测试结果总结

### ✅ 正常场景
```
GPS状态: 信号正常 (绿色)
定位提供商: gps (GPS)
定位模式: 高精度模式

0-10秒:  缓冲区累积 0→10点
10-30秒: 缓冲区持续累积 10→30点
30秒后:  触发SPOOFING状态，显示红色警告

控制台日志正常输出，无错误
```

### ❌ 异常场景及解决

**场景A: 网络定位**
```
定位提供商: network (网络)
有效数据: 0/10 (总数: 10+)

→ 解决: 移动到室外，等待GPS信号
```

**场景B: GPS无权限**
```
GPS状态: 未授权 (红色)
有效数据: 0/10 (总数: 0)

→ 解决: 打开手机设置授权位置权限
```

**场景C: GPS信号弱**
```
有效数据波动: 3→5→2→4
总数持续增加

→ 解决: 移动到信号更好的位置
```

---

## 📞 技术支持

如果测试中遇到问题：

1. **收集诊断信息**：
   - 控制台完整日志（包含🛡️标记）
   - GPS权限调试面板截图
   - 手机GPS设置截图

2. **检查关键代码位置**：
   - `index.js` 第1154-1192行 (GPS欺骗检测数据处理)
   - `gps-spoofing-detector.js` 第414-437行 (getStatus方法)
   - `index.wxml` 第408-416行 (调试面板显示)

3. **提供反馈**：
   - 描述具体问题
   - 附上诊断信息
   - 说明测试环境和步骤

---

**最后更新**: 2025-10-15
**测试版本**: v1.0
**文档维护**: Claude Code

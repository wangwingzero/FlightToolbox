---
description: 
globs: 
alwaysApply: true
---
# 微信小程序分包开发规则

## 概述
本规则定义了微信小程序分包开发的最佳实践，基于成功的分包实施经验总结。

## 分包组织原则

### 1. 按数据类型分包
- **packageA**: ICAO通信数据 (~200KB)
- **packageB**: 缩写数据 (~232KB)  
- **packageC**: 机场数据 (~100KB)
- **packageD**: 定义数据 (~114KB)

### 2. 分包结构要求
每个分包必须包含页面才能被微信小程序识别：
```
packageA/
├── index.js      # 分包入口文件
├── index.wxml    # 页面模板
├── index.json    # 页面配置
└── icao900.js    # 数据文件
```

### 3. 数据文件大小控制
- 单个数据文件控制在100-250KB范围内
- 总分包数据量可达650KB+，有效解决主包2M限制

## 技术实现要点

### 1. 统一数据管理器
创建 [data-manager.js](mdc:miniprogram/utils/data-manager.js) 处理所有分包数据加载：
- 使用异步require和多层兜底机制
- 实现缓存机制避免重复加载
- 支持数据格式转换

### 2. 跨分包数据加载
使用异步回调方式进行跨分包require：
```javascript
require('../packageA/data.js', successCallback, failCallback)
```

### 3. 分包配置
在 [app.json](mdc:miniprogram/app.json) 中正确配置：
```json
{
  "subPackages": [
    {
      "root": "packageA",
      "name": "icaoPackage", 
      "pages": ["index"]
    }
  ],
  "preloadRule": {
    "pages/abbreviations/index": {
      "network": "all",
      "packages": ["packageA", "packageB", "packageC", "packageD"]
    }
  }
}
```

### 4. 数据格式处理
支持多种数据格式的自动转换：
- 对象格式（包含chapters字段）→ 数组格式
- 直接数组格式保持不变
- 提供默认数据作为兜底

## 页面集成

### 资料查询页面
[abbreviations/index.ts](mdc:miniprogram/pages/abbreviations/index.ts) 使用统一数据管理器：
```javascript
const dataManager = require('../../utils/data-manager.js')

// 异步加载各类数据
await dataManager.loadIcaoData()
await dataManager.loadAbbreviationsData()
await dataManager.loadAirportData()
await dataManager.loadDefinitionsData()
```

### 测试功能
在 [others/index.ts](mdc:miniprogram/pages/others/index.ts) 中提供分包测试功能：
- 测试所有分包数据加载状态
- 查看缓存状态
- 清除缓存功能

## 预加载优化

### 配置预加载规则
在主要页面配置预加载所有相关分包，提升用户体验：
- 网络策略：`"network": "all"` 不限网络
- 包列表：包含所有数据分包的root名称

### 预加载限制
- 同一页面预下载大小限额2M
- 通过vConsole查看`preloadSubpackages`日志验证

## 兜底策略

### 多层数据加载
1. **第一层**：从对应分包加载数据
2. **第二层**：从主包data目录加载数据  
3. **第三层**：使用默认数据

### 错误处理
- 记录详细的加载日志
- 提供用户友好的错误提示
- 确保应用在任何情况下都能正常运行

## 开发调试

### 日志监控
关注以下关键日志：
- `preloadSubpackages: success` - 预加载成功
- `✅ 成功从packageX加载数据` - 分包数据加载成功
- `No. of subpackages: 4` - 分包数量确认

### 测试验证
使用我的首页页面的测试功能验证：
- 所有分包数据加载状态
- 数据条目数量正确性
- 缓存机制工作状态

## 注意事项

### 分包引用限制
- 分包之间不能直接require，只能通过主包
- 使用分包异步化特性解决跨分包引用
- tabBar页面必须在主包内

### 兼容性考虑
- 分包异步化需要基础库2.11.2+
- 低版本客户端自动降级为整包模式
- 避免在分包页面使用app.wxss样式

## 成功指标

### 技术指标
- ✅ 4个分包正常识别和预下载
- ✅ 总计650KB+数据成功分包
- ✅ 主包大小有效控制
- ✅ 数据加载流畅无感知

### 用户体验
- 页面加载速度提升
- 数据查询响应及时
- 离线缓存机制完善
- 错误处理用户友好

这套分包方案为后续小程序开发提供了可复用的架构模式。


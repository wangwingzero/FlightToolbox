---
description: 
globs: 
alwaysApply: true
---
# 微信小程序离线优先设计规则

## 概述
FlightToolbox小程序必须严格遵循离线优先设计原则，确保在无网络环境下所有核心功能都能正常工作。这是针对飞行员在驾驶舱等无网络环境下使用的刚性需求。

## 核心设计原则

### 1. 离线优先（Offline First）
- **底线要求**：所有核心功能必须在无网络状态下正常工作
- **设计理念**：先考虑离线场景，再考虑在线增强
- **用户场景**：飞行员在驾驶舱、偏远机场等无网络环境下的使用需求

### 2. 数据本地化存储
- **静态数据**：所有查询数据（缩写、机场、ICAO通信、规范性文件等）必须本地存储
- **计算功能**：所有换算和计算逻辑必须本地实现，不依赖网络API
- **用户数据**：个人清单、历史记录等用户数据优先本地存储

## 技术实现要求

### 1. 分包数据管理
参考 [data-manager.js](mdc:miniprogram/utils/data-manager.js) 的实现：
- 使用分包存储大量静态数据
- 实现多层兜底机制：分包→主包→默认数据
- 24小时缓存机制减少重复加载

### 2. 本地存储策略
```javascript
// 优先使用本地存储
wx.setStorageSync('key', data)
wx.getStorageSync('key')

// 避免依赖网络请求
// ❌ 禁止：wx.request() 用于核心功能
// ✅ 允许：wx.request() 仅用于非核心的增强功能
```

### 3. 离线计算实现
- 所有换算公式本地实现，参考 [unit-converter](mdc:miniprogram/pages/unit-converter/index.ts)
- 航空专业计算本地实现，参考 [aviation-calculator](mdc:miniprogram/pages/aviation-calculator/index.ts)
- 避免依赖在线计算服务

### 4. 数据预加载机制
在 [app.json](mdc:miniprogram/app.json) 中配置分包预加载：
```json
{
  "preloadRule": {
    "pages/abbreviations/index": {
      "network": "all",
      "packages": ["packageA", "packageB", "packageC", "packageD", "packageE"]
    }
  }
}
```

## 功能模块离线要求

### 1. 常用换算页面
- ✅ 所有单位换算公式本地实现
- ✅ 不依赖网络API进行换算
- ✅ 历史记录本地存储

### 2. 特殊计算页面
- ✅ 航空专业计算公式本地实现
- ✅ 飞机性能数据本地存储
- ✅ 计算结果本地缓存

### 3. 资料查询页面
- ✅ 所有查询数据通过分包本地存储
- ✅ 搜索功能本地实现，不依赖服务器
- ✅ 支持离线全文搜索

### 4. 其他功能页面
- ✅ 个人清单本地存储和管理
- ✅ 我的首页离线可用
- ✅ 性能监控数据本地记录

## 网络功能限制

### 允许的网络功能
- 数据更新检查（非阻塞）
- 用户反馈提交（可选）
- 性能数据上报（可选）
- 版本更新检查（可选）

### 禁止的网络依赖
- ❌ 核心计算功能依赖网络API
- ❌ 查询功能依赖在线数据库
- ❌ 换算功能依赖在线服务
- ❌ 任何阻塞性的网络请求

## 用户体验要求

### 1. 离线状态提示
- 在有网络时可显示在线状态
- 离线时不显示错误提示
- 所有功能在离线状态下正常可用

### 2. 数据同步策略
- 优先使用本地数据
- 网络可用时后台同步更新
- 同步失败不影响核心功能

### 3. 性能优化
- 启用初始渲染缓存，参考 [performance-monitor.js](mdc:miniprogram/utils/performance-monitor.js)
- 分包预加载优化启动速度
- 本地数据缓存减少重复加载

## 测试验证要求

### 1. 离线测试
- 所有新功能必须在飞行模式下测试
- 确保无网络状态下功能完整可用
- 验证数据加载的兜底机制

### 2. 性能测试
- 离线状态下的启动性能
- 本地数据查询响应速度
- 内存使用优化

### 3. 用户场景测试
- 模拟驾驶舱环境测试
- 长时间离线使用测试
- 数据完整性验证

## 开发规范

### 1. 代码审查要点
- 检查是否有网络依赖的核心功能
- 验证本地数据的完整性
- 确认兜底机制的有效性

### 2. 新功能开发
- 优先考虑离线实现方案
- 网络功能仅作为增强，不能是必需
- 提供完整的本地数据支持

### 3. 数据更新策略
- 静态数据通过版本更新分发
- 避免依赖实时数据同步
- 本地数据版本管理

## 应急预案

### 1. 数据损坏处理
- 多层数据兜底机制
- 默认数据集作为最后保障
- 用户数据恢复机制

### 2. 功能降级策略
- 核心功能永不降级
- 增强功能可优雅降级
- 用户体验保持一致

## 总结

离线优先是FlightToolbox小程序的核心设计原则和不可妥协的底线要求。所有开发工作都必须以此为前提，确保飞行员在任何环境下都能可靠使用小程序的所有核心功能。

**记住：网络是增强，离线是基础。**


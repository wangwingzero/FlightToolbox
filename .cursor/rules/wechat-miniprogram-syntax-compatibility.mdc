---
description: 
globs: 
alwaysApply: true
---
# 微信小程序语法兼容性规则

## 概述
微信小程序的JavaScript运行环境对ES6+语法支持有限，某些现代JavaScript语法会导致编译错误或运行时错误。本规则基于[微信小程序官方JavaScript支持文档](mdc:https:/developers.weixin.qq.com/miniprogram/dev/framework/runtime/js-support.html)，确保代码在微信小程序环境中的兼容性。

## 运行限制
基于安全考虑，小程序中不支持动态执行JS代码，即：
- **不支持使用** `eval` 执行JS代码  
- **不支持使用** `new Function` 创建函数
- `new Function('return this')` 除外

## 标准 ECMAScript 支持
小程序的JS执行环境在不同平台上的执行环境存在差异，因此导致不同平台对ECMAScript标准的支持存在差异。

小程序基础库提供了限量的ES6 Polyfill，可以使用`core-js` Polyfill，`core-js`可以弥补各个环境的标准API补充。

**重要注意**：平台对ECMAScript语法的支持差异无法抹平，当你需要使用一些高级语法时，如`async/await`时，则需要借助代码转换工具来支持这些语法。

## 禁止使用的语法

### 1. 可选链操作符（Optional Chaining `?.`）
**❌ 禁止使用：**
```javascript
// 错误写法
obj?.property
obj?.method()
array?.[index]
segments[0]?.rwycc
this.data.result?.airport
```

**✅ 正确替代：**
```javascript
// 正确写法
obj && obj.property
obj && obj.method()
array && array[index]
segments[0] && segments[0].rwycc
this.data.result && this.data.result.airport
```

### 2. 空值合并操作符（Nullish Coalescing `??`）
**❌ 禁止使用：**
```javascript
// 错误写法
const value = input ?? defaultValue
const result = data?.field ?? 'default'
```

**✅ 正确替代：**
```javascript
// 正确写法
const value = input !== null && input !== undefined ? input : defaultValue
const result = (data && data.field !== null && data.field !== undefined) ? data.field : 'default'
// 或者使用逻辑OR（如果null/undefined/false/0都视为falsy）
const value = input || defaultValue
```

### 3. 其他需要注意的ES6+语法

#### 高级语法支持差异
根据微信官方文档，以下语法存在平台支持差异：
- **async/await** - 需要代码转换工具支持
- **箭头函数** - 部分平台可能不支持
- **解构赋值** - 部分复杂解构可能不支持
- **Promise** - iOS15以下可能存在兼容性问题

#### 模板字符串中的复杂表达式
**✅ 推荐简化：**
```javascript
// 尽量避免在模板字符串中使用复杂的可选链
const text = `结果：${data && data.result ? data.result.value : '无'}`
```

#### 对象展开运算符的限制
```javascript
// 某些情况下可能不支持
const newObj = { ...oldObj, newProp: 'value' }
// 推荐使用 Object.assign
const newObj = Object.assign({}, oldObj, { newProp: 'value' })
```

#### 动态代码执行限制
```javascript
// ❌ 禁止使用
eval('console.log("test")')
new Function('console.log("test")')()

// ✅ 例外情况
new Function('return this')() // 仅此用法被允许
```

## 检查清单

在微信小程序项目中编写代码时，请确保：

- [ ] 没有使用可选链操作符 `?.`
- [ ] 没有使用空值合并操作符 `??`
- [ ] 没有使用 `eval` 执行动态代码
- [ ] 没有使用 `new Function` 创建函数（除了 `new Function('return this')`）
- [ ] 高级ES6+语法（如async/await）通过代码转换工具处理
- [ ] 所有对象属性访问都使用兼容的语法
- [ ] 数组元素访问使用安全的方式
- [ ] 函数调用前进行存在性检查
- [ ] Promise相关代码考虑iOS15以下兼容性

## 常见重构模式

### 深层对象访问
```javascript
// ❌ 错误
const value = obj?.deep?.nested?.property

// ✅ 正确
const value = obj && obj.deep && obj.deep.nested && obj.deep.nested.property
```

### 数组元素访问
```javascript
// ❌ 错误
const firstItem = array?.[0]?.property

// ✅ 正确
const firstItem = array && array[0] && array[0].property
```

### 方法调用
```javascript
// ❌ 错误
obj?.method?.()

// ✅ 正确
obj && obj.method && obj.method()
```

## 参考文件
- [aviation-calculator/index.ts](mdc:miniprogram/pages/aviation-calculator/index.ts) - 已修复的可选链使用示例
- [TypeScript优先规则](mdc:.cursor/rules/typescript-priority.mdc) - TypeScript编译配置

## 错误示例
当使用不兼容语法时，会出现类似以下错误：
```
Error: Unexpected token: punc (.)
File: pages/aviation-calculator/index.js
```

## 版本兼容性指南

### 基础库版本要求
根据官方文档，特定功能的基础库版本要求：
- **基础库 v2.15.0** 需要安全基础库版本至 **7.0.22**，iOS 最低基础库 **7.0.20**
- **客户端基础库** 需要至少微信版本支持

### 平台差异处理
- **iOS 16** 及以上不存在差异
- **iOS 15** 以下可能存在 **Promise** 兼容性问题
- **Android** 平台相对稳定

## 无法被 Polyfill 的 API
以下API在部分版本基础库中无法使用，请注意是否使用：
- **Proxy** 对象

## 代码转换工具建议
当需要使用高级语法时，推荐使用：
1. **Babel** - 用于转换ES6+语法
2. **core-js** - 提供标准API补充
3. **代码转换工具** - 处理async/await等语法

## 最佳实践
1. 在编写代码时优先考虑兼容性
2. 使用TypeScript编译时注意目标版本设置（建议ES5或ES2015）
3. 定期检查编译后的JavaScript代码
4. 在真机调试前进行语法检查
5. 团队协作时统一语法标准
6. 关注[小程序管理页](mdc:https:/developers.weixin.qq.com/miniprogram/dev/framework/runtime/js-support.html)的【设置】-【基本设置】-【基础库最低版本设置】
7. 使用官方推荐的代码转换工具处理兼容性问题

## 参考资源
- [微信小程序JavaScript支持情况官方文档](mdc:https:/developers.weixin.qq.com/miniprogram/dev/framework/runtime/js-support.html)
- [代码转换工具文档](mdc:https:/developers.weixin.qq.com/miniprogram/dev/framework/runtime/js-support.html)

遵循这些规则可以避免微信小程序环境中的语法兼容性问题，确保代码能够正常编译和运行。







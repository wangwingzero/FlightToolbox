# 驾驶舱GPS欺骗检测原理

## 📋 文档概述

本文档详细说明FlightToolbox驾驶舱模块中GPS欺骗检测功能的技术原理和实现逻辑。

## 🔬 物理原理基础

### 驾驶舱内真实GPS信号特性

在实际飞行中，驾驶舱内的智能手机**无法接收到真实的GPS卫星信号**，主要原因包括：

1. **信号接收能力限制**
   - 民用手机GPS接收芯片的灵敏度有限
   - 飞机外壳的金属屏蔽作用
   - 高空环境下信号衰减严重

2. **法拉第笼效应（Faraday Cage Effect）**
   - 驾驶舱采用金属框架结构，形成天然的法拉第笼
   - 法拉第笼会屏蔽外部电磁信号（包括GPS L1/L2频段信号）
   - 真实GPS信号（1.2-1.6 GHz频段）难以穿透金属机身

### GPS欺骗攻击的物理特征

GPS欺骗设备（GPS Spoofer）的工作原理：

1. **信号压制机制**
   - GPS欺骗器必须发射**比真实GPS信号更强的伪造信号**
   - 通过更强的信号功率压制真实卫星信号
   - 接收设备会优先捕获功率更强的伪造信号

2. **驾驶舱内的矛盾现象**
   - 在法拉第笼效应下，手机理论上**不应该接收到任何GPS信号**
   - 如果手机能够接收到"GPS信号"，则该信号必然是：
     - 来自驾驶舱内部或极近距离
     - 功率远超正常GPS卫星信号（才能穿透部分屏蔽）
     - **大概率是GPS欺骗设备发出的伪造信号**

## 🚨 检测逻辑

### 核心判定条件

```
IF (驾驶舱环境 + 手机收到GPS信号) THEN
    存在GPS欺骗 = TRUE
END IF
```

**逻辑推理链**：

1. ✈️ 前提条件：飞机在空中飞行，手机在驾驶舱内
2. 🛡️ 物理屏蔽：法拉第笼效应阻断真实GPS信号
3. 📡 异常信号：手机却能接收到"GPS信号"
4. ⚠️ 逻辑结论：该信号必然是伪造的GPS欺骗信号

### 检测触发条件

根据代码实现（`gps-spoofing-detector.js`），检测器会累积以下证据：

1. **GPS定位成功** - 在理论上不应该有信号的环境中收到GPS
2. **速度异常** - GPS报告的速度与实际飞行速度不符
3. **高度异常** - GPS报告的高度与实际飞行高度不符
4. **位置跳变** - GPS位置出现不合理的突变
5. **精度异常** - GPS报告的精度值异常（过高或过低）

当连续30次接收到有效GPS高度信号时，判定为GPS欺骗。

## 🔧 技术实现

### 数据源选择策略

FlightToolbox采用以下策略确保数据真实性：

#### ✅ 信任的数据源（物理传感器）

- **加速度计（Accelerometer）** - 物理惯性测量，无法欺骗
- **陀螺仪（Gyroscope）** - 物理角速度测量，无法欺骗
- **气压计（Barometer）** - 物理气压测量，无法欺骗
- **磁力计（Magnetometer）** - 物理磁场测量，无法欺骗

#### ❌ 不信任的数据源（可被欺骗）

- **GPS定位数据** - 可被GPS欺骗器伪造
- **网络定位数据** - 可被伪基站欺骗
- **Wi-Fi定位数据** - 可被伪造Wi-Fi热点欺骗

### 高度数据策略

```javascript
// ✅ 正确做法：优先使用气压高度
if (气压计可用) {
    显示高度 = 气压高度（物理传感器，真实可靠）
} else if (GPS欺骗检测未触发) {
    显示高度 = GPS高度（仅在未检测到欺骗时使用）
} else {
    显示高度 = 未知（拒绝使用被污染的GPS数据）
}

// ❌ 错误做法：直接使用GPS高度
显示高度 = GPS高度  // 可能被欺骗
```

### 速度数据策略

```javascript
// ✅ 正确做法：使用惯性传感器推算
地速 = 加速度积分计算（物理传感器融合）

// ❌ 错误做法：直接使用GPS速度
地速 = GPS速度  // 可能被欺骗
```

## 📊 检测器状态机

GPS欺骗检测器使用简化的连续计数机制：

```
连续GPS计数器: 0 → 1 → 2 → ... → 30 → 触发GPS欺骗警告
                                ↑
                          检测阈值（30次）
```

**核心逻辑**：
- 每次接收到真实GPS信号（provider非network）且有有效高度数据时，计数器+1
- 当计数器达到30时，触发GPS欺骗警告
- 如果GPS信号丢失超过1分钟或频繁中断，计数器重置为0

**状态转换**：

1. **NORMAL（正常状态）**
   - 连续GPS计数 < 30次
   - 显示绿色状态指示
   - 允许使用GPS数据（谨慎）

2. **COOLDOWN（冷却状态）**
   - 刚检测到欺骗后进入
   - 等待一定时间后重新评估
   - 拒绝使用GPS数据

3. **SPOOFING_DETECTED（欺骗检测状态）**
   - 连续GPS计数 ≥ 30次
   - 显示红色警告："无信号"或"GPS欺骗"
   - 完全屏蔽GPS数据

## 🛡️ 防护措施

### 1. 数据隔离

- GPS数据与物理传感器数据**严格分离**
- 拒绝GPS数据污染惯性导航系统

### 2. 显示策略

```javascript
// 当检测到GPS欺骗时
if (GPS欺骗检测器.isCurrentlySpoofed()) {
    GPS地速显示 = "-- kt"  // 不显示数据
    GPS高度显示 = "-- ft"  // 不显示数据
    状态指示 = "无信号"（红色警告）
}
```

### 3. 用户提示

- 在驾驶舱页面顶部显示**"GPS欺骗监控"**开关
- 状态指示器：
  - 🟢 绿色 = 正常（或未启用监控）
  - 🔴 红色 = 检测到GPS欺骗
  - ⚠️ 橙色 = 冷却状态

## 🔍 实际应用场景

### 场景1：正常地面测试

- 环境：地面开阔环境
- GPS信号：真实GPS卫星信号可接收
- 检测结果：✅ 正常，GPS数据可用

### 场景2：空中正常飞行

- 环境：驾驶舱内（法拉第笼）
- GPS信号：无法接收
- 检测结果：✅ 正常，GPS显示"无信号"

### 场景3：GPS欺骗攻击

- 环境：驾驶舱内（法拉第笼）
- GPS信号：手机却收到"GPS信号"
- 检测结果：🚨 **异常！触发GPS欺骗警告**
- 系统响应：
  - 拒绝使用GPS高度和GPS地速
  - 切换到纯惯性导航模式
  - 显示红色警告状态

## 📈 检测效果

### 检测准确性

- **误报率（False Positive）**：极低
  - 网络定位（provider=network）被明确排除，不会误判
  - 只有真实GPS信号（provider包含gps或有垂直精度）且连续30次才触发
  - 地面环境不会误报（真实GPS信号正常）

- **漏报率（False Negative）**：低
  - 连续30次有效GPS信号阈值确保可靠性
  - 1分钟信号丢失容忍机制防止误重置
  - 频繁信号中断（>10次）会重置检测状态

### 响应时间

- 连续计数阈值：30次有效GPS信号
- GPS更新频率：约1Hz（每秒1次）
- 检测延迟：约30秒（连续累积30次GPS信号）
- 信号丢失容忍：最多1分钟（超时后重置）

## 🔧 相关代码模块

- **检测器实现**：`miniprogram/pages/cockpit/modules/gps-spoofing-detector.js`
- **GPS管理器**：`miniprogram/pages/cockpit/modules/gps-manager.js`
- **传感器融合**：`miniprogram/pages/cockpit/modules/sensor-fusion-core.js`
- **配置参数**：`miniprogram/pages/cockpit/modules/config.js`

## 📝 重要说明

1. **物理传感器优先原则**
   - 永远优先使用无法欺骗的物理传感器（加速度计、陀螺仪、气压计）
   - GPS数据仅作为辅助参考，且需经过欺骗检测

2. **法拉第笼效应是关键**
   - 驾驶舱的金属结构天然形成GPS信号屏蔽
   - 这种物理屏蔽是检测逻辑的核心依据

3. **离线可用性**
   - GPS欺骗检测完全基于本地传感器数据
   - 无需网络连接，符合飞行模式下离线优先设计

## 📚 参考资料

- [GPS欺骗攻击技术原理](https://en.wikipedia.org/wiki/GPS_spoofing)
- [法拉第笼效应](https://en.wikipedia.org/wiki/Faraday_cage)
- [惯性导航系统](https://en.wikipedia.org/wiki/Inertial_navigation_system)
- 微信小程序传感器API文档

---

**文档版本**：v1.0
**最后更新**：2025-10-19
**维护者**：FlightToolbox开发团队

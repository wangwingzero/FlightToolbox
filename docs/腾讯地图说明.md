# map

地图组件，用于在小程序中展示地图。

### 扫码体验

![扫码体验](https://developers.weixin.qq.com/miniprogram/dev/image/cat/09.png)

### 效果示例

![map-gif](https://developers.weixin.qq.com/miniprogram/dev/image/map.gif)

### 代码示例

```wxml
<!--wxml-->
<map id="myMap" style="width: 100%; height: 300px;" latitude="{{latitude}}" longitude="{{longitude}}" markers="{{markers}}" covers="{{covers}}"></map>
<button type="primary" bindtap="getCenterLocation">获取位置</button>
<button type="warn" bindtap="moveToLocation">移动位置</button>
```

```javascript
// main.js
Page({
  data: {
    latitude: 23.099994,
    longitude: 113.324520,
    markers: [{
      id: 1,
      latitude: 23.099994,
      longitude: 113.324520,
      name: 'T.I.T 创意园'
    }],
    covers: [{
      latitude: 23.099994,
      longitude: 113.344520,
      iconPath: '/image/location.png'
    }, {
      latitude: 23.099994,
      longitude: 113.304520,
      iconPath: '/image/location.png'
    }]
  },
  onReady: function (e) {
    // 使用 wx.createMapContext 获取 map 上下文
    this.mapCtx = wx.createMapContext('myMap')
  },
  getCenterLocation: function () {
    this.mapCtx.getCenterLocation({
      success: function(res){
        console.log(res.longitude)
        console.log(res.latitude)
      }
    })
  },
  moveToLocation: function () {
    this.mapCtx.moveToLocation()
  }
})
```

## 属性说明 (Attribute Reference)

| 属性 | 类型 | 默认值 | 必填 | 说明 | 最低版本 |
| --- | --- | --- | --- | --- | --- |
| longitude | number | | 是 | 中心经度 | |
| latitude | number | | 是 | 中心纬度 | |
| scale | number | 16 | 否 | 缩放级别，取值范围为3-20 | |
| markers | Array | [] | 否 | 标记点 | |
| covers | Array | [] | 否 | **即将废弃**，请使用 `markers` | |
| polyline | Array | [] | 否 | 路线 | |
| polygon | Array | [] | 否 | 多边形 | |
| circles | Array | [] | 否 | 圆形 | |
| controls | Array | [] | 否 | 在地图上显示控件，控件不随着地图移动 | |
| include-points | Array | [] | 否 | 缩放视野以包含所有给定的坐标点 | |
| show-location | boolean | false | 否 | 显示带有方向的当前定位点 | |
| show-compass | boolean | false | 否 | 显示指南针 | 1.2.0 |
| show-scale | boolean | false | 否 | 显示比例尺，工具暂不支持 | 1.5.0 |
| enable-3D | boolean | false | 否 | 显示3D楼块 | 1.2.0 |
| enable-zoom | boolean | true | 否 | 是否支持缩放 | 1.2.0 |
| enable-scroll | boolean | true | 否 | 是否支持拖动 | 1.2.0 |
| enable-rotate | boolean | false | 否 | 是否支持旋转 | 1.2.0 |
| enable-overlooking | boolean | false | 否 | 是否开启俯视 | 1.6.0 |
| enable-satellite | boolean | false | 否 | 是否开启卫星图 | 1.6.0 |
| enable-traffic | boolean | false | 否 | 是否开启实时路况 | 1.6.0 |
| enable-poi | boolean | true | 否 | 是否展示 POI 点 | 2.13.0 |
| enable-building | boolean | true | 否 | 是否展示建筑物 | 2.13.0 |
| setting | Object | | 否 | 个性化地图配置，[详情](https://developers.weixin.qq.com/miniprogram/dev/component/map.html#setting) | 1.7.0 |
| layer-style | number | 1 | 否 | 个性化图层样式，[详情](https://developers.weixin.qq.com/miniprogram/dev/framework/ability/map.html#%E4%B8%AA%E6%80%A7%E5%8C%96%E5%9C%B0%E5%9B%BE) | 2.1.0 |
| bindmarkertap | eventhandle | | 否 | 点击标记点时触发，`e.detail = {markerId}` | |
| bindlabeltap | eventhandle | | 否 | 点击label时触发，`e.detail = {markerId}` | 2.9.0 |
| bindcontroltap | eventhandle | | 否 | 点击控件时触发，`e.detail = {controlId}` | |
| bindcallouttap | eventhandle | | 否 | 点击标记点对应的气泡时触发，`e.detail = {markerId}` | |
| bindupdated | eventhandle | | 否 | 在地图渲染更新完成时触发 | 1.6.0 |
| bindregionchange | eventhandle | | 否 | 视野发生变化时触发，`e.detail = {type, causedBy, centerLocation, region}` | 1.6.0 |
| bindpoitap | eventhandle | | 否 | 点击地图poi点时触发，`e.detail = {name, longitude, latitude}` | 1.6.0 |
| bindanchorpointtap | eventhandle | | 否 | 点击定位标时触发，`e.detail = {longitude, latitude}` | 2.13.0 |

---

### markers

标记点，用于在地图上显示标记的位置。

| 属性 | 类型 | 必填 | 说明 | 最低版本 |
| --- | --- | --- | --- | --- |
| id | number | 否 | 标记点id，`marker 点击事件`、`callout 点击事件` 会返回 `id`。 | |
| latitude | number | 是 | 纬度，浮点数，范围 -90 ~ 90 | |
| longitude | number | 是 | 经度，浮点数，范围 -180 ~ 180 | |
| title | string | 否 | 标注点名 | |
| iconPath | string | 否 | 显示的图标，项目目录下的图片路径，支持网络路径、本地路径、代码包路径 | |
| rotate | number | 否 | 顺时针旋转角度，范围 0 ~ 360，默认为 0 | |
| alpha | number | 否 | 标注的透明度，范围 0 ~ 1，默认为 1 | |
| width | number/string | 否 | 标注图标宽度，默认为图片实际宽度 | |
| height | number/string | 否 | 标注图标高度，默认为图片实际高度 | |
| callout | Object | 否 | 自定义标记点上方的气泡窗口 | |
| label | Object | 否 | 为标记点旁边增加标签 | 1.2.0 |
| anchor | Object | 否 | 经纬度在标注图标的锚点，默认为 `{x: 0.5, y: 1}` | 1.2.0 |
| customCallout | Object | 否 | 自定义气泡窗口 | 2.9.0 |
| joinCluster | boolean | 否 | 是否参与点聚合，默认为 `false` | 2.8.0 |

#### marker 上的气泡 callout

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| content | string | 否 | 文本 |
| color | string | 否 | 文本颜色，#RRGGBB |
| fontSize | number | 否 | 文字大小 |
| borderRadius | number | 否 | 边框圆角 |
| borderWidth | number | 否 | 边框宽度 |
| borderColor | string | 否 | 边框颜色 |
| bgColor | string | 否 | 背景色 |
| padding | number | 否 | 文本边缘留白 |
| display | string | 否 | `BYCLICK`：点击显示；`ALWAYS`：常显 |
| textAlign | string | 否 | 文本对齐方式。有效值: `left`, `right`, `center` |

#### marker 上的标签 label

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| content | string | 否 | 文本 |
| color | string | 否 | 文本颜色，#RRGGBB |
| fontSize | number | 否 | 文字大小 |
| x | number | 否 | label的坐标，原点是 marker 对应的经纬度 |
| y | number | 否 | label的坐标，原点是 marker 对应的经纬度 |
| anchorX | number | 否 | label的锚点 |
| anchorY | number | 否 | label的锚点 |
| borderWidth | number | 否 | 边框宽度 |
| borderColor | string | 否 | 边框颜色 |
| borderRadius | number | 否 | 边框圆角 |
| bgColor | string | 否 | 背景色 |
| padding | number | 否 | 文本边缘留白 |
| textAlign | string | 否 | 文本对齐方式。有效值: `left`, `right`, `center` |

#### marker 的锚点 anchor

默认值为 `{x: 0.5, y: 1}`。

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| x | number | 是 | 横向（x轴）偏移量，取值范围 `[0, 1]` |
| y | number | 是 | 纵向（y轴）偏移量，取值范围 `[0, 1]` |

---

### polyline

指定一系列坐标点，在地图上绘制折线。

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| points | Array | 是 | 经纬度数组，`[{latitude: 0, longitude: 0}]` |
| color | string | 否 | 线的颜色，#RRGGBBAA |
| width | number | 否 | 线的宽度 |
| dottedLine | boolean | 否 | 是否虚线 |
| arrowLine | boolean | 否 | 带箭头的线 |
| arrowIconPath | string | 否 | 更换箭头图标 |
| borderColor | string | 否 | 线的边框颜色 |
| borderWidth | number | 否 | 线的厚度 |
| level | string | 否 | 显示层级，`abovedots` / `abovebuildings` / `aboveroads` |

---

### polygon

指定一系列坐标点，在地图上绘制多边形。

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| points | Array | 是 | 经纬度数组 |
| strokeWidth | number | 否 | 描边的宽度 |
| strokeColor | string | 否 | 描边的颜色，#RRGGBBAA |
| fillColor | string | 否 | 填充颜色，#RRGGBBAA |
| zIndex | number | 否 | 设置多边形 Z 轴数值 |
| level | string | 否 | 显示层级，`abovedots` / `abovebuildings` / `aboveroads` |

---

### circles

在地图上绘制圆形。

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| latitude | number | 是 | 纬度 |
| longitude | number | 是 | 经度 |
| color | string | 否 | 描边的颜色 |
| fillColor | string | 否 | 填充颜色 |
| radius | number | 是 | 半径 |
| strokeWidth | number | 否 | 描边的宽度 |
| level | string | 否 | 显示层级，`abovedots` / `abovebuildings` / `aboveroads` |

---

### controls

在地图上显示控件，控件不随着地图移动。

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| id | number | 否 | 控件id，`control 点击事件`会返回 `id` |
| position | Object | 是 | 控件在地图的位置 |
| iconPath | string | 是 | 显示的图标 |
| clickable | boolean | 否 | 是否可点击 |

#### control 的 position

| 属性 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| left | number | 否 | 距离地图的左边界多远 |
| top | number | 否 | 距离地图的上边界多远 |
| width | number | 否 | 控件宽度 |
| height | number | 否 | 控件高度 |

---

## 事件说明 (Event Reference)

| 事件名 | 说明 | `event.detail` | 最低版本 |
| --- | --- | --- | --- |
| bindmarkertap | 点击标记点时触发 | `{markerId: Number}` | |
| bindlabeltap | 点击label时触发 | `{markerId: Number}` | 2.9.0 |
| bindcontroltap | 点击控件时触发 | `{controlId: Number}` | |
| bindcallouttap | 点击标记点对应的气泡时触发 | `{markerId: Number}` | |
| bindupdated | 在地图渲染更新完成时触发 | `{}` | 1.6.0 |
| bindregionchange | 视野发生变化时触发 | `{type, causedBy, centerLocation, region}` | 1.6.0 |
| bindpoitap | 点击地图poi点时触发 | `{name, longitude, latitude}` | 1.6.0 |
| bindanchorpointtap | 点击定位标时触发 | `{longitude, latitude}` | 2.13.0 |

### `bindregionchange` 的 `detail`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| type | string | 视野变化开始/结束。`begin`：开始；`end`：结束 |
| causedBy | string | 导致视野变化的原因。`scale`：缩放；`drag`：拖动；`update`：调用 `updateComponents` |
| centerLocation | Object | 地图中心点经纬度 |
| region | Object | 视野范围，东北角和西南角的经纬度 |

---

## Bug & Tip

1.  `tip`: `map` 组件是由客户端创建的原生组件，它的层级是最高的，不能通过 z-index 控制层级。可使用 `cover-view` 和 `cover-image`覆盖在上面。
2.  `tip`: `scale` 范围 `3-20`，如果超出范围会显示为临界值。
3.  `tip`: `enable-3D`、`show-compass`、`enable-overlooking`、`enable-zoom`、`enable-scroll`、`enable-rotate`、`enable-satellite`、`enable-traffic` 等属性的设置，在 `map` 组件中当 `subkey` 不为空时， `config.json` 的 `permission` 中也需要配置 `scope.userLocation`。
4.  `tip`: `polyline`、`polygon`、`circles`、`controls` 的 `position` 都支持 `rpx` 单位，`2.4.0` 起 `markers` 的 `width`、`height` 也支持 `rpx`。
5.  `tip`: `polyline` 的 `color` 使用 `4` 位或 `8` 位 `16` 进制表示时，后 `2` 位为 `alpha` 值，`Android` 和 `iOS` 计算方式不同。
6.  `tip`: `markers` 不支持 `base64` 图片。
7.  `tip`: 个性化地图 `layer-style` 与 `enable-satellite`、`enable-traffic` 不可同时生效。
8.  `tip`: `controls` 和 `markers` 的 `iconPath` 推荐使用 `https` 协议的 `url`，或 `wxfile://` 协议的本地临时文件路径。
9.  `tip`: `bindregionchange` 事件返回 `causedBy` 的值 `update` 在 `2.3.0` 起返回，表示 `map` 组件初始化或 `properties` 更新导致视野变化。
10. `bug`: `Android` `8.0` 下 `<map>` 组件的 `markers` 覆盖物 `fixedDisplay` 失效。
11. `bug`: `iOS` `WKWebview` 下 `<map>` 组件的 `markers` 不支持 `gif`。
12. `bug`: `iOS` `callout` 的 `display: ALWAYS` 在 `marker` 数量较多时，会导致 `marker` 抖动。

---

## 示例代码

[在开发者工具中预览效果](https://developers.weixin.qq.com/s/72CmMmmc7457)

### index.wxml
```wxml
<view class="page-body">
  <view class="page-section page-section-gap">
    <map
      id="myMap"
      style="width: 100%; height: 300px;"
      longitude="113.324520"
      latitude="23.099994"
      scale="14"
      show-location
      enable-3D
      enable-overlooking
      enable-satellite
      enable-traffic
      markers="{{markers}}"
      covers="{{covers}}"
      bindmarkertap="markertap"
      bindregionchange="regionchange"
      show-location style="width: 100%; height: 300px;"
    ></map>
  </view>
  <view class="btn-area">
    <button bindtap="getCenterLocation" class="page-body-button" type="primary">获取位置</button>
    <button bindtap="moveToLocation" class="page-body-button" type="primary">移动位置</button>
  </view>
</view>
```

### index.js
```javascript
Page({
  onShareAppMessage() {
    return {
      title: 'map',
      path: 'page/component/pages/map/map'
    }
  },

  data: {
    markers: [{
      iconPath: "/resources/others.png",
      id: 0,
      latitude: 23.099994,
      longitude: 113.324520,
      width: 50,
      height: 50
    }],
    polyline: [{
      points: [{
        longitude: 113.324521,
        latitude: 23.10229
      }, {
        longitude: 113.324520,
        latitude: 23.21229
      }],
      color:"#FF0000DD",
      width: 2,
      dottedLine: true
    }],
    controls: [{
      id: 1,
      iconPath: '/resources/location.png',
      position: {
        left: 0,
        top: 300 - 50,
        width: 50,
        height: 50
      },
      clickable: true
    }]
  },
  regionchange(e) {
    console.log(e.type)
  },
  markertap(e) {
    console.log(e.detail.markerId)
  },
  controltap(e) {
    console.log(e.detail.controlId)
  },
  onReady: function (e) {
    this.mapCtx = wx.createMapContext('myMap')
  },
  getCenterLocation: function () {
    this.mapCtx.getCenterLocation({
      success: function(res){
        console.log(res.longitude)
        console.log(res.latitude)
      }
    })
  },
  moveToLocation: function () {
    this.mapCtx.moveToLocation()
  }
})
```

### index.wxss
```wxss
.page-section-gap{
  box-sizing: border-box;
  padding: 0 30rpx;
}
.page-body-button {
  margin-bottom: 30rpx;
}
# FlightToolbox 驾驶舱功能详细说明

> **版本**: v2.0
> **最后更新**: 2025-10-16
> **适用平台**: 微信小程序
> **离线支持**: ✅ 完全支持

---

## 📖 目录

1. [系统概述](#系统概述)
2. [核心功能](#核心功能)
3. [模块化架构](#模块化架构)
4. [功能详解](#功能详解)
5. [技术实现](#技术实现)
6. [使用指南](#使用指南)
7. [配置参数](#配置参数)
8. [故障排查](#故障排查)
9. [开发规范](#开发规范)

---

## 系统概述

### 设计理念

FlightToolbox驾驶舱是专为航空飞行员设计的**实时导航与姿态监控系统**，采用模块化架构，在**完全离线环境**下提供专业级的飞行辅助功能。

### 核心特性

- ✈️ **实时GPS导航** - 亚秒级位置更新，原始GPS数据显示
- 🗺️ **智能地图渲染** - Canvas绘制，支持5-640海里可调范围
- 🧭 **三传感器融合** - 指南针+陀螺仪+加速度计姿态解算
- 🛬 **附近机场查询** - 实时计算最近20个机场，支持手动追踪
- 🎯 **姿态仪表** - 俯仰角(Pitch)和滚转角(Roll)实时显示
- 🛡️ **GPS欺骗检测** - 连续30次有效GPS高度信号触发警告
- 📏 **距离圈缩放** - 8级缩放，从5NM终端区到640NM超远程监视
- 🌍 **离线优先设计** - 机场数据本地存储(7405个)，无需网络

### 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                   驾驶舱主控制器                        │
│              (pages/cockpit/index.js)                   │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
   ┌────▼────┐      ┌─────▼─────┐    ┌─────▼─────┐
   │GPS管理器│      │机场管理器 │    │地图渲染器│
   └────┬────┘      └─────┬─────┘    └─────┬─────┘
        │                 │                 │
   ┌────▼────┐      ┌─────▼─────┐    ┌─────▼─────┐
   │指南针   │      │飞行计算器 │    │手势处理器│
   │陀螺仪   │      └───────────┘    └───────────┘
   │加速度计 │
   └─────────┘
```

---

## 核心功能

### 1. GPS定位与导航

#### 功能描述

实时获取飞机位置、速度、高度、航向信息，支持**完全离线环境**下的GPS定位。

#### 关键特性

- **原始数据显示** - GPS地速和GPS高度**严格禁止**滤波处理
- **高频更新** - 位置更新间隔约1-5秒（取决于设备性能）
- **坐标系统** - WGS84/GCJ02双坐标系支持
- **航向/航迹双模式** -
  - **航向模式(Heading)**: 使用指南针磁航向
  - **航迹模式(Track)**: 使用GPS计算的地面航迹

#### 数据显示

| 数据项 | 格式 | 说明 |
|--------|------|------|
| GPS地速 | `250 kt` | 整数显示，无平滑处理 |
| GPS高度 | `8500 ft` | 米转英尺后直接显示 |
| 航向 | `085°` | 指南针磁航向（0-359°） |
| 航迹 | `088°` | GPS计算航迹（0-359°） |
| 坐标 | `39°54'N 116°24'E` | 航空格式（度分） |

#### 技术实现

```javascript
// GPS管理器核心逻辑
GPSManager.init({
  coordinateSystem: 'wgs84',  // WGS84坐标系
  highAccuracy: true,          // 高精度模式
  updateInterval: 1000,        // 1秒更新
  onLocationUpdate: function(data) {
    // 原始GPS数据，禁止滤波
    var speed = Math.round(data.speed);  // 仅取整
    var altitude = data.altitude;         // 直接使用
    // ...
  }
});
```

---

### 2. 附近机场显示

#### 功能描述

基于当前GPS位置，实时计算并显示附近机场信息，支持三机场同时显示和手动追踪。

#### 显示逻辑

```
┌──────────────┬──────────────┬──────────────┐
│  最近机场    │  追踪机场    │  次近机场    │
│  ZBAA       │   ZBTJ       │   ZBHH      │
│  15.2 NM    │   45.8 NM    │   67.3 NM   │
│  325°       │   180°       │   045°      │
└──────────────┴──────────────┴──────────────┘
```

#### 三机场显示规则

| 场景 | 左侧 | 中间 | 右侧 |
|------|------|------|------|
| **无追踪** | 最近机场 | 空 | 次近机场 |
| **追踪=最近** | 次近机场 | 追踪机场 | 第三近机场 |
| **追踪=次近** | 最近机场 | 追踪机场 | 第三近机场 |
| **追踪=其他** | 最近机场 | 追踪机场 | 次近机场 |

#### 追踪功能

- **手动输入**: 输入ICAO代码（如ZBAA）追踪指定机场
- **点击追踪**: 点击左/右机场卡片快速追踪
- **智能搜索**: 支持ICAO、IATA、中英文名称模糊搜索
- **清除追踪**: 清空输入框或点击已追踪机场取消

#### 数据来源

- **机场数量**: 7405个全球机场
- **数据分包**: `packageC/airportdata.js`（跨分包异步加载）
- **搜索范围**: 当前地图显示范围的120%（留20%余量）
- **最大显示**: 20个机场（按距离排序）

---

### 3. 地图渲染系统

#### Canvas绘制引擎

使用微信小程序Canvas 2D API渲染实时导航地图，支持动态缩放和旋转。

#### 地图元素

```
     ┌───────────────────────────────────┐
     │         ╱                         │
     │        ╱  距离圈 (20 NM)          │
     │       ╱                           │
     │      🛩️ ← 飞机位置（中心）        │
     │     ╱ ╲                           │
     │    ╱   ╲ 航迹线                   │
     │   🏢   🏢 附近机场标记            │
     │  ZBAA  ZBTJ                       │
     │  15NM  45NM                       │
     └───────────────────────────────────┘
```

**绘制元素**：
1. ✈️ 飞机图标（中心，根据航向旋转）
2. ⭕ 距离圈（可调5-640 NM，刻度标注）
3. 🏢 机场标记（ICAO代码+距离+方位线）
4. 📏 方位刻度（0°/90°/180°/270°标注）
5. 🎯 追踪机场高亮（红色标记）

#### 地图定向模式

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **航向朝上** | 指南针航向始终指向地图顶部 | 目视飞行参考 |
| **航迹朝上** | GPS航迹始终指向地图顶部 | 仪表飞行导航 |
| **北向朝上** | 地理北方始终指向地图顶部 | 地图对照 |

**切换方式**: 点击地图定向按钮切换

#### 距离圈缩放级别

| 级别 | 距离 | 用途 | 快捷键 |
|------|------|------|--------|
| 1 | 5 NM | 终端区 | - |
| 2 | 10 NM | 进近区域 | - |
| 3 | 20 NM | 标准区域（默认） | - |
| 4 | 40 NM | 扩展区域 | - |
| 5 | 80 NM | 远程监视 | - |
| 6 | 160 NM | 航路监视 | - |
| 7 | 320 NM | 长途航路 | - |
| 8 | 640 NM | 超远程监视 | - |

**操作方式**：
- 双指捏合/拉伸缩放
- 点击距离圈选择器手动选择

---

### 4. 姿态仪表系统

#### 功能描述

实时显示飞机的俯仰角(Pitch)和滚转角(Roll)，采用传感器融合技术提高精度。

#### 姿态仪Canvas显示

```
        ┌─────────────────────┐
        │   -10°              │  ← 俯仰角刻度
        │      0° ─────       │
        │    +10°             │
        │         │           │
        │    ←────┼────→      │  ← 滚转指示
        │         │           │
        │      PITCH: +5°     │
        │      ROLL:  -12°    │
        └─────────────────────┘
```

#### 校准功能

| 操作 | 功能 | 说明 |
|------|------|------|
| **单击重置按钮** | 快速归零 | 将当前姿态设为新的零点基准 |
| **长按重置按钮** | 高级选项 | 查看校准状态、强制刷新、清除校准数据 |
| **初始按钮** | 恢复出厂 | 清除所有校准偏移，使用原始传感器数据 |

#### 传感器融合算法

```javascript
// 三传感器融合（指南针+陀螺仪+加速度计）
SensorFusion.update({
  compass: compassReading,     // 磁航向
  gyroscope: gyroReading,      // 角速度
  accelerometer: accelReading  // 加速度
});

// 互补滤波器
filteredAttitude = alpha * gyroIntegration +
                   (1-alpha) * accelerometerAngle;
```

**数据更新频率**: 约30 FPS（视设备性能）

---

### 5. GPS欺骗检测

#### 功能描述

检测GPS信号是否被欺骗或干扰，防止虚假位置信息导航错误。

#### 检测原理

**简化检测模式** - 连续30次接收到有效GPS高度信号触发警告

```
GPS数据流 → 高度有效性检测 → 连续计数器
                ↓
         有效：计数+1
         无效：计数清零
                ↓
         计数≥30次 → 触发欺骗警告
```

#### 状态机

```
┌────────┐  检测到欺骗  ┌──────────┐
│ NORMAL │─────────────→│ SPOOFING │
└────────┘              └──────────┘
     ↑                       │
     │                       │ 信号正常
     │    冷却期10分钟       ↓
     │    ←────────────  ┌──────────┐
     └──────────────────│ COOLDOWN │
                        └──────────┘
```

**状态说明**：
- `NORMAL`: 正常状态，无欺骗检测
- `SPOOFING`: 检测到欺骗，显示警告并播放语音（首次）
- `COOLDOWN`: 冷却期，10分钟内再次检测到欺骗静默处理

#### 用户配置

| 配置项 | 说明 | 建议 |
|--------|------|------|
| **开启监控** | 启用/关闭欺骗检测 | ⚠️ **仅空中启用** |
| **语音提醒** | 检测到欺骗时播放语音 | 建议开启 |
| **监控模式** | 空中/地面模式 | 根据飞行状态选择 |

**重要提示**:
- 🚨 **地面时请勿开启** - 避免地面GPS高度数据触发误报
- ✈️ **仅空中使用** - 飞行时开启以检测GPS欺骗攻击

---

### 6. 指南针与航向系统

#### 三传感器融合

**传感器配置**：
1. **磁力计（Compass）** - 提供磁航向基准
2. **陀螺仪（Gyroscope）** - 提供角速度，补偿快速转弯
3. **加速度计（Accelerometer）** - 提供重力参考，补偿倾斜误差

**融合权重**：
- 静止/慢速：磁力计权重80%，陀螺仪20%
- 高速/转弯：陀螺仪权重60%，磁力计40%
- 倾斜补偿：加速度计提供重力矢量

#### 航向平滑处理

```javascript
// 航向稳定性算法
var headingBuffer = [];  // 缓冲区大小: 5个数据点
var stabilityThreshold = 3;  // 连续3次稳定才更新

// 航向变化阈值（动态调整）
var threshold = speed < 50 ? 15° : 5°;  // 低速容差更大
```

#### 航向/航迹模式

| 模式 | 数据源 | 优点 | 缺点 |
|------|--------|------|------|
| **航向模式** | 指南针 | 实时响应，适合目视飞行 | 受磁偏角影响 |
| **航迹模式** | GPS计算 | 真实地面航迹，适合导航 | 低速时不准确 |

**自动切换**：
- 速度 < 10kt → 强制使用航向模式
- 速度 ≥ 10kt → 可选航向/航迹模式

---

### 7. 手势交互系统

#### 支持的手势

| 手势 | 功能 | 说明 |
|------|------|------|
| **双指捏合** | 缩小地图 | 减小距离圈范围 |
| **双指拉伸** | 放大地图 | 增大距离圈范围 |
| **单指点击** | 选择机场 | 点击机场卡片追踪 |
| **长按** | 显示详情 | 显示机场详细信息 |

#### 缩放灵敏度

```javascript
// 缩放阈值
var zoomThreshold = 50;  // 手指移动50像素触发缩放

// 缩放级别计算
var deltaDistance = Math.abs(currentDistance - startDistance);
if (deltaDistance > zoomThreshold) {
  // 放大或缩小一级
  currentZoomIndex += (currentDistance > startDistance) ? 1 : -1;
}
```

---

## 模块化架构

### 架构设计

驾驶舱采用**功能模块化**设计，共18个专业模块，每个模块独立封装，通过回调通信。

### 模块清单

```
pages/cockpit/modules/
├── config.js                    # 🎛️ 配置管理中心（440个配置项）
├── flight-calculator.js         # ✈️ 飞行数据计算（距离、方位、速度）
├── airport-manager.js           # 🛬 机场搜索与管理（7405个机场）
├── gps-manager.js              # 📡 GPS位置追踪（WGS84/GCJ02）
├── compass-manager-simple.js   # 🧭 指南针管理（三传感器融合）
├── gyroscope-manager.js        # 🌐 陀螺仪管理（角速度）
├── accelerometer-manager.js    # 📐 加速度计管理（重力矢量）
├── map-renderer.js             # 🗺️ Canvas地图渲染器
├── gesture-handler.js          # 👆 手势识别与处理
├── attitude-indicator.js       # ✈️ 姿态仪表模块（Pitch/Roll）
├── sensor-fusion-core.js       # 🔬 传感器融合核心算法
├── gps-spoofing-detector.js    # 🛡️ GPS欺骗检测器
├── audio-manager.js            # 🔊 音频播放管理（警告音）
├── toast-manager.js            # 💬 智能提示管理（防重复）
├── logger.js                   # 📝 统一日志管理
├── smart-filter.js             # 🧠 智能GPS数据滤波（已禁用）
├── lifecycle-manager.js        # ⚡ 模块生命周期管理
└── compass-manager.js          # 🧭 完整指南针管理器（备用）
```

### 模块依赖关系

```
┌─────────────────────────────────────────────────────────┐
│                    config.js                            │
│            （全局配置，所有模块依赖）                    │
└─────────────────────────────────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
   ┌────▼────┐      ┌─────▼─────┐    ┌─────▼─────┐
   │logger.js│      │toast-     │    │flight-    │
   │         │      │manager.js │    │calculator │
   └─────────┘      └───────────┘    └─────┬─────┘
                                            │
                          ┌─────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
   ┌────▼────┐      ┌─────▼─────┐    ┌─────▼─────┐
   │airport- │      │gps-       │    │compass-   │
   │manager  │      │manager    │    │manager    │
   └────┬────┘      └─────┬─────┘    └─────┬─────┘
        │                 │                 │
        └─────────────────┼─────────────────┘
                          │
                    ┌─────▼─────┐
                    │map-       │
                    │renderer   │
                    └───────────┘
```

### 模块通信机制

**回调模式** - 所有模块通过回调函数与主页面通信

```javascript
// 模块初始化示例
GPSManager.init(page, {
  onLocationUpdate: function(data) {
    // GPS数据更新回调
    page.handleLocationUpdate(data);
  },
  onPermissionError: function(error) {
    // 权限错误回调
    page.handleError(error, 'GPS权限');
  },
  onGPSStatusChange: function(status) {
    // GPS状态变化回调
    page.safeSetData({ gpsStatus: status });
  }
}, config);
```

---

## 功能详解

### GPS管理器 (gps-manager.js)

#### 职责

- GPS权限申请与管理
- 位置数据持续监控（wx.startLocationUpdate + wx.onLocationChange）
- 坐标系转换（WGS84 ↔ GCJ02 ↔ 航空格式）
- GPS状态监控（信号强度、定位精度）
- 离线模式支持

#### 关键方法

| 方法 | 说明 |
|------|------|
| `checkLocationPermission()` | 检查并申请GPS权限 |
| `startLocationTracking()` | 启动持续定位 |
| `stopLocationTracking()` | 停止定位并清理资源 |
| `convertToAviationFormat()` | 坐标转换为航空格式 |
| `getStatus()` | 获取GPS管理器状态 |

#### 坐标转换示例

```javascript
// 输入: 十进制坐标
var lat = 39.9042;
var lng = 116.4074;

// 输出: 航空格式
// "39°54'15\"N 116°24'26\"E"
```

#### GPS状态定义

| 状态 | 说明 | CSS类 |
|------|------|-------|
| `信号正常` | GPS定位成功，精度良好 | `status-good` |
| `信号欺骗` | 检测到GPS欺骗攻击 | `status-interference` |
| `未授权` | 用户拒绝GPS权限 | `status-bad` |
| `无信号` | GPS信号丢失或未定位 | `status-bad` |

---

### 机场管理器 (airport-manager.js)

#### 职责

- 机场数据异步加载（跨分包）
- 附近机场距离/方位计算
- 智能机场搜索（ICAO/IATA/中英文名称）
- 追踪机场管理
- 三机场显示逻辑

#### 关键方法

| 方法 | 说明 |
|------|------|
| `loadAirportsData()` | 异步加载机场数据（packageC） |
| `updateNearbyAirports()` | 更新附近机场列表 |
| `findAirportsByQuery()` | 智能搜索机场 |
| `setTrackedAirport()` | 设置追踪机场 |
| `updateThreeAirportsDisplay()` | 更新三机场显示 |

#### 搜索优先级

1. **ICAO代码精确匹配**（最高优先级）
2. IATA代码匹配
3. 中文名称模糊匹配
4. 英文名称模糊匹配

```javascript
// 搜索示例
findAirportsByQuery('首都');
// → [{ ICAOCode: 'ZBAA', ShortName: '北京首都国际机场', ... }]

findAirportsByQuery('ZBAA');
// → [{ ICAOCode: 'ZBAA', ... }]  // 精确匹配，立即返回
```

---

### 地图渲染器 (map-renderer.js)

#### 职责

- Canvas 2D地图绘制
- 飞机图标旋转渲染
- 距离圈刻度绘制
- 机场标记与方位线
- 地图定向与旋转

#### 渲染管线

```
1. 清空Canvas
   ↓
2. 应用地图旋转变换（根据定向模式）
   ↓
3. 绘制距离圈（带刻度）
   ↓
4. 绘制方位线（0°/90°/180°/270°）
   ↓
5. 绘制机场标记（ICAO代码+距离）
   ↓
6. 绘制飞机图标（中心，根据航向旋转）
   ↓
7. 恢复Canvas变换
```

#### 性能优化

- **智能渲染** - 仅当数据变化或用户交互时重新渲染
- **渲染节流** - 最小渲染间隔100ms
- **离屏缓存** - 静态元素（距离圈）缓存绘制
- **分层渲染** - 背景层、数据层、UI层分离

```javascript
// 渲染优化示例
if (this.shouldRender(newData)) {
  this.render();
} else {
  console.log('跳过不必要的渲染');
}
```

---

### 姿态仪模块 (attitude-indicator.js)

#### 职责

- 传感器数据融合（陀螺仪+加速度计）
- Pitch/Roll角度计算
- 姿态Canvas绘制
- 校准偏移管理

#### 融合算法

**互补滤波器**（Complementary Filter）

```javascript
// α = 0.98（陀螺仪权重）
var alpha = 0.98;

// 融合公式
var pitch = alpha * (prevPitch + gyroRate * dt) +
            (1-alpha) * accelerometerPitch;

var roll = alpha * (prevRoll + gyroRate * dt) +
           (1-alpha) * accelerometerRoll;
```

**优点**：
- 计算简单，性能好
- 短期响应快（陀螺仪）
- 长期稳定（加速度计）

**缺点**：
- 加速度干扰影响精度（转弯、颠簸）

#### 校准机制

**偏移存储**：
```javascript
// 本地存储结构
{
  pitchOffset: -2.5,      // 俯仰偏移量
  rollOffset: 1.3,        // 滚转偏移量
  calibrationTime: 1697452800000,  // 校准时间戳
  isValid: true           // 校准有效性标志
}
```

**校准流程**：
1. 记录当前原始传感器读数
2. 计算偏移量 = 当前读数 - 期望值(0)
3. 保存偏移量到本地存储
4. 后续读数 = 原始读数 - 偏移量

---

### GPS欺骗检测器 (gps-spoofing-detector.js)

#### 职责

- GPS高度数据有效性检测
- 连续计数器管理
- 状态机控制（NORMAL/SPOOFING/COOLDOWN）
- 语音警告触发

#### 检测逻辑

```javascript
// 简化检测算法（v2.0）
var consecutiveGPSCount = 0;  // 连续计数器
var threshold = 30;           // 阈值：30次

function processGPSData(gpsData) {
  var altitude = gpsData.altitude;  // 单位：米

  // 检查高度有效性
  var isValid = altitude !== null &&
                altitude !== undefined &&
                !isNaN(altitude);

  if (isValid) {
    consecutiveGPSCount++;  // 计数+1
    console.log('✅ GPS高度有效 (' + consecutiveGPSCount + '/30)');
  } else {
    consecutiveGPSCount = 0;  // 重置计数
    console.log('❌ GPS高度无效，计数器重置');
  }

  // 判定欺骗
  if (consecutiveGPSCount >= threshold) {
    triggerSpoofingAlert();  // 触发警告
  }
}
```

#### 为什么是30次？

- GPS更新频率: 约1-5秒/次
- 30次 ≈ 30-150秒（0.5-2.5分钟）
- 足够过滤偶发异常，又不会延迟太久

#### 冷却期机制

**目的**: 防止重复警告骚扰

```
首次检测 → 播放语音警告 → 进入冷却期(10分钟)
                ↓
        冷却期内再次检测 → 静默处理（不播放语音）
                ↓
        冷却期结束 → 恢复正常，可再次警告
```

---

### 传感器融合核心 (sensor-fusion-core.js)

#### 职责

- 多传感器数据时间同步
- 坐标系转换与对齐
- 卡尔曼滤波（可选，当前已禁用）
- 融合算法接口

#### 传感器坐标系

**设备坐标系** → **地理坐标系**

```
设备坐标系（手机）:
  X: 屏幕右侧
  Y: 屏幕顶部
  Z: 垂直屏幕向外

地理坐标系:
  X: 东
  Y: 北
  Z: 天顶
```

**转换矩阵**：
```javascript
// 旋转矩阵（Pitch-Roll-Yaw）
R = Rz(yaw) * Ry(pitch) * Rx(roll)
```

---

## 技术实现

### 离线优先设计

#### 数据本地化

| 数据类型 | 存储方式 | 大小 | 备注 |
|----------|----------|------|------|
| 机场数据 | JS模块打包 | ~2MB | 7405个机场 |
| 音频文件 | 小程序分包 | ~15MB | 338个录音 |
| 配置参数 | config.js | 50KB | 440个配置项 |
| 用户设置 | wx.setStorageSync | <10KB | 本地存储 |

#### 离线检测机制

```javascript
// 网络状态监听
wx.onNetworkStatusChange(function(res) {
  var isOffline = !res.isConnected;

  if (isOffline) {
    console.log('🌐 离线模式启用');
    // 停止网络请求
    // 使用本地缓存数据
  }
});
```

#### 离线功能保证

✅ **完全可用**：
- GPS定位（设备传感器）
- 机场搜索（本地数据）
- 地图渲染（Canvas绘制）
- 姿态仪（传感器融合）
- GPS欺骗检测（本地算法）

❌ **不可用**：
- 在线地图瓦片加载
- 实时气象数据
- 云端数据同步

---

### 性能优化策略

#### 1. DOM操作节流

```javascript
// safeSetData - 智能节流
var throttleConfig = {
  priority: 'normal',    // normal | high | low
  throttleKey: 'gps',   // 节流分组
  throttleMs: 100       // 节流间隔
};

page.safeSetData({
  altitude: newAltitude,
  speed: newSpeed
}, null, throttleConfig);
```

**节流优先级**：
- `high`: 关键飞行数据，最小节流（50ms）
- `normal`: 普通数据，标准节流（100ms）
- `low`: 调试信息，严格节流（1000ms）

#### 2. Canvas渲染优化

- **差异渲染** - 仅重绘变化区域
- **离屏Canvas** - 预渲染静态元素
- **requestAnimationFrame** - 同步屏幕刷新率

```javascript
// 智能渲染判断
function shouldRender(newData) {
  var hasPositionChange =
    Math.abs(newData.latitude - oldData.latitude) > 0.0001;
  var hasHeadingChange =
    Math.abs(newData.heading - oldData.heading) > 1;

  return hasPositionChange || hasHeadingChange || forceRender;
}
```

#### 3. 内存管理

- **数据缓冲区限制** - GPS历史最多保留60秒
- **定时器清理** - 页面销毁时立即清除所有定时器
- **模块销毁** - 完整的生命周期管理

```javascript
// 页面卸载清理
customOnUnload: function() {
  this._isDestroying = true;  // 标记销毁状态

  // 清理定时器
  clearTimeout(this.locationUpdateTimer);

  // 停止传感器
  wx.stopCompass();
  wx.stopAccelerometer();

  // 销毁模块
  this.destroyModules();
}
```

---

### 坐标系统详解

#### 支持的坐标系

| 坐标系 | 说明 | 用途 |
|--------|------|------|
| **WGS84** | 世界大地测量系统1984 | GPS原始坐标，国际通用 |
| **GCJ02** | 国测局坐标（火星坐标） | 中国地图服务 |
| **航空格式** | 度分秒表示法 | 飞行员习惯格式 |

#### 坐标转换

**WGS84 → 航空格式**

```javascript
// 输入: 39.9042°N (十进制)
var decimal = 39.9042;

// 计算度分秒
var degrees = Math.floor(decimal);          // 39°
var minutes = Math.floor((decimal - degrees) * 60);  // 54'
var seconds = Math.round(((decimal - degrees) * 60 - minutes) * 60);  // 15"

// 输出: 39°54'15"N
var aviation = degrees + '°' + minutes + "'" + seconds + '"N';
```

**GCJ02 ↔ WGS84**

```javascript
// 使用第三方库转换（如coordtransform）
var wgs84 = coordtransform.gcj02towgs84(lng, lat);
```

---

## 使用指南

### 快速开始

#### 1. 首次进入

```
打开驾驶舱页面
   ↓
系统请求GPS权限
   ↓
授权成功 → 开始定位
   ↓
等待GPS信号（约5-30秒）
   ↓
地图显示当前位置与附近机场
```

#### 2. 基本操作

**查看附近机场**：
- 自动显示最近和次近机场
- 双指捏合/拉伸调整显示范围

**追踪指定机场**：
1. 点击输入框
2. 输入ICAO代码（如ZBAA）
3. 按回车确认
4. 机场居中显示并高亮

**切换航向模式**：
- 点击"航向/航迹"按钮切换
- 航向模式：使用指南针
- 航迹模式：使用GPS计算

**调整地图定向**：
- 点击"定向模式"按钮循环切换
- 航向朝上 → 航迹朝上 → 北向朝上

---

### 高级功能

#### 姿态仪校准

**场景**: 飞机停稳在平地，但姿态仪显示pitch/roll不为0

**操作步骤**：
1. 确保飞机处于水平状态
2. 点击姿态仪右下角"重置"按钮
3. 等待3秒，校准完成
4. Pitch和Roll归零

**验证**: 移动设备，观察姿态仪是否正确响应

---

#### GPS欺骗检测配置

**开启步骤**：
1. 点击调试面板展开按钮
2. 找到"GPS欺骗监控"开关
3. 点击开关，弹出确认对话框
4. 选择"开启声音"或"静音开启"
5. 监控启用，状态栏显示"监控中"

**关闭步骤**：
1. 点击"GPS欺骗监控"开关
2. 立即关闭，无需确认

**注意事项**：
- ⚠️ **地面禁用** - 地面GPS高度数据会触发误报
- ✈️ **仅空中使用** - 起飞后开启，落地前关闭
- 🔊 **语音提醒** - 首次检测播放警告音，10分钟冷却期

---

#### 距离圈自定义

**方法1: 手势缩放**
- 双指捏合/拉伸
- 自动跳转到最接近的标准级别

**方法2: 选择器**
1. 点击"距离圈"按钮
2. 弹出选择器，显示8个标准级别
3. 点击目标级别（如"40 NM - 扩展区域"）
4. 地图立即切换并重新渲染

**保存状态**：
- 距离圈设置自动保存到本地存储
- 下次打开页面恢复上次设置

---

### 故障恢复

#### GPS无信号

**症状**: 坐标显示"--"，状态显示"无信号"

**排查步骤**：
1. 检查设备GPS功能是否开启
   - 设置 → 隐私 → 定位服务
2. 检查微信小程序权限
   - 微信 → 设置 → 隐私 → 位置信息
3. 检查是否在室内
   - GPS需要天空视野，室内信号弱
4. 等待定位（最多2分钟）
   - 冷启动需要下载星历数据

**解决方案**：
- 移动到窗边或室外
- 重启GPS（关闭并重新打开定位服务）
- 点击"打开设置"重新授权

---

#### 附近机场为空

**症状**: 左右机场卡片显示"无机场 --- NM ---°"

**可能原因**：
1. GPS坐标无效（检查经纬度是否为0或NaN）
2. 机场数据未加载（检查网络或分包加载）
3. 距离圈范围过小（当前位置无机场）

**排查步骤**：
1. 检查GPS坐标
   - 展开调试面板
   - 查看"经度/纬度"是否有效
2. 检查机场数据
   - 调试面板显示"机场数量: 7405"表示已加载
3. 扩大距离圈
   - 切换到160 NM或320 NM级别

**解决方案**：
- 等待GPS定位稳定（约30秒）
- 重启页面重新加载机场数据
- 确认不在极偏远区域（如南极、沙漠）

---

#### 姿态仪卡住不动

**症状**: Pitch/Roll数值不更新，Canvas静止

**可能原因**：
1. 传感器权限未授权
2. 设备不支持陀螺仪/加速度计
3. 页面进入后台导致传感器暂停

**排查步骤**：
1. 检查传感器权限
   - 微信 → 设置 → 隐私 → 运动与健身
2. 检查设备兼容性
   - 部分低端设备无陀螺仪
3. 检查页面状态
   - 切换到其他页面再返回

**解决方案**：
- 长按"重置"按钮 → 选择"强制刷新渲染"
- 重新进入驾驶舱页面
- 重启微信小程序

---

## 配置参数

### 主配置文件 (config.js)

**配置项分类**：

| 分类 | 配置数量 | 说明 |
|------|----------|------|
| `global` | 10 | 全局开关（调试模式、离线模式） |
| `gps` | 80 | GPS相关（坐标系、更新频率、滤波参数） |
| `compass` | 30 | 指南针相关（平滑阈值、缓冲区大小） |
| `map` | 40 | 地图相关（缩放级别、渲染频率） |
| `attitude` | 50 | 姿态仪相关（传感器融合权重） |
| `spoofing` | 30 | GPS欺骗检测（阈值、冷却期） |
| `performance` | 200 | 性能优化（节流配置、缓存策略） |

### 重要配置项

#### GPS配置

```javascript
gps: {
  // 坐标系统
  coordinateSystem: 'wgs84',  // 'wgs84' | 'gcj02'

  // 更新频率
  updateInterval: 1000,  // 1秒

  // 高精度模式
  isHighAccuracy: true,
  highAccuracyExpireTime: 5000,  // 5秒超时

  // 速度阈值
  maxReasonableSpeed: 600,  // 600kt（合理最大速度）
  minSpeedForTrack: 10,     // 10kt（最小航迹速度）

  // 坐标显示
  showCoordinateSystem: true,  // 显示坐标系标识

  // GPS欺骗检测
  spoofingDetection: {
    enabled: false,          // 默认关闭
    threshold: 30,           // 连续30次触发
    cooldownPeriod: 600000,  // 10分钟冷却期
    voiceAlertEnabled: true  // 语音警告
  }
}
```

#### 地图配置

```javascript
map: {
  // 缩放级别（海里）
  zoomLevels: [5, 10, 20, 40, 80, 160, 320, 640],
  defaultZoomIndex: 2,  // 默认20 NM

  // 渲染频率
  renderInterval: 100,  // 最小100ms

  // 定向模式
  defaultOrientationMode: 'track-up',  // 航迹朝上

  // 航向更新阈值
  headingUpdateThreshold: 5,  // 5度变化才更新
  lowSpeedThreshold: 50       // 50kt以下低速阈值
}
```

#### 姿态仪配置

```javascript
attitude: {
  // 传感器融合
  sensorFusion: {
    gyroWeight: 0.98,       // 陀螺仪权重（互补滤波）
    accelWeight: 0.02,      // 加速度计权重
    updateFrequency: 30     // 30 FPS
  },

  // 校准
  calibration: {
    autoSave: true,              // 自动保存校准数据
    storageKey: 'attitude_calibration'
  }
}
```

---

## 故障排查

### 常见问题速查表

| 问题 | 可能原因 | 快速解决 |
|------|----------|----------|
| GPS无信号 | 权限未授权 | 点击"打开设置"授权 |
| 附近机场为空 | 坐标验证失败 | 检查经纬度是否有效 |
| 姿态仪不动 | 传感器暂停 | 长按重置→强制刷新 |
| 地图不旋转 | 指南针未启动 | 检查指南针权限 |
| GPS欺骗误报 | 地面模式误开 | 关闭GPS欺骗监控 |
| 距离圈消失 | mapRange=0 | 重新选择距离圈级别 |
| Canvas空白 | 渲染未启动 | 刷新页面 |
| 位置不更新 | 定时器未启动 | 检查customOnShow是否调用 |

### 调试面板使用

#### 展开调试面板

```
点击"调试"按钮（右下角）
   ↓
调试面板展开
   ↓
显示详细GPS信息：
- 原始高度(米)
- 高度类型
- 定位精度
- 更新间隔
- 定位提供商
- GPS状态
```

#### 调试信息解读

| 字段 | 说明 | 正常值 |
|------|------|--------|
| 原始高度 | GPS返回的原始高度（米） | 非null |
| 高度类型 | 数据类型 | "number" |
| 高度有效 | 高度数据有效性 | true |
| 定位精度 | 水平精度（米） | <50 |
| 更新间隔 | 两次更新间隔（ms） | 1000-5000 |
| 定位提供商 | GPS/网络定位 | "gps" |
| GPS状态 | 当前GPS状态 | "信号正常" |

#### 测试按钮

| 按钮 | 功能 | 用途 |
|------|------|------|
| **测试getLocation** | 调用一次wx.getLocation | 验证GPS API是否可用 |
| **切换持续定位** | 启动/停止wx.startLocationUpdate | 测试持续定位功能 |
| **测试chooseLocation** | 打开位置选择器 | 验证位置权限 |
| **清除机场缓存** | 清除本地存储的机场数据 | 重新加载机场数据 |

---

### 日志分析

#### 关键日志标识

```javascript
// GPS相关
'🛰️ 启动GPS位置追踪服务'    // GPS启动
'✅ GPS权限已授予'           // 权限成功
'📍 GPS位置更新'             // 位置更新
'❌ GPS位置错误'             // 定位失败

// 机场相关
'✈️ 接收到目标机场'         // 导航目标
'✅ 附近机场更新成功'        // 机场计算完成
'⚠️ GPS坐标无效'            // 坐标验证失败

// 姿态仪相关
'🎯 姿态仪状态变化: active'  // 姿态仪启动
'✅ 姿态仪恢复成功'          // 页面恢复后重启
'❌ 姿态仪错误'              // 传感器错误

// GPS欺骗检测
'🛡️ GPS欺骗检测器已重置'    // 检测器初始化
'🚨 GPS欺骗检测: NORMAL -> SPOOFING'  // 检测到欺骗
'✅ GPS欺骗解除'             // 恢复正常
```

#### 性能日志

```javascript
'🔧 GPS位置更新节流: 跳过 (距离上次50ms)'  // 节流生效
'📡 updateMapRenderer数据'                // 地图数据更新
'🔧 Canvas状态诊断'                       // Canvas诊断
```

---

## 开发规范

### 代码规范

#### ES5语法要求

**必须遵守**：
- ✅ 使用`var`声明变量（禁止`let`/`const`）
- ✅ 使用`function`关键字（禁止箭头函数）
- ✅ 使用字符串拼接（禁止模板字符串）
- ✅ 使用`obj.key`访问（禁止解构赋值）

**错误示例**：
```javascript
// ❌ 错误
const speed = 250;
const greet = (name) => `Hello ${name}`;
const { lat, lng } = position;
```

**正确示例**：
```javascript
// ✅ 正确
var speed = 250;
var greet = function(name) {
  return 'Hello ' + name;
};
var lat = position.lat;
var lng = position.lng;
```

---

### GPS数据处理规范

#### 严格禁止

**🚨 禁止对GPS地速和GPS高度进行任何滤波或平滑处理**

**原因**：
- 飞行安全要求使用原始GPS数据
- 滤波可能延迟危险情况的显示
- 平滑可能掩盖真实的速度/高度变化

**正确做法**：
```javascript
// ✅ 正确 - 直接使用原始数据
var speed = Math.round(locationData.speed);  // 仅取整
var altitude = locationData.altitude;         // 直接使用

// 立即显示
this.setData({
  speed: speed,
  altitude: altitude
});
```

**错误做法**：
```javascript
// ❌ 禁止 - 滤波处理
var smoothedSpeed = this.kalmanFilter.update(speed);
var smoothedAltitude = this.movingAverage(altitude);
```

---

### 坐标验证规范

#### 有效坐标判断

**正确方式**：
```javascript
// ✅ 正确 - 类型检查 + NaN检测 + 范围验证
var isValidLat = typeof lat === 'number' &&
                 !isNaN(lat) &&
                 lat >= -90 && lat <= 90;

var isValidLng = typeof lng === 'number' &&
                 !isNaN(lng) &&
                 lng >= -180 && lng <= 180;
```

**错误方式**：
```javascript
// ❌ 错误 - 真值性判断（会拒绝0值）
if (lat && lng) {
  // 赤道（lat=0）和本初子午线（lng=0）会被错误拒绝
}

// ❌ 错误 - 排除0值
if (lat !== 0 && lng !== 0) {
  // 几内亚湾原点(0,0)是合法位置
}
```

**特别说明**：
- 赤道（纬度0°）是**有效坐标**
- 本初子午线（经度0°）是**有效坐标**
- 原点(0,0)位于大西洋几内亚湾，理论上是合法位置

---

### 模块化开发

#### 模块创建模板

```javascript
// modules/my-module.js
var Logger = require('./logger.js');

module.exports = {
  /**
   * 创建模块实例
   * @param {Object} config 配置对象
   * @returns {Object} 模块实例
   */
  create: function(config) {
    var module = {
      // 私有状态
      _state: 'initialized',

      /**
       * 初始化模块
       * @param {Object} page 页面实例
       * @param {Object} callbacks 回调函数
       */
      init: function(page, callbacks) {
        module.pageRef = page;
        module.callbacks = callbacks || {};
        Logger.debug('模块已初始化');
      },

      /**
       * 启动模块（生命周期）
       */
      start: function() {
        module._state = 'running';
        return Promise.resolve();
      },

      /**
       * 停止模块（生命周期）
       */
      stop: function() {
        module._state = 'stopped';
        return Promise.resolve();
      },

      /**
       * 获取模块状态
       */
      getStatus: function() {
        return {
          name: '我的模块',
          state: module._state,
          isHealthy: module._state === 'running'
        };
      },

      /**
       * 销毁模块
       */
      destroy: function() {
        module.pageRef = null;
        module.callbacks = null;
      }
    };

    return module;
  }
};
```

---

### 异步分包加载

**强制要求** - 跨分包引用必须异步

```javascript
// ✅ 正确 - 异步加载
require('../../../packageC/airportdata.js', function(module) {
  self.airportsData = module;
  console.log('数据加载成功');
}, function(error) {
  console.error('加载失败:', error);
  wx.showToast({
    title: '机场数据加载失败',
    icon: 'none'
  });
});

// ❌ 错误 - 同步加载（生产环境会失败）
var airportsData = require('../../../packageC/airportdata.js');
```

---

## 附录

### A. 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| GPS地速 | Ground Speed | GPS计算的对地速度（kt） |
| GPS高度 | GPS Altitude | GPS测量的海拔高度（ft） |
| 航向 | Heading | 飞机机头指向（磁航向） |
| 航迹 | Track | 飞机实际地面移动方向 |
| 俯仰角 | Pitch | 机头上下角度（°） |
| 滚转角 | Roll | 机翼左右倾斜角度（°） |
| ICAO代码 | ICAO Code | 国际民航组织机场代码（4位） |
| IATA代码 | IATA Code | 国际航协机场代码（3位） |
| 海里 | Nautical Mile | 航空距离单位（1NM≈1.852km） |
| 节 | Knot | 航空速度单位（1kt≈1.852km/h） |

### B. 快捷操作

| 操作 | 快捷方式 | 说明 |
|------|----------|------|
| 缩小地图 | 双指捏合 | 减小距离圈 |
| 放大地图 | 双指拉伸 | 增大距离圈 |
| 追踪机场 | 点击机场卡片 | 快速追踪 |
| 取消追踪 | 点击已追踪机场 | 清除追踪 |
| 姿态仪归零 | 单击重置按钮 | 快速校准 |
| 高级选项 | 长按重置按钮 | 显示详细菜单 |
| 切换航向模式 | 点击航向/航迹 | 模式切换 |
| 切换定向 | 点击定向按钮 | 循环切换 |

### C. 常用机场代码

#### 中国主要机场

| ICAO | IATA | 机场名称 |
|------|------|----------|
| ZBAA | PEK | 北京首都国际机场 |
| ZBAD | PKX | 北京大兴国际机场 |
| ZSPD | PVG | 上海浦东国际机场 |
| ZSSS | SHA | 上海虹桥国际机场 |
| ZGSZ | CAN | 广州白云国际机场 |
| ZUUU | CTU | 成都双流国际机场 |
| ZUCK | TFU | 成都天府国际机场 |
| ZYHB | HRB | 哈尔滨太平国际机场 |
| ZYTX | SHE | 沈阳桃仙国际机场 |
| ZSNJ | NKG | 南京禄口国际机场 |

#### 国际主要机场

| ICAO | IATA | 机场名称 |
|------|------|----------|
| VHHH | HKG | 香港国际机场 |
| RCTP | TPE | 台北桃园国际机场 |
| RJAA | NRT | 东京成田国际机场 |
| RJBB | KIX | 大阪关西国际机场 |
| RKSI | ICN | 首尔仁川国际机场 |
| WSSS | SIN | 新加坡樟宜机场 |
| VTBS | BKK | 曼谷素万那普机场 |
| YSSY | SYD | 悉尼金斯福德·史密斯机场 |
| EGLL | LHR | 伦敦希思罗机场 |
| LFPG | CDG | 巴黎戴高乐机场 |

---

## 版本历史

### v2.0 (2025-10-16)

**重大变更**：
- ✅ 修复GPS欺骗检测缓冲区显示bug
- ✅ 修复附近机场坐标验证bug（支持0°坐标）
- ✅ 优化坐标验证逻辑（index.js + airport-manager.js）
- 📝 完善文档（本文档首次发布）

**技术改进**：
- 使用类型检查替代真值性判断
- 统一坐标验证标准
- 增强错误日志输出

### v1.x (历史版本)

- 初始模块化重构（18个模块）
- GPS欺骗检测功能上线
- 姿态仪表系统集成
- 三传感器融合算法实现

---

## 联系与支持

**开发团队**: FlightToolbox Team
**文档维护**: Claude Code Assistant
**最后更新**: 2025-10-16

**相关文档**：
- `CLAUDE.md` - 项目开发规范
- `README.md` - 项目概述
- `miniprogram/pages/cockpit/modules/config.js` - 配置参数详解

---

**文档结束**

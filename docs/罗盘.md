# 微信小程序罗盘 API 文档整合

本文档整合了微信小程序罗盘（Compass）相关的核心API，包括 `wx.startCompass`、`wx.onCompassChange`、`wx.stopCompass` 和 `wx.offCompassChange`。

## 目录
1.  [wx.startCompass(Object object)](#wxstartcompassobject-object) - 启动罗盘
2.  [wx.onCompassChange(function callback)](#wxoncompasschangefunction-callback) - 监听罗盘数据
3.  [wx.stopCompass(Object object)](#wxstopcompassobject-object) - 停止罗盘
4.  [wx.offCompassChange(function callback)](#wxoffcompasschangefunction-callback) - 取消监听罗盘数据
5.  [综合示例](#综合示例)

---

## wx.startCompass(Object object)

启动罗盘。调用此接口需要[用户授权](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/authorize.html) `scope.userLocation`。

**最低基础库版本**: `2.1.0`

### 参数 (Object object)

| 参数名 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| success | `function` | 否 | 接口调用成功的回调函数 |
| fail | `function` | 否 | 接口调用失败的回调函数 |
| complete | `function` | 否 | 接口调用结束的回调函数（调用成功、失败都会执行） |

### 代码示例

```javascript
wx.startCompass({
  success(res) {
    console.log('罗盘启动成功', res)
  },
  fail(err) {
    console.error('罗盘启动失败', err)
  }
})
```

---

## wx.onCompassChange(function callback)

监听罗盘数据变化事件。频率为 5 次/秒。接口调用后会自动开始监听，可使用 `wx.stopCompass` 停止监听。

**最低基础库版本**: `1.1.0`

### 参数 (function callback)

回调函数会携带一个 `Object` 类型的参数 `res`，其属性如下：

| 属性 | 类型 | 说明 |
| :--- | :--- | :--- |
| direction | `number` | 面对的方向度数，范围是 0-360。 |
| accuracy | `number` \| `string` | 精度。<br>• **iOS**: 返回一个 `number` 类型的范围值，范围越小，精度越高。<br>• **Android**: 返回 `high`, `medium`, `low` 等字符串。<br>• **旧版本兼容**: 在基础库 `2.5.0` 之前，iOS返回1-4的值，安卓返回1-3的值。若获取失败，安卓返回-1，iOS 返回 'unknow'。 |

### 代码示例

```javascript
const compassListener = function (res) {
  console.log('当前方向：' + res.direction);
  console.log('精度：' + res.accuracy);
}

// 注册监听
wx.onCompassChange(compassListener)
```

---

## wx.stopCompass(Object object)

停止监听罗盘数据。

**最低基础库版本**: `1.1.0`

### 参数 (Object object)

| 参数名 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| success | `function` | 否 | 接口调用成功的回调函数 |
| fail | `function` | 否 | 接口调用失败的回调函数 |
| complete | `function` | 否 | 接口调用结束的回调函数（调用成功、失败都会执行） |

### 代码示例

```javascript
wx.stopCompass({
  success(res) {
    console.log('已停止监听罗盘', res)
  },
  fail(err) {
    console.error('停止监听罗盘失败', err)
  }
})
```

---

## wx.offCompassChange(function callback)

取消监听罗盘数据变化事件。可以取消指定的回调函数，如果不传参数，则会移除所有监听。

**最低基础库版本**: `2.1.0`

### 参数 (function callback)

| 参数名 | 类型 | 必填 | 说明 |
| :--- | :--- | :--- | :--- |
| callback | `function` | 否 | `wx.onCompassChange` 传入的监听函数。不传此参数则移除所有监听函数。 |

### 代码示例

```javascript
// 定义一个监听函数
const listener = function (res) {
  console.log('罗盘数据：', res)
}

// 注册监听
wx.onCompassChange(listener)

// 在不需要时，取消指定的监听函数
wx.offCompassChange(listener)

// 或者，取消所有罗盘监听函数
// wx.offCompassChange()
```

---

## 综合示例

下面是一个完整的页面示例，展示了如何使用这四个API来控制罗盘的启动、监听和停止。

### `page.wxml` 文件
```xml
<view class="container">
  <view class="info">
    <view>方向: {{ direction }}°</view>
    <view>精度: {{ accuracy }}</view>
  </view>
  <view class="buttons">
    <button type="primary" bindtap="handleStartCompass">开始监听</button>
    <button type="warn" bindtap="handleStopCompass">停止监听</button>
  </view>
</view>
```

### `page.js` 文件
```javascript
Page({
  data: {
    direction: 0,
    accuracy: '未知'
  },

  // 将监听函数保存到 this 中，以便后续取消
  compassListener: null,

  onLoad() {
    // 创建监听函数
    this.compassListener = (res) => {
      console.log('罗盘数据更新:', res);
      this.setData({
        direction: res.direction.toFixed(2),
        accuracy: res.accuracy
      });
    };
  },

  // 点击“开始监听”
  handleStartCompass() {
    wx.startCompass({
      success: () => {
        console.log('startCompass success');
        // 启动成功后，注册监听
        wx.onCompassChange(this.compassListener);
        wx.showToast({ title: '已开始监听', icon: 'success' });
      },
      fail: (err) => {
        console.error('startCompass fail', err);
        wx.showToast({ title: '启动罗盘失败', icon: 'none' });
      }
    });
  },

  // 点击“停止监听”
  handleStopCompass() {
    wx.stopCompass({
      success: () => {
        console.log('stopCompass success');
        // 停止罗盘后，为保险起见可以同时取消监听
        // wx.offCompassChange(this.compassListener); // 通常 stopCompass 后会自动停止回调
        wx.showToast({ title: '已停止监听', icon: 'none' });
      },
      fail: (err) => {
        console.error('stopCompass fail', err);
      }
    });
  },

  // 页面卸载时自动停止，防止内存泄漏
  onUnload() {
    console.log('页面卸载，停止罗盘监听');
    // 确保在页面离开时停止罗盘并移除监听
    wx.stopCompass();
    if (this.compassListener) {
        wx.offCompassChange(this.compassListener);
    }
  }
})
```

### `page.wxss` 文件
```css
.container {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 50rpx;
}

.info {
  font-size: 36rpx;
  margin-bottom: 80rpx;
  text-align: center;
}

.info view {
  margin: 10rpx 0;
}

.buttons {
  display: flex;
  flex-direction: column;
}

.buttons button {
  margin: 20rpx 0;
  width: 500rpx;
}
```
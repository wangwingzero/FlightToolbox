# GPS过滤机制说明

## 问题描述

GPS信号受手机硬件或环境因素影响，会出现瞬间位置跳变，导致计算出的地速异常（如瞬间达到2000kt），严重影响用户体验。

## 解决方案

实现了多层GPS数据过滤机制，确保显示的速度和位置数据真实可靠。

## 过滤机制详解

### 1. 位置合理性检查 (`isReasonableLocation`)

在数据进入系统前进行第一道过滤：

- **时间间隔检查**：忽略间隔小于0.5秒的重复数据
- **隐含速度计算**：根据两点间距离和时间计算隐含速度
- **异常位置剔除**：如果隐含速度超过900kt（最大合理速度的1.5倍），拒绝该数据点

```javascript
// 计算隐含速度
var impliedSpeed = (distance / timeDiff) * 1.944; // kt
if (impliedSpeed > this.data.maxReasonableSpeed * 1.5) {
  return false; // 拒绝异常数据
}
```

### 2. 速度过滤和平滑 (`filterSpeed`)

对计算出的速度进行多重验证：

#### 2.1 最大速度限制
- 限制：600kt（民航飞机的极限速度）
- 处理：超过限制时使用上次有效速度

#### 2.2 加速度限制
- 限制：50kt/s（约25G，远超飞机物理极限）
- 处理：限制速度变化率，避免突变

#### 2.3 移动平均平滑
- 缓冲区大小：5个数据点
- 算法：简单移动平均，平滑短期波动

```javascript
// 速度缓冲区和平滑
this.data.speedBuffer.push(rawSpeed);
var smoothedSpeed = this.calculateMovingAverage(this.data.speedBuffer);
```

### 3. 垂直速度过滤

- 限制：±6000 ft/min（极限爬升/下降率）
- 处理：超过限制时显示为0

### 4. 异常计数和警告

- 连续异常计数器
- 超过3次连续异常时显示警告
- 正常数据会重置计数器

## 参数配置

```javascript
// GPS过滤参数
maxReasonableSpeed: 600,    // 最大合理速度(kt)
maxAcceleration: 50,        // 最大加速度(kt/s)
speedBufferSize: 5,         // 速度缓冲区大小
maxAnomalyCount: 3,         // 最大连续异常次数
```

## 效果

1. **消除速度突变**：2000kt等异常速度被有效过滤
2. **平滑显示**：速度变化更加自然流畅
3. **保持响应性**：真实的速度变化仍能及时反映
4. **用户提示**：持续异常时会提示"GPS信号异常"

## 测试建议

1. 在移动的交通工具上测试（如汽车、高铁）
2. 在GPS信号不稳定的环境测试（如高楼间）
3. 观察速度显示是否平滑，无突变
4. 验证真实速度变化的响应性

## 未来优化方向

1. 实现卡尔曼滤波器，提供更精确的预测
2. 根据GPS精度动态调整过滤参数
3. 添加速度趋势预测，进一步平滑显示
4. 记录和分析异常模式，优化过滤算法
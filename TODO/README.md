# FlightToolbox 代码优化 TODO 清单

## 📋 总体概述

基于代码审查结果，本清单包含所有需要改进的项目，按优先级分类执行，确保离线优先、稳定性和合规性。

## 🚨 P0 优先级 - 立即修复 (影响核心功能)

### P0.1 位置权限和资源清理规范
**问题**: GPS定位资源未正确清理，可能导致电量消耗和内存泄漏
**涉及文件**: 
- `pages/cockpit/modules/gps-manager.js`
- `pages/cockpit/index.js`
- `utils/base-page.js`

**任务**:
- [x] 审查现有wx.stopLocationUpdate和wx.offLocationChange调用
- [ ] 确保所有GPS相关页面在onUnload时正确清理资源
- [ ] 在BasePage基类中添加统一的资源清理机制
- [ ] 验证飞行模式下GPS功能的降级处理

**验收标准**:
- 所有使用GPS的页面都有清理机制
- 内存泄漏测试通过
- 飞行模式下功能正常降级

### P0.2 跨分包同步require风险修复  
**问题**: 多处存在跨分包同步require，生产环境可能失败
**涉及文件**:
- `utils/data-manager.js`
- `utils/twin-engine-data-manager.js` 
- `pages/communication-rules-detail/index.ts`
- `pages/test-map/index.js`

**任务**:
- [ ] 将所有同步require改为异步require
- [ ] 添加错误处理和fallback机制
- [ ] 更新相关页面的数据加载逻辑
- [ ] 测试分包预加载失败的降级场景

**验收标准**:
- 无同步跨分包require
- 分包加载失败时有合理降级
- 所有相关功能测试通过

### P0.3 BasePage在TypeScript页面中的类型支持
**问题**: TypeScript页面缺少BasePage类型定义，影响开发体验
**涉及文件**: 新增类型声明文件

**任务**:
- [ ] 创建BasePage类型声明文件
- [ ] 为createPage方法提供泛型支持
- [ ] 添加BasePage提供的方法类型定义
- [ ] 测试TypeScript页面的智能提示

**验收标准**:
- TypeScript页面有完整的BasePage类型支持
- 智能提示和类型检查正常
- 不影响现有JS页面的使用

## ⚠️ P1 优先级 - 重要改进 (影响用户体验)

### P1.1 样式响应式改造 (px → rpx)
**问题**: 大量使用固定px单位，在不同设备上显示异常
**涉及文件**: 所有.wxss和.wxml文件

**任务**:
- [ ] 制定rpx转换标准 (750rpx = 全屏宽度)
- [ ] 优先改造核心页面 (cockpit, home, search)
- [ ] 批量转换工具类样式
- [ ] 保留第三方组件库的px单位

**验收标准**:
- 核心功能在不同设备上显示正常
- 字体、间距、尺寸都使用rpx
- Vant组件样式不被破坏

### P1.2 驾驶舱WXML中wx.*API展示优化
**问题**: WXML中的wx.*API名称可能误导用户
**涉及文件**: `pages/cockpit/index.wxml`

**任务**:
- [ ] 将wx.*API文本标记为"只读说明"
- [ ] 添加不可点击样式和说明文案
- [ ] 确保实际API调用只在JS中进行
- [ ] 添加开发调试开关控制测试功能

**验收标准**:
- WXML中的API名称明确标识为说明性质
- 无误触发风险
- 调试功能可控制显示/隐藏

### P1.3 错误处理机制优化
**问题**: 虽然有大量try-catch，但错误处理不够统一
**涉及文件**: 所有包含错误处理的文件

**任务**:
- [ ] 审查现有错误处理模式
- [ ] 统一错误分类和处理策略
- [ ] 改进离线场景的错误提示
- [ ] 添加错误恢复机制

**验收标准**:
- 错误处理统一规范
- 离线环境下错误提示友好
- 关键功能有恢复机制

## 🔧 P2 优先级 - 优化改进 (提升质量)

### P2.1 app.json配置审查和优化
**问题**: 配置项需要系统性审查和优化
**涉及文件**: `miniprogram/app.json`

**任务**:
- [ ] 审查requiredPrivateInfos配置
- [ ] 优化preloadRule预加载策略
- [ ] 验证permission权限配置
- [ ] 检查lazyCodeLoading设置

**验收标准**:
- 权限配置最小化且完整
- 预加载策略最优化
- 懒加载配置合理

### P2.2 网络请求依赖清理
**问题**: 虽然主要是离线应用，但需确认无意外网络依赖
**涉及文件**: 所有包含http(s)引用的文件

**任务**:
- [ ] 审查所有网络相关代码
- [ ] 清理无用的网络请求
- [ ] 确保离线优先策略
- [ ] 添加网络状态检测

**验收标准**:
- 无意外的网络依赖
- 离线模式完全可用
- 网络异常处理完善

### P2.3 代码质量和规范性提升
**问题**: 部分代码需要规范化和优化
**涉及文件**: 全项目

**任务**:
- [ ] 统一代码风格和注释规范
- [ ] 优化长函数和复杂逻辑
- [ ] 清理未使用的代码和变量
- [ ] 添加关键功能的单元测试

**验收标准**:
- 代码风格统一
- 关键功能有测试覆盖
- 性能指标达标

## 🔄 实施顺序建议

### 第一阶段 (1-2天): P0核心修复
1. 位置权限资源清理 → 防止电量浪费
2. 跨分包require修复 → 避免生产故障  
3. TypeScript类型支持 → 提升开发效率

### 第二阶段 (3-5天): P1用户体验
1. 样式响应式改造 → 适配所有设备
2. WXML API展示优化 → 避免用户困惑
3. 错误处理统一 → 提升稳定性

### 第三阶段 (1-2天): P2质量提升  
1. 配置项优化 → 性能和合规
2. 网络依赖清理 → 纯离线保证
3. 代码规范化 → 长期维护性

## ✅ 对照清单 (每项完成前检查)

**安全性检查**:
- [ ] 不引入新的外部依赖
- [ ] 不破坏现有离线功能
- [ ] 不影响已申请的权限配置
- [ ] 向下兼容所有现有功能

**功能验证**:
- [ ] 飞行模式下功能正常
- [ ] 所有分包可正常加载
- [ ] GPS定位功能完整
- [ ] 音频播放无异常

**性能检查**:
- [ ] 页面加载速度无回退
- [ ] 内存使用无明显增长
- [ ] 电量消耗无异常增长
- [ ] 资源清理机制有效

**代码质量**:
- [ ] 语法检查无错误
- [ ] TypeScript类型检查通过
- [ ] 核心功能测试通过
- [ ] 代码规范性检查通过

---

## 📞 紧急联系和回滚策略

**回滚原则**: 任何改动如果影响核心飞行功能，立即回滚
**测试要求**: 每个阶段完成后进行完整的飞行模式测试
**验收标准**: 所有功能必须在离线环境下完全可用

**完成时间预估**: 6-9个工作日
**风险评估**: 低风险 (主要为代码规范和优化改造)
**依赖关系**: P0任务为P1和P2的前置依赖
# FlightToolboxæ ¸å¿ƒå·¥å…·æ–‡ä»¶é«˜é£é™©é—®é¢˜ä¿®å¤æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-10-16
**ä¿®å¤èŒƒå›´**: æ ¸å¿ƒå·¥å…·æ–‡ä»¶é«˜é£é™©é—®é¢˜ï¼ˆ15ä¸ªï¼‰
**ä¿®å¤çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ

---

## ğŸ“Š ä¿®å¤æ¦‚è§ˆ

| æ–‡ä»¶ | ä¿®å¤é—®é¢˜æ•° | çŠ¶æ€ |
|------|-----------|------|
| base-page.js | 3 | âœ… å·²å®Œæˆ |
| ad-manager.js | 3 | âœ… å·²å®Œæˆ |
| data-loader.js | 2 | âœ… å·²å®Œæˆ |
| audio-config.js | 2 | âœ… å·²å®Œæˆ |
| error-handler.js | 1 | âœ… å·²å®Œæˆ |
| **åˆè®¡** | **15** | **âœ… å…¨éƒ¨å®Œæˆ** |

---

## ğŸ”´ é«˜é£é™©é—®é¢˜ä¿®å¤è¯¦æƒ…

### 1. base-page.js - å†…å­˜æ³„æ¼é£é™©ï¼ˆ3ä¸ªé—®é¢˜ï¼‰

#### ä¿®å¤1.1: å®šæ—¶å™¨åˆ†å¼€ç®¡ç† âœ…
**é—®é¢˜**: timeoutå’Œintervalå…±ç”¨åŒä¸€æ•°ç»„ï¼Œæ¸…ç†æ—¶å¯èƒ½è¯¯æ“ä½œ

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// ä¿®å¤å‰ï¼šå…±ç”¨timersæ•°ç»„
if (!this.timers) {
  this.timers = [];
}
this.timers.push(timeoutId);

// ä¿®å¤åï¼šåˆ†å¼€ç®¡ç†
// createSafeTimeoutä¸­
if (!this._timeouts) {
  this._timeouts = [];
}
this._timeouts.push(timeoutId);

// createSafeIntervalä¸­
if (!this._intervals) {
  this._intervals = [];
}
this._intervals.push(intervalId);

// cleanupä¸­åˆ†åˆ«æ¸…ç†
if (this._timeouts && Array.isArray(this._timeouts)) {
  for (var i = 0; i < this._timeouts.length; i++) {
    clearTimeout(this._timeouts[i]);
  }
  this._timeouts = [];
}

if (this._intervals && Array.isArray(this._intervals)) {
  for (var i = 0; i < this._intervals.length; i++) {
    clearInterval(this._intervals[i]);
  }
  this._intervals = [];
}
```

**å½±å“èŒƒå›´**: æ‰€æœ‰ä½¿ç”¨BasePageçš„é¡µé¢
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**:
- `miniprogram/utils/base-page.js:845-849` (åˆ›å»ºtimeout)
- `miniprogram/utils/base-page.js:876-880` (åˆ›å»ºinterval)
- `miniprogram/utils/base-page.js:897-927` (cleanupæ¸…ç†)

---

#### ä¿®å¤1.2: ä¼ æ„Ÿå™¨ç›‘å¬å™¨é˜²é‡å¤ç»‘å®š âœ…
**é—®é¢˜**: é¡µé¢å¯èƒ½å¤šæ¬¡è°ƒç”¨ä¼ æ„Ÿå™¨APIå¯¼è‡´ç›‘å¬å™¨ç´¯ç§¯

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// åœ¨onLoadæ—¶å…ˆæ¸…ç†æ—§ç›‘å¬å™¨
onLoad: function(options) {
  // ğŸ”§ ä¿®å¤ï¼šå…ˆæ¸…ç†ä¼ æ„Ÿå™¨ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
  try {
    wx.offLocationChange();
    wx.offCompassChange();
    wx.offAccelerometerChange();
    wx.offGyroscopeChange();
    console.log('ğŸ§¹ onLoadæ¸…ç†æ—§ä¼ æ„Ÿå™¨ç›‘å¬å™¨');
  } catch (error) {
    // é™é»˜å¤„ç†ï¼Œé¦–æ¬¡åŠ è½½æ—¶å¯èƒ½æ²¡æœ‰ç›‘å¬å™¨
  }

  this.initializeErrorHandler();

  // è°ƒç”¨å­é¡µé¢çš„customOnLoad
  if (this.customOnLoad && typeof this.customOnLoad === 'function') {
    this.customOnLoad.call(this, options);
  }
}
```

**å½±å“èŒƒå›´**: é©¾é©¶èˆ±ç­‰ä½¿ç”¨ä¼ æ„Ÿå™¨çš„é¡µé¢
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/base-page.js:33-42`

---

#### ä¿®å¤1.3: setDataé˜Ÿåˆ—å›è°ƒå®‰å…¨æ‰§è¡Œ âœ…
**é—®é¢˜**: å›è°ƒæ‰§è¡Œæ—¶é¡µé¢å·²é”€æ¯å¯èƒ½å¯¼è‡´undefinedé”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// ä¿®å¤å‰ï¼šç®€å•çš„ç±»å‹æ£€æŸ¥
if (typeof callback === 'function') {
  callback();
}

// ä¿®å¤åï¼šä½¿ç”¨å®‰å…¨æ‰§è¡ŒåŒ…è£…å™¨
// åœ¨_processSetDataQueueä¸­
for (var i = 0; i < mergeResult.callbacks.length; i++) {
  // ğŸ”§ ä¿®å¤3ï¼šå®‰å…¨æ‰§è¡Œå›è°ƒï¼Œæ·»åŠ å­˜åœ¨æ€§æ£€æŸ¥å’Œtry-catchä¿æŠ¤
  this._executeCallbackSafely(mergeResult.callbacks[i]);
}

// _executeCallbackSafelyæ–¹æ³•å·²å­˜åœ¨
_executeCallbackSafely: function(callback) {
  if (callback && typeof callback === 'function') {
    try {
      callback();
    } catch (error) {
      console.warn('âš ï¸ å›è°ƒæ‰§è¡Œå¤±è´¥ (é¡µé¢å·²é”€æ¯):', error);
    }
  }
}
```

**å½±å“èŒƒå›´**: æ‰€æœ‰ä½¿ç”¨BasePageçš„é¡µé¢
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/base-page.js:562-565, 573-576`

---

### 2. ad-manager.js - å¹¿å‘Šå®ä¾‹ç®¡ç†é£é™©ï¼ˆ3ä¸ªé—®é¢˜ï¼‰

#### ä¿®å¤2.1: å¹¿å‘Šå®ä¾‹é”€æ¯å»¶è¿Ÿå†…å­˜æ³„æ¼ âœ…
**é—®é¢˜**: å»¶è¿Ÿé”€æ¯æœŸé—´é¢‘ç¹åˆ‡æ¢é¡µé¢ä¼šç´¯ç§¯å¤šä¸ªå¾…é”€æ¯å®ä¾‹

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// æ·»åŠ å¾…é”€æ¯å®ä¾‹è·Ÿè¸ªï¼ˆå·²åœ¨æ–‡ä»¶é¡¶éƒ¨å£°æ˜ï¼‰
pendingDestroyInstances: [],

// åœ¨destroyVideoAdä¸­
destroyVideoAd: function() {
  if (this.videoAd) {
    // ... å…ˆç§»é™¤ç›‘å¬å™¨

    // ğŸ”§ ä¿®å¤1ï¼šè·Ÿè¸ªå¾…é”€æ¯å®ä¾‹
    var videoAdInstance = this.videoAd;
    this.videoAd = null; // ç«‹å³æ¸…ç©ºå¼•ç”¨

    // æ·»åŠ åˆ°å¾…é”€æ¯åˆ—è¡¨
    if (!this.pendingDestroyInstances) {
      this.pendingDestroyInstances = [];
    }
    this.pendingDestroyInstances.push({
      instance: videoAdInstance,
      timestamp: Date.now()
    });

    // 100msåé”€æ¯å¹¶ä»åˆ—è¡¨ç§»é™¤
    setTimeout(function() {
      try {
        videoAdInstance.destroy && videoAdInstance.destroy();

        self.pendingDestroyInstances = self.pendingDestroyInstances.filter(function(item) {
          return item.instance !== videoAdInstance;
        });
      } catch (e) {
        // é™é»˜å¤„ç†
      }
    }, 100);

    // ğŸ”§ ä¿®å¤1ï¼šå®šæœŸæ¸…ç†è¶…æ—¶çš„å¾…é”€æ¯å®ä¾‹ï¼ˆ5ç§’å¼ºåˆ¶æ¸…ç†ï¼‰
    setTimeout(function() {
      if (self.pendingDestroyInstances && self.pendingDestroyInstances.length > 0) {
        var now = Date.now();
        self.pendingDestroyInstances = self.pendingDestroyInstances.filter(function(item) {
          if (now - item.timestamp > 5000) {
            self.log('[AdManager] âš ï¸ å¹¿å‘Šå®ä¾‹é”€æ¯è¶…æ—¶ï¼Œå¼ºåˆ¶æ¸…ç†å¼•ç”¨');
            item.instance = null;
            return false;
          }
          return true;
        });
      }
    }, 5000);
  }
}
```

**å½±å“èŒƒå›´**: æ‰€æœ‰æ˜¾ç¤ºå¹¿å‘Šçš„é¡µé¢
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/ad-manager.js:38-39, 123-170`

---

#### ä¿®å¤2.2: å¹¿å‘Šäº‹ä»¶ç›‘å¬å™¨ç²¾ç¡®ç§»é™¤ âœ…
**é—®é¢˜**: `off()`æ–¹æ³•ä¸å¸¦å‚æ•°ä¼šç§»é™¤æ‰€æœ‰ç›‘å¬å™¨ï¼Œå¯èƒ½è¯¯åˆ å…¶ä»–ç›‘å¬å™¨

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// bindAdEventsä¸­ä½¿ç”¨å‘½åå‡½æ•°
bindAdEvents: function() {
  if (!this.videoAd) return;
  var self = this;

  // å…ˆæ¸…é™¤æ—§ç›‘å¬å™¨
  this.videoAd.offLoad && this.videoAd.offLoad();
  this.videoAd.offError && this.videoAd.offError();
  this.videoAd.offClose && this.videoAd.offClose();

  // ğŸ”§ ä½¿ç”¨å‘½åå‡½æ•°ï¼Œä¾¿äºç²¾ç¡®ç§»é™¤
  this._onAdLoadHandler = function() {
    self.isLoadingVideo = false;
    self.isVideoReady = true;
    self.log('[AdManager] å¹¿å‘ŠåŠ è½½æˆåŠŸ');
  };

  this._onAdErrorHandler = function(err) {
    // ...
  };

  this._onAdCloseHandler = function(res) {
    // ...
  };

  // ç»‘å®šç›‘å¬å™¨
  this.videoAd.onLoad(this._onAdLoadHandler);
  this.videoAd.onError(this._onAdErrorHandler);
  this.videoAd.onClose(this._onAdCloseHandler);
}

// destroyVideoAdä¸­ç²¾ç¡®ç§»é™¤
destroyVideoAd: function() {
  if (this.videoAd) {
    // ğŸ”§ ä¿®å¤1ï¼šä½¿ç”¨å‘½åå‡½æ•°å¼•ç”¨ï¼Œç²¾ç¡®ç§»é™¤ç›‘å¬å™¨
    if (this._onAdLoadHandler) {
      this.videoAd.offLoad(this._onAdLoadHandler);
      this._onAdLoadHandler = null;
    }
    if (this._onAdErrorHandler) {
      this.videoAd.offError(this._onAdErrorHandler);
      this._onAdErrorHandler = null;
    }
    if (this._onAdCloseHandler) {
      this.videoAd.offClose(this._onAdCloseHandler);
      this._onAdCloseHandler = null;
    }
    // ...
  }
}
```

**å½±å“èŒƒå›´**: å¹¿å‘Šç³»ç»Ÿ
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/ad-manager.js:268-290, 109-121`

---

#### ä¿®å¤2.3: å¹¿å‘ŠåŠ è½½è¶…æ—¶çŠ¶æ€æ£€æŸ¥ âœ…
**é—®é¢˜**: è¶…æ—¶å‰é¡µé¢é”€æ¯ï¼Œå®šæ—¶å™¨ä»ä¼šè§¦å‘å¹¶ä¿®æ”¹çŠ¶æ€

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// preloadAdAndShowä¸­è®¾ç½®è¶…æ—¶
self.loadingTimeout = setTimeout(function() {
  self.log('[AdManager] âŒ å¹¿å‘ŠåŠ è½½è¶…æ—¶ï¼ˆ15ç§’ï¼‰');
  wx.hideLoading();
  self.isShowingAd = false;
  self.isLoadingVideo = false;
  self.loadingTimeout = null;

  // ğŸ”§ ä¿®å¤3ï¼šè¶…æ—¶æ—¶æ£€æŸ¥å¹¶é”€æ¯å¹¿å‘Šå®ä¾‹ï¼Œé˜²æ­¢åç»­çŠ¶æ€é”™ä¹±
  if (self.videoAd) {
    self.log('[AdManager] è¶…æ—¶åé”€æ¯å¹¿å‘Šå®ä¾‹ï¼Œé˜²æ­¢çŠ¶æ€é”™ä¹±');
    try {
      self.videoAd.destroy && self.videoAd.destroy();
    } catch (e) {
      // é™é»˜å¤„ç†é”€æ¯é”™è¯¯
    }
    self.videoAd = null;
  }

  wx.showToast({
    title: 'å¹¿å‘ŠåŠ è½½è¶…æ—¶\nç½‘ç»œå¯èƒ½è¾ƒæ…¢\nè¯·ç¨åé‡è¯•',
    icon: 'none',
    duration: 3000
  });

  self.onAdSkipped();
}, 15000);

// clearLoadingTimeoutå¢å¼ºç‰ˆ
clearLoadingTimeout: function() {
  if (this.loadingTimeout) {
    clearTimeout(this.loadingTimeout);
    this.loadingTimeout = null;
    this.log('[AdManager] æ¸…é™¤åŠ è½½è¶…æ—¶è®¡æ—¶å™¨');

    // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœå¹¿å‘Šå®ä¾‹çŠ¶æ€å¼‚å¸¸ï¼Œæ ‡è®°ä¸ºæœªå°±ç»ª
    if (this.videoAd && this.isLoadingVideo) {
      this.log('[AdManager] âš ï¸ æ£€æµ‹åˆ°åŠ è½½çŠ¶æ€å¼‚å¸¸ï¼Œé‡ç½®çŠ¶æ€');
      this.isLoadingVideo = false;
      this.isVideoReady = false;
    }
  }
}
```

**å½±å“èŒƒå›´**: å¹¿å‘Šç³»ç»Ÿ
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/ad-manager.js:459-485, 653-667`

---

### 3. data-loader.js - å¹¶å‘åŠ è½½å†²çªï¼ˆ2ä¸ªé—®é¢˜ï¼‰

#### ä¿®å¤3.1: åŠ è½½çŠ¶æ€é”®å†²çª âœ…
**é—®é¢˜**: ä¸åŒé¡µé¢ä½¿ç”¨ç›¸åŒcontextä¼šå…±äº«åŠ è½½çŠ¶æ€

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// æ·»åŠ é¡µé¢å®ä¾‹IDè®¡æ•°å™¨
function DataLoader() {
  this.loadingStates = {};
  this.cache = {};
  this.retryAttempts = {};
  this.maxRetries = 3;
  this.retryDelay = 1000;
  // ğŸ”§ ä¿®å¤1ï¼šæ·»åŠ é¡µé¢å®ä¾‹IDè®¡æ•°å™¨ï¼Œç”¨äºåŒºåˆ†ä¸åŒé¡µé¢å®ä¾‹
  this.pageInstanceCounter = 0;
}

// loadWithLoadingä¸­
// ğŸ”§ ä¿®å¤1ï¼šä¸ºæ¯ä¸ªé¡µé¢å®ä¾‹åˆ†é…å”¯ä¸€IDï¼Œé˜²æ­¢çŠ¶æ€é”®å†²çª
if (!pageInstance._dataLoaderInstanceId) {
  this.pageInstanceCounter++;
  pageInstance._dataLoaderInstanceId = 'page_' + this.pageInstanceCounter + '_' + Date.now();
}

// ğŸ”§ ä¿®å¤1ï¼šä½¿ç”¨é¡µé¢å®ä¾‹ID + context + cacheKey ç»„åˆï¼Œç¡®ä¿å”¯ä¸€æ€§
var loadingStateKey = pageInstance._dataLoaderInstanceId + '_' + context + '_' + (cacheKey || 'default');
if (this.loadingStates[loadingStateKey]) {
  console.log('â³ ' + context + 'æ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
  return this.loadingStates[loadingStateKey];
}
```

**å½±å“èŒƒå›´**: æ‰€æœ‰æ•°æ®åŠ è½½åœºæ™¯
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/data-loader.js:18-19, 35-38, 50`

---

#### ä¿®å¤3.2: åˆ†åŒ…æ£€æµ‹æ–¹æ³•ä¼˜åŒ– âœ…
**é—®é¢˜**: ä½¿ç”¨ç›¸å¯¹è·¯å¾„å’Œindex.jsæ£€æµ‹ä¸å¯é 

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// ğŸ”§ ä¿®å¤2ï¼šä½¿ç”¨åˆ†åŒ…ä¸­çš„å·²çŸ¥æ•°æ®æ–‡ä»¶è¿›è¡Œæµ‹è¯•
checkSubpackagePreloaded: function(packageName) {
  return new Promise(function(resolve, reject) {
    try {
      // ğŸ”§ ä¿®å¤2ï¼šä½¿ç”¨åˆ†åŒ…ä¸­çš„å·²çŸ¥æ•°æ®æ–‡ä»¶è¿›è¡Œæµ‹è¯•
      var knownDataPaths = {
        'packageA': '../packageA/data/icao-data.js',
        'packageB': '../packageB/data/abbreviations-data.js',
        'packageC': '../packageC/data/airports-data.js',
        'packageD': '../packageD/data/definitions-data.js',
        'packageF': '../packageF/pages/acr/index.js',
        'packageG': '../packageG/pages/dangerous-goods/index.js',
        'packageH': '../packageH/pages/twin-engine/index.js',
        'packagePerformance': '../packagePerformance/pages/index/index.js',
        'packageCCAR': '../packageCCAR/data/ccar-data.js',
        'packageIOSA': '../packageIOSA/data/iosa-data.js',
        'packageO': '../packageO/pages/index/index.js',
        'packageCompetence': '../packageCompetence/data/competence-data.js',
        'packageMedical': '../packageMedical/data/medicalStandards.js'
      };

      var testPath = knownDataPaths[packageName] || ('../' + packageName + '/index.js');

      // å°è¯•requireå·²çŸ¥æ–‡ä»¶è·¯å¾„æ¥æ£€æŸ¥åˆ†åŒ…æ˜¯å¦å·²åŠ è½½
      require(testPath);
      console.log('âœ… åˆ†åŒ…' + packageName + 'å·²é¢„åŠ è½½ï¼ˆéªŒè¯è·¯å¾„:' + testPath + 'ï¼‰');
      resolve(true);
    } catch (error) {
      // åˆ†åŒ…æœªåŠ è½½æˆ–è·¯å¾„ä¸å­˜åœ¨
      console.log('â³ åˆ†åŒ…' + packageName + 'æœªé¢„åŠ è½½');
      resolve(false);
    }
  });
}
```

**å½±å“èŒƒå›´**: åˆ†åŒ…é¢„åŠ è½½ç³»ç»Ÿ
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/data-loader.js:155-187`

---

### 4. audio-config.js - ES6è¯­æ³•å…¼å®¹æ€§ï¼ˆ2ä¸ªé—®é¢˜ï¼‰

#### ä¿®å¤4.1: ES6 classæ”¹ä¸ºES5æ„é€ å‡½æ•° âœ…
**é—®é¢˜**: é¡¹ç›®è¦æ±‚ä¸¥æ ¼éµå¾ªES5è¯­æ³•ï¼Œclassåœ¨æ—§ç‰ˆæœ¬å¾®ä¿¡å¯èƒ½ä¸æ”¯æŒ

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// ä¿®å¤å‰ï¼šES6 class
class AudioConfigManager {
  constructor() {
    this.continents = [...];
    this.regions = [...];
    this.airports = [...];
  }

  getContinents() {
    return this.continents;
  }
}

// ä¿®å¤åï¼šES5æ„é€ å‡½æ•°
function AudioConfigManager() {
  // å¤§æ´²æ¿å—å®šä¹‰
  this.continents = [
    {
      id: 'asia',
      name: 'äºšæ´²',
      // ...
    }
  ];

  // å›½å®¶/åœ°åŒºå®šä¹‰
  this.regions = [
    // ...
  ];

  this.airports = [
    // ...
  ];
}

// æ–¹æ³•æ·»åŠ åˆ°åŸå‹
AudioConfigManager.prototype.getContinents = function() {
  return this.continents;
};
```

**å½±å“èŒƒå›´**: éŸ³é¢‘é…ç½®ç³»ç»Ÿ
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/audio-config.js:42-417, 421-501`

---

#### ä¿®å¤4.2: ç®­å¤´å‡½æ•°æ”¹ä¸ºä¼ ç»Ÿfunction âœ…
**é—®é¢˜**: ç®­å¤´å‡½æ•°åœ¨æ—§ç‰ˆæœ¬å¾®ä¿¡å¯èƒ½ä¸æ”¯æŒ

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// ä¿®å¤å‰ï¼šç®­å¤´å‡½æ•°
getRegionsByContinent(continentId) {
  return this.regions.filter(region => region.continentId === continentId);
}

getGroupedRegions() {
  return this.continents.map(continent => {
    const regions = this.getRegionsByContinent(continent.id);
    const totalCount = regions.reduce((sum, region) => sum + (region.count || 0), 0);
    return {
      id: continent.id,
      // ...
    };
  }).filter(group => group.regions.length > 0);
}

// ä¿®å¤åï¼šä¼ ç»Ÿfunction
AudioConfigManager.prototype.getRegionsByContinent = function(continentId) {
  var self = this;
  return this.regions.filter(function(region) {
    return region.continentId === continentId;
  });
};

AudioConfigManager.prototype.getGroupedRegions = function() {
  var self = this;
  var grouped = this.continents.map(function(continent) {
    var regions = self.getRegionsByContinent(continent.id);
    var totalCount = regions.reduce(function(sum, region) {
      return sum + (region.count || 0);
    }, 0);

    return {
      id: continent.id,
      name: continent.name,
      // ...
      regions: regions,
      totalCount: totalCount,
      regionCount: regions.length
    };
  }).filter(function(group) {
    return group.regions.length > 0;
  });

  return grouped;
};
```

**å½±å“èŒƒå›´**: éŸ³é¢‘é…ç½®ç³»ç»Ÿ
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**: `miniprogram/utils/audio-config.js:431-461`

---

### 5. error-handler.js - åˆ†åŒ…åˆ—è¡¨å®Œæ•´æ€§ï¼ˆ1ä¸ªé—®é¢˜ï¼‰

#### ä¿®å¤5.1: åˆ†åŒ…åˆ—è¡¨è¡¥å……å®Œæ•´ âœ…
**é—®é¢˜**: ç¼ºå°‘éŸ³é¢‘åˆ†åŒ…å’Œæ–°å¢åŠŸèƒ½åˆ†åŒ…

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// ä¿®å¤å‰ï¼šä»…8ä¸ªåŠŸèƒ½åˆ†åŒ…
var allPackages = [
  'packageA', 'packageB', 'packageC', 'packageD',
  'packageCCAR', 'packageF', 'packageG', 'packageH'
];

// ä¿®å¤åï¼šå®Œæ•´çš„26ä¸ªåˆ†åŒ…ï¼ˆ13åŠŸèƒ½+13éŸ³é¢‘ï¼‰
// aggressivePreloadAllä¸­
var allPackages = [
  // åŠŸèƒ½åˆ†åŒ…ï¼ˆ13ä¸ªï¼‰
  'packageA',           // icaoPackage - ICAOæ ‡å‡†èˆªç©ºè‹±è¯­
  'packageB',           // abbreviationsPackage - AIPæ ‡å‡†åŠç©ºå®¢ç¼©å†™
  'packageC',           // airportPackage - å…¨çƒæœºåœºæ•°æ®
  'packageD',           // definitionsPackage - èˆªç©ºä¸“ä¸šæœ¯è¯­
  'packageF',           // acrPackage - ACRè®¡ç®—å·¥å…·
  'packageG',           // dangerousGoodsPackage - å±é™©å“è§„å®š
  'packageH',           // twinEnginePackage - åŒå‘é£æœºæ€§èƒ½
  'packagePerformance', // é£æœºæ€§èƒ½å‚æ•°
  'packageCCAR',        // caacPackage - CCARæ°‘èˆªè§„ç« 
  'packageIOSA',        // iosaPackage - IATAè¿è¡Œå®‰å…¨å®¡è®¡æœ¯è¯­
  'packageO',           // pagesPackage - å·¥å…·é›†åˆ
  'packageCompetence',  // competencePackage - PLMèƒœä»»åŠ›æ¡†æ¶
  'packageMedical',     // medicalPackage - æ°‘èˆªä½“æ£€æ ‡å‡†
  // éŸ³é¢‘åˆ†åŒ…ï¼ˆ13ä¸ªå›½å®¶/åœ°åŒºï¼‰
  'packageJapan',       // æ—¥æœ¬æˆç”°æœºåœº
  'packagePhilippines', // è²å¾‹å®¾é©¬å°¼æ‹‰æœºåœº
  'packageKorean',      // éŸ©å›½ä»å·æœºåœº
  'packageSingapore',   // æ–°åŠ å¡æ¨Ÿå®œæœºåœº
  'packageThailand',    // æ³°å›½æ›¼è°·æœºåœº
  'packageRussia',      // ä¿„ç½—æ–¯è«æ–¯ç§‘æœºåœº
  'packageSrilanka',    // æ–¯é‡Œå…°å¡ç§‘ä¼¦å¡æœºåœº
  'packageAustralia',   // æ¾³å¤§åˆ©äºšæ‚‰å°¼æœºåœº
  'packageTurkey',      // åœŸè€³å…¶ä¼Šæ–¯å¦å¸ƒå°”æœºåœº
  'packageFrance',      // æ³•å›½æˆ´é«˜ä¹æœºåœº
  'packageAmerica',     // ç¾å›½æ—§é‡‘å±±æœºåœº
  'packageItaly',       // æ„å¤§åˆ©ç½—é©¬æœºåœº
  'packageUAE'          // é˜¿è”é…‹è¿ªæ‹œæœºåœº
];

// checkAndFillMissingPackagesä¸­ä¹Ÿå·²åŒæ­¥ä¿®å¤
var allPackages = [
  // åŠŸèƒ½åˆ†åŒ…
  'packageA', 'packageB', 'packageC', 'packageD', 'packageF', 'packageG',
  'packageH', 'packagePerformance', 'packageCCAR', 'packageIOSA', 'packageO',
  'packageCompetence', 'packageMedical',
  // éŸ³é¢‘åˆ†åŒ…
  'packageJapan', 'packagePhilippines', 'packageKorean', 'packageSingapore',
  'packageThailand', 'packageRussia', 'packageSrilanka', 'packageAustralia',
  'packageTurkey', 'packageFrance', 'packageAmerica', 'packageItaly', 'packageUAE'
];

// checkSubpackageStatusä¸­ä¹Ÿå·²åŒæ­¥ä¿®å¤
var packages = [
  'packageA', 'packageB', 'packageC', 'packageD', 'packageF', 'packageG',
  'packageH', 'packagePerformance', 'packageCCAR', 'packageIOSA', 'packageO',
  'packageCompetence', 'packageMedical',
  'packageJapan', 'packagePhilippines', 'packageKorean', 'packageSingapore',
  'packageThailand', 'packageRussia', 'packageSrilanka', 'packageAustralia',
  'packageTurkey', 'packageFrance', 'packageAmerica', 'packageItaly', 'packageUAE'
];
```

**å½±å“èŒƒå›´**: åˆ†åŒ…åŠ è½½ç³»ç»Ÿ
**é£é™©ç­‰çº§**: ğŸ”´ é«˜é£é™©
**ä¿®å¤ä½ç½®**:
- `miniprogram/utils/error-handler.js:420-449` (aggressivePreloadAll)
- `miniprogram/utils/error-handler.js:482-491` (checkAndFillMissingPackages)
- `miniprogram/utils/error-handler.js:129-136` (checkSubpackageStatus)

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

### ä»£ç è´¨é‡æ£€æŸ¥
- [x] æ‰€æœ‰ä¿®å¤ç¬¦åˆES5è¯­æ³•è§„èŒƒ
- [x] æ²¡æœ‰ä½¿ç”¨ç®­å¤´å‡½æ•°
- [x] æ²¡æœ‰ä½¿ç”¨classã€letã€constç­‰ES6ç‰¹æ€§
- [x] ä¿æŒåŸæœ‰åŠŸèƒ½é€»è¾‘ä¸å˜
- [x] æ·»åŠ äº†è¯¦ç»†çš„ä¿®å¤æ³¨é‡Šæ ‡è®°

### åŠŸèƒ½éªŒè¯
- [x] å®šæ—¶å™¨æ¸…ç†æœºåˆ¶ï¼štimeoutå’Œintervalæ­£ç¡®åˆ†å¼€ç®¡ç†
- [x] ä¼ æ„Ÿå™¨ç›‘å¬å™¨ï¼šonLoadæ—¶å…ˆæ¸…ç†ï¼Œé¿å…é‡å¤ç»‘å®š
- [x] setDataå›è°ƒï¼šä½¿ç”¨å®‰å…¨æ‰§è¡ŒåŒ…è£…å™¨ï¼Œé˜²æ­¢é¡µé¢é”€æ¯æ—¶é”™è¯¯
- [x] å¹¿å‘Šå®ä¾‹ï¼šæ·»åŠ å¾…é”€æ¯å®ä¾‹è·Ÿè¸ªå’Œè¶…æ—¶æ¸…ç†
- [x] å¹¿å‘Šç›‘å¬å™¨ï¼šä½¿ç”¨å‘½åå‡½æ•°ç²¾ç¡®ç§»é™¤
- [x] å¹¿å‘Šè¶…æ—¶ï¼šæ£€æŸ¥å®ä¾‹çŠ¶æ€ï¼Œé˜²æ­¢çŠ¶æ€é”™ä¹±
- [x] æ•°æ®åŠ è½½ï¼šæ·»åŠ é¡µé¢å®ä¾‹IDï¼Œé¿å…çŠ¶æ€å†²çª
- [x] åˆ†åŒ…æ£€æµ‹ï¼šä½¿ç”¨å·²çŸ¥æ•°æ®æ–‡ä»¶è·¯å¾„æé«˜å¯é æ€§
- [x] éŸ³é¢‘é…ç½®ï¼šå®Œå…¨è½¬æ¢ä¸ºES5è¯­æ³•
- [x] åˆ†åŒ…åˆ—è¡¨ï¼šåŒ…å«å…¨éƒ¨26ä¸ªåˆ†åŒ…ï¼ˆ13åŠŸèƒ½+13éŸ³é¢‘ï¼‰

### ç¦»çº¿æ¨¡å¼å…¼å®¹æ€§
- [x] æ‰€æœ‰ä¿®å¤ä¸å½±å“ç¦»çº¿ä¼˜å…ˆè®¾è®¡
- [x] åˆ†åŒ…é¢„åŠ è½½æœºåˆ¶æ­£å¸¸å·¥ä½œ
- [x] éŸ³é¢‘é…ç½®åœ¨ç¦»çº¿æ¨¡å¼ä¸‹å¯ç”¨
- [x] æ•°æ®åŠ è½½åœ¨ç¦»çº¿æ¨¡å¼ä¸‹æœ‰å…œåº•æ–¹æ¡ˆ

---

## ğŸ“ˆ ä¿®å¤æ•ˆæœé¢„æœŸ

### å†…å­˜ç®¡ç†æ”¹å–„
1. **å®šæ—¶å™¨æ³„æ¼é£é™©é™ä½**: ä»æ··åˆç®¡ç†æ”¹ä¸ºåˆ†ç±»ç®¡ç†ï¼Œæ¸…ç†æ›´ç²¾ç¡®
2. **ä¼ æ„Ÿå™¨ç›‘å¬å™¨ä¼˜åŒ–**: é˜²æ­¢é‡å¤ç»‘å®šï¼Œå‡å°‘å†…å­˜æ¶ˆè€—
3. **å¹¿å‘Šå®ä¾‹ç®¡ç†**: è·Ÿè¸ªå¾…é”€æ¯å®ä¾‹ï¼Œ5ç§’è¶…æ—¶å¼ºåˆ¶æ¸…ç†

### ç¨³å®šæ€§æå‡
1. **setDataé˜Ÿåˆ—æ›´å®‰å…¨**: å›è°ƒæ‰§è¡Œæœ‰å¼‚å¸¸ä¿æŠ¤ï¼Œé¡µé¢é”€æ¯ä¸ä¼šå´©æºƒ
2. **å¹¿å‘ŠçŠ¶æ€ä¸€è‡´æ€§**: è¶…æ—¶æ£€æŸ¥å®ä¾‹çŠ¶æ€ï¼Œé¿å…çŠ¶æ€é”™ä¹±
3. **æ•°æ®åŠ è½½æ— å†²çª**: é¡µé¢å®ä¾‹IDç¡®ä¿ä¸åŒé¡µé¢åŠ è½½äº’ä¸å¹²æ‰°

### å…¼å®¹æ€§å¢å¼º
1. **ES5è¯­æ³•ä¿è¯**: æ”¯æŒæ—§ç‰ˆæœ¬å¾®ä¿¡å°ç¨‹åº
2. **åˆ†åŒ…æ£€æµ‹æ›´å¯é **: ä½¿ç”¨å·²çŸ¥æ–‡ä»¶è·¯å¾„ï¼Œæ£€æµ‹å‡†ç¡®ç‡æé«˜
3. **åˆ†åŒ…åˆ—è¡¨å®Œæ•´**: è¦†ç›–å…¨éƒ¨26ä¸ªåˆ†åŒ…ï¼Œç¦»çº¿åŠŸèƒ½å®Œå¤‡

---

## ğŸ”„ åç»­å»ºè®®

### P1 - æœ¬å‘¨å®Œæˆï¼ˆä¸­é£é™©ä¼˜åŒ–ï¼‰
1. base-page.jsçš„setDataæ‰¹å¤„ç†é€»è¾‘ä¼˜åŒ–
2. ad-manager.jsçš„ç½‘ç»œæ£€æµ‹ç­–ç•¥æ”¹è¿›
3. audio-preload-guide.jsçš„å¼¹çª—æ—¶æœºä¼˜åŒ–
4. error-handler.jsçš„æ—¥å¿—ç³»ç»Ÿå¢å¼º

### P2 - è¿­ä»£ä¼˜åŒ–ï¼ˆä¸‹æœˆï¼‰
1. data-loader.jsæ·»åŠ ç¼“å­˜TTLæœºåˆ¶
2. ad-manager.jså®ç°å¹¿å‘Šä½è´¨é‡è¯„åˆ†
3. ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶å»ºè®¾
4. æ€§èƒ½ç›‘æ§ä½“ç³»å®Œå–„

### P3 - é•¿æœŸè§„åˆ’ï¼ˆä¸‹å­£åº¦ï¼‰
1. æ¨¡å—åŒ–é‡æ„ï¼ˆæ‹†åˆ†å¤§æ–‡ä»¶ï¼‰
2. å•å…ƒæµ‹è¯•è¦†ç›–
3. JSDocæ–‡æ¡£å®Œå–„
4. ä»£ç è§„èŒƒå·¥å…·é›†æˆ

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¿®å¤å·¥ä½œæˆåŠŸè§£å†³äº†æ ¸å¿ƒå·¥å…·æ–‡ä»¶ä¸­çš„15ä¸ªé«˜é£é™©é—®é¢˜ï¼Œæ¶µç›–å†…å­˜æ³„æ¼ã€å¹¶å‘å†²çªã€è¯­æ³•å…¼å®¹ã€é…ç½®å®Œæ•´æ€§ç­‰å…³é”®é¢†åŸŸã€‚æ‰€æœ‰ä¿®å¤å‡ï¼š

âœ… **ç¬¦åˆé¡¹ç›®è§„èŒƒ**: ä¸¥æ ¼éµå¾ªES5è¯­æ³•å’Œç¦»çº¿ä¼˜å…ˆè®¾è®¡åŸåˆ™
âœ… **ä¿æŒåŠŸèƒ½å®Œæ•´**: ä¸å½±å“åŸæœ‰ä¸šåŠ¡é€»è¾‘å’Œç”¨æˆ·ä½“éªŒ
âœ… **æå‡ç³»ç»Ÿç¨³å®š**: æ˜¾è‘—é™ä½å†…å­˜æ³„æ¼å’ŒçŠ¶æ€é”™ä¹±é£é™©
âœ… **å¢å¼ºå…¼å®¹æ€§**: ç¡®ä¿åœ¨æ—§ç‰ˆæœ¬å¾®ä¿¡ä¸­æ­£å¸¸è¿è¡Œ

**å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯åéƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œé‡ç‚¹å…³æ³¨ç¦»çº¿æ¨¡å¼å’Œä¼ æ„Ÿå™¨åŠŸèƒ½çš„ç¨³å®šæ€§ã€‚**

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-16
**å®¡æŸ¥äººå‘˜**: Claude Code
**ä¸‹ä¸€æ­¥**: ç»§ç»­å®¡æŸ¥é©¾é©¶èˆ±æ¨¡å—ï¼ˆ18ä¸ªä¸“ä¸šæ¨¡å—ï¼‰

# 我是在开发微信小程序，需要注意微信小程序特有的规则和规范

# 微信小程序离线优先设计规则

## 概述

FlightToolbox小程序必须严格遵循离线优先设计原则，确保在无网络环境下所有核心功能都能正常工作。这是针对飞行员在驾驶舱等无网络环境下使用的刚性需求。

## 核心设计原则

### 1. 离线优先（Offline First）

- **底线要求**：所有核心功能必须在无网络状态下正常工作
- **设计理念**：先考虑离线场景，再考虑在线增强
- **用户场景**：飞行员在驾驶舱、偏远机场等无网络环境下的使用需求

### 2. 数据本地化存储

- **静态数据**：所有查询数据（缩写、机场、ICAO通信、规范性文件等）必须本地存储
- **计算功能**：所有换算和计算逻辑必须本地实现，不依赖网络API
- **用户数据**：个人清单、历史记录等用户数据优先本地存储

## 技术实现要求

### 1. 分包数据管理

参考 @data-manager.js 的实现：

- 使用分包存储大量静态数据
- 实现多层兜底机制：分包→主包→默认数据
- 24小时缓存机制减少重复加载

### 2. 本地存储策略

```javascript
// 优先使用本地存储
wx.setStorageSync('key', data)
wx.getStorageSync('key')

// 避免依赖网络请求
// ❌ 禁止：wx.request() 用于核心功能
// ✅ 允许：wx.request() 仅用于非核心的增强功能
```

### 3. 离线计算实现

- 所有换算公式本地实现，参考 @unit-converter
- 航空专业计算本地实现，参考 @aviation-calculator
- 避免依赖在线计算服务

### 4. 数据预加载机制

在 @app.json 中配置分包预加载：

```json
{
  "preloadRule": {
    "pages/abbreviations/index": {
      "network": "all",
      "packages": ["packageA", "packageB", "packageC", "packageD", "packageE"]
    }
  }
}
```

## 功能模块离线要求

### 1. 常用换算页面

- ✅ 所有单位换算公式本地实现
- ✅ 不依赖网络API进行换算
- ✅ 历史记录本地存储

### 2. 特殊计算页面

- ✅ 航空专业计算公式本地实现
- ✅ 飞机性能数据本地存储
- ✅ 计算结果本地缓存

### 3. 万能查询页面

- ✅ 所有查询数据通过分包本地存储
- ✅ 搜索功能本地实现，不依赖服务器
- ✅ 支持离线全文搜索

### 4. 其他功能页面

- ✅ 个人清单本地存储和管理
- ✅ 我的首页离线可用
- ✅ 性能监控数据本地记录

## 网络功能限制

### 允许的网络功能

- 数据更新检查（非阻塞）
- 用户反馈提交（可选）
- 性能数据上报（可选）
- 版本更新检查（可选）

### 禁止的网络依赖

- ❌ 核心计算功能依赖网络API
- ❌ 查询功能依赖在线数据库
- ❌ 换算功能依赖在线服务
- ❌ 任何阻塞性的网络请求

## 用户体验要求

### 1. 离线状态提示

- 在有网络时可显示在线状态
- 离线时不显示错误提示
- 所有功能在离线状态下正常可用

### 2. 数据同步策略

- 优先使用本地数据
- 网络可用时后台同步更新
- 同步失败不影响核心功能

### 3. 性能优化

- 启用初始渲染缓存，参考 @performance-monitor.js
- 分包预加载优化启动速度
- 本地数据缓存减少重复加载

## 测试验证要求

### 1. 离线测试

- 所有新功能必须在飞行模式下测试
- 确保无网络状态下功能完整可用
- 验证数据加载的兜底机制

### 2. 性能测试

- 离线状态下的启动性能
- 本地数据查询响应速度
- 内存使用优化

### 3. 用户场景测试

- 模拟驾驶舱环境测试
- 长时间离线使用测试
- 数据完整性验证

## 开发规范

### 1. 代码审查要点

- 检查是否有网络依赖的核心功能
- 验证本地数据的完整性
- 确认兜底机制的有效性

### 2. 新功能开发

- 优先考虑离线实现方案
- 网络功能仅作为增强，不能是必需
- 提供完整的本地数据支持

### 3. 数据更新策略

- 静态数据通过版本更新分发
- 避免依赖实时数据同步
- 本地数据版本管理

## 应急预案

### 1. 数据损坏处理

- 多层数据兜底机制
- 默认数据集作为最后保障
- 用户数据恢复机制

### 2. 功能降级策略

- 核心功能永不降级
- 增强功能可优雅降级
- 用户体验保持一致

## 总结

离线优先是FlightToolbox小程序的核心设计原则和不可妥协的底线要求。所有开发工作都必须以此为前提，确保飞行员在任何环境下都能可靠使用小程序的所有核心功能。

**记住：网络是增强，离线是基础。**

# 微信小程序分包开发规则

## 概述

本规则定义了微信小程序分包开发的最佳实践，基于成功的分包实施经验总结。

## 分包组织原则

### 1. 按数据类型分包

- **packageA**: ICAO通信数据 (~200KB)
- **packageB**: 缩写数据 (~232KB)
- **packageC**: 机场数据 (~100KB)
- **packageD**: 定义数据 (~114KB)

### 2. 分包结构要求

每个分包必须包含页面才能被微信小程序识别：

```
packageA/
├── index.js      # 分包入口文件
├── index.wxml    # 页面模板
├── index.json    # 页面配置
└── icao900.js    # 数据文件
```

### 3. 数据文件大小控制

- 单个数据文件控制在100-250KB范围内
- 总分包数据量可达650KB+，有效解决主包2M限制

## 技术实现要点

### 1. 统一数据管理器

创建 @data-manager.js 处理所有分包数据加载：

- 使用异步require和多层兜底机制
- 实现缓存机制避免重复加载
- 支持数据格式转换

### 2. 跨分包数据加载

使用异步回调方式进行跨分包require：

```javascript
require('../packageA/data.js', successCallback, failCallback)
```

### 3. 分包配置

在 @app.json 中正确配置：

```json
{
  "subPackages": [
    {
      "root": "packageA",
      "name": "icaoPackage", 
      "pages": ["index"]
    }
  ],
  "preloadRule": {
    "pages/abbreviations/index": {
      "network": "all",
      "packages": ["packageA", "packageB", "packageC", "packageD"]
    }
  }
}
```

### 4. 数据格式处理

支持多种数据格式的自动转换：

- 对象格式（包含chapters字段）→ 数组格式
- 直接数组格式保持不变
- 提供默认数据作为兜底

## 页面集成

### 万能查询页面

@abbreviations/index.ts 使用统一数据管理器：

```javascript
const dataManager = require('../../utils/data-manager.js')

// 异步加载各类数据
await dataManager.loadIcaoData()
await dataManager.loadAbbreviationsData()
await dataManager.loadAirportData()
await dataManager.loadDefinitionsData()
```

### 测试功能

在 @others/index.ts 中提供分包测试功能：

- 测试所有分包数据加载状态
- 查看缓存状态
- 清除缓存功能

## 预加载优化

### 配置预加载规则

在主要页面配置预加载所有相关分包，提升用户体验：

- 网络策略：`"network": "all"` 不限网络
- 包列表：包含所有数据分包的root名称

### 预加载限制

- 同一页面预下载大小限额2M
- 通过vConsole查看 `preloadSubpackages`日志验证

## 兜底策略

### 多层数据加载

1. **第一层**：从对应分包加载数据
2. **第二层**：从主包data目录加载数据
3. **第三层**：使用默认数据

### 错误处理

- 记录详细的加载日志
- 提供用户友好的错误提示
- 确保应用在任何情况下都能正常运行

## 开发调试

### 日志监控

关注以下关键日志：

- `preloadSubpackages: success` - 预加载成功
- `✅ 成功从packageX加载数据` - 分包数据加载成功
- `No. of subpackages: 4` - 分包数量确认

### 测试验证

使用我的首页页面的测试功能验证：

- 所有分包数据加载状态
- 数据条目数量正确性
- 缓存机制工作状态

## 注意事项

### 分包引用限制

- 分包之间不能直接require，只能通过主包
- 使用分包异步化特性解决跨分包引用
- tabBar页面必须在主包内

### 兼容性考虑

- 分包异步化需要基础库2.11.2+
- 低版本客户端自动降级为整包模式
- 避免在分包页面使用app.wxss样式

## 成功指标

### 技术指标

- ✅ 4个分包正常识别和预下载
- ✅ 总计650KB+数据成功分包
- ✅ 主包大小有效控制
- ✅ 数据加载流畅无感知

### 用户体验

- 页面加载速度提升
- 数据查询响应及时
- 离线缓存机制完善
- 错误处理用户友好

这套分包方案为后续小程序开发提供了可复用的架构模式。

# 微信小程序字体兼容性规则

## 概述

微信小程序对外部字体引用有严格限制，开发时需要遵循特定的字体使用规范。

## 字体使用限制

### 禁止的字体引用方式

- ❌ **禁止使用 @import url() 引入外部字体**
  ```css
  /* 错误示例 - 微信小程序不支持 */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  ```

- ❌ **禁止引用网络字体文件**
  ```css
  /* 错误示例 - 微信小程序不支持 */
  @font-face {
    font-family: 'CustomFont';
    src: url('https://example.com/font.woff2');
  }
  ```

### 推荐的字体使用方式

- ✅ **使用系统字体栈**
  ```css
  /* 推荐做法 - 兼容微信小程序 */
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
  ```

- ✅ **本地字体文件（如需要）**
  - 将字体文件放在小程序包内
  - 使用相对路径引用
  - 注意包大小限制

## 常见问题解决

### 字体加载错误

**问题现象：**
- 控制台出现 `ERR_CACHE_MISS` 错误
- WXSS编译错误：token `url`
- 字体无法正常显示

**解决方案：**
1. 移除所有 `@import url()` 语句
2. 替换为系统字体栈
3. 清理相关的字体引用

### 字体回退策略

建议的字体回退顺序：
1. **-apple-system** - iOS系统字体
2. **BlinkMacSystemFont** - macOS系统字体
3. **'Segoe UI'** - Windows系统字体
4. **'PingFang SC'** - 苹果中文字体
5. **'Hiragino Sans GB'** - 苹果中文字体（旧版）
6. **'Microsoft YaHei'** - 微软雅黑
7. **sans-serif** - 通用无衬线字体

## 开发规范

### 代码审查要点

- 检查是否有外部字体引用
- 验证字体栈的完整性
- 确认在微信开发者工具中无字体错误

### 测试验证

- 在微信开发者工具中测试字体显示
- 检查控制台是否有字体相关错误
- 验证在不同设备上的字体效果

### 预览页面兼容

开发预览页面时也要遵循相同规则：
- 移除Google Fonts等外部字体引用
- 使用相同的系统字体栈
- 保持设计一致性

## 注意事项

1. **性能考虑**：系统字体加载速度更快，用户体验更好
2. **兼容性**：系统字体在所有设备上都有良好支持
3. **维护性**：避免外部依赖，减少潜在问题
4. **包大小**：不增加小程序包体积

## 总结

微信小程序的字体使用必须遵循平台限制，优先使用系统字体栈可以确保最佳的兼容性和性能表现。开发时应避免任何形式的外部字体引用，以防止编译错误和运行时问题。

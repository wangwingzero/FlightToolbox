# å¾®ä¿¡å°ç¨‹åºåˆ†åŒ…èµ„æºæœ¬åœ°ç¼“å­˜å®Œæ•´å®ç°æŒ‡å—

> **ç›®æ ‡è¯»è€…**ï¼šæœªæ¥çš„AIåŠ©æ‰‹ã€æ–°æ¥æ‰‹é¡¹ç›®çš„å¼€å‘è€…
> **æ–‡æ¡£ç›®çš„**ï¼š100%å¯å¤ç°çš„åˆ†åŒ…èµ„æºæœ¬åœ°ç¼“å­˜æŠ€æœ¯å®ç°
> **æœ€åæ›´æ–°**ï¼š2025-01-04
> **éªŒè¯çŠ¶æ€**ï¼šâœ… å·²åœ¨FlightToolboxé¡¹ç›®çœŸæœºéªŒè¯é€šè¿‡

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
2. [æŠ€æœ¯åŸç†](#æŠ€æœ¯åŸç†)
3. [å®Œæ•´å®ç°æ­¥éª¤](#å®Œæ•´å®ç°æ­¥éª¤)
4. [ä»£ç æ¨¡æ¿ï¼ˆå¯ç›´æ¥å¤åˆ¶ï¼‰](#ä»£ç æ¨¡æ¿å¯ç›´æ¥å¤åˆ¶)
5. [æ€§èƒ½ä¼˜åŒ–è¦ç‚¹](#æ€§èƒ½ä¼˜åŒ–è¦ç‚¹)
6. [å¸¸è§é™·é˜±ä¸é¿å‘æŒ‡å—](#å¸¸è§é™·é˜±ä¸é¿å‘æŒ‡å—)
7. [æµ‹è¯•éªŒè¯æ–¹æ³•](#æµ‹è¯•éªŒè¯æ–¹æ³•)
8. [æ•…éšœæ’æŸ¥æµç¨‹](#æ•…éšœæ’æŸ¥æµç¨‹)

---

## æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### âŒ å†å²é—®é¢˜

å¾®ä¿¡å°ç¨‹åºçš„åˆ†åŒ…èµ„æºï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€PDFç­‰ï¼‰åœ¨ç¦»çº¿ç¯å¢ƒä¸‹å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼š

| é—®é¢˜ | ç°è±¡ | åŸå›  | å½±å“ |
|------|------|------|------|
| **åˆ†åŒ…èµ„æºè¢«æ¸…ç†** | äºŒæ¬¡å¯åŠ¨æ—¶å›¾ç‰‡é»‘å±/éŸ³é¢‘æ’­æ”¾å¤±è´¥ | å¾®ä¿¡ä¼šæ¦‚ç‡æ€§æ¸…ç†åˆ†åŒ…ç¼“å­˜ | ç¦»çº¿ä¸å¯ç”¨ |
| **å¼€å‘ç¯å¢ƒ â‰  çœŸæœº** | å¼€å‘è€…å·¥å…·æ­£å¸¸ï¼ŒçœŸæœºå¼‚å¸¸ | å¼€å‘å·¥å…·ä¸æ”¯æŒ `wx.loadSubpackage` | æµ‹è¯•ä¸å……åˆ† |
| **é¢„åŠ è½½ä¸å¯é ** | ä»…ä¾èµ– `preloadRule` ä¸å¤Ÿ | é¢„åŠ è½½åªæ˜¯å»ºè®®ï¼Œä¸ä¿è¯æ‰§è¡Œ | ç”¨æˆ·ä½“éªŒå·® |

### âœ… æ ¸å¿ƒè§£å†³æ–¹æ¡ˆ

**ä¸‰å±‚é˜²æŠ¤æœºåˆ¶**ï¼ˆ2025-01-04é‡å¤§çªç ´ï¼‰ï¼š

```javascript
// ğŸ”¥ å…³é”®æŠ€æœ¯ï¼šå°†åˆ†åŒ…èµ„æºå†™å…¥ wx.env.USER_DATA_PATH
// è¿™æ˜¯å”¯ä¸€èƒ½ä¿è¯èµ„æºæŒä¹…åŒ–çš„æ–¹æ³•

// ç¬¬ä¸€å±‚ï¼šä¸»åŠ¨åŠ è½½åˆ†åŒ…ï¼ˆç¡®ä¿åˆ†åŒ…å¯è®¿é—®ï¼‰
wx.loadSubpackage({ name: 'packageName', success: () => {...} });

// ç¬¬äºŒå±‚ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆæ ¸å¿ƒçªç ´ï¼Œå†™å…¥æŒä¹…åŒ–ç›®å½•ï¼‰
wx.getFileSystemManager().copyFile({
  srcPath: åˆ†åŒ…èµ„æºè·¯å¾„,
  destPath: wx.env.USER_DATA_PATH + '/your-cache/file.ext'
});

// ç¬¬ä¸‰å±‚ï¼šæ™ºèƒ½å…œåº•ï¼ˆç¯å¢ƒæ£€æµ‹ + è‡ªåŠ¨é‡è¯• + ç”¨æˆ·å¼•å¯¼ï¼‰
if (ç¯å¢ƒ === 'å¼€å‘è€…å·¥å…·') return; // é¿å…è¯¯åˆ¤
if (ç¼“å­˜å­˜åœ¨) ä½¿ç”¨ç¼“å­˜;
else if (å·²é¢„åŠ è½½) è‡ªåŠ¨é‡è¯•3æ¬¡;
else æ˜¾ç¤ºå¼•å¯¼å¼¹çª—;
```

---

## æŠ€æœ¯åŸç†

### ä¸ºä»€ä¹ˆå¿…é¡»ä½¿ç”¨ `wx.env.USER_DATA_PATH`ï¼Ÿ

| å­˜å‚¨æ–¹å¼ | è·¯å¾„ç¤ºä¾‹ | æŒä¹…åŒ– | é‡å¯åå¯ç”¨ | å¾®ä¿¡æ¸…ç† | é€‚ç”¨åœºæ™¯ |
|---------|---------|--------|----------|---------|---------|
| **wx.env.USER_DATA_PATH** | `wxfile://usr/your-cache/` | âœ… æ°¸ä¹… | âœ… æ˜¯ | âŒ ä¸ä¼š | **èµ„æºç¼“å­˜** â­â­â­ |
| wx.setStorageSync | Storage API | âœ… æ°¸ä¹… | âœ… æ˜¯ | âŒ ä¸ä¼š | é…ç½®/ç´¢å¼• |
| åˆ†åŒ…è·¯å¾„ | `/packageName/file.ext` | âš ï¸ ä¸´æ—¶ | âš ï¸ å¯èƒ½ | âœ… ä¼š | âŒ ä¸å¯é  |
| ä¸´æ—¶æ–‡ä»¶ | `wxfile://tmp/` | âŒ ä¸´æ—¶ | âŒ å¦ | âœ… ä¼š | âŒ ä¸å¯é  |

**å…³é”®å‘ç°**ï¼š
- âœ… **wx.env.USER_DATA_PATH æ˜¯ç”¨æˆ·æ•°æ®ç›®å½•**ï¼Œå¾®ä¿¡ä¸ä¼šæ¸…ç†
- âœ… **é‡å¯å°ç¨‹åºåä¾ç„¶å¯è®¿é—®**ï¼ŒçœŸæ­£å®ç°ç¦»çº¿å¯ç”¨
- âœ… **å­˜å‚¨ç©ºé—´ç‹¬ç«‹**ï¼Œä¸å ç”¨ 10MB Storage é…é¢
- âš ï¸ **éœ€è¦æ‰‹åŠ¨ç®¡ç†ç©ºé—´**ï¼Œå»ºè®®å®ç° LRU æ¸…ç†æœºåˆ¶

---

## å®Œæ•´å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šå®šä¹‰ç¼“å­˜é…ç½®ï¼ˆå¿…é¡»ï¼‰

```javascript
/**
 * ç¼“å­˜é…ç½®ï¼ˆæ ¹æ®èµ„æºç±»å‹è°ƒæ•´ï¼‰
 */

// 1. ç¼“å­˜ç›®å½•ï¼ˆæŒä¹…åŒ–è·¯å¾„ï¼‰
var CACHE_DIR = wx.env.USER_DATA_PATH + '/your-resource-cache';

// 2. ç¼“å­˜ç´¢å¼•Keyï¼ˆå­˜å‚¨åœ¨Storageä¸­ï¼‰
var CACHE_INDEX_KEY = 'your_cache_index';

// 3. ç¼“å­˜å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰
var MAX_CACHE_SIZE = 300 * 1024 * 1024;  // 300MB

// 4. å•æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå­—èŠ‚ï¼‰
var MAX_FILE_SIZE = 5 * 1024 * 1024;     // 5MB
```

**é‡è¦**ï¼š
- `CACHE_DIR` è·¯å¾„å¿…é¡»ä»¥ `wx.env.USER_DATA_PATH` å¼€å¤´
- `CACHE_INDEX_KEY` ç”¨äºåœ¨ Storage ä¸­è®°å½•ç¼“å­˜æ–‡ä»¶æ˜ å°„å…³ç³»
- `MAX_CACHE_SIZE` æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ï¼ˆéŸ³é¢‘å»ºè®®300MBï¼Œå›¾ç‰‡å»ºè®®50MBï¼‰

---

### æ­¥éª¤2ï¼šåˆå§‹åŒ–ç¼“å­˜ç³»ç»Ÿï¼ˆå¼‚æ­¥ï¼‰

```javascript
/**
 * åˆå§‹åŒ–ç¼“å­˜ç³»ç»Ÿï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰
 *
 * @returns {Promise} åˆå§‹åŒ–å®Œæˆçš„Promise
 */
function initCache() {
  var self = this;

  if (this._cacheInitialized) {
    return Promise.resolve();
  }

  return new Promise(function(resolve, reject) {
    try {
      // ğŸ”¥ å…³é”®ï¼šæ£€æµ‹å¼€å‘è€…å·¥å…·ç¯å¢ƒ
      var isDevTools = (typeof wx.loadSubpackage !== 'function');
      if (isDevTools) {
        console.warn('âš ï¸ å¼€å‘è€…å·¥å…·ç¯å¢ƒï¼šç¼“å­˜åŠŸèƒ½ä»…åœ¨çœŸæœºæœ‰æ•ˆ');
        self._cacheInitialized = true;
        resolve();
        return;
      }

      // 1. è·å–æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨
      self.cacheFs = wx.getFileSystemManager();

      // 2. å¼‚æ­¥æ£€æŸ¥ç¼“å­˜ç›®å½•æ˜¯å¦å­˜åœ¨
      self.cacheFs.access({
        path: CACHE_DIR,
        success: function() {
          console.log('âœ… ç¼“å­˜ç›®å½•å·²å­˜åœ¨');
          finishInit(resolve);
        },
        fail: function() {
          // 3. ç›®å½•ä¸å­˜åœ¨ï¼Œå¼‚æ­¥åˆ›å»º
          self.cacheFs.mkdir({
            dirPath: CACHE_DIR,
            recursive: true,
            success: function() {
              console.log('âœ… ç¼“å­˜ç›®å½•åˆ›å»ºæˆåŠŸ');
              finishInit(resolve);
            },
            fail: function(error) {
              console.error('âŒ åˆ›å»ºç¼“å­˜ç›®å½•å¤±è´¥:', error);
              self._cacheInitialized = true;
              reject(error);
            }
          });
        }
      });

    } catch (error) {
      console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
      self._cacheInitialized = true;
      reject(error);
    }
  });

  // å†…éƒ¨è¾…åŠ©å‡½æ•°ï¼šå®Œæˆåˆå§‹åŒ–
  function finishInit(resolve) {
    try {
      // 4. åŠ è½½ç¼“å­˜ç´¢å¼•
      self.cacheIndex = wx.getStorageSync(CACHE_INDEX_KEY) || {};
      console.log('âœ… ç¼“å­˜ç´¢å¼•åŠ è½½æˆåŠŸï¼Œå·²ç¼“å­˜æ–‡ä»¶æ•°:', Object.keys(self.cacheIndex).length);

      // 5. è®¡ç®—å½“å‰ç¼“å­˜æ€»å¤§å°
      self.totalCacheSize = 0;
      Object.keys(self.cacheIndex).forEach(function(key) {
        self.totalCacheSize += (self.cacheIndex[key].size || 0);
      });
      console.log('ğŸ“Š å½“å‰ç¼“å­˜æ€»å¤§å°:', (self.totalCacheSize / 1024 / 1024).toFixed(2) + ' MB');

      // 6. åˆå§‹åŒ–Promiseç®¡ç†å™¨
      self.cachePromises = {};

      // 7. æ ‡è®°å·²åˆå§‹åŒ–
      self._cacheInitialized = true;

      resolve();
    } catch (error) {
      console.error('âŒ å®Œæˆåˆå§‹åŒ–å¤±è´¥:', error);
      self._cacheInitialized = true;
      resolve(); // å³ä½¿å¤±è´¥ä¹Ÿresolveï¼Œé¿å…é˜»å¡
    }
  }
}
```

**å…³é”®ç‚¹**ï¼š
1. âœ… **å¼‚æ­¥æ“ä½œ**ï¼šä½¿ç”¨ `access()` / `mkdir()` è€Œé `accessSync()` / `mkdirSync()`
2. âœ… **å¼€å‘å·¥å…·æ£€æµ‹**ï¼š`typeof wx.loadSubpackage !== 'function'` åˆ¤æ–­ç¯å¢ƒ
3. âœ… **é”™è¯¯å¤„ç†**ï¼šå³ä½¿å¤±è´¥ä¹Ÿæ ‡è®°ä¸ºå·²åˆå§‹åŒ–ï¼Œé¿å…é‡å¤å°è¯•

---

### æ­¥éª¤3ï¼šç¼“å­˜èµ„æºåˆ°æœ¬åœ°ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰

```javascript
/**
 * ç¼“å­˜èµ„æºåˆ°æœ¬åœ°ï¼ˆæ”¯æŒå›¾ç‰‡ã€éŸ³é¢‘ã€PDFç­‰ï¼‰
 *
 * @param {string} cacheKey - ç¼“å­˜é”®ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
 * @param {string} originalSrc - åŸå§‹èµ„æºè·¯å¾„ï¼ˆåˆ†åŒ…è·¯å¾„ï¼‰
 * @returns {Promise<string>} ç¼“å­˜åçš„æœ¬åœ°è·¯å¾„
 */
function cacheResource(cacheKey, originalSrc) {
  var self = this;

  return new Promise(function(resolve, reject) {
    // 0. ç¡®ä¿å·²åˆå§‹åŒ–ï¼ˆå¼‚æ­¥ï¼‰
    Promise.resolve(self.initCache()).then(function() {

      // 1. æ£€æŸ¥æ˜¯å¦å·²ç¼“å­˜
      var existingPath = self.getCachedPath(cacheKey);
      if (existingPath) {
        console.log('âœ… èµ„æºå·²ç¼“å­˜ï¼Œç›´æ¥ä½¿ç”¨:', existingPath);
        resolve(existingPath);
        return;
      }

      // 2. æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç¼“å­˜ä¸­ï¼ˆé˜²æ­¢é‡å¤ä¸‹è½½ï¼‰
      if (self.cachePromises[cacheKey]) {
        console.log('â³ èµ„æºæ­£åœ¨ç¼“å­˜ä¸­ï¼Œç­‰å¾…å®Œæˆ:', cacheKey);
        self.cachePromises[cacheKey].then(resolve).catch(reject);
        return;
      }

      // 3. å¼€å§‹ç¼“å­˜æµç¨‹
      console.log('ğŸ”„ å¼€å§‹ç¼“å­˜èµ„æº:', cacheKey, originalSrc);

      var cachePromise = new Promise(function(innerResolve, innerReject) {
        var targetPath = CACHE_DIR + '/' + generateFileName(cacheKey);
        var absoluteSrc = originalSrc.startsWith('/') ? originalSrc : '/' + originalSrc;

        // 4. è·å–æ–‡ä»¶ä¿¡æ¯
        self.getFileInfo(absoluteSrc, function(fileInfo) {
          var fileSize = fileInfo.size;

          // 5. æ£€æŸ¥æ–‡ä»¶å¤§å°
          if (fileSize > MAX_FILE_SIZE) {
            innerReject(new Error('æ–‡ä»¶è¿‡å¤§: ' + fileSize + ' bytes'));
            return;
          }

          // 6. æ£€æŸ¥ç¼“å­˜ç©ºé—´
          if (self.totalCacheSize + fileSize > MAX_CACHE_SIZE) {
            console.warn('âš ï¸ ç¼“å­˜ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†æ—§ç¼“å­˜');
            self.cleanOldCache(fileSize).then(function() {
              performCopy();
            }).catch(function() {
              performCopy(); // æ¸…ç†å¤±è´¥ä¹Ÿå°è¯•å¤åˆ¶
            });
          } else {
            performCopy();
          }

          // å†…éƒ¨å‡½æ•°ï¼šæ‰§è¡Œæ–‡ä»¶å¤åˆ¶
          function performCopy() {
            self.cacheFs.copyFile({
              srcPath: absoluteSrc,
              destPath: targetPath,
              success: function() {
                // 7. æ›´æ–°ç¼“å­˜ç´¢å¼•
                self.cacheIndex[cacheKey] = {
                  path: targetPath,
                  size: fileSize,
                  timestamp: Date.now(),
                  originalSrc: originalSrc
                };

                // 8. æŒä¹…åŒ–ç´¢å¼•
                wx.setStorageSync(CACHE_INDEX_KEY, self.cacheIndex);

                // 9. æ›´æ–°æ€»å¤§å°
                self.totalCacheSize += fileSize;

                console.log('âœ… èµ„æºå·²ç¼“å­˜:', targetPath);
                innerResolve(targetPath);
              },
              fail: function(error) {
                console.error('âŒ å¤åˆ¶æ–‡ä»¶å¤±è´¥:', error);
                innerReject(error);
              }
            });
          }
        }, innerReject);

      }).finally(function() {
        // æ¸…ç†Promiseå¼•ç”¨
        delete self.cachePromises[cacheKey];
      });

      // ä¿å­˜Promiseå¼•ç”¨ï¼ˆé˜²æ­¢é‡å¤ç¼“å­˜ï¼‰
      self.cachePromises[cacheKey] = cachePromise;

      // è¿”å›Promise
      cachePromise.then(resolve).catch(reject);

    }).catch(function(initError) {
      console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', initError);
      reject(initError);
    });
  });
}

/**
 * è·å–æ–‡ä»¶ä¿¡æ¯ï¼ˆæ ¹æ®èµ„æºç±»å‹é€‰æ‹©APIï¼‰
 */
function getFileInfo(filePath, onSuccess, onError) {
  // ğŸ”¥ å…³é”®ï¼šä¸åŒèµ„æºç±»å‹ä½¿ç”¨ä¸åŒAPI

  // å›¾ç‰‡ï¼šä½¿ç”¨ wx.getImageInfo
  if (filePath.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
    wx.getImageInfo({
      src: filePath,
      success: onSuccess,
      fail: onError
    });
  }
  // éŸ³é¢‘/å…¶ä»–ï¼šä½¿ç”¨ wx.getFileSystemManager().getFileInfo
  else {
    wx.getFileSystemManager().getFileInfo({
      filePath: filePath,
      success: onSuccess,
      fail: onError
    });
  }
}

/**
 * ç”Ÿæˆç¼“å­˜æ–‡ä»¶å
 */
function generateFileName(cacheKey) {
  // å°†cacheKeyè½¬æ¢ä¸ºå®‰å…¨çš„æ–‡ä»¶åï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
  return cacheKey.replace(/[^a-zA-Z0-9_-]/g, '_') + '.cache';
}
```

**å…³é”®ç‚¹**ï¼š
1. âœ… **é˜²æ­¢é‡å¤ç¼“å­˜**ï¼šä½¿ç”¨ `cachePromises` å­—å…¸ç®¡ç†æ­£åœ¨è¿›è¡Œçš„ç¼“å­˜æ“ä½œ
2. âœ… **ç©ºé—´ç®¡ç†**ï¼šç¼“å­˜å‰æ£€æŸ¥ç©ºé—´ï¼Œä¸è¶³æ—¶è‡ªåŠ¨æ¸…ç†
3. âœ… **APIé€‰æ‹©**ï¼šå›¾ç‰‡ç”¨ `wx.getImageInfo`ï¼ŒéŸ³é¢‘ç”¨ `getFileInfo`

---

### æ­¥éª¤4ï¼šLRUç¼“å­˜æ¸…ç†ï¼ˆé‡è¦ï¼‰

```javascript
/**
 * æ¸…ç†æ—§ç¼“å­˜ï¼ˆLRUç­–ç•¥ï¼šæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰
 *
 * @param {number} requiredSize - éœ€è¦é‡Šæ”¾çš„ç©ºé—´å¤§å°ï¼ˆå­—èŠ‚ï¼‰
 * @returns {Promise} æ¸…ç†å®Œæˆçš„Promise
 */
function cleanOldCache(requiredSize) {
  var self = this;

  return new Promise(function(resolve, reject) {
    // 1. æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæœ€æ—§çš„åœ¨å‰ï¼‰
    var sortedKeys = Object.keys(self.cacheIndex).sort(function(a, b) {
      var timeA = self.cacheIndex[a].timestamp || 0;
      var timeB = self.cacheIndex[b].timestamp || 0;
      return timeA - timeB;
    });

    var freedSize = 0;
    var deletePromises = [];

    // 2. æ”¶é›†éœ€è¦åˆ é™¤çš„æ–‡ä»¶
    var filesToDelete = [];
    for (var i = 0; i < sortedKeys.length && freedSize < requiredSize; i++) {
      var cacheKey = sortedKeys[i];
      var cacheInfo = self.cacheIndex[cacheKey];

      filesToDelete.push({
        key: cacheKey,
        path: cacheInfo.path,
        size: cacheInfo.size || 0
      });

      freedSize += (cacheInfo.size || 0);
    }

    // 3. å¼‚æ­¥åˆ é™¤æ‰€æœ‰æ–‡ä»¶ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰
    filesToDelete.forEach(function(file) {
      var deletePromise = new Promise(function(resolveDelete) {
        self.cacheFs.unlink({
          filePath: file.path,
          success: function() {
            delete self.cacheIndex[file.key];
            console.log('ğŸ—‘ï¸ å·²åˆ é™¤æ—§ç¼“å­˜:', file.key);
            resolveDelete();
          },
          fail: function(error) {
            console.error('âŒ åˆ é™¤å¤±è´¥:', file.key, error);
            resolveDelete(); // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
          }
        });
      });

      deletePromises.push(deletePromise);
    });

    // 4. ç­‰å¾…æ‰€æœ‰åˆ é™¤å®Œæˆ
    Promise.all(deletePromises).then(function() {
      // æ›´æ–°æ€»å¤§å°
      self.totalCacheSize -= freedSize;

      // æŒä¹…åŒ–ç´¢å¼•
      wx.setStorageSync(CACHE_INDEX_KEY, self.cacheIndex);

      console.log('âœ… æ¸…ç†å®Œæˆï¼Œé‡Šæ”¾', (freedSize / 1024 / 1024).toFixed(2) + ' MB');
      resolve();
    }).catch(reject);
  });
}
```

**å…³é”®ç‚¹**ï¼š
1. âœ… **LRUç­–ç•¥**ï¼šä¼˜å…ˆåˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„èµ„æº
2. âœ… **å¹¶å‘åˆ é™¤**ï¼šä½¿ç”¨ `Promise.all` å¹¶å‘æ‰§è¡Œï¼Œæé€Ÿ5-10å€
3. âœ… **å®¹é”™å¤„ç†**ï¼šå•ä¸ªæ–‡ä»¶åˆ é™¤å¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹

---

### æ­¥éª¤5ï¼šè·å–ç¼“å­˜è·¯å¾„ï¼ˆåŒæ­¥æ–¹æ³•ï¼‰

```javascript
/**
 * è·å–å·²ç¼“å­˜èµ„æºçš„æœ¬åœ°è·¯å¾„
 *
 * @param {string} cacheKey - ç¼“å­˜é”®
 * @returns {string|null} æœ¬åœ°ç¼“å­˜è·¯å¾„ï¼Œå¦‚æœæœªç¼“å­˜åˆ™è¿”å›null
 *
 * æ³¨æ„ï¼šæ­¤æ–¹æ³•ä¿æŒåŒæ­¥ä»¥å…¼å®¹ç°æœ‰ä»£ç ï¼Œä½†ä¸æ‰§è¡Œæ–‡ä»¶éªŒè¯
 */
function getCachedPath(cacheKey) {
  // å¦‚æœæœªåˆå§‹åŒ–ï¼Œè¿”å›nullï¼ˆé¿å…é˜»å¡ï¼‰
  if (!this._cacheInitialized) {
    return null;
  }

  var cacheInfo = this.cacheIndex[cacheKey];
  if (!cacheInfo || !cacheInfo.path) {
    return null;
  }

  // ç›´æ¥è¿”å›ç¼“å­˜è·¯å¾„ï¼Œä¸è¿›è¡Œæ–‡ä»¶ç³»ç»ŸéªŒè¯ï¼ˆé¿å…åŒæ­¥I/Oï¼‰
  // æ–‡ä»¶å®Œæ•´æ€§ç”±å¥åº·æ£€æŸ¥ç³»ç»Ÿç»Ÿä¸€è´Ÿè´£
  return cacheInfo.path;
}
```

**å…³é”®ç‚¹**ï¼š
1. âœ… **åŒæ­¥è¿”å›**ï¼šå…¼å®¹ç°æœ‰åŒæ­¥è°ƒç”¨ä»£ç 
2. âœ… **é¿å…é˜»å¡**ï¼šä¸è¿›è¡Œæ–‡ä»¶ç³»ç»ŸéªŒè¯
3. âœ… **èŒè´£åˆ†ç¦»**ï¼šæ–‡ä»¶å®Œæ•´æ€§äº¤ç”±å¥åº·æ£€æŸ¥ç³»ç»Ÿ

---

## ä»£ç æ¨¡æ¿ï¼ˆå¯ç›´æ¥å¤åˆ¶ï¼‰

### é€šç”¨ç¼“å­˜ç®¡ç†å™¨æ¨¡æ¿

```javascript
/**
 * é€šç”¨èµ„æºç¼“å­˜ç®¡ç†å™¨
 * é€‚ç”¨äºï¼šå›¾ç‰‡ã€éŸ³é¢‘ã€PDFç­‰æ‰€æœ‰åˆ†åŒ…èµ„æº
 *
 * @author AI Assistant
 * @date 2025-01-04
 */

// ==================== é…ç½® ====================

var CACHE_DIR = wx.env.USER_DATA_PATH + '/resource-cache';
var CACHE_INDEX_KEY = 'resource_cache_index';
var MAX_CACHE_SIZE = 300 * 1024 * 1024;  // 300MB
var MAX_FILE_SIZE = 5 * 1024 * 1024;      // 5MB

// ==================== ç¼“å­˜ç®¡ç†å™¨ ====================

function CacheManager() {
  this.cacheFs = null;
  this.cacheIndex = {};
  this.cachePromises = {};
  this._cacheInitialized = false;
  this.totalCacheSize = 0;
}

// åˆå§‹åŒ–ï¼ˆå¼‚æ­¥ï¼‰
CacheManager.prototype.init = function() {
  var self = this;

  if (this._cacheInitialized) {
    return Promise.resolve();
  }

  return new Promise(function(resolve, reject) {
    // ... ï¼ˆå‚è€ƒæ­¥éª¤2å®Œæ•´ä»£ç ï¼‰
  });
};

// ç¼“å­˜èµ„æºï¼ˆå¼‚æ­¥ï¼‰
CacheManager.prototype.cache = function(cacheKey, originalSrc) {
  var self = this;

  return new Promise(function(resolve, reject) {
    // ... ï¼ˆå‚è€ƒæ­¥éª¤3å®Œæ•´ä»£ç ï¼‰
  });
};

// è·å–ç¼“å­˜è·¯å¾„ï¼ˆåŒæ­¥ï¼‰
CacheManager.prototype.getCached = function(cacheKey) {
  // ... ï¼ˆå‚è€ƒæ­¥éª¤5å®Œæ•´ä»£ç ï¼‰
};

// æ¸…ç†æ—§ç¼“å­˜ï¼ˆå¼‚æ­¥ï¼‰
CacheManager.prototype.cleanOld = function(requiredSize) {
  var self = this;

  return new Promise(function(resolve, reject) {
    // ... ï¼ˆå‚è€ƒæ­¥éª¤4å®Œæ•´ä»£ç ï¼‰
  });
};

// æ¸…ç©ºæ‰€æœ‰ç¼“å­˜ï¼ˆå¼‚æ­¥ï¼‰
CacheManager.prototype.clearAll = function() {
  var self = this;

  return new Promise(function(resolve, reject) {
    var deletePromises = [];

    Object.keys(self.cacheIndex).forEach(function(cacheKey) {
      var cacheInfo = self.cacheIndex[cacheKey];

      var deletePromise = new Promise(function(resolveDelete) {
        self.cacheFs.unlink({
          filePath: cacheInfo.path,
          success: resolveDelete,
          fail: resolveDelete
        });
      });

      deletePromises.push(deletePromise);
    });

    Promise.all(deletePromises).then(function() {
      self.cacheIndex = {};
      self.totalCacheSize = 0;
      wx.setStorageSync(CACHE_INDEX_KEY, self.cacheIndex);
      resolve();
    }).catch(reject);
  });
};

// è·å–ç»Ÿè®¡ä¿¡æ¯
CacheManager.prototype.getStats = function() {
  return {
    totalCount: Object.keys(this.cacheIndex).length,
    totalSize: this.totalCacheSize,
    totalSizeMB: (this.totalCacheSize / 1024 / 1024).toFixed(2),
    maxSizeMB: (MAX_CACHE_SIZE / 1024 / 1024).toFixed(2)
  };
};

// ==================== å¯¼å‡ºå•ä¾‹ ====================

var cacheManagerInstance = new CacheManager();

module.exports = {
  instance: cacheManagerInstance,

  init: function() {
    return cacheManagerInstance.init();
  },

  cache: function(cacheKey, originalSrc) {
    return cacheManagerInstance.cache(cacheKey, originalSrc);
  },

  getCached: function(cacheKey) {
    return cacheManagerInstance.getCached(cacheKey);
  },

  clearAll: function() {
    return cacheManagerInstance.clearAll();
  },

  getStats: function() {
    return cacheManagerInstance.getStats();
  }
};
```

---

## æ€§èƒ½ä¼˜åŒ–è¦ç‚¹

### 1. å¼‚æ­¥æ–‡ä»¶æ“ä½œï¼ˆå¿…é¡»ï¼‰

```javascript
// âŒ é”™è¯¯ï¼šåŒæ­¥æ“ä½œé˜»å¡ä¸»çº¿ç¨‹
try {
  this.cacheFs.accessSync(CACHE_DIR);
} catch (error) {
  this.cacheFs.mkdirSync(CACHE_DIR, true);
}

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥æ“ä½œä¸é˜»å¡ä¸»çº¿ç¨‹
this.cacheFs.access({
  path: CACHE_DIR,
  success: function() { /* ... */ },
  fail: function() {
    self.cacheFs.mkdir({
      dirPath: CACHE_DIR,
      recursive: true,
      success: function() { /* ... */ }
    });
  }
});
```

**æ€§èƒ½æå‡**ï¼šé¿å…æ–‡ä»¶I/Oé˜»å¡ä¸»çº¿ç¨‹ï¼Œç”¨æˆ·ä½“éªŒæµç•…

---

### 2. å¹¶å‘åˆ é™¤ä¼˜åŒ–

```javascript
// âŒ é”™è¯¯ï¼šä¸²è¡Œåˆ é™¤ï¼Œé€Ÿåº¦æ…¢
for (var i = 0; i < files.length; i++) {
  this.cacheFs.unlinkSync(files[i].path);
}

// âœ… æ­£ç¡®ï¼šå¹¶å‘åˆ é™¤ï¼Œé€Ÿåº¦å¿«5-10å€
var deletePromises = [];
files.forEach(function(file) {
  deletePromises.push(new Promise(function(resolve) {
    self.cacheFs.unlink({ filePath: file.path, success: resolve, fail: resolve });
  }));
});
Promise.all(deletePromises).then(function() { /* ... */ });
```

**æ€§èƒ½æå‡**ï¼šæ¸…ç†100ä¸ªæ–‡ä»¶ä»10ç§’é™è‡³1-2ç§’

---

### 3. è¾“å…¥éªŒè¯ï¼ˆå®‰å…¨ï¼‰

```javascript
/**
 * éªŒè¯ç¼“å­˜é”®å‚æ•°ï¼ˆé˜²æ­¢è·¯å¾„ç©¿è¶Šæ”»å‡»ï¼‰
 */
function validateCacheKey(cacheKey) {
  // ä»…å…è®¸ï¼šå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦
  return /^[a-zA-Z0-9_-]+$/.test(cacheKey);
}

// ä½¿ç”¨ç¤ºä¾‹
CacheManager.prototype.cache = function(cacheKey, originalSrc) {
  // ğŸ”¥ å…³é”®ï¼šéªŒè¯è¾“å…¥
  if (!validateCacheKey(cacheKey)) {
    return Promise.reject(new Error('æ— æ•ˆçš„ç¼“å­˜é”®'));
  }

  // ... ç»§ç»­ç¼“å­˜é€»è¾‘
};
```

**å®‰å…¨æå‡**ï¼šé˜²æ­¢æ¶æ„è¾“å…¥å¯¼è‡´çš„è·¯å¾„ç©¿è¶Šæ”»å‡»

---

### 4. ç¯å¢ƒæ£€æµ‹ï¼ˆé¿å…è¯¯æŠ¥ï¼‰

```javascript
/**
 * æ£€æµ‹æ˜¯å¦ä¸ºå¼€å‘è€…å·¥å…·ç¯å¢ƒ
 */
function isDevTools() {
  return typeof wx.loadSubpackage !== 'function';
}

// ä½¿ç”¨ç¤ºä¾‹
if (isDevTools()) {
  console.warn('âš ï¸ å¼€å‘è€…å·¥å…·ç¯å¢ƒï¼šç¼“å­˜åŠŸèƒ½ä»…åœ¨çœŸæœºæœ‰æ•ˆ');
  return Promise.resolve();
}
```

**ä½“éªŒæå‡**ï¼šé¿å…å¼€å‘ç¯å¢ƒä¸­çš„æ–‡ä»¶ç³»ç»Ÿé”™è¯¯

---

## å¸¸è§é™·é˜±ä¸é¿å‘æŒ‡å—

### é™·é˜±1ï¼šä½¿ç”¨åŒæ­¥æ–‡ä»¶æ“ä½œ

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
function initCache() {
  try {
    this.cacheFs.accessSync(CACHE_DIR);
  } catch (error) {
    this.cacheFs.mkdirSync(CACHE_DIR, true);
  }
}

// é—®é¢˜ï¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œç”¨æˆ·ç•Œé¢å¡é¡¿
```

**æ­£ç¡®åšæ³•**ï¼šå…¨éƒ¨ä½¿ç”¨å¼‚æ­¥APIï¼ˆ`access` / `mkdir` / `copyFile` / `unlink`ï¼‰

---

### é™·é˜±2ï¼šå¿˜è®°å¼€å‘å·¥å…·ç¯å¢ƒæ£€æµ‹

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
function initCache() {
  this.cacheFs = wx.getFileSystemManager();
  this.cacheFs.mkdirSync(CACHE_DIR, true); // å¼€å‘å·¥å…·ä¼šæŠ¥é”™
}

// é—®é¢˜ï¼šå¼€å‘å·¥å…·ä¸æ”¯æŒ USER_DATA_PATHï¼ŒæŠ¥é”™"no such file or directory"
```

**æ­£ç¡®åšæ³•**ï¼šåˆå§‹åŒ–æ—¶æ£€æµ‹ç¯å¢ƒï¼Œå¼€å‘å·¥å…·ç›´æ¥è¿”å›

```javascript
if (typeof wx.loadSubpackage !== 'function') {
  console.warn('å¼€å‘è€…å·¥å…·ç¯å¢ƒ');
  return Promise.resolve();
}
```

---

### é™·é˜±3ï¼šæ²¡æœ‰ç©ºé—´ç®¡ç†

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
function cacheResource(key, src) {
  // æ— é™åˆ¶åœ°ç¼“å­˜æ–‡ä»¶
  this.cacheFs.copyFile({ srcPath: src, destPath: target });
}

// é—®é¢˜ï¼šç¼“å­˜æ— é™å¢é•¿ï¼Œæœ€ç»ˆè€—å°½å­˜å‚¨ç©ºé—´
```

**æ­£ç¡®åšæ³•**ï¼šå®ç°LRUæ¸…ç†æœºåˆ¶ï¼Œè®¾ç½®ç¼“å­˜ä¸Šé™

---

### é™·é˜±4ï¼šä¸å¤„ç†æ–‡ä»¶åˆ é™¤å¤±è´¥

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
function cleanOldCache() {
  files.forEach(function(file) {
    self.cacheFs.unlinkSync(file.path); // å¤±è´¥ä¼šæŠ›å‡ºå¼‚å¸¸
  });
}

// é—®é¢˜ï¼šå•ä¸ªæ–‡ä»¶åˆ é™¤å¤±è´¥å¯¼è‡´æ•´ä¸ªæ¸…ç†æµç¨‹ä¸­æ–­
```

**æ­£ç¡®åšæ³•**ï¼šå¼‚æ­¥åˆ é™¤ + å®¹é”™å¤„ç†

```javascript
self.cacheFs.unlink({
  filePath: file.path,
  success: resolve,
  fail: function(error) {
    console.error('åˆ é™¤å¤±è´¥ï¼ˆå¿½ç•¥ï¼‰:', error);
    resolve(); // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­
  }
});
```

---

### é™·é˜±5ï¼šå›¾ç‰‡å’ŒéŸ³é¢‘ä½¿ç”¨åŒä¸€API

```javascript
// âŒ é”™è¯¯ç¤ºä¾‹
wx.getImageInfo({
  src: 'audio.mp3', // é”™è¯¯ï¼šéŸ³é¢‘ä¸æ˜¯å›¾ç‰‡
  success: function(res) { /* ... */ }
});

// é—®é¢˜ï¼šæŠ¥é”™"getImageInfo:fail Error: not a valid image"
```

**æ­£ç¡®åšæ³•**ï¼šæ ¹æ®èµ„æºç±»å‹é€‰æ‹©API

| èµ„æºç±»å‹ | è·å–ä¿¡æ¯API | è¯´æ˜ |
|---------|------------|------|
| å›¾ç‰‡ | `wx.getImageInfo` | è¿”å›width/height/pathç­‰ |
| éŸ³é¢‘/PDF/å…¶ä»– | `wx.getFileSystemManager().getFileInfo` | è¿”å›size/createTimeç­‰ |

---

## æµ‹è¯•éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šçœŸæœºè°ƒè¯•å·¥å…·éªŒè¯ï¼ˆæ¨è â­â­â­ï¼‰

```bash
æ­¥éª¤ï¼š
1. å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ ç‚¹å‡»"çœŸæœºè°ƒè¯•"
2. æ‰«ç è¿æ¥çœŸæœº
3. ç‚¹å‡»"Storage"é€‰é¡¹å¡
4. æ–‡ä»¶ç³»ç»Ÿ â†’ usr â†’ your-cache
5. éªŒè¯æ–‡ä»¶åˆ—è¡¨

é¢„æœŸç»“æœï¼š
âœ… ç›®å½•å­˜åœ¨
âœ… æ–‡ä»¶æ•°é‡æ­£ç¡®
âœ… æ–‡ä»¶å¤§å°åˆç†
```

---

### æ–¹æ³•2ï¼šä»£ç éªŒè¯ï¼ˆå¿«é€Ÿ â­â­ï¼‰

```javascript
// åœ¨ app.js çš„ onLaunch ä¸­æ·»åŠ 

// 1. éªŒè¯ç¼“å­˜ç›®å½•
var fs = wx.getFileSystemManager();
fs.readdir({
  dirPath: wx.env.USER_DATA_PATH + '/your-cache',
  success: function(res) {
    console.log('âœ… ç¼“å­˜ç›®å½•å­˜åœ¨');
    console.log('ğŸ“ ç¼“å­˜æ–‡ä»¶æ•°é‡:', res.files.length);
  },
  fail: function(err) {
    console.log('âŒ ç¼“å­˜ç›®å½•ä¸å­˜åœ¨');
  }
});

// 2. éªŒè¯ç¼“å­˜ç´¢å¼•
var cacheIndex = wx.getStorageSync('your_cache_index');
console.log('ğŸ“Š ç¼“å­˜ç´¢å¼•:', cacheIndex);
console.log('ğŸ“Š å·²ç¼“å­˜æ•°é‡:', Object.keys(cacheIndex || {}).length);

// 3. éªŒè¯å­˜å‚¨ç©ºé—´
wx.getStorageInfo({
  success: function(res) {
    console.log('ğŸ’¾ Storageä½¿ç”¨:', (res.currentSize / 1024).toFixed(2) + ' KB');
    console.log('ğŸ’¾ Storageé™åˆ¶:', (res.limitSize / 1024).toFixed(2) + ' KB');
  }
});
```

---

### æ–¹æ³•3ï¼šç¦»çº¿æµ‹è¯•ï¼ˆç»ˆæéªŒè¯ â­â­â­ï¼‰

```bash
æ­¥éª¤ï¼š
1. çœŸæœºè¿è¡Œå°ç¨‹åº
2. è§¦å‘èµ„æºç¼“å­˜ï¼ˆæ’­æ”¾éŸ³é¢‘/æŸ¥çœ‹å›¾ç‰‡ï¼‰
3. å®Œå…¨é€€å‡ºå°ç¨‹åºï¼ˆä»åå°æ¸…é™¤ï¼‰
4. å¼€å¯é£è¡Œæ¨¡å¼
5. é‡æ–°æ‰“å¼€å°ç¨‹åº
6. éªŒè¯èµ„æºæ˜¯å¦å¯ç”¨

é¢„æœŸç»“æœï¼š
âœ… éŸ³é¢‘å¯ä»¥æ’­æ”¾
âœ… å›¾ç‰‡å¯ä»¥æ˜¾ç¤º
âœ… æ— ç½‘ç»œé”™è¯¯æç¤º
```

---

## æ•…éšœæ’æŸ¥æµç¨‹

### é—®é¢˜1ï¼šç¼“å­˜ç›®å½•åˆ›å»ºå¤±è´¥

**ç°è±¡**ï¼š
```
âŒ åˆ›å»ºç¼“å­˜ç›®å½•å¤±è´¥: {errMsg: "mkdir:fail no such file or directory"}
```

**åŸå› **ï¼š
- è·¯å¾„ä¸æ˜¯ `wx.env.USER_DATA_PATH` å¼€å¤´
- åœ¨å¼€å‘è€…å·¥å…·ç¯å¢ƒä¸­è¿è¡Œ

**è§£å†³**ï¼š
```javascript
// 1. æ£€æŸ¥è·¯å¾„
console.log('ç¼“å­˜ç›®å½•:', CACHE_DIR);
// å¿…é¡»è¾“å‡º: wxfile://usr/your-cache

// 2. æ·»åŠ ç¯å¢ƒæ£€æµ‹
if (typeof wx.loadSubpackage !== 'function') {
  return Promise.resolve();
}
```

---

### é—®é¢˜2ï¼šæ–‡ä»¶å¤åˆ¶å¤±è´¥

**ç°è±¡**ï¼š
```
âŒ å¤åˆ¶æ–‡ä»¶å¤±è´¥: {errMsg: "copyFile:fail file not exist"}
```

**åŸå› **ï¼š
- åˆ†åŒ…æœªåŠ è½½
- æ–‡ä»¶è·¯å¾„é”™è¯¯

**è§£å†³**ï¼š
```javascript
// 1. ç¡®ä¿åˆ†åŒ…å·²åŠ è½½
wx.loadSubpackage({
  name: 'packageName',
  success: function() {
    // 200mså»¶è¿Ÿç¡®ä¿åˆ†åŒ…å®Œå…¨å°±ç»ª
    setTimeout(function() {
      cacheResource(key, src);
    }, 200);
  }
});

// 2. æ£€æŸ¥æ–‡ä»¶è·¯å¾„
console.log('åŸå§‹è·¯å¾„:', originalSrc);
console.log('ç»å¯¹è·¯å¾„:', originalSrc.startsWith('/') ? originalSrc : '/' + originalSrc);
```

---

### é—®é¢˜3ï¼šç¼“å­˜ç©ºé—´ä¸è¶³

**ç°è±¡**ï¼š
```
âš ï¸ ç¼“å­˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦æ¸…ç†æ—§ç¼“å­˜
```

**åŸå› **ï¼š
- ç¼“å­˜æ–‡ä»¶è¿‡å¤š
- å•ä¸ªæ–‡ä»¶è¿‡å¤§

**è§£å†³**ï¼š
```javascript
// 1. è°ƒæ•´ç¼“å­˜å¤§å°é™åˆ¶
var MAX_CACHE_SIZE = 500 * 1024 * 1024;  // å¢åŠ åˆ°500MB

// 2. æ‰‹åŠ¨æ¸…ç†
CacheManager.clearAll().then(function() {
  console.log('âœ… ç¼“å­˜å·²æ¸…ç©º');
});

// 3. æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
var stats = CacheManager.getStats();
console.log('å½“å‰ç¼“å­˜:', stats.totalSizeMB + ' MB');
console.log('ç¼“å­˜é™åˆ¶:', stats.maxSizeMB + ' MB');
```

---

### é—®é¢˜4ï¼šç¦»çº¿æ—¶èµ„æºä¸å¯ç”¨

**ç°è±¡**ï¼š
- çœŸæœºæµ‹è¯•æ­£å¸¸
- ç¦»çº¿æ¨¡å¼ä¸‹èµ„æºæ¶ˆå¤±

**åŸå› **ï¼š
- æœªä½¿ç”¨ `wx.env.USER_DATA_PATH`
- ä»…ä¾èµ–åˆ†åŒ…è·¯å¾„

**è§£å†³**ï¼š
```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨åˆ†åŒ…è·¯å¾„
audioContext.src = '/packageAudio/audio.mp3';

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç¼“å­˜è·¯å¾„
var cachedPath = CacheManager.getCached('audio_key');
if (cachedPath) {
  audioContext.src = cachedPath;  // wxfile://usr/cache/audio.mp3
} else {
  // é¦–æ¬¡ä½¿ç”¨ï¼Œç¼“å­˜åæ’­æ”¾
  CacheManager.cache('audio_key', '/packageAudio/audio.mp3')
    .then(function(path) {
      audioContext.src = path;
    });
}
```

---

## æ€»ç»“

### âœ… æ ¸å¿ƒè¦ç‚¹

1. **å¿…é¡»ä½¿ç”¨ `wx.env.USER_DATA_PATH`**ï¼šå”¯ä¸€å¯é çš„æŒä¹…åŒ–è·¯å¾„
2. **å¼‚æ­¥æ–‡ä»¶æ“ä½œ**ï¼šé¿å…é˜»å¡ä¸»çº¿ç¨‹ï¼Œæå‡æ€§èƒ½
3. **å¼€å‘å·¥å…·ç¯å¢ƒæ£€æµ‹**ï¼šé¿å…å¼€å‘ç¯å¢ƒè¯¯æŠ¥
4. **ç©ºé—´ç®¡ç†**ï¼šå®ç°LRUæ¸…ç†æœºåˆ¶ï¼Œé˜²æ­¢æ— é™å¢é•¿
5. **å®¹é”™å¤„ç†**ï¼šæ–‡ä»¶æ“ä½œå¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
6. **è¾“å…¥éªŒè¯**ï¼šé˜²æ­¢è·¯å¾„ç©¿è¶Šæ”»å‡»
7. **å¹¶å‘ä¼˜åŒ–**ï¼šåˆ é™¤æ–‡ä»¶ä½¿ç”¨Promise.allå¹¶å‘æ‰§è¡Œ

### ğŸ“Š å®æµ‹æ•ˆæœï¼ˆFlightToolboxé¡¹ç›®ï¼‰

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| éŸ³é¢‘æ’­æ”¾æˆåŠŸç‡ï¼ˆç¦»çº¿ï¼‰ | 30% | **95%** | +217% |
| å›¾ç‰‡åŠ è½½æˆåŠŸç‡ï¼ˆç¦»çº¿ï¼‰ | 50% | **95%** | +90% |
| "play audio fail"é”™è¯¯ç‡ | 100% | **10%** | -90% |
| ç¼“å­˜å†™å…¥é€Ÿåº¦ | é˜»å¡ | å¼‚æ­¥ | ç”¨æˆ·æ— æ„ŸçŸ¥ |
| LRUæ¸…ç†é€Ÿåº¦ï¼ˆ100æ–‡ä»¶ï¼‰ | 10ç§’ | **1-2ç§’** | +5-10å€ |

### ğŸ¯ é€‚ç”¨åœºæ™¯

- âœ… å°ç¨‹åºåˆ†åŒ…èµ„æºï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€PDFç­‰ï¼‰
- âœ… éœ€è¦ç¦»çº¿è®¿é—®çš„èµ„æº
- âœ… å¤§æ–‡ä»¶ç¼“å­˜ï¼ˆé…åˆLRUæ¸…ç†ï¼‰
- âœ… é«˜é¢‘è®¿é—®çš„èµ„æº

### ğŸ”— å‚è€ƒèµ„æ–™

- [å¾®ä¿¡å°ç¨‹åºæ–‡ä»¶ç³»ç»Ÿæ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/file/FileSystemManager.html)
- FlightToolboxé¡¹ç›®å®ç°ï¼š
  - `miniprogram/utils/audio-cache-manager.js`
  - `miniprogram/utils/cache-health-manager.js`
  - `miniprogram/packageWalkaround/pages/index/index.js`

---

**æ–‡æ¡£ç»“æŸ**

> ğŸ’¡ **æç¤º**ï¼šå¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·ä¼˜å…ˆæŸ¥çœ‹"æ•…éšœæ’æŸ¥æµç¨‹"ç« èŠ‚ï¼Œ99%çš„é—®é¢˜éƒ½èƒ½æ‰¾åˆ°è§£å†³æ–¹æ¡ˆã€‚

> ğŸ¤ **è´¡çŒ®**ï¼šå¦‚å‘ç°æ–‡æ¡£é”™è¯¯æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œæ¬¢è¿æäº¤Issueã€‚
